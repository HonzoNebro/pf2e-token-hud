(()=>{var Vt=Object.defineProperty;var c=(t,e)=>Vt(t,"name",{value:e,configurable:!0});var Jt="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function Ke(t){function e(f){ChatMessage.create({user:game.user.id,content:f,speaker:ChatMessage.getSpeaker({actor:t})})}c(e,"toChat");let{name:s,attributes:i}=t,{sp:a,resolve:n}=i,o=w("hud.resolve.full",{name:s}),l=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:s});if(a.value===a.max)return ui.notifications.warn(o);if(n.value<1)return ui.notifications.warn(l);let r=t.itemTypes.feat.find(f=>f.sourceId===Jt),u=await renderTemplate(O("dialogs/resolve"),{hasSteel:r,i18n:f=>w(`hud.resolve.${f}`)});new Dialog({title:w("hud.resolve.title"),content:u,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:w("hud.resolve.yes"),callback:async f=>{let{attributes:d}=t,{sp:p,resolve:m}=d;if(p.value===p.max)return e(o);if(m.value<1)return e(l);let g=f.find("input:checked").val(),h=`${p.value}/${p.max}`;if(g==="breather")e(w("hud.resolve.breather.used",{name:s,ratio:h})),await t.update({"system.attributes.sp.value":p.max,"system.attributes.resolve.value":m.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:s,ratio:h}));let v=p.value+Math.floor(p.max/2);await t.update({"system.attributes.sp.value":Math.min(v,p.max),"system.attributes.resolve.value":m.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:w("hud.resolve.no")}}}).render(!0)}c(Ke,"useResolve");var Qt=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),Xt=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function Yt(t,e="normal"){return t+(Qt.get(e)??0)}c(Yt,"adjustDC");function Zt(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}c(Zt,"rarityToDCAdjustment");function pe(t,e="common"){return Yt(t,Zt(e))}c(pe,"adjustDCByRarity");function fe(t,{proficiencyWithoutLevel:e,rarity:s="common"}={}){let i=game.settings.get("pf2e","proficiencyVariant");e??=i==="ProficiencyWithoutLevel";let a=Xt.get(t)??14;return pe(e?a-Math.max(t,0):a,s)}c(fe,"calculateDC");function ae(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}c(ae,"htmlQueryAll");function Fe(t,e){return t instanceof Element?t.closest(e):null}c(Fe,"htmlClosest");var qe={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"},ei={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function We(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return qe.passive;let s=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(s??"").toLowerCase().trim();return qe[i]??e}c(We,"getActionIcon");function Ve(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,s=String(e??"").toLowerCase().trim();return ei[s]??""}c(Ve,"getActionGlyph");function Je(t){return Error(`PF2e System | ${t}`)}c(Je,"ErrorPF2e");function Qe(t,e){return t.includes(e)}c(Qe,"tupleHasValue");function ti(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}c(ti,"isRelevantEvent");function me(t){let e=!game.user.settings.showRollDialogs;if(!ti(t))return{skipDialog:e};let s={skipDialog:t.shiftKey?!e:e};return(t.ctrlKey||t.metaKey)&&(s.rollMode=game.user.isGM?"gmroll":"blindroll"),s}c(me,"eventToRollParams");var ii=["fortitude","reflex","will"],Ye=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(",");function si(t,e){for(let s of t){(!e||e.isOwner)&&s.classList.add("with-repost");let i=ae(s,"i[data-pf2-repost]");if(i.length>0){if(e&&!e.isOwner){for(let o of i)o.remove();s.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let a=document.createElement("i"),n=s.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";a.classList.add("fa-solid",n),a.dataset.pf2Repost="",a.title=game.i18n.localize("PF2E.Repost"),s.appendChild(a),a.addEventListener("click",o=>{o.stopPropagation();let l=o.target;if(!(l instanceof HTMLElement))return;let r=l?.parentElement;if(!r)return;let u=Ze(l,e);ai(r,u)})}}c(si,"injectRepostElement");function ni(t,e=null){for(let s of ae(t,"a.inline-roll[data-damage-roll]")){let i=Fe(s,"[data-item-id]")?.dataset.itemId,a=e?.items.get(i??"");a&&(s.dataset.flavor||=a.name)}}c(ni,"flavorDamageRolls");function Xe(t,e){let s=t.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${t.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${s}</span> ${t.outerHTML}`.trim()}c(Xe,"makeRepostHtml");function ai(t,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(u=>u in t.dataset))return;let s=et(e),i=(s??e)?.hasPlayerOwner?"all":"gm",a=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${ae(t.parentElement,Ye).map(f=>Xe(f,i)).join("<br>")}</div>`:Xe(t,i))(),n=CONFIG.ChatMessage.documentClass,o=s?n.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0).shift()}):n.getSpeaker(),l=game.messages.get(Fe(t,"[data-message-id]")?.dataset.messageId??""),r=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:l?.flags.pf2e.origin?{pf2e:{origin:deepClone(l.flags.pf2e.origin)}}:{};n.create({speaker:o,content:a,flags:r})}c(ai,"repostAction");function ge(t,e){e??=Ze(t,e);let s=ae(t,Ye).filter(a=>["A","SPAN"].includes(a.nodeName));si(s,e),ni(t,e instanceof Actor?e:null);for(let a of s.filter(n=>n.dataset.pf2Action)){let{pf2Action:n,pf2Glyph:o,pf2Variant:l,pf2Dc:r,pf2ShowDc:u,pf2Skill:f}=a.dataset;a.addEventListener("click",d=>{let p=game.pf2e.actions[n?game.pf2e.system.sluggify(n,{camel:"dromedary"}):""],m=u??"all";n&&p?p({event:d,glyph:o,variant:l,difficultyClass:r?{scope:"check",value:Number(r)||0,visibility:m}:void 0,skill:f}):console.warn(`PF2e System | Skip executing unknown action '${n}'`)})}for(let a of s.filter(n=>n.dataset.pf2Check&&!n.dataset.invalid)){let{pf2Check:n,pf2Dc:o,pf2Traits:l,pf2Label:r,pf2Defense:u,pf2Adjustment:f}=a.dataset;if(!n)return;a.addEventListener("click",async d=>{let p=parent=et(e),m=l?.split(",").map(h=>h.trim()).filter(h=>!!h)??[],g=me(d);switch(n){case"flat":{let h=new p.perception.constructor(p,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),v=Number.isInteger(Number(o))?{label:r,value:Number(o)}:null;h.roll({...g,extraRollOptions:m,dc:v});break}default:{let h=Qe(ii,n),v=h?[]:m.filter(T=>T in CONFIG.PF2E.actionTraits)??[],D=(()=>{if(n in CONFIG.PF2E.magicTraditions){let q=p.spellcasting.filter(P=>P.tradition===n).flatMap(P=>P.statistic??[]).sort((P,ie)=>ie.check.mod-P.check.mod).shift()??null;if(q)return q}let T=p.getStatistic(n);return T?.check.type==="check"&&v.includes("attack")?T.extend({check:{type:"attack-roll",domains:["attack","attack-roll",`${n}-attack-roll`]}}):T})();if(!D){console.warn(Je(`Skip rolling unknown statistic ${n}`).message);break}let E=u?game.user.targets.first()?.actor:null,S=(()=>{let T=Number(f)||0;return o==="@self.level"?fe(p.level)+T:Number(o??"NaN")+T})(),z=(()=>{if(Number.isInteger(S))return{label:r,value:S};if(u){let T=E?.getStatistic(u);return T?{statistic:T.dc,scope:"check",value:T.dc.value}:null}return null})(),R=(()=>{let T=e instanceof Item?e:e instanceof ChatMessage?e.item:null;return T?.isOfType("action")||h&&!T?.isOfType("weapon")?T:null})(),M={...g,extraRollOptions:m,origin:h&&parent instanceof Actor?parent:null,dc:z,target:!h&&z?.statistic?E:null,item:R,traits:v};if(!!(R?.isOfType("action")&&R.actionCost)&&u){let T=n in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":"PF2E.ActionsCheck.x";M.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:Ve(R.actionCost),subtitle:game.i18n.format(T,{type:D.label}),title:R.name})}D.roll(M)}}})}let i={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};for(let a of s.filter(n=>n.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:n,pf2Distance:o,pf2TemplateData:l,pf2Traits:r,pf2Width:u}=a.dataset;a.addEventListener("click",()=>{if(typeof n!="string"){console.warn("PF2e System | Could not create template'");return}let f=JSON.parse(l??"{}");f.distance||=Number(o),f.fillColor||=game.user.color,f.t=i[n],f.t==="ray"?f.width=Number(u)||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):f.t==="cone"&&(f.angle=CONFIG.MeasuredTemplate.defaults.angle),r&&(f.flags={pf2e:{origin:{traits:r.split(",")}}});let d=new CONFIG.MeasuredTemplate.documentClass(f,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(d).drawPreview()})}}c(ge,"listenInlineRoll");function Ze(t,e){if(e)return e;let i=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return i instanceof Actor||i instanceof JournalEntry?i:null}c(Ze,"resolveDocument");function et(t){return t instanceof Actor?t:t instanceof Item||t instanceof ChatMessage?t.actor:null}c(et,"resolveActor");var he=["U","T","E","M","L"];async function tt(t,e){let s=t.data(),i=s.itemId?e.items.get(s.itemId):await fromUuid(s.uuid),a=await i?.getChatData({secrets:e.isOwner},s);if(!a)return;let n=document.createElement("div");return n.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(n,i,a),ge(n,i),n}c(tt,"getItemSummary");function G(t){t.on("mouseenter",e=>{e.preventDefault();let s=e.currentTarget.querySelector(".name"),{width:i}=s.getBoundingClientRect();if(s.scrollWidth<=Math.ceil(i))return;let a=s.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:a})}),t.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),t.on("mousedown",e=>{game.tooltip.deactivate()})}c(G,"addNameTooltipListeners");function it(t,e){t.preventDefault(),j(t,e)?.sheet.render(!0,{focus:!0})}c(it,"editItem");async function st(t,e){t.preventDefault();let s=j(t,e);if(s){if(t.ctrlKey)return s.delete();new Dialog({title:w("deleteItem.title"),content:await renderTemplate("systems/pf2e/templates/actors/delete-item-dialog.hbs",{name:s.name}),buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:w("deleteItem.ok"),callback:()=>s.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:w("deleteItem.cancel")}}}).render(!0)}}c(st,"deleteItem");function j(t,e){let{itemId:s}=t.currentTarget.closest("[data-item-id]").dataset;return e.items.get(s)}c(j,"getItemFromEvent");function ye(t){return t.isOwner?W(t,`macros.${game.user.id}`)?.map(e=>{let s=fromUuidSync(e);return s?{img:s.img,name:s.name,uuid:e}:null}).filter(Boolean):void 0}c(ye,"getMacros");function be(t,e){let{type:s,uuid:i}=TextEditor.getDragEventData(t.originalEvent)??{};if(s!=="Macro"||!fromUuidSync(i))return;let a=`macros.${game.user.id}`,n=W(e,a)?.slice()??[];n.includes(i)||(n.push(i),Y(e,a,n))}c(be,"onDroppedMacro");function ke(t,e){let s=`macros.${game.user.id}`,i=W(e,s)?.slice();if(!i?.length)return;let{uuid:a}=t.currentTarget.closest(".macro").dataset,n=i.indexOf(a);n!==-1&&(i.splice(n,1),Y(e,s,i))}c(ke,"deleteMacro");function ve(t=()=>!0){let e=game.user.targets,s=e.size===1?e.first():null;return s&&t(s)?s:null}c(ve,"getUniqueTarget");function N(t,e){return e?t.toLowerCase().includes(e):!0}c(N,"filterIn");async function Z(t,e,s){let i=V(),a=i?.element;if(!a)return;a.find("> .popup").remove();let n=document.createElement("div");n.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${w("popup.close")}</a>
    </div>
</div>`;let o=n.firstElementChild;typeof e=="string"?(e=await X(e,s),o.insertAdjacentHTML("beforeend",e)):o.append(e),o.querySelector("[data-action=close-popup]").addEventListener("click",()=>o.remove()),a.append(o),i.lock()}c(Z,"popup");async function _(t,e,s){s??=t.find(".name").html();let i=await tt(t,e);i&&Z(s.trim(),i,e)}c(_,"showItemSummary");async function nt({weapon:t,trait:e,selection:s}){if(t.system.traits.toggles[e].selection===s)return!1;let a=t.actor?.items.get(t.id);return a?.isOfType("weapon")&&a===t?await a.update({[`system.traits.toggles.${e}.selection`]:s}):a?.isOfType("weapon")&&t.altUsageType==="melee"?await a.update({[`system.meleeUsage.traitToggles.${e}`]:s}):await a?.rules.find(o=>o.key==="Strike"&&!o.ignored&&o.slug===t.slug)?.toggleTrait({trait:e,selection:s}),!0}c(nt,"toggleWeaponTrait");var we={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},at={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function ot(t,e){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+t,0,3)}}c(ot,"adjustDegreeOfSuccess");function Ie(t,e){return t===20?ot(at.INCREASE,e):t===1?ot(at.LOWER,e):e}c(Ie,"adjustDegreeByDieValue");function rt(t,e,s){return t-s>=10?Ie(e,we.CRITICAL_SUCCESS):s-t>=10?Ie(e,we.CRITICAL_FAILURE):t>=s?Ie(e,we.SUCCESS):Ie(e,we.FAILURE)}c(rt,"calculateDegreeOfSuccess");var oi=["arcana","crafting","medicine","nature","occultism","religion","society"],lt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function ct(t){let s=(await new Roll("1d20").evaluate({async:!0})).dice[0].total,i=s===1?"0":s===20?"3":"",a=Object.values(t.skills).filter(r=>r.lore),n=ve(r=>r.actor?.identificationDCs)?.actor,o={dieSuccess:i,dieResult:s,target:n,i18n:r=>w(`actions.recall-knowledge.${r}`)};if(n){let{standard:r,skills:u,lore:f}=n.identificationDCs,d=r.progression.slice();d.length=4,d=[...d];let p=f.map(({progression:m})=>{let g=m;return g.length=6,[...g]});o.skillsDCs=d,o.loresDCs=p,o.skills=await Promise.all(u.map(m=>{let g=t.skills[m];return Oe(g,s,d)})),o.lores=await Promise.all(a.map(m=>Oe(m,s)))}else o.skills=await Promise.all([...oi.map(r=>t.skills[r]),...a].map(r=>Oe(r,s)));let l=await renderTemplate(O("chat/recall-knowledge"),o);ChatMessage.create({flavor:l,speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL})}c(ct,"rollRecallKnowledges");async function Oe(t,e,s){let{rank:i,label:a}=t,n=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),o=n.total-n.dice[0].total,l=e+o;return{mod:o,rank:i,label:a,total:l,modifier:B(o),rankLabel:he[i],checks:s?.map(r=>{if(!r)return"-";let u=rt(l,e,r);return{success:u,icon:lt[u].icon,title:lt[u].name}})}}c(Oe,"rollSkill");async function Ce(t,e,s,{rollMode:i=void 0,create:a=!0,data:n={}}){let o=`systems/pf2e/templates/chat/${e.type}-card.hbs`,l=s.token,r=t?.currentTarget.closest(".item")??{},u=CONFIG.ChatMessage.documentClass,f=Object.keys(n).length>0?n:r.dataset||{},d={actor:s,tokenId:l?`${l.parent?.id}.${l.id}`:null,item:e,data:await e.getChatData(void 0,f)},p={speaker:u.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return i??=t?.ctrlKey||t?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(i)&&(p.whisper=u.getWhisperRecipients("GM").map(m=>m.id)),i==="blindroll"&&(p.blind=!0),p.content=await renderTemplate(o,d),a?u.create(p,{renderSheet:!1}):new u(p)}c(Ce,"unownedItemToMessage");var K="pf2e-token-hud",ri=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),ut="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",li="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",Pe="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",ci={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${K}.skills.actions.earnIncome`,treatWounds:`${K}.skills.actions.treatWounds`,"borrow-arcane-spell":`${K}.skills.actions.borrow-arcane-spell`,"identify-magic":`${K}.skills.actions.identify-magic`,"identify-alchemy":`${K}.skills.actions.identify-alchemy`,"learn-spell":`${K}.skills.actions.learn-spell`,"crafting-goods":`${K}.skills.actions.crafting-goods`,"staging-performance":`${K}.skills.actions.staging-performance`},dt={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:ut,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},di={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},oe=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&ri.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>Me(t,ut)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>Me(t,li)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];oe.forEach(t=>{t.actions=t.actions.map(i=>typeof i=="string"?di[i]:i);let{slug:e,actions:s}=t;for(let i of s){let a=i.slug.replace(/-(.)/g,(n,o)=>o.toUpperCase()).capitalize();i.skillSlug=e,i.uuid=dt[i.slug],i.label=ci[i.slug]??`PF2E.Actions.${a}.Title`,i.variants?i.variants=i.variants.map(n=>({slug:n,label:`${K}.skills.actions.${n}`})):i.map&&(i.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),i.modifiers?.forEach(({modifiers:n})=>{n.forEach(o=>{o.label=`${K}.skills.modifiers.${o.slug}`})})}});var $e=oe.map(t=>t.slug),pi=oe.reduce((t,{slug:e,actions:s})=>(t[e]={slug:e,actions:s.reduce((i,a)=>(i[a.slug]=a,i),{})},t),{}),pt=new Set(Object.values(dt).filter(Boolean));function Ne(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}c(Ne,"getSkillLabel");async function ft(t,e,s){let i=[],a=!b("untrained"),n=!t.isOfType("character");for(let r=0;r<oe.length;r++){let{slug:u,actions:f}=oe[r],{label:d,rank:p,mod:m}=t.getStatistic(u),g=game.i18n.localize(d),h=f.filter(({condition:E,trained:S})=>(a||n||!S||t.skills[u].rank>=1)&&(!E||E(t))).map(E=>({...E,name:game.i18n.localize(E.label),variants:E.variants?.map(S=>({...S,name:game.i18n.localize(S.label)}))})),v=N(g,s),D=h;!v&&(D=h.filter(({name:E,variants:S})=>N(E,s)||S?.some(z=>N(z.name,s))),!D.length)||(i[r]={slug:u,name:g,rank:p,modifier:B(m),actions:v?h:D})}i.sort((r,u)=>r.slug==="perception"?-1:u.slug==="perception"?1:r.name.localeCompare(u.name));let o=Object.values(t.skills).filter(({lore:r,label:u})=>r&&N(u,s)).map(({label:r,rank:u,mod:f,slug:d})=>({slug:d,label:r,rank:u,modifier:B(f)})),l=o.reduce((r,u)=>u.modifier.length>r?u.modifier.length:r,2);return{contentData:{follow:w(`skills.actions.${gt(t)?"following":"follow"}`),skills:i,lores:o,loresModifierWidth:l},doubled:b("skills-columns")}}c(ft,"getSkillsData");function mt(t,e,s){t.find("[data-action=action-description]").on("click",i=>{i.preventDefault();let a=$(i.currentTarget).closest(".action");_(a,e,a.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async i=>{i.preventDefault();let a=gt(e);if(a)return await a.delete();let n=(await fromUuid(Pe)).toObject();setProperty(n,"flags.core.sourceId",Pe),await e.createEmbeddedDocuments("Item",[n])}),t.find("[data-action=roll-skill]").on("click",i=>{i.preventDefault();let{slug:a}=i.currentTarget.dataset;e.getStatistic(a)?.roll({event:i})}),t.find("[data-action=roll-action]").on("click contextmenu",async i=>{i.preventDefault();let a=$(i.currentTarget),{skillSlug:n,slug:o}=a.closest(".action").data(),{variant:l,map:r}=a.data(),u=i.type==="contextmenu"?await Se(n):void 0;u!==null&&fi({event:i,actor:e,token:s,skillSlug:n,slug:o,variant:l,map:r,skill:u?.selected})}),t.find("[data-action=action-chat]").on("click",async i=>{i.preventDefault();let{uuid:a}=i.currentTarget.closest(".action").dataset,n=await fromUuid(a);n&&Ce(i,n,e,{create:!0})}))}c(mt,"addSkillsListeners");function gt(t){return t.itemTypes.effect.find(e=>e.sourceId===Pe)}c(gt,"isFollowingAnExpert");async function Se(t,e){let s=$e.map(a=>({slug:a,label:Ne(a)})),i=await renderTemplate(O("dialogs/variant"),{i18n:a=>w(`skills.variant.${a}`),dc:e,skills:s,selected:t});return Dialog.prompt({title:w("skills.variant.title"),label:w("skills.variant.button"),callback:a=>({selected:a.find("select").val(),dc:a.find("input").val()}),rejectClose:!1,content:i,options:{width:280}})}c(Se,"variantsDialog");function fi({event:t,actor:e,skillSlug:s,slug:i,variant:a,map:n,skill:o,token:l}){let r=pi[s].actions[i],u=r.type;o??=r.noSkill?void 0:s;let f=r.rollOption?[`action:${r.rollOption}`]:void 0;f&&a&&f.push(`action:${r.rollOption}:${a}`);let d={event:t,actors:[e],tokens:[l],variant:a,rollOptions:f,rollMode:r.secret?"blindroll":"roll"};if(d.modifiers=[],r.modifiers){for(let{condition:p,modifiers:m}of r.modifiers)if(!(p&&!p(e)))for(let g of m)d.modifiers.push(new game.pf2e.Modifier(g))}if(r.custom){r.custom(e,d);return}else if(!u){e.getStatistic(o)?.roll(d);return}u===1?(d.skill=o,n&&d.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:n})),game.pf2e.actions[i](d)):u===2?(d.statistic=o,n&&(d.multipleAttackPenalty=n/-5),game.pf2e.actions.get(i).use(d)):u===3&&game.pf2e.actions[i](e)}c(fi,"rollAction");var Re={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function ht(t,e,s){let{attributes:i}=t,{initiative:a}=i;return{contentData:{noMacro:w("extras.no-macro"),macros:ye(t)?.filter(n=>N(n.name,s)),initiative:a&&{selected:a.statistic,skills:$e.map(n=>({slug:n,label:Ne(n)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:Re}}}c(ht,"getExtrasData");function yt(t,e,s){function i(n,o,l="click"){t.find(`[data-action=${n}]`).on(l,r=>{r.preventDefault(),o(r)})}if(c(i,"action"),i("action-description",n=>{let o=$(n.currentTarget).closest(".row");_(o,e)}),!e.isOwner)return;G(t.find(".macro"));async function a(n){let{uuid:o}=n.currentTarget.closest(".macro").dataset;return fromUuid(o)}c(a,"getMacro"),i("delete-macro",n=>ke(n,e)),i("edit-macro",async n=>{(await a(n))?.sheet.render(!0)}),i("use-macro",async n=>{(await a(n))?.execute({actor:e,token:s})}),t.on("drop",n=>be(n,e)),i("action-chat",async n=>{let{uuid:o}=n.currentTarget.closest(".row").dataset,l=await fromUuid(o);l&&Ce(n,l,e,{create:!0})}),t.find("input[name], select[name]").on("change",async n=>{let o=n.currentTarget,l=o.type==="number"?o.valueAsNumber:o.value;await e.update({[o.name]:l})}),i("roll-initiative",async n=>{await e.initiative.roll({event:n})}),i("prepare-dailies",n=>{let o=game.modules.get("pf2e-dailies");o?.active&&o.api.openDailiesInterface(e)}),i("rest-for-the-night",n=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[s]})}),i("roll-recall-knowledge",n=>{ct(e)}),i("roll-aid",async n=>{let o=await Se(null,20),l={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};o!==null&&game.pf2e.actions.get("aid").use({event:n,actors:[e],tokens:[s],statistic:o?.selected,difficultyClass:{value:o?.dc},notes:[l]})},"click contextmenu"),i("roll-point-out",n=>{game.pf2e.actions.get("point-out").use({event:n,actors:[e],tokens:[s]})}),i("roll-escape",async n=>{let o=n.type==="contextmenu"?await Se():void 0,l=$(n.currentTarget).data().map;o!==null&&game.pf2e.actions.get("escape").use({event:n,actors:[e],tokens:[s],statistic:o?.selected,multipleAttackPenalty:l})},"click contextmenu")}c(yt,"addExtrasListeners");var te={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionTypeReaction",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionTypeFree",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.ActionTypePassive",actionLabel:"PF2E.ActionTypePassive"}},bt={delay:[500,0],position:"top",theme:"crb-hover",arrow:!1};async function kt(t,e,s){let i=t.isOfType("character"),a=t.synthetics.toggles.slice(),n=b("actions"),o=wt()?.getStances(t).sort((g,h)=>g.name.localeCompare(h.name)),l=i?gi(t):hi(t),r,u=game.modules.get("pf2e-hero-actions");if(u?.active&&i){let g=u.api.getHeroActions(t),h=t.heroPoints.value-g.length;r={actions:g,draw:Math.max(h,0),discard:Math.abs(Math.min(h,0)),canTrade:g.length&&game.settings.get("pf2e-hero-actions","trade")}}let f=t.isOwner,d=t.getRollData(),p=t.system.actions&&await Promise.all(t.system.actions.map(async(g,h)=>({...g,index:h,visible:!i||g.visible,damageFormula:await g.damage?.({getFormula:!0}),criticalFormula:await g.critical?.({getFormula:!0}),description:g.description?await X(g.description,t,{rollData:d,isOwner:f}):void 0,altUsages:g.altUsages&&await Promise.all(g.altUsages.map(async v=>({...v,usage:v.item.isThrown?"thrown":"melee",damageFormula:await v.damage?.({getFormula:!0}),criticalFormula:await v.critical?.({getFormula:!0})})))}))),m={};for(let g of l)N(g.name,s)&&(n!=="split"?(m.action??=[],m.action.push(g)):(m[g.type]??=[],m[g.type].push(g)));if(m=Object.entries(m).map(([g,h])=>(h.forEach(v=>{v.img=We(v.cost),v.typeLabel=te[v.type].actionLabel}),n!=="type"?h.sort((v,D)=>v.name.localeCompare(D.name)):h.sort((v,D)=>{let E=te[v.type].order,S=te[D.type].order;return E===S?v.name.localeCompare(D.name):E-S}),{type:g,actions:h,label:te[g].label})),n==="split"&&m.sort((g,h)=>te[g.type].order-te[h.type].order),a.length||o?.length||p?.length||m.length||r?.actions.length){let g=+((o?.length??0)>0)+ +((p?.length??0)>0)+m.length+ +((r?.actions.length??0)>0);return{contentData:{toggles:a,stances:o,strikes:p,sections:m,heroActions:r,i18n:h=>w(`actions.${h}`),variantLabel:h=>h.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:g>1&&b("actions-columns"),classes:[b("actions-colors")?"attack-damage-system-colors":""]}}}c(kt,"getActionsData");function vt(t,e){G(t.find(".toggle")),G(t.find(".strike")),G(t.find(".action"));function s(n,o,l="click"){return n=typeof n=="string"?[n]:n,n=n.map(r=>`[data-action=${r}]`).join(", "),t.find(n).on(l,r=>{r.preventDefault(),o(r)})}c(s,"action");function i(n){let o=n.currentTarget.closest(".strike"),l=e.system.actions[o.dataset.index];if(!l)return null;let{altUsage:r}=n.currentTarget.dataset;return["melee","thrown"].includes(r)?l.altUsages?.find(u=>r==="thrown"?u.item.isThrown:u.item.isMelee)??null:l}c(i,"getStrike");function a(n){return $(n.currentTarget).closest(".action").data().uuid}c(a,"getUuid"),s("action-description",async n=>{let o=$(n.currentTarget).closest(".action");_(o,e)}),s("hero-action-description",async n=>{let{description:o,name:l}=await mi(a(n))??{};o&&Z(l,o,e)}),s("strike-description",async n=>{let o=i(n);if(!o)return;let l=document.createElement("div");l.classList.add("description"),l.innerHTML=await renderTemplate(O("strike-description"),o),Z(o.label,l,e)}),s("trait-description",n=>{let o=i(n);if(!o)return;let{index:l}=n.currentTarget.dataset,r=o.traits[l];if(!r)return;let u=game.i18n.localize(r.description);u&&Z(game.i18n.localize(r.label),u,e)}),s("stance-description",n=>{let o=$(n.currentTarget).closest(".action");_(o,e)}),e.isOwner&&(s("stance-chat",n=>{j(n,e)?.toMessage(n,{create:!0})}),s("stance-toggle",n=>{let{effectUuid:o}=n.currentTarget.closest(".action").dataset;game.modules.get("pf2e-stances")?.api.toggleStance(e,o)}),s("action-chat",n=>{j(n,e)?.toMessage(n,{create:!0})}),s("hero-action-chat",async n=>{await game.modules.get("pf2e-hero-actions")?.api.sendActionToChat(e,a(n))}),s("draw-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.drawHeroActions(e)}),s("use-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.useHeroAction(e,a(n))}),s("discard-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.discardHeroActions(e,a(n))}),s("trade-hero-action",async n=>{game.modules.get("pf2e-hero-actions")?.api.tradeHeroAction(e)}),s("strike-attack",n=>{let{index:o,altUsage:l}=n.currentTarget.dataset;i(n)?.variants[o].roll({event:n,altUsage:l})}),s(["strike-damage","strike-critical"],n=>{let{action:o}=n.currentTarget.dataset;i(n)?.[o==="strike-damage"?"damage":"critical"]({event:n})}).tooltipster(bt),s(["toggle-roll-option","set-suboption"],n=>{let o=n.currentTarget.closest(".toggle"),{domain:l,option:r,itemId:u}=o.dataset,f=o.querySelector("select")?.value??null;e.toggleRollOption(l,r,u??null,o.querySelector("input").checked,f)}),s("strike-auxiliary",n=>{if(n.currentTarget!==n.target)return;let o=i(n);if(!o)return;let{index:l}=n.currentTarget.dataset,r=n.currentTarget.querySelector("select")?.value??null;o.auxiliaryActions?.[l]?.execute({selection:r})}),s("toggle-versatile",n=>{let o=i(n)?.item;if(!o)return;let l=n.currentTarget,{value:r}=l.dataset,u=o?.system.damage.damageType??null,f=l.classList.contains("selected")||r===u?null:r;nt({trait:"versatile",weapon:o,selection:f})}).tooltipster(bt),s("strike-ammo",async n=>{let o=i(n)?.item;if(!o)return;let l=e.items.get(n.currentTarget.value);await o.update({system:{selectedAmmoId:l?.id??null}})},"change"))}c(vt,"addActionsListeners");function wt(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:void 0}c(wt,"getStancesModuleApi");function mi(t){return game.modules.get("pf2e-hero-actions")?.api.getHeroActionDetails(t)}c(mi,"getHeroActionDescription");function gi(t){let e=wt()?.getActionsUUIDS()??new Set,s=new Set([...e,...pt,...Object.values(Re)]),i=t.itemTypes.action.filter(n=>!s.has(n.sourceId)),a=t.itemTypes.feat.filter(n=>n.actionCost&&!e.has(n.sourceId));return[...i,...a].filter(n=>{let o=n.system.traits.value;return!o.includes("downtime")&&!o.includes("exploration")}).map(n=>{let o=n.actionCost;return{id:n.id,type:o?.type??"free",cost:o,name:n.name}})}c(gi,"getCharacterActions");function hi(t){return t.itemTypes.action.map(e=>{let s=e.actionCost,i=s?.type??"passive",a=i==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(n=>n.key==="Aura"));return{id:e.id,type:i,cost:s,name:e.name,hasDeathNote:e.system.deathNote,hasAura:a}})}c(hi,"getNpcActions");async function It(t){let{system:e}=t,{details:s,traits:i,attributes:a}=e,{stealth:n}=a,{description:o,disable:l,routine:r,reset:u,isComplex:f}=s,d=t.getRollData(),p=t.isOwner,m=c(async g=>X(g,t,{isOwner:p,rollData:d}),"enrich");return{contentData:{description:await m(o),disable:await m(l),routine:await m(r),reset:await m(u),isComplex:f,rarity:{value:i.rarity,label:CONFIG.PF2E.rarityTraits[i.rarity]},traits:i.value.map(g=>CONFIG.PF2E.hazardTraits[g]),stealth:B(n.value)},style:{["--max-width"]:b("hazard-width")+"em"}}}c(It,"getHazardData");function Ct(t,e){t.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let i=$(s.currentTarget).closest(".action");_(i,e)}),ge(t,e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",s=>{s.preventDefault(),e.initiative.roll({event:s})})}c(Ct,"addHazardListeners");var St=new Set(["arcane","divine","occult","primal"]);function yi(t,e){return t.has(e)}c(yi,"setHasElement");function bi(t){return t.traits.has("cursed")?"unique":t.rarity}c(bi,"getDcRarity");function ki(t){let e=t.system.traits.value;return new Set(e.filter(s=>yi(St,s)))}c(ki,"getMagicTraditions");function vi(t,e,s){let i={occult:e,primal:e,divine:e,arcane:e},a=ki(t);for(let n of St)a.size>0&&!a.has(n)&&(i[n]=e+s);return{arcana:i.arcane,nature:i.primal,religion:i.divine,occultism:i.occult}}c(vi,"getIdentifyMagicDCs");function wi(t,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:s}){let i=fe(t.level,{proficiencyWithoutLevel:e}),a=bi(t),n=pe(i,a);return t.isMagical?vi(t,n,s):t.isAlchemical?{crafting:n}:{dc:n}}c(wi,"getItemIdentificationDCs");function Ii(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}c(Ii,"objectHasKey");var re=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),i=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",a=wi(e,{proficiencyWithoutLevel:i,notMatchingTraditionModifier:s});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:a}}activateListeners(e){e.find("button.update-identification").on("click",s=>{let i=$(s.delegateTarget);this.submit({updateData:{status:i.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let s=this.item,i=s.system.identification.unidentified.img,a=s.system.identification.unidentified.name,n=s.system.identification.identified.name,o=$("div#identify-item").find("tr").toArray().flatMap(u=>{let f=u.dataset.skill,d=Number(u.dataset.dc);if(!(Number.isInteger(d)&&Ii(CONFIG.PF2E.skillList,f)))return[];let p=game.i18n.localize(CONFIG.PF2E.skillList[f]);return{slug:f,name:p,dc:d}}),l=s.isMagical?"action:identify-magic":s.isAlchemical?"action:identify-alchemy":null,r=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:i,itemName:a,identifiedName:n,rollOptions:["concentrate","exploration","secret",l].filter(Boolean),skills:o});await CONFIG.ChatMessage.documentClass.create({user:game.user.id,content:r})})}async _updateObject(e,s){let i=s.status;i==="identified"&&await this.item.setIdentificationStatus(i)}};c(re,"IdentifyItemPopup");var Te={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function Tt(t,e,s){let{contents:i,coins:a,totalWealth:n,bulk:o,invested:l}=t.inventory,r=b("containers")||(W(t,`containers.${game.user.id}`)??[]),u={},f={};for(let d of i){if(!Te[d.type])continue;let p=d.system.containerId;d.type!=="backpack"&&p&&(r===!0||r.includes(p))?(u[p]??=[],u[p].push(d)):(f[d.type]??=[],f[d.type].push(d))}if(f=Object.entries(f).map(([d,p])=>{if(p.sort((m,g)=>m.name.localeCompare(g.name)),d==="backpack")for(let m=p.length-1;m>=0;m--){let g=p[m],h=u[g.id]?.filter(v=>N(v.name,s));if(!h?.length){N(g.name,s)||p.splice(m,1);continue}h.sort((v,D)=>v.name.localeCompare(D.name)),p.splice(m+1,0,...h)}else p=p.filter(m=>N(m.name,s));return{type:d,items:p,label:Te[d].label}}).filter(d=>d.items.length).sort((d,p)=>Te[d.type].order-Te[p.type].order),f.length)return{doubled:f.length>1&&b("items-columns"),contentData:{canCarry:!!t.adjustCarryType,categories:f,bulk:o,containers:r,i18n:d=>w(`items.${d}`),invested:l?`${game.i18n.localize("PF2E.InvestedLabel")}: ${l.value} / ${l.max}`:"",wealth:{coins:a.goldValue,total:n.goldValue}}}}c(Tt,"getItemsData");function Et(t,e,s){let i=t.find(".item");G(i),i.find("[data-action=item-description]").on("click",async a=>{a.preventDefault();let n=$(a.currentTarget).closest(".item");await _(n,e)}),i.find("[data-action=toggle-contains-items]").on("click",async a=>{a.preventDefault();let n=`containers.${game.user.id}`,o=a.currentTarget.closest(".item").dataset.itemId,l=W(e,n)?.slice()??[],r=l.indexOf(o);r===-1?l.push(o):l.splice(r,1),await Y(e,n,l)}),e.isOwner&&(i.find("[data-action=item-chat]").on("click",async a=>{j(a,e)?.toMessage(a,{create:!0})}),i.on("dragstart",a=>{let n=a.target.closest(".item"),{itemType:o,uuid:l}=n.dataset,r=new Image;r.src=n.querySelector(".item-img img").src,r.style.width="32px",r.style.height="32px",r.style.borderRadius="4px",r.style.position="absolute",r.style.left="-1000px",document.body.append(r),a.originalEvent.dataTransfer.setDragImage(r,16,16),a.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:o,uuid:l})),n.addEventListener("dragend",()=>r.remove(),{once:!0})}),t.find(".quantity input").on("change",async a=>{await j(a,e)?.update({"system.quantity":a.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",a=>{a.preventDefault();let{itemId:n}=a.currentTarget.closest(".item").dataset;e.toggleInvested(n)}),t.find("[data-action=repair-item]").on("click",a=>{a.preventDefault();let n=j(a,e);n&&game.pf2e.actions.repair({item:n,actors:[e],tokens:[s]})}),t.find("[data-action=toggle-identified]").on("click",a=>{a.preventDefault();let n=j(a,e);n&&(n.isIdentified?n.setIdentificationStatus("unidentified"):new re(n).render(!0))}),t.find("[data-action=edit-item]").on("click",a=>{a.preventDefault(),it(a,e)}),t.find("[data-action=delete-item]").on("click",a=>{a.preventDefault(),st(a,e)}),t.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(a,{event:n,origin:o}){let l=j(n,e);if(!l)return;let r=document.createElement("div");r.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:l});let u=r.children[1],f=$(u);if(f.find("[data-carry-type]").on("click",async d=>{let p=l.system.equipped,{carryType:m,handsHeld:g=0,inSlot:h}=$(d.currentTarget).data();h=h==="true",(m!==p.carryType||h!==p.inSlot||m==="held"&&g!==p.handsHeld)&&await e.adjustCarryType(l,{carryType:m,handsHeld:g,inSlot:h})}),l.type!=="backpack"){let d=e.itemTypes.backpack.filter(p=>p.isIdentified);if(d.length){let p="";for(let m of d)p+='<li><a class="item-control item-location-option',m===l.container&&(p+=" selected"),p+=`" data-action="send-to-container" data-container-id="${m.id}">`,p+=`<i class="fas fa-box"></i>${m.name}</a></li>`;f.find("ul").append(p),f.find("[data-action=send-to-container]").on("click",async m=>{let{containerId:g}=m.currentTarget.dataset;e.items.has(g)&&(a.close(),await l.update({"system.containerId":g}))})}}a.content(u)}}))}c(Et,"addItemsListeners");async function Dt(t,e,s){let i=t.system.resources.focus??{value:0,max:0},a=t.spellcasting.regular,n=b("tradition"),o=[],l=[],r=!1;for(let d of a){let p=d.id,m=n&&d.statistic.label[0],g=await d.getSheetData(),h=g.isFocusPool,v=d.system?.prepared?.value==="charge",D=getProperty(d,"flags.pf2e-staves.staveID")!==void 0,E={value:getProperty(d,"flags.pf2e-staves.charges")??0};for(let S of g.levels){if(!S.active.length||S.uses?.max===0)continue;let z=[],R=S.isCantrip,M=S.active.filter(H=>H&&H.uses?.max!==0);for(let H=0;H<M.length;H++){let{spell:T,expended:q,virtual:P,uses:ie,castLevel:se}=M[H];N(T.name,s)&&z.push({name:T.name,img:T.img,tradition:m,castLevel:se??T.level,slotId:H,entryId:p,itemId:T.id,inputId:g.isInnate?T.id:g.id,inputPath:v?"flags.pf2e-staves.charges":g.isInnate?"system.location.uses.value":`system.slots.slot${S.level}.value`,isCharge:v,isVirtual:P,isInnate:g.isInnate,isCantrip:R,isFocus:h,isPrepared:g.isPrepared,isSpontaneous:g.isSpontaneous||g.isFlexible,slotLevel:S.level,uses:ie??(v?E:S.uses),expended:q??(h&&!R?i.value<=0:!1),action:T.system.time.value,type:v?D?`${L}.spells.staff`:`${L}.spells.charges`:g.isInnate?"PF2E.PreparationTypeInnate":g.isSpontaneous?"PF2E.PreparationTypeSpontaneous":g.isFlexible?"PF2E.SpellFlexibleLabel":h?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:v?0:g.isPrepared?1:h?2:g.isInnate?3:g.isSpontaneous?4:5})}if(z.length){if(h)if(R)r=!0;else{l.push(...z);continue}o[S.level]??=[],o[S.level].push(...z)}}}if(o.length){let d=b("spells")?(p,m)=>p.order===m.order?p.name.localeCompare(m.name):p.order-m.order:(p,m)=>p.name.localeCompare(m.name);o.forEach(p=>p.sort(d))}l.length&&(l.sort((d,p)=>d.name.localeCompare(p.name)),o[12]=l,r=!1);let f=(await t.spellcasting.ritual?.getSheetData())?.levels.flatMap((d,p)=>d.active.map(({spell:m})=>{if(N(m.name,s))return{name:m.name,img:m.img,slotId:p,itemId:m.id,level:m.level,time:m.system.time.value}}).filter(Boolean));if(o.length||f?.length){let d=xt(t),p=o.length+ +((f?.length??0)>0);return{contentData:{spells:o,rituals:f,focusPool:i,hasFocusCantrips:r,attackMod:At(d)?d[0].mod:null},doubled:p>1&&b("spells-columns")}}}c(Dt,"getSpellsData");function xt(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:s,id:i})=>({name:s,id:i,mod:B(e.mod),statistic:e}))}c(xt,"getSpellAttacks");function At(t){return new Set(t.map(({mod:e})=>e)).size===1}c(At,"hasSingleSpellAttack");function Lt(t,e,s){G(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async i=>{i.preventDefault();let a=$(i.currentTarget).closest(".spell");_(a,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async i=>{i.preventDefault();let a=xt(e);if(!a.length)return;let n;if(At(a))n=a[0].statistic;else{let r=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:w("spells.attacks.ok"),callback:u=>u.find("input:checked").val()}},title:w("spells.attacks.title"),content:await renderTemplate(O("dialogs/spell-attacks"),{attacks:a}),close:()=>null});r&&(n=e.items.get(r)?.statistic)}let o=me(i),{map:l}=i.currentTarget.dataset;l&&(o.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(l)})]),n?.check.roll(o)}),t.find("[data-action=spell-chat]").on("click",async i=>{i.preventDefault(),j(i,e)?.toMessage(i,{create:!0})}),t.find("[data-action=toggle-pips]").on("click contextmenu",async i=>{i.preventDefault();let a=i.type==="click"?1:-1,n=(e.system.resources.focus?.value??0)+a;await e.update({"system.resources.focus.value":n})}),t.find("[data-action=toggle-prepared]").on("click",i=>{i.preventDefault();let{slotLevel:a,slotId:n,entryId:o,expended:l}=$(i.currentTarget).closest(".spell").data();e.spellcasting.collections.get(o)?.setSlotExpendedState(a??0,n??0,l!==!0)}),t.find("[data-action=cast-spell]").on("click",i=>{i.preventDefault();let{slotLevel:a,slotId:n,entryId:o,itemId:l}=$(i.currentTarget).closest(".spell").data(),r=e.spellcasting.collections.get(o,{strict:!0});if(!r)return;let u=r.get(l,{strict:!0});u&&r.entry.cast(u,{slot:n,level:a})}),t.find("[data-input-path]").on("change",async i=>{let{inputPath:a,entryId:n}=$(i.currentTarget).data(),o=i.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:n,[a]:o}])}))}c(Lt,"addSpellsListeners");var Ci="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",Ft={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},le={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},Si=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],Ti={actions:{getData:kt,addListeners:vt},items:{getData:Tt,addListeners:Et},spells:{getData:Dt,addListeners:Lt},skills:{getData:ft,addListeners:mt},extras:{getData:ht,addListeners:yt},hazard:{getData:It,addListeners:Ct}},ce={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Ei={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},ue=class extends Application{#e=null;#d=null;#i=null;#a=null;#c=!1;#o=null;#u=[!1,!1,!1];#t=!1;#s=!1;#n=!1;#p;#r;#f;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,s)=>{s?this.#h(e):this.#y(e)},this.#r=e=>{let s=e.button;if(![0,2].includes(s))return;if(e.type==="mouseup"){this.#u[s]=!1;return}this.#u[s]=!0;let i=e.target,a=this.element[0];if(a){let n=a.querySelector(".popup");if(n&&!n.contains(i))if(!a.querySelector(".sidebar"))this.forceClose();else return n.remove();i.closest("canvas")&&this.forceClose();return}else this.#g();this.unlock(!0)},this.#f=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#f),Hooks.on("canvasPan",this.forceClose)}setToken(e,s){if(e!==this.#e){this.#e&&delete this.#e.actor.apps[this.appId],this.#e=e;let i=e?.actor;i&&(i.apps[this.appId]=this)}this.#n=s??this.#m(e)}setHolding(e){let s=b("use-holding");if(s!=="none"&&(this.#c=e,!(this.#s||this.#t)))if(e){if(!this.#i)return;let i=this.#m(this.#i);if(s==="half"&&!game.user.isGM&&!i){this.#g(),this.render();return}this.setToken(this.#i,i),this.render()}else s==="all"?this.close():game.user.isGM?(this.setToken(this.#i),this.render()):this.#n&&this.close()}#m(e){let s=e?.actor;if(!s)return!1;let i,a=s.system.details.alliance==="party";return game.user.isGM&&b("use-holding")==="half"&&!this.#c||s.isOfType("familiar")&&!s.master?i=!1:i=e.isOwner||b("observer")&&(e.observer||a&&b("party")),i}#h(e){if($(window.document).find(":hover").filter("#combat-popout, #sidebar, #mini-tracker, [id^=pf2e-perception]").length)return;let s=e.actor;if(!s||s.isOfType("loot","party")||(this.#i=e,e!==this.#d&&!this.#t&&this.close(),this.mousedown||this.#t||this.#s||e===this.#e))return;let i=b("use-holding"),a=this.#m(e);i!=="none"&&!this.#c&&(i==="all"||a)||(this.#b(!0),this.setToken(e,a),i==="none"||!this.#c?this.renderWithDelay():this.render())}#y(e){this.#i=null,!(this.mousedown||this.#t||this.#s)&&(this.#o=setTimeout(()=>{this.#o=null,!(this.#s||this.#t)&&this.close()},10))}renderWithDelay(){let e=b("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#b(e){this.#o!==null&&(clearTimeout(this.#o),this.#o=null,e&&this.close())}#g(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#f),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:O("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return this.actor?.itemTypes.effect.find(e=>e.flags.core?.sourceId===Ci)}get isCharacter(){return this.actor?.isOfType("character")}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,s=this.#e?.actor;if(!s)return{};let i=null,a=b("saves"),n=b("others"),o=this.isCharacter,{attributes:l}=s,{hp:r,sp:u={max:0,value:0},ac:f}=l,d=game.settings.get("pf2e","staminaVariant"),p=b("distance"),m=b("scale");if(p==="all"||p==="self"&&this.#n){let k=b("unit").split(","),A=Number(k[0]?.trim())||1,F=k[1]?.trim()||game.system.gridUnits,x=Number(k[2]?.trim())||0,U=canvas.tokens.controlled,J=!1,Q=U.length===1?U[0]:null;(!Q||Q===e)&&(Q=ve(),J=!0),Q&&Q!==e&&(i={unit:F,icon:J?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(Q)*A).toFixed(x)})}let g;if(!this.#n||b("see-status")){let k=b("status").split(",").map(A=>A.trim()).filter(Boolean);if(k.length&&r.max){let A=r.max+(d?u.max:0),F=r.value+(d?u.value:0),x=Math.clamped(F/A,0,1),U=(()=>{let J=k.length;return b("last-status")?x===1?J:Math.ceil(x*(J-1)):Math.ceil(x*J)})();g={hue:x*x*122+3,value:U===0?game.i18n.localize("EFFECT.StatusDead"):k.at(U-1)}}}let h={status:g,distance:i,fontSize:m,tokenId:e.id,type:s.isOfType("creature")?"creature":s.type};if(!this.#n||s.isOfType("familiar")&&!s.master)return h;let{level:v,saves:D,isOwner:E,system:S,itemTypes:z}=s,{resistances:R,weaknesses:M,immunities:H}=l;h={...h,isOwner:E,isObserver:this.#n,name:e.document.name,hp:r,ac:f.value,level:v,hasActions:z.action.length||S.actions?.filter(k=>k.visible!==!1).length};let T=b("ranks");function q(k,A,F){let x=k.slug,U=A==="bonus"?B(k.mod):k.dc.value;return{slug:x,value:U,label:F[x].label,icon:F[x].icon,rank:T&&he[k.rank]}}c(q,"getStatistic");function P(k,A){if(!k.length)return"";let F=k.map(x=>Ae(x.label.replace("-"," ").titleCase())).join("");return A?`<li>${game.i18n.localize(A)}<ul>`+F+"</ul></li>":F}if(c(P,"toIWR"),s.isOfType("hazard")){let{hardness:k,emitsSound:A,stealth:F}=l;return{...h,hardness:k,emitsSound:A.toString().capitalize(),immunities:P(H),weaknesses:P(M),resistances:P(R),stealth:{value:F.value,details:await X(F.details,s)},saves:a!=="none"&&["fortitude","reflex","will"].map(x=>{let U=D[x];return U?q(U,a,ce):{slug:x,label:ce[x].label,icon:ce[x].icon}})}}if(h={...h,sidebarTitles:{actions:`${L}.actions.title`,items:`${L}.items.title`,spells:`${L}.spells.title`,skills:`${L}.skills.title`,extras:`${L}.extras.title`},hasItems:s.inventory.size},s.isOfType("vehicle")){let{hardness:k,collisionDC:A,collisionDamage:F}=l,{details:x}=S,{crew:U,passengers:J,pilotingCheck:Q,speed:Wt}=x;return{...h,hardness:k,crew:U,passengers:J,pilotingCheck:Q,speed:Wt,collisionDC:A.value,collisionDamage:F.value,immunities:P(H),weaknesses:P(M),resistances:P(R),fortitude:q(D.fortitude,a,ce)}}let ie=b("show-death"),{heroPoints:se,_source:Ht}=s,{traits:xe}=S,{wounded:Ue,dying:ze,shield:Ut,resolve:zt,speed:de,adjustment:jt}=l;se&&game.modules.get("xdy-pf2e-workbench")?.active&&(se.max=game.settings.get("xdy-pf2e-workbench","maxHeroPoints")||3);function Ae(k){return`<li>${k.trim()}</li>`}c(Ae,"toInfo");function _t(k,A){return k.localeCompare(A)}c(_t,"sort");let Bt=xe?.languages?.value.map(k=>game.i18n.localize(CONFIG.PF2E.languages[k])).filter(Boolean).sort(_t).map(Ae).join(""),Gt=o?xe.senses.map(k=>k.label):xe.senses.value?.split(","),ne=Si.map(({type:k,icon:A},F)=>({index:F,icon:A,label:game.i18n.localize(CONFIG.PF2E.speedTypes[k]??"PF2E.SpeedTypesLand"),value:(F===0?de.total:de.otherSpeeds.find(x=>x.type===k)?.total)||0})),je=W(s,`speeds.selected.${game.user.id}`),Kt=(()=>{let k=0;if(je!==void 0)k=je;else if(b("force-speed")||ne[0].value===0){let A={index:0,value:ne[0].value};k=ne.reduce((F,{value:x},U)=>x>F.value?{index:U,value:x}:F,A).index}return ne.splice(k,1)[0]})(),_e=ne.map(({value:k,label:A,index:F})=>`<li><a data-index="${F}">${A}: ${k}</a></li>`).join("");de.details&&(_e+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${de.details}</li>`);let Be=Ht.system.details?.alliance,Le=Be===null?"neutral":Be??"default",Ge=s.hasPlayerOwner?"party":"opposition",qt=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(le[Ge].label)})},{value:"opposition",label:game.i18n.localize(le.opposition.label)},{value:"party",label:game.i18n.localize(le.party.label)},{value:"neutral",label:game.i18n.localize(le.neutral.label)}].filter(({value:k})=>k!==Le).map(({value:k,label:A})=>`<li><a data-alliance="${k}">${A}</a></li>`).join("");return{...h,sp:d?u:{max:0},hero:se,dying:ze,wounded:Ue,shield:Ut,resolve:zt,adjustment:jt,alliance:le[Le==="default"?Ge:Le],alliances:qt,isCharacter:o,showDeathLine:o&&(ie==="always"||ze.value||Ue.value),digitalPips:b("pips"),hasCover:this.hasCover,saves:a!=="none"&&["fortitude","reflex","will"].map(k=>q(D[k],a,ce)),others:n!=="none"&&["perception","stealth","athletics"].map(k=>q(s.getStatistic(k),n,Ei)),speeds:{main:Kt,others:_e},iwr:P(H,"PF2E.ImmunitiesLabel")+P(M,"PF2E.WeaknessesLabel")+P(R,"PF2E.ResistancesLabel"),senses:Gt?.filter(Boolean).map(Ae).join(""),languages:Bt,hasSpells:s.spellcasting.some(k=>k.category!=="items"),hasNotes:!o&&(S.details.publicNotes||S.details.privateNotes&&E)}}close(e={}){this.setToken(null),this.unlock(!0),this.#s=!1,this.#g();let s=Application.RENDER_STATES;if(!e.force&&![s.RENDERED,s.ERROR].includes(this._state))return;this._state=s.CLOSING;let i=this.element;if(!i)return this._state=s.CLOSED;i.css({minHeight:0});for(let a of this.constructor._getInheritanceChain())Hooks.call(`close${a.name}`,this,i);i.remove(),this._element=null,this._state=s.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,s={}){let i,a,n,o,l;if(this.#d===this.#e){let r=this.sidebar[0];if(r){i=r.dataset.type,a=r.scrollTop;let u=r.querySelector(".sidebar-header");u.classList.contains("show")&&(l=u.querySelector(" input").value.trim())}n=this.popup[0],n&&(o=n.scrollTop)}if(await super._render(e,s),ui.windows[this.appId]=this,i){let r=await this.#l(i,l);a>0&&r.scrollTop(a)}n&&(this.element.append(n),o>0&&(n.scrollTop=o)),this.#d=this.#e,this.inner.length&&b("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let s=this.element[0],i=e.worldTransform.a,a=s.getBoundingClientRect(),n=canvas.clientCoordinatesFromCanvas(e.document._source),o={x:n.x,y:n.y,width:e.hitArea.width*i,height:e.hitArea.height*i,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},l,r=this.#n?Ft[b("position")].slice():Ft[b("small-position")].slice();for(;r.length&&!l;){let u=r.shift();u==="left"?(l={x:o.x-a.width,y:He(a,o)},l.x<0&&(l=void 0)):u==="right"?(l={x:o.right,y:He(a,o)},l.x+a.width>window.innerWidth&&(l=void 0)):u==="top"?(l={x:Ot(a,o),y:o.y-a.height},l.y<0&&(l=void 0)):u==="bottom"&&(l={x:Ot(a,o),y:o.bottom},l.y+a.height>window.innerHeight&&(l=void 0))}return l&&(s.style.left=`${l.x}px`,s.style.top=`${l.y}px`),l}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||b("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let s=this.#e,i=s?.actor;if(!i)return;let a=s.isOwner,n=CONFIG.ChatMessage.documentClass;b("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",r=>{r.preventDefault();let{publicNotes:u,privateNotes:f}=i.system.details;if(!u&&(!f||!a))return;let d="";u&&(d+=`<div class="notes-header">${game.i18n.localize("PF2E.NPC.PublicNotes")}</div>`,d+=`<div class="notes-content">${u}</div>`),f&&a&&(d+=`<div class="notes-header">${game.i18n.localize("PF2E.NPC.PrivateNotes")}</div>`,d+=`<div class="notes-content">${f}</div>`),Z(`${i.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,d,i)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(b("autolock")==="hover"&&this.lock(),this.#s=!0)}),e.on("mouseleave",()=>{this.#s=!1,!(this.#t||this.#i)&&this.close()}),e.on("dragover",()=>{s.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let o=e.find("[data-action=show-info]");o.tooltipster({position:["top","bottom","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click"}),o.filter(".stealth").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(r,{origin:u,tooltip:f})=>{this.lock(),$(f).find(".content-link").on("click",()=>setTimeout(()=>r.close(),10))}).tooltipster("option","functionAfter",()=>this.unlock()),(a?o.filter(":not(.speeds):not(.stealth)"):o).on("mouseleave",r=>{$(r.currentTarget).tooltipster("hide")}),e.find("[data-action=open-sidebar]").on("click",this.#l.bind(this)),a&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",r=>{r.preventDefault();let u=r.type==="click"?"elite":"weak";i.applyAdjustment(i.system.attributes.adjustment===u?null:u)}),e.find("[data-action=toggle-alliance]").tooltipster({position:["bottom","top","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click",interactive:!0,functionReady:(r,{origin:u,tooltip:f})=>{this.lock(),f.querySelectorAll("[data-alliance]").forEach(d=>{d.addEventListener("click",async p=>{p.preventDefault();let m=d.dataset.alliance;m==="default"?i.update({"system.details.-=alliance":null}):i.update({"system.details.alliance":m==="neutral"?null:m})})})},functionAfter:()=>this.unlock()}),e.find("[data-action=collision-dc]").on("click",r=>{r.preventDefault();let u=i.system.attributes.collisionDC.value||15;n.create({content:`@Check[type:reflex|dc:${u}]`,speaker:n.getSpeaker({actor:i})})}),e.find("[data-action=collision-damage]").on("click",async r=>{r.preventDefault();let u=(i.system.attributes.collisionDamage.value||"1d6").trim();isNaN(Number(u.at(-1)))||(u+="[bludgeoning]");let f=CONFIG.Dice.rolls.find(p=>p.name==="DamageRoll"),d=await new f(u).evaluate({async:!0});n.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:n.getSpeaker({actor:i}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[d]})}),e.find("input").on("change",async r=>{let u=r.currentTarget,f=u.valueAsNumber,d=u.name;u.blur(),d!=="shield.value"?await i.update({[d]:f}):await i.heldShield.update({"system.hp.value":f})}),e.find("[data-action=toggle-hero]").on("click contextmenu",r=>{r.preventDefault();let{max:u,value:f}=i.heroPoints;game.modules.get("xdy-pf2e-workbench")?.active&&(u=game.settings.get("xdy-pf2e-workbench","maxHeroPoints")||3);let d=r.type==="click"?1:-1,p=Math.clamped(f+d,0,u);p!==f&&i.update({"system.resources.heroPoints.value":p})}),e.find("[data-action=raise-shield]").on("click",r=>{r.preventDefault(),game.pf2e.actions.raiseAShield({actors:[i],tokens:[s]})}),e.find("[data-action=take-cover]").on("click",async r=>{r.preventDefault(),game.pf2e.actions.get("take-cover").use({actors:[i],tokens:[s]})}),e.find("[data-action=roll-save]").on("click",r=>{r.preventDefault();let u=r.currentTarget.dataset.save;i.saves[u].roll({event:r})}),e.find("[data-action=roll-other]").on("click",r=>{r.preventDefault();let u=r.currentTarget.dataset.slug;if(u!=="athletics"){let{ctrlKey:f,metaKey:d,shiftKey:p}=r;r=new MouseEvent("click",{ctrlKey:!f,metaKey:d,shiftKey:p})}i.getStatistic(u)?.roll({event:r})}),e.find("[data-action=recovery-check]").on("click",r=>{r.preventDefault(),i.rollRecovery(r)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",r=>{r.preventDefault();let u=r.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",f=i.system.attributes[u]?.max;f&&(r.type==="click"?i.increaseCondition(u,{max:f}):i.decreaseCondition(u))}),e.find("[data-action=use-resolve]").on("click",r=>{r.preventDefault(),Ke(i)}),o.filter(".speeds").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(r,{origin:u,tooltip:f})=>{this.lock(),f.querySelectorAll("[data-index]").forEach(d=>{d.addEventListener("click",async p=>{p.preventDefault(),await Y(i,`speeds.selected.${game.user.id}`,Number(d.dataset.index))})})}).tooltipster("option","functionAfter",()=>this.unlock()))}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#l(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#l(e,s){e=typeof e=="string"?e:e.currentTarget.dataset.type;let i=this.element,a=this.sidebar,n=a[0]?.dataset.type;if(a.remove(),i.find("[data-action=open-sidebar]").removeClass("active"),n===e&&s===void 0){this.unlock();return}let o=this.#e,l=o.actor,r=s!==void 0||b("filter"),{getData:u,addListeners:f}=Ti[e],d=await u(l,o,s?.toLowerCase())??{};if(!d.contentData&&!r)return ui.notifications.warn(w(`${e}.empty`,{name:this.#e.name}));let p={...d.contentData??{},isGM:game.user.isGM,isCharacter:this.isCharacter,isOwner:l.isOwner};this.lock(),i.find(`[data-action=open-sidebar][data-type=${e}]`).addClass("active"),i=i[0];let m=d.classes??[];m.push(e),b("scrollbar")||m.push("no-scrollbar"),d.doubled&&m.push("doubled");let g=d.style??{};g["--max-height"]=b("height").trim()||"100%";let h=document.createElement("div");h.innerHTML=await renderTemplate(O("sidebar"),{classes:m.join(" "),style:Object.entries(g).map(([M,H])=>`${M}: ${H}`).join("; "),type:e,filter:s,filterLabel:w("filter"),showFilter:r,content:(await renderTemplate(O(`sidebars/${e}`),p)).trim()}),a=h.firstElementChild,i.append(a);let v=a.getBoundingClientRect(),D=i.getBoundingClientRect(),E;b("position")==="left"?(E=D.x-v.width,E<0&&(E=D.right)):(E=D.right,E+v.width>window.innerWidth&&(E=D.x-v.width));let z=parseInt(window.getComputedStyle(i).padding),R=He(v,D,z);return a.style.left=`${E}px`,a.style.top=`${R}px`,a=$(a),a.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",M=>{M.preventDefault(),a.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#l(e,"")}),a.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",M=>{M.key==="Enter"&&this.#l(e,M.currentTarget.value.trim())}),f(a,l,o),Hooks.callAll("renderHUDSidebar",e,a,this),a}};c(ue,"HUD");function He(t,e,s=0){let i=e.y+e.height/2-t.height/2;return i+t.height>window.innerHeight&&(i=window.innerHeight-t.height-s),i<0&&(i=s),i}c(He,"postionFromTargetY");function Ot(t,e){let s=e.x+e.width/2-t.width/2;return s+t.width>window.innerWidth&&(y=window.innerWidth-t.width),s<0&&(s=0),s}c(Ot,"postionFromTargetX");var L="pf2e-token-hud",ee=null;function V(t=!1){return t?ee?.element:ee}c(V,"getHud");function Ee(t){t&&!ee?ee=new ue:!t&&ee&&(ee.delete(),ee=null)}c(Ee,"enableModule");function b(t){return game.settings.get(L,t)}c(b,"getSetting");function w(...t){let e=t.at(-1),s=typeof e=="object",i=s?t.slice(0,-1):t;return i.unshift(L),game.i18n[s?"format":"localize"](i.join("."),e)}c(w,"localize");function Me(t,e){return t.itemTypes.feat.some(s=>s.sourceId===e)}c(Me,"hasFeat");function O(t){return`modules/${L}/templates/${t}.hbs`}c(O,"templatePath");function B(t){return t>=0?`+${t}`:t}c(B,"modifier");function W(t,e){return t.getFlag(L,e)}c(W,"getFlag");function Y(t,e,s){return t.setFlag(L,e,s)}c(Y,"setFlag");async function X(t,e,{isOwner:s=e.isOwner,rollData:i=e.getRollData()}={}){return t=t?.trim(),t?await TextEditor.enrichHTML(t,{async:!0,secrets:s,rollData:i}):""}c(X,"enrichHTML");function $t(){Mt("hold",{onDown:()=>{b("use-holding")!=="none"&&V()?.setHolding(!0)},onUp:()=>{V()?.setHolding(!1)}}),Mt("filter",{onUp:()=>{V()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}c($t,"registerKeybindings");function Pt(t,e){return`${L}.keybinds.${t}.${e}`}c(Pt,"path");function Mt(t,e={}){game.keybindings.register(L,t,{name:Pt(t,"name"),hint:Pt(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}c(Mt,"register");function Nt(){let t=game.data.users.find(s=>s._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(s=>w(`settings.status.statuses.${s}`)).join(", ");I("status",String,e,{scope:"world"}),I("last-status",Boolean,!1,{scope:"world"}),I("party",Boolean,!1,{scope:"world"}),I("enabled",Boolean,!0,{onChange:Ee}),I("position",String,"right",{choices:{left:C("position","choices.left"),right:C("position","choices.right"),top:C("position","choices.top"),bottom:C("position","choices.bottom")}}),I("small-position",String,"top",{choices:{left:C("position","choices.left"),right:C("position","choices.right"),top:C("position","choices.top"),bottom:C("position","choices.bottom")}}),I("delay",Number,250,{range:{min:0,max:2e3,step:50}}),I("scale",Number,14,{range:{min:10,max:30,step:1}}),I("use-holding",String,"none",{hint:C("use-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:C("use-holding","choices.none"),half:C("use-holding",t?"choices.gm.half":"choices.player.half"),all:C("use-holding",t?"choices.gm.all":"choices.player.all")}}),I("autolock",String,"none",{choices:{none:C("autolock","choices.none"),hover:C("autolock","choices.hover"),render:C("autolock","choices.render")}}),I("observer",Boolean,!0),I("see-status",Boolean,!1),I("saves",String,"bonus",{choices:{none:C("saves","choices.none"),bonus:C("saves","choices.bonus"),dc:C("saves","choices.dc")}}),I("others",String,"none",{choices:{none:C("saves","choices.none"),bonus:C("saves","choices.bonus"),dc:C("saves","choices.dc")}}),I("ranks",Boolean,!1),I("show-death",String,"always",{choices:{none:C("show-death","choices.none"),always:C("show-death","choices.always"),only:C("show-death","choices.only")}}),I("force-speed",Boolean,!1),I("tooltips",Boolean,!1),I("pips",Boolean,!1),I("distance",String,"all",{choices:{none:C("distance","choices.none"),self:C("distance","choices.self"),all:C("distance","choices.all")}}),I("unit",String,""),I("height",String,""),I("filter",Boolean,!1),I("scrollbar",Boolean,!0),I("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),I("actions-columns",Boolean,!1),I("items-columns",Boolean,!1),I("spells-columns",Boolean,!1),I("skills-columns",Boolean,!1),I("actions",String,"split",{choices:{name:C("actions","choices.name"),type:C("actions","choices.type"),split:C("actions","choices.split")}}),I("actions-colors",Boolean,!0),I("containers",Boolean,!1),I("spells",Boolean,!1),I("tradition",Boolean,!1),I("untrained",Boolean,!0)}c(Nt,"registerSettings");function Rt(t,e){let s=e.find(`.tab[data-tab=${L}]`);function i(a,n,o="h3"){let l=w(`menu.${n}`);s.find(`[name="${L}.${a}"]`).closest(".form-group").before(`<${o}>${l}</${o}>`)}c(i,"beforeGroup"),game.user.isGM&&i("enabled","client.header","h2"),i("saves","client.tooltip"),i("distance","client.distance"),i("height","client.sidebar"),i("actions","client.actions"),i("containers","client.items"),i("spells","client.spells"),i("untrained","client.skills")}c(Rt,"renderSettingsConfig");function C(t,e){return`${L}.settings.${t}.${e}`}c(C,"path");function I(t,e,s,i={}){game.settings.register(L,t,{name:C(t,"name"),hint:C(t,"hint"),scope:"client",config:!0,type:e,default:s,...i})}c(I,"register");Hooks.once("setup",async()=>{Nt(),$t(),await loadTemplates({creature:O("tooltips/creature"),hazard:O("tooltips/hazard"),vehicle:O("tooltips/vehicle")})});Hooks.once("ready",()=>{b("enabled")&&Ee(!0),game.modules.get("pf2e-token-hud").api={getHud:V}});Hooks.on("renderSettingsConfig",Rt);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&V()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${L}.actor.macros.contextmenu`,condition:s=>{let{documentId:i}=s.data();return b("enabled")&&game.actors.get(i)?.isOwner},callback:s=>{let{documentId:i}=s.data();Di(i)}})});var De=class extends Dialog{async getData(e={}){let s=super.getData(e);return typeof s.content=="function"&&(s.content=await s.content()),s}};c(De,"DataDialog");function Di(t){let e=game.actors.get(t);if(!e)return;let s=new De({title:`${e.name} - ${w("actor.macros.title")}`,content:async()=>{let i=ye(e)??[];return renderTemplate(O("dialogs/macros"),{macros:i,noMacro:w("extras.no-macro")})},buttons:{},render:i=>{e.apps[s.appId]=s,i.on("drop",a=>be(a,e)),i.find("[data-action=delete-macro]").on("click",a=>ke(a,e))},close:()=>{delete e.apps[s.appId]}},{height:"auto"}).render(!0)}c(Di,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
