(()=>{var Ze=Object.defineProperty;var u=(s,e)=>Ze(s,"name",{value:e,configurable:!0});var et=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),tt=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]),fe=new Set(["arcane","divine","occult","primal"]),me={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"};function ge(s,e="systems/pf2e/icons/actions/Empty.webp"){if(s===null)return me.passive;let i=typeof s!="object"?s:s.type==="action"?s.value:s.type,t=String(i??"").toLowerCase().trim();return me[t]??e}u(ge,"getActionIcon");async function he({weapon:s,trait:e,selection:i}){if(s.system.traits.toggles[e].selection===i)return!1;let n=s.actor?.items.get(s.id);return n?.isOfType("weapon")&&n===s?await n.update({[`system.traits.toggles.${e}.selection`]:i}):n?.isOfType("weapon")&&s.altUsageType==="melee"?await n.update({[`system.meleeUsage.traitToggles.${e}`]:i}):await n?.rules.find(r=>r.key==="Strike"&&!r.ignored&&r.slug===s.slug)?.toggleTrait({trait:e,selection:i}),!0}u(he,"toggleWeaponTrait");function it(s,e="normal"){return s+(et.get(e)??0)}u(it,"adjustDC");function st(s="common"){switch(s){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}u(st,"rarityToDCAdjustment");function ee(s,e="common"){return it(s,st(e))}u(ee,"adjustDCByRarity");function nt(s,{proficiencyWithoutLevel:e,rarity:i="common"}={}){let t=game.settings.get("pf2e","proficiencyVariant");e??=t==="ProficiencyWithoutLevel";let n=tt.get(s)??14;return ee(e?n-Math.max(s,0):n,i)}u(nt,"calculateDC");function ot(s){return s.traits.has("cursed")?"unique":s.rarity}u(ot,"getDcRarity");function at(s){let e=s.system.traits.value;return new Set(e.filter(i=>ut(fe,i)))}u(at,"getMagicTraditions");function rt(s,e,i){let t={occult:e,primal:e,divine:e,arcane:e},n=at(s);for(let o of fe)n.size>0&&!n.has(o)&&(t[o]=e+i);return{arcana:t.arcane,nature:t.primal,religion:t.divine,occultism:t.occult}}u(rt,"getIdentifyMagicDCs");function ct(s,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:i}){let t=nt(s.level,{proficiencyWithoutLevel:e}),n=ot(s),o=ee(t,n);return s.isMagical?rt(s,o,i):s.isAlchemical?{crafting:o}:{dc:o}}u(ct,"getItemIdentificationDCs");function lt(s,e){return(typeof e=="string"||typeof e=="number")&&e in s}u(lt,"objectHasKey");function ut(s,e){return s.has(e)}u(ut,"setHasElement");var U=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,i=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),t=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",n=ct(e,{proficiencyWithoutLevel:t,notMatchingTraditionModifier:i});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:n}}activateListeners(e){e.find("button.update-identification").on("click",i=>{let t=$(i.delegateTarget);this.submit({updateData:{status:t.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let i=this.item,t=i.system.identification.unidentified.img,n=i.system.identification.unidentified.name,o=i.system.identification.identified.name,r=$("div#identify-item").find("tr").toArray().flatMap(c=>{let d=c.dataset.skill,p=Number(c.dataset.dc);if(!(Number.isInteger(p)&&lt(CONFIG.PF2E.skillList,d)))return[];let m=game.i18n.localize(CONFIG.PF2E.skillList[d]);return{slug:d,name:m,dc:p}}),a=i.isMagical?"action:identify-magic":i.isAlchemical?"action:identify-alchemy":null,l=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:t,itemName:n,identifiedName:o,rollOptions:["concentrate","exploration","secret",a].filter(Boolean),skills:r});await CONFIG.ChatMessage.documentClass.create({user:game.user.id,content:l})})}async _updateObject(e,i){let t=i.status;t==="identified"&&await this.item.setIdentificationStatus(t)}};u(U,"IdentifyItemPopup");async function ye(s,e,i,{rollMode:t=void 0,create:n=!0,data:o={}}){let r=`systems/pf2e/templates/chat/${e.type}-card.hbs`,a=i.token,l=s?.currentTarget.closest(".item")??{},c=CONFIG.ChatMessage.documentClass,d=Object.keys(o).length>0?o:l.dataset||{},p={actor:i,tokenId:a?`${a.parent?.id}.${a.id}`:null,item:e,data:await e.getChatData(void 0,d)},m={speaker:c.getSpeaker({actor:i,token:i.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return t??=s?.ctrlKey||s?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(t)&&(m.whisper=c.getWhisperRecipients("GM").map(T=>T.id)),t==="blindroll"&&(m.blind=!0),m.content=await renderTemplate(r,p),n?c.create(m,{renderSheet:!1}):new c(m)}u(ye,"unownedItemToMessage");async function ve(s,e){let i=s.data(),t=i.itemId?e.items.get(i.itemId):await fromUuid(i.uuid),n=await t?.getChatData({},i);if(!n)return;let o=document.createElement("div");return o.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(o,t,n),o}u(ve,"getItemSummary");function F(s){s.on("mouseenter",e=>{e.preventDefault();let i=e.currentTarget.querySelector(".name"),{width:t}=i.getBoundingClientRect();if(i.scrollWidth<=Math.ceil(t))return;let n=i.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:n})}),s.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),s.on("mousedown",e=>{game.tooltip.deactivate()})}u(F,"addNameTooltipListeners");function be(s,e){s.preventDefault(),I(s,e)?.sheet.render(!0,{focus:!0})}u(be,"editItem");async function we(s,e){s.preventDefault();let i=I(s,e);if(i){if(s.ctrlKey)return i.delete();new Dialog({title:v("deleteItem.title"),content:await renderTemplate("systems/pf2e/templates/actors/delete-item-dialog.hbs",{name:i.name}),buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:v("deleteItem.ok"),callback:()=>i.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:v("deleteItem.cancel")}}}).render(!0)}}u(we,"deleteItem");function I(s,e){let{itemId:i}=s.currentTarget.closest("[data-item-id]").dataset;return e.items.get(i)}u(I,"getItemFromEvent");async function K(s,e){let i=$(`#${b}`);if(!i.length)return;i.find(".popup").remove();let t=document.createElement("div");t.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${s}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${v("popup.close")}</a>
    </div>
</div>`;let n=t.firstElementChild;typeof e=="string"?(e=await TextEditor.enrichHTML(e,{async:!0}),n.insertAdjacentHTML("beforeend",e)):n.append(e),n.querySelector("[data-action=close-popup]").addEventListener("click",()=>n.remove()),i.append(n)}u(K,"popup");async function P(s,e,i){i??=s.find(".name").html();let t=await ve(s,e);t&&K(i.trim(),t)}u(P,"showItemSummary");var E="pf2e-token-hud",dt=new Set(["Compendium.pf2e.equipment-srd.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.4kz3vhkKPUuXBpxk"]),ke="Compendium.pf2e.feats-srd.0GF2j54roPFIDmXf",pt={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${E}.skills.actions.earnIncome`,treatWounds:`${E}.skills.actions.treatWounds`,"borrow-arcane-spell":`${E}.skills.actions.borrow-arcane-spell`,"identify-magic":`${E}.skills.actions.identify-magic`,"identify-alchemy":`${E}.skills.actions.identify-alchemy`,"learn-spell":`${E}.skills.actions.learn-spell`,"crafting-goods":`${E}.skills.actions.crafting-goods`,"staging-performance":`${E}.skills.actions.staging-performance`},Te={"sense-motive":"Compendium.pf2e.actionspf2e.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.SkZAQRkLLkmBQNB9","tumble-through":"Compendium.pf2e.actionspf2e.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.QNAVeNKtHA0EUw4X",bonMot:ke,gatherInformation:"Compendium.pf2e.actionspf2e.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.2EE4aF4SZpYf0R6H"},mt={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},B=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:["recall-knowledge",{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:s=>!s.itemTypes.equipment.some(e=>e.isHeld&&dt.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:["recall-knowledge",{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:s=>s.itemTypes.feat.some(e=>e.getFlag("core","sourceId")===ke)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"]},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"recall-knowledge","identify-magic","learn-spell"]},{slug:"occultism",actions:["recall-knowledge","decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["recall-knowledge","decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:["recall-knowledge",{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];B.forEach(s=>{s.actions=s.actions.map(t=>typeof t=="string"?mt[t]:t);let{slug:e,actions:i}=s;for(let t of i){let n=t.slug.replace(/-(.)/g,(o,r)=>r.toUpperCase()).capitalize();t.skillSlug=e,t.uuid=Te[t.slug],t.label=pt[t.slug]??`PF2E.Actions.${n}.Title`,t.variants?t.variants=t.variants.map(o=>({slug:o,label:`${E}.skills.actions.${o}`})):t.map&&(t.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),t.modifiers?.forEach(({modifiers:o})=>{o.forEach(r=>{r.label=`${E}.skills.modifiers.${r.slug}`})})}});var ie=B.map(s=>s.slug),ft=B.reduce((s,{slug:e,actions:i})=>(s[e]={slug:e,actions:i.reduce((t,n)=>(t[n.slug]=n,t),{})},s),{}),Ce=new Set(Object.values(Te).filter(Boolean));function se(s){return game.i18n.localize(s==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[s])}u(se,"getSkillLabel");async function Se(s){let e=[],i=!f("untrained"),t=!s.isOfType("character");for(let o=0;o<B.length;o++){let{slug:r,actions:a}=B[o],{label:l,rank:c,mod:d}=ne(r,s);e[o]={slug:r,label:l,rank:c,modifier:te(d),actions:a.filter(p=>(i||t||!p.trained||s.skills[r].rank>=1)&&(!p.condition||p.condition(s)))}}let n=Object.values(s.skills).filter(o=>o.lore).map(({label:o,rank:r,mod:a,slug:l})=>({slug:l,label:o,rank:r,modifier:te(a)}));return{skills:e,lores:n,doubled:f("skills-columns")}}u(Se,"getSkillsData");function ne(s,e){return s==="perception"?e.perception:e.skills[s]}u(ne,"getSkill");function Ie(s,e){s.find("[data-action=action-description]").on("click",async i=>{i.preventDefault();let t=$(i.currentTarget).closest(".action");P(t,e,t.find(".name").children().html())}),e.isOwner&&(s.find("[data-action=roll-skill]").on("click",i=>{i.preventDefault();let{slug:t}=i.currentTarget.dataset;ne(t,e).roll({event:i})}),s.find("[data-action=roll-action]").on("click contextmenu",async i=>{i.preventDefault();let t=$(i.currentTarget),{skillSlug:n,slug:o}=t.closest(".action").data(),r=i.type==="contextmenu"?await V(n):void 0;r!==null&&gt(i,e,n,o,t.data(),r)}),s.find("[data-action=action-chat]").on("click",async i=>{i.preventDefault();let{uuid:t}=i.currentTarget.closest(".action").dataset,n=await fromUuid(t);n&&ye(i,n,e,{create:!0})}))}u(Ie,"addSkillsListeners");async function V(s){let e='<p style="text-align: center; margin-block: 0 8px;">';e+=`<strong>${v("skills.variant.label")}</strong> <select>`;for(let i of ie){let t=i===s?"selected":"",n=se(i);e+=`<option value="${i}" ${t}>${n}</option>`}return e+="</select></p>",Dialog.prompt({title:v("skills.variant.title"),label:v("skills.variant.button"),callback:i=>i.find("select").val(),rejectClose:!1,content:e,options:{width:280}})}u(V,"createVariantDialog");function gt(s,e,i,t,{variant:n,map:o},r){let a=ft[i].actions[t],l=a.type;r??=a.noSkill?void 0:i;let c={event:s,actors:[e],variant:n,rollMode:a.secret?"blindroll":"roll"};if(c.modifiers=[],a.modifiers){for(let{condition:d,modifiers:p}of a.modifiers)if(!(d&&!d(e)))for(let m of p)c.modifiers.push(new game.pf2e.Modifier(m))}if(a.custom){a.custom(e,c);return}else if(!l){ne(r,e).roll(c);return}l===1?(c.skill=r,o&&c.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:o})),game.pf2e.actions[t](c)):l===2?(c.statistic=r,o&&(c.multipleAttackPenalty=o/-5),game.pf2e.actions.get(t).use(c)):l===3&&game.pf2e.actions[t](e)}u(gt,"rollAction");var N={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionTypeReaction",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionTypeFree",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.ActionTypePassive",actionLabel:"PF2E.ActionTypePassive"}},Ee={delay:[500,0],position:"top",theme:"crb-hover",arrow:!1};async function De(s){let e=s.isOfType("character"),i=s.synthetics.toggles.slice(),t=f("actions"),n=e?yt(s):vt(s),o,r=game.modules.get("pf2e-hero-actions");if(r?.active&&e){let c=r.api.getHeroActions(s),d=s.heroPoints.value-c.length;o={actions:c,draw:Math.max(d,0),discard:Math.abs(Math.min(d,0)),canTrade:c.length&&game.settings.get("pf2e-hero-actions","trade")}}let a=await Promise.all(s.system.actions.map(async(c,d)=>({...c,index:d,damageFormula:await c.damage?.({getFormula:!0}),criticalFormula:await c.critical?.({getFormula:!0})}))),l={};for(let c of n)t!=="split"?(l.action??=[],l.action.push(c)):(l[c.type]??=[],l[c.type].push(c));if(l=Object.entries(l).map(([c,d])=>(d.forEach(p=>{p.img=ge(p.cost),p.typeLabel=N[p.type].actionLabel}),t!=="type"?d.sort((p,m)=>p.name.localeCompare(m.name)):d.sort((p,m)=>{let T=N[p.type].order,h=N[m.type].order;return T===h?p.name.localeCompare(m.name):T-h}),{type:c,actions:d,label:N[c].label})),t==="split"&&l.sort((c,d)=>N[c.type].order-N[d.type].order),i.length||a.length||l.length||o?.length)return{toggles:i,strikes:a,sections:l,heroActions:o,damageTypes:CONFIG.PF2E.damageTypes}}u(De,"getActionsData");function xe(s){if(f("actions-colors"))return{classList:["attack-damage-system-colors"]}}u(xe,"getActionsOptions");function Le(s,e){F(s.find(".toggle")),F(s.find(".strike")),F(s.find(".action"));function i(o,r,a="click"){return o=typeof o=="string"?[o]:o,o=o.map(l=>`[data-action=${l}]`).join(", "),s.find(o).on(a,l=>{l.preventDefault(),r(l)})}u(i,"action");function t(o){let{index:r}=o.currentTarget.closest(".strike").dataset;return e.system.actions[r]}u(t,"getStrike");function n(o){return $(o.currentTarget).closest(".action").data().uuid}u(n,"getUuid"),i("action-description",async o=>{let r=$(o.currentTarget).closest(".action");P(r,e)}),i("hero-action-description",async o=>{let{description:r,name:a}=await ht(n(o))??{};r&&K(a,r)}),i("strike-description",async o=>{let r=t(o);if(!r)return;let a=document.createElement("div");a.classList.add("description"),a.innerHTML=await renderTemplate(z("strike-description"),r),K(r.label,a)}),e.isOwner&&(i("action-chat",o=>{I(o,e)?.toMessage(o,{create:!0})}),i("hero-action-chat",async o=>{await game.modules.get("pf2e-hero-actions")?.api.sendActionToChat(e,n(o))}),i("draw-hero-action",async o=>{await game.modules.get("pf2e-hero-actions")?.api.drawHeroActions(e)}),i("use-hero-action",async o=>{await game.modules.get("pf2e-hero-actions")?.api.useHeroAction(e,n(o))}),i("discard-hero-action",async o=>{await game.modules.get("pf2e-hero-actions")?.api.discardHeroActions(e,n(o))}),i("trade-hero-action",async o=>{game.modules.get("pf2e-hero-actions")?.api.tradeHeroAction(e)}),i("strike-attack",o=>{let{index:r}=o.currentTarget.dataset;t(o)?.variants[r].roll({event:o})}),i(["toggle-roll-option","set-suboption"],o=>{let r=o.currentTarget.closest(".toggle"),{domain:a,option:l,itemId:c}=r.dataset,d=r.querySelector("select")?.value??null;e.toggleRollOption(a,l,c??null,r.querySelector("input").checked,d)}),i(["strike-damage","strike-critical"],o=>{let{action:r}=o.currentTarget.dataset;t(o)?.[r==="strike-damage"?"damage":"critical"]({event:o})}).tooltipster(Ee),i("strike-auxiliary",o=>{if(o.currentTarget!==o.target)return;let r=t(o);if(!r)return;let{index:a}=o.currentTarget.dataset,l=o.currentTarget.querySelector("select")?.value??null;r.auxiliaryActions?.[a]?.execute({selection:l})}),i("toggle-versatile",o=>{let r=t(o)?.item;if(!r)return;let a=o.currentTarget,{value:l}=a.dataset,c=r?.system.damage.damageType??null,d=a.classList.contains("selected")||l===c?null:l;he({trait:"versatile",weapon:r,selection:d})}).tooltipster(Ee),i("strike-ammo",async o=>{let r=t(o)?.item;if(!r)return;let a=e.items.get(o.currentTarget.value);await r.update({system:{selectedAmmoId:a?.id??null}})},"change"))}u(Le,"addActionsListeners");function ht(s){return game.modules.get("pf2e-hero-actions")?.api.getHeroActionDetails(s)}u(ht,"getHeroActionDescription");function yt(s){let e=s.itemTypes.action.filter(t=>!Ce.has(t.sourceId)),i=s.itemTypes.feat.filter(t=>t.actionCost);return[...e,...i].filter(t=>{let n=t.system.traits.value;return!n.includes("downtime")&&!n.includes("exploration")}).map(t=>{let n=t.actionCost;return{id:t.id,type:n?.type??"free",cost:n,name:t.name}})}u(yt,"getCharacterActions");function vt(s){return s.itemTypes.action.map(e=>{let i=e.actionCost,t=i?.type??"passive",n=t==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(o=>o.key==="Aura"));return{id:e.id,type:t,cost:i,name:e.name,hasDeathNote:e.system.deathNote,hasAura:n}})}u(vt,"getNpcActions");async function Ae(s){let{attributes:e}=s,{initiative:i}=e;return{initiative:{selected:i.statistic,skills:ie.map(t=>({slug:t,label:se(t)}))},hasDailies:game.modules.get("pf2e-dailies")?.active}}u(Ae,"getExtrasData");function Fe(s,e){if(!e.isOwner)return;s.find("input[name], select[name]").on("change",async t=>{let n=t.currentTarget,o=n.type==="number"?n.valueAsNumber:n.value;await e.update({[n.name]:o})});function i(t,n,o="click"){s.find(`[data-action=${t}]`).on(o,r=>{r.preventDefault(),n(r)})}u(i,"action"),i("roll-initiative",async t=>{await e.initiative.roll({event:t})}),i("prepare-dailies",t=>{let n=game.modules.get("pf2e-dailies");n?.active&&n.api.openDailiesInterface(e)}),i("rest-for-the-night",t=>{game.pf2e.actions.restForTheNight({actors:[e]})}),i("roll-aid",async t=>{let n=await V(),o={text:"@UUID[Compendium.pf2e.other-effects.AHMUpMbaVkZ5A1KX]"};n!==null&&game.pf2e.actions.get("aid").use({event:t,actors:[e],statistic:n,notes:[o]})},"click contextmenu"),i("roll-escape",async t=>{let n=t.type==="contextmenu"?await V():void 0;n!==null&&game.pf2e.actions.get("escape").use({event:t,actors:[e],statistic:n})},"click contextmenu")}u(Fe,"addExtrasListeners");var oe={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function Pe(s){let e={};for(let i of s.inventory.contents)e[i.type]??=[],e[i.type].push(i);return{categories:Object.entries(e).map(([i,t])=>(t.sort((n,o)=>n.name.localeCompare(o.name)),{type:i,items:t,label:oe[i].label})).sort((i,t)=>oe[i.type].order-oe[t.type].order)}}u(Pe,"getItemsData");function Me(s,e){let i=s.find(".item");F(i),i.find("[data-action=item-description]").on("click",async t=>{t.preventDefault();let n=$(t.currentTarget).closest(".item");P(n,e)}),e.isOwner&&(i.find("[data-action=item-chat]").on("click",async t=>{I(t,e)?.toMessage(t,{create:!0})}),i.on("dragstart",t=>{let n=t.target.closest(".item"),{itemType:o,uuid:r}=n.dataset,a=new Image;a.src=n.querySelector(".item-img img").src,a.style.width="32px",a.style.height="32px",a.style.borderRadius="4px",a.style.position="absolute",a.style.left="-1000px",document.body.append(a),t.originalEvent.dataTransfer.setDragImage(a,16,16),t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:o,uuid:r})),n.addEventListener("dragend",()=>a.remove(),{once:!0})}),s.find(".quantity input").on("change",async t=>{await I(t,e)?.update({"system.quantity":t.currentTarget.valueAsNumber})}),s.find("[data-action=toggle-item-invest]").on("click",t=>{t.preventDefault();let{itemId:n}=t.currentTarget.closest(".item").dataset;e.toggleInvested(n)}),s.find("[data-action=repair-item]").on("click",t=>{t.preventDefault();let n=I(t,e);n&&game.pf2e.actions.repair({item:n,actors:[e]})}),s.find("[data-action=toggle-identified]").on("click",t=>{t.preventDefault();let n=I(t,e);n&&(n.isIdentified?n.setIdentificationStatus("unidentified"):new U(n).render(!0))}),s.find("[data-action=edit-item]").on("click",t=>{t.preventDefault(),be(t,e)}),s.find("[data-action=delete-item]").on("click",t=>{t.preventDefault(),we(t,e)}),s.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(t,{event:n,origin:o}){let r=I(n,e);if(!r)return;let a=document.createElement("div");a.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:r});let l=a.children[1];$(l).find("[data-carry-type]").on("click",c=>{let{carryType:d,handsHeld:p=0,inSlot:m}=$(c.currentTarget).data();e.adjustCarryType(r,d,p,m),t.close()}),t.content(l)}}))}u(Me,"addItemsListeners");async function Oe(s){let e=s.system.resources.focus?.value??0,i=s.spellcasting.regular,t=f("tradition"),n=[];for(let a of i){let l=a.id,c=t&&a.statistic.label[0],d=await a.getSheetData(),p=a.system?.prepared?.value==="charge",m=getProperty(a,"flags.pf2e-staves.staveID")!==void 0,T={value:getProperty(a,"flags.pf2e-staves.charges")??0};for(let h of d.levels){if(!h.active.length||h.uses?.max===0)continue;let S=[],x=h.active.filter(D=>D&&D.uses?.max!==0);for(let D=0;D<x.length;D++){let{spell:L,expended:O,virtual:_,uses:q,castLevel:J}=x[D];S.push({name:L.name,img:L.img,tradition:c,castLevel:J??L.level,slotId:D,entryId:l,itemId:L.id,inputId:d.isInnate?L.id:d.id,inputPath:p?"flags.pf2e-staves.charges":d.isInnate?"system.location.uses.value":`system.slots.slot${h.level}.value`,isCharge:p,isVirtual:_,isInnate:d.isInnate,isCantrip:h.isCantrip,isFocus:d.isFocusPool,isPrepared:d.isPrepared,isSpontaneous:d.isSpontaneous||d.isFlexible,slotLevel:h.level,uses:q??(p?T:h.uses),expended:O??(d.isFocusPool&&!h.isCantrip?e<=0:!1),action:L.system.time.value,type:p?m?`${b}.spells.staff`:`${b}.spells.charges`:d.isInnate?"PF2E.PreparationTypeInnate":d.isSpontaneous?"PF2E.PreparationTypeSpontaneous":d.isFlexible?"PF2E.SpellFlexibleLabel":d.isFocusPool?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:p?0:d.isPrepared?1:d.isFocusPool?2:d.isInnate?3:d.isSpontaneous?4:5})}S.length&&(n[h.level]??=[],n[h.level].push(...S))}}if(n.length){let a=f("spells")?(l,c)=>l.order===c.order?l.name.localeCompare(c.name):l.order-c.order:(l,c)=>l.name.localeCompare(c.name);n.forEach(l=>l.sort(a))}let r=(await s.spellcasting.ritual?.getSheetData())?.levels.flatMap((a,l)=>a.active.map(({spell:c})=>({name:c.name,img:c.img,slotId:l,itemId:c.id,level:c.level,time:c.system.time.value})));if(n.length||r?.length)return{spells:n,rituals:r,doubled:f("spells-columns")}}u(Oe,"getSpellsData");function $e(s,e){F(s.find(".spell")),s.find("[data-action=spell-description]").on("click",async i=>{i.preventDefault();let t=$(i.currentTarget).closest(".spell");P(t,e)}),e.isOwner&&(s.find("[data-action=spell-chat]").on("click",async i=>{I(i,e)?.toMessage(i,{create:!0})}),s.find("[data-action=toggle-pips]").on("click contextmenu",async i=>{i.preventDefault();let t=i.type==="click"?1:-1,n=(e.system.resources.focus?.value??0)+t;await e.update({"system.resources.focus.value":n})}),s.find("[data-action=toggle-prepared]").on("click",i=>{i.preventDefault();let{slotLevel:t,slotId:n,entryId:o,expended:r}=$(i.currentTarget).closest(".spell").data();e.spellcasting.collections.get(o)?.setSlotExpendedState(t??0,n??0,r!==!0)}),s.find("[data-action=cast-spell]").on("click",i=>{i.preventDefault();let{slotLevel:t,slotId:n,entryId:o,itemId:r}=$(i.currentTarget).closest(".spell").data(),a=e.spellcasting.collections.get(o,{strict:!0});if(!a)return;let l=a.get(r,{strict:!0});l&&a.entry.cast(l,{slot:n,level:t})}),s.find("[data-input-path]").on("change",async i=>{let{inputPath:t,entryId:n}=$(i.currentTarget).data(),o=i.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:n,[t]:o}])}))}u($e,"addSpellsListeners");var ae="Compendium.pf2e.other-effects.I9lfZUiCwMiGogVi",bt="Compendium.pf2e.feats-srd.jFmdevE4nKevovzo",wt={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},kt={G:'<i class="fa-solid fa-face-smile-halo"></i>',N:'<i class="fa-solid fa-face-meh"></i>',E:'<i class="fa-solid fa-face-angry-horns"></i>'},Tt=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],Ct={actions:{getData:De,addListeners:Le,getOptions:xe},items:{getData:Pe,addListeners:Me},spells:{getData:Oe,addListeners:$e},skills:{getData:Se,addListeners:Ie},extras:{getData:Ae,addListeners:Fe}},G=class extends Application{#e=null;#u=null;#i=null;#s=!1;#n=null;#o;#a=[!1,!1,!1];#t=!1;#r=!1;#c=null;#l=null;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#c=(e,i)=>{let n=e.isOwner||e.observer&&f("observer");if(f("chat")&&$(window.document).find(":hover").filter("#sidebar").length||this.mousedown||this.#t||this.#r||!(e instanceof Token)||!e.actor?.isOfType("character","npc"))return;let r=e.localTransform,a=e.document;if(!(r.tx!==a.x||r.ty!==a.y)&&(this.#s=i,!(i&&this.#e===e&&this.rendered)))if(i&&!game.keyboard.downKeys.has("ControlLeft")){this.#d(e);let l=f("holding"),c=Re();if(l!=="none"&&!c&&(l==="all"||n))return;if(!this.#n)return this.render(null,null,l==="none"||l==="owned"&&!n&&!c);clearTimeout(this.#n),this.#n=null,this.render()}else this.close()},this.#o=e=>{let i=e.button;if(![0,2].includes(i))return;if(e.type==="mouseup"){this.#a[i]=!1;return}this.#a[i]=!0;let t=e.target,n=this.element[0];if(n){let o=n.querySelector(".popup");if(n.contains(t)){o&&!o.contains(t)&&o.remove();return}if(t.closest(".app")||t.closest(".tooltipster-base"))return;if(o)return o.remove();this.forceClose()}else this.#i&&(clearTimeout(this.#i),this.#i=null);this.#t=!1},this.#l=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#o),window.addEventListener("mouseup",this.#o),Hooks.on("hoverToken",this.#c),Hooks.on("deleteToken",this.#l),Hooks.on("canvasPan",this.forceClose)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#o),window.removeEventListener("mouseup",this.#o),Hooks.off("hoverToken",this.#c),Hooks.off("deleteToken",this.#l),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:z("hud")})}get mousedown(){return this.#a[0]||this.#a[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return this.actor?.itemTypes.effect.find(e=>e.flags.core?.sourceId===ae)}get isCharacter(){return this.actor?.isOfType("character")}#d(e){e!==this.#e&&(this.#e&&delete this.#e.actor.apps?.[b],this.#e=e)}getData(){let e=this.#e,i=this.#e?.actor;if(!i)return{};let t=null,n=e.isOwner,o=n||e.observer&&f("observer"),r=f("distance"),a=this.isCharacter,{attributes:l,saves:c,heroPoints:d,system:p,alignment:m}=i,{traits:T}=p,{hp:h,sp:S={max:0,value:0},resolve:x,ac:D,shield:L,speed:O,dying:_,wounded:q,resistances:J,weaknesses:qe,immunities:Ke}=l,X=game.settings.get("pf2e","staminaVariant");if(r==="all"||r==="self"&&o){let g=f("unit").split(","),C=Number(g[0]?.trim())||1,A=g[1]?.trim()||game.system.gridUnits,M=Number(g[2]?.trim())||0,R=canvas.tokens.controlled,de=!1,H=R.length===1?R[0]:null;if(!H||H===e){let pe=game.user.targets;H=pe.size===1?pe.first():null,de=!0}H&&H!==e&&(t={unit:A,icon:de?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(H)*C).toFixed(M)})}let Y;if(!o||f("see-status")){let g=f("status").split(",").map(C=>C.trim()).filter(Boolean);if(g.length){let C=h.max+(X?S.max:0),M=(h.value+(X?S.value:0))/C,R=Math.ceil(M*g.length);Y={hue:M*M*122+3,value:R===0?game.i18n.localize("EFFECT.StatusDead"):g.at(R-1)}}}if(!o)return{status:Y,distance:t,tokenId:e.id};function Q(g){return`<li>${g.trim()}</li>`}u(Q,"toInfo");function Ve(g,C){return g.localeCompare(C)}u(Ve,"sort");let We=i.system.traits?.languages?.value.map(g=>game.i18n.localize(CONFIG.PF2E.languages[g])).sort(Ve).map(Q).join(""),Je=a?T.senses.map(g=>g.label):T.senses.value.split(",");function Z(g,C){return g.length?`<li>${game.i18n.localize(C)}<ul>`+g.map(A=>Q(A.label.replace("-"," ").titleCase())).join("")+"</ul></li>":""}u(Z,"toIWR");let le=Tt.map(({type:g,icon:C},A)=>({index:A,icon:C,label:game.i18n.localize(CONFIG.PF2E.speedTypes[g]??"PF2E.SpeedTypesLand"),value:(g==="land"?O.total:O.otherSpeeds.find(M=>M.type===g)?.total)||0})),Xe=Ne(i,`speeds.selected.${game.user.id}`)||0,Ye=le.splice(Xe,1)[0],ue=le.map(({value:g,label:C,index:A})=>`<a data-index="${A}"><li>${C}: ${g}</li></a>`).join("");O.details&&(ue+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${O.details}</li>`);let Qe=f("show-death");return{distance:t,status:Y,isOwner:n,isObserver:o,tokenId:e.id,name:e.document.name,hp:h,sp:X?S:{max:0},ac:D.value,hero:d,dying:_,wounded:q,shield:L,resolve:x,alignment:{value:m,icon:kt[m.at(-1)]},level:i.level,isCharacter:a,showDeathLine:a&&(Qe==="always"||_.value||q.value),hasCover:this.hasCover,saves:{fortitude:c.fortitude.mod,reflex:c.reflex.mod,will:c.will.mod},speeds:{main:Ye,others:ue},iwr:Z(Ke,"PF2E.ImmunitiesLabel")+Z(qe,"PF2E.WeaknessesLabel")+Z(J,"PF2E.ResistancesLabel"),senses:Je.map(Q).join(""),languages:We,hasSpells:i.spellcasting.some(g=>g.category!=="items"),hasItems:i.inventory.size}}#p(e){this.#d(null),this.#s=!1,this.#t=!1,this.#r=!1,this.#i!==null&&(clearTimeout(this.#i),this.#i=null);let i=Application.RENDER_STATES;if(!e.force&&![i.RENDERED,i.ERROR].includes(this._state))return;this._state=i.CLOSING;let t=this.element;if(!t)return this._state=i.CLOSED;t.css({minHeight:0});for(let n of this.constructor._getInheritanceChain())Hooks.call(`close${n.name}`,this,t);t.remove(),this._element=null,this._state=i.CLOSED,delete ui.windows[this.appId]}close(e={}){if(e.force)return this.#p(e);this.#n=setTimeout(()=>{this.#n=null,!this.#s&&this.#p(e)})}async _render(e=!1,i={}){let t,n;if(this.#u===this.#e){let o=this.element.find(".sidebar")[0];o&&(t=o.dataset.type,n=o.scrollTop)}if(await super._render(e,i),ui.windows[this.appId]=this,t){let o=await this.#m(t);n>0&&(o.scrollTop=n)}this.#u=this.#e}render(e,i,t){if(!this.#e?.actor)return;if(!t)return super.render(!0);let n=f("delay");n?this.#i=setTimeout(()=>super.render(!0),n):super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let i=this.element[0],t=e.worldTransform.a,n=i.getBoundingClientRect(),o=canvas.clientCoordinatesFromCanvas(e.document._source),r={x:o.x,y:o.y,width:e.hitArea.width*t,height:e.hitArea.height*t,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},a,l=e.observer?wt[f("position")].slice():["top","bottom"];for(;l.length&&!a;){let c=l.shift();c==="left"?(a={x:r.x-n.width,y:re(n,r)},a.x<0&&(a=void 0)):c==="right"?(a={x:r.right,y:re(n,r)},a.x+n.width>window.innerWidth&&(a=void 0)):c==="top"?(a={x:He(n,r),y:r.y-n.height},a.y<0&&(a=void 0)):c==="bottom"&&(a={x:He(n,r),y:r.bottom},a.y+n.height>window.innerHeight&&(a=void 0))}return a&&(i.style.left=`${a.x}px`,i.style.top=`${a.y}px`),a}activateListeners(e){let i=this.#e,t=i?.actor;if(!t)return;let n=i.isOwner;t.apps[b]=this,e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{this.#s=!0,this.#r=!0}),e.on("mouseleave",()=>{this.#r=!1,!this.#t&&(this.#s=!1,this.close())}),e.on("dragover",()=>{e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0})});let o=e.find("[data-action=show-info]");o.tooltipster({position:["top","bottom","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click"}),(n?o.filter(":not(.speeds)"):o).on("mouseleave",a=>{$(a.currentTarget).tooltipster("hide")}),e.find(".inner .footer [data-type]").on("click",this.#m.bind(this)),n&&(e.find("input").on("change",async a=>{let l=a.currentTarget,c=l.valueAsNumber,d=l.name;l.blur(),d!=="shield.value"?await t.update({[d]:c}):await t.heldShield.update({"system.hp.value":c})}),e.find("[data-action=toggle-hero]").on("click contextmenu",a=>{a.preventDefault();let{max:l,value:c}=t.heroPoints,d=a.type==="click"?1:-1,p=Math.clamped(c+d,0,l);p!==c&&t.update({"system.resources.heroPoints.value":p})}),e.find("[data-action=raise-shield]").on("click",a=>{a.preventDefault(),game.pf2e.actions.raiseAShield({actors:[t]})}),e.find("[data-action=take-cover]").on("click",async a=>{a.preventDefault();let l=(await fromUuid(ae)).toObject();setProperty(l,"flags.core.sourceId",ae);let c=this.hasCover;this.hasCover?await c.delete():await t.createEmbeddedDocuments("Item",[l])}),e.find("[data-action=roll-save]").on("click",a=>{a.preventDefault();let l=a.currentTarget.dataset.save;t.saves[l].roll({event:a})}),e.find("[data-action=recovery-check]").on("click",a=>{a.preventDefault(),t.rollRecovery(a)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",a=>{a.preventDefault();let l=a.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",c=t.system.attributes[l]?.max;c&&(a.type==="click"?t.increaseCondition(l,{max:c}):t.decreaseCondition(l))}),e.find("[data-action=use-resolve]").on("click",a=>{a.preventDefault(),St(t)}),o.filter(".speeds").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(a,{origin:l,tooltip:c})=>{this.#t=!0,c.querySelectorAll("[data-index]").forEach(d=>{d.addEventListener("click",async p=>{p.preventDefault(),await je(t,`speeds.selected.${game.user.id}`,Number(d.dataset.index))})})}).tooltipster("option","functionAfter",()=>{e.find(".sidebar").length||(this.#t=!1)}))}async#m(e){e=typeof e=="string"?e:e.currentTarget.dataset.type;let i=this.element,t=i.find(".sidebar"),n=t[0]?.dataset.type;if(t.remove(),i.find(".inner .footer [data-type]").removeClass("active"),n===e){this.#t=!1;return}let o=this.actor,{getData:r,addListeners:a,getOptions:l}=Ct[e],c=await r(o),{classList:d=[]}=l&&await l(o)||{};if(!c)return ui.notifications.warn(v(`${e}.empty`,{name:this.#e.name}));c.isGM=game.user.isGM,c.isCharacter=this.isCharacter,c.isOwner=o.isOwner,this.#t=!0,i.find(`.inner .footer [data-type=${e}]`).addClass("active"),i=i[0];let p=document.createElement("div");p.innerHTML=await renderTemplate(z(e),c),t=p.firstElementChild,t.classList.add("sidebar",...d),f("scrollbar")||t.classList.add("no-scrollbar"),c.doubled&&t.classList.add("doubled"),t.dataset.type=e,t.style.setProperty("--max-height",f("height").trim()||"100%"),this.element.append(t);let m=t.getBoundingClientRect(),T=i.getBoundingClientRect(),h=T.x-m.width;h<0&&(h=T.right);let S=parseInt(window.getComputedStyle(i).padding),x=re(m,T,S);return t.style.left=`${h}px`,t.style.top=`${x}px`,a($(t),o),t}};u(G,"HUD");function re(s,e,i=0){let t=e.y+e.height/2-s.height/2;return t+s.height>window.innerHeight&&(t=window.innerHeight-s.height-i),t<0&&(t=i),t}u(re,"postionFromTargetY");function He(s,e){let i=e.x+e.width/2-s.width/2;return i+s.width>window.innerWidth&&(y=window.innerWidth-s.width),i<0&&(i=0),i}u(He,"postionFromTargetX");function St(s){function e(d){ChatMessage.create({user:game.user.id,content:d,speaker:ChatMessage.getSpeaker({actor:s})})}u(e,"toChat");let{name:i,attributes:t}=s,{sp:n,resolve:o}=t,r=v("hud.resolve.full",{name:i}),a=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:i});if(n.value===n.max)return ui.notifications.warn(r);if(o.value<1)return ui.notifications.warn(a);let l=s.itemTypes.feat.find(d=>d.sourceId===bt),c='<p><input type="radio" name="pick" value="breather" style="margin-right: 6px;';l||(c+=" display: none;"),c+='" checked><span>',l&&(c+=`<strong>${v("hud.resolve.breather.label")}:</strong> `),c+=`${v("hud.resolve.breather.msg")}</span></p>`,l&&(c+='<p><input type="radio" name="pick" value="steel" style="margin-right: 6px;">',c+=`<span><strong>${game.i18n.localize("PF2E.Actions.SteelYourResolve.Title")}:</strong> `,c+=`${v("hud.resolve.steel.msg")}</span></p>`),new Dialog({title:v("hud.resolve.title"),content:c,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:v("hud.resolve.yes"),callback:async d=>{let{attributes:p}=s,{sp:m,resolve:T}=p;if(m.value===m.max)return e(r);if(T.value<1)return e(a);let h=d.find("input:checked").val(),S=`${m.value}/${m.max}`;if(h==="breather")e(v("hud.resolve.breather.used",{name:i,ratio:S})),await s.update({"system.attributes.sp.value":m.max,"system.attributes.resolve.value":T.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:i,ratio:S}));let x=m.value+Math.floor(m.max/2);await s.update({"system.attributes.sp.value":Math.min(x,m.max),"system.attributes.resolve.value":T.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:v("hud.resolve.no")}}}).render(!0)}u(St,"useResolve");var b="pf2e-token-hud",j=null;function Ue(){return j}u(Ue,"getHud");function W(s){s&&!j?j=new G:!s&&j&&(j.delete(),j=null)}u(W,"enableModule");function f(s){return game.settings.get(b,s)}u(f,"getSetting");function v(...s){let e=s.at(-1),i=typeof e=="object",t=i?s.slice(0,-1):s;return t.unshift(b),game.i18n[i?"format":"localize"](t.join("."),e)}u(v,"localize");function z(s){return`modules/${b}/templates/${s}.hbs`}u(z,"templatePath");function te(s){return s>=0?`+${s}`:s}u(te,"modifier");function Ne(s,e){return s.getFlag(b,e)}u(Ne,"getFlag");function je(s,e,i){return s.setFlag(b,e,i)}u(je,"setFlag");var ce=!1;function ze(){It("hold",{onDown:()=>{ce=!0,f("holding")!=="none"&&Ue().render()},onUp:()=>{ce=!1}})}u(ze,"registerKeybindings");function Re(){return ce}u(Re,"isHolding");function Be(s,e){return`${b}.keybinds.${s}.${e}`}u(Be,"path");function It(s,e={}){game.keybindings.register(b,s,{name:Be(s,"name"),hint:Be(s,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}u(It,"register");function Ge(){let s=["first","second","third","fourth"].map(e=>v(`settings.status.statuses.${e}`)).join(", ");w("status",String,s,{scope:"world"}),w("enabled",Boolean,!0,{onChange:W}),w("position",String,"right",{choices:{left:k("position","choices.left"),right:k("position","choices.right"),top:k("position","choices.top"),bottom:k("position","choices.bottom")}}),w("delay",Number,250,{range:{min:0,max:2e3,step:50}}),w("holding",String,"none",{choices:{none:k("holding","choices.none"),owned:k("holding","choices.owned"),all:k("holding","choices.all")}}),w("observer",Boolean,!0),w("see-status",Boolean,!1),w("chat",Boolean,!0),w("show-death",String,"always",{choices:{none:k("show-death","choices.none"),always:k("show-death","choices.always"),only:k("show-death","choices.only")}}),w("distance",String,"all",{choices:{none:k("distance","choices.none"),self:k("distance","choices.self"),all:k("distance","choices.all")}}),w("unit",String,""),w("height",String,""),w("scrollbar",Boolean,!0),w("spells-columns",Boolean,!1),w("skills-columns",Boolean,!1),w("actions",String,"split",{choices:{name:k("actions","choices.name"),type:k("actions","choices.type"),split:k("actions","choices.split")}}),w("actions-colors",Boolean,!0),w("spells",Boolean,!1),w("tradition",Boolean,!1),w("untrained",Boolean,!0)}u(Ge,"registerSettings");function _e(s,e){let i=e.find(`.tab[data-tab=${b}]`);function t(n,o,r="h3"){let a=v(`menu.${o}`);i.find(`[name="${b}.${n}"]`).closest(".form-group").before(`<${r}>${a}</${r}>`)}u(t,"beforeGroup"),game.user.isGM&&t("enabled","client.header","h2"),t("distance","client.distance"),t("height","client.sidebar"),t("actions","client.actions"),t("spells","client.spells"),t("untrained","client.skills")}u(_e,"renderSettingsConfig");function k(s,e){return`${b}.settings.${s}.${e}`}u(k,"path");function w(s,e,i,t={}){game.settings.register(b,s,{name:k(s,"name"),hint:k(s,"hint"),scope:"client",config:!0,type:e,default:i,...t})}u(w,"register");Hooks.once("setup",()=>{Ge(),ze()});Hooks.once("ready",()=>{f("enabled")&&W(!0)});Hooks.on("renderSettingsConfig",_e);})();
//# sourceMappingURL=main.js.map
