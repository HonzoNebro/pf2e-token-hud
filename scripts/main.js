(()=>{var Es=Object.defineProperty;var u=(t,e)=>Es(t,"name",{value:e,configurable:!0});var Ds="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function gt(t){function e(d){ChatMessage.create({user:game.user.id,content:d,speaker:ChatMessage.getSpeaker({actor:t})})}u(e,"toChat");let{name:s,attributes:i}=t,{sp:n,resolve:a}=i,o=E("hud.resolve.full",{name:s}),l=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:s});if(n.value===n.max)return ui.notifications.warn(o);if(a.value<1)return ui.notifications.warn(l);let r=t.itemTypes.feat.find(d=>d.sourceId===Ds),c=await renderTemplate(U("dialogs/resolve"),{hasSteel:r,i18n:d=>E(`hud.resolve.${d}`)});new Dialog({title:E("hud.resolve.title"),content:c,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:E("hud.resolve.yes"),callback:async d=>{let{attributes:p}=t,{sp:m,resolve:g}=p;if(m.value===m.max)return e(o);if(g.value<1)return e(l);let f=d.find("input:checked").val(),k=`${m.value}/${m.max}`;if(f==="breather")e(E("hud.resolve.breather.used",{name:s,ratio:k})),await t.update({"system.attributes.sp.value":m.max,"system.attributes.resolve.value":g.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:s,ratio:k}));let h=m.value+Math.floor(m.max/2);await t.update({"system.attributes.sp.value":Math.min(h,m.max),"system.attributes.resolve.value":g.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:E("hud.resolve.no")}}}).render(!0)}u(gt,"useResolve");function de(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageRoll")}u(de,"getDamageRollClass");function ht(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageInstance")}u(ht,"getDamageInstanceClass");function Q(){return CONFIG.ChatMessage.documentClass}u(Q,"getChatMessageClass");function yt(){return CONFIG.MeasuredTemplate.documentClass}u(yt,"getMeasuredTemplateDocumentClass");function bt(){return CONFIG.MeasuredTemplate.objectClass}u(bt,"getMeasuredTemplateObjectClass");var wt={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"},Os={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function kt(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return wt.passive;let s=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(s??"").toLowerCase().trim();return wt[i]??e}u(kt,"getActionIcon");function $e(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,s=String(e??"").toLowerCase().trim();return Os[s]??""}u($e,"getActionGlyph");function te(t){return Error(`PF2e System | ${t}`)}u(te,"ErrorPF2e");function vt(t,e){return t.includes(e)}u(vt,"tupleHasValue");function Xe(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(Xe,"objectHasKey");var Pe=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,Qe=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,As=new RegExp(Qe,"gu"),Fs=String.raw`(?:${Pe})(?=${Qe})|(?:${Qe})(?=${Pe})`,Ls=String.raw`(?:${Pe})(?=${Pe})`,Ct=String.raw`\p{Lowercase_Letter}`,It=String.raw`\p{Uppercase_Letter}`,Ms=new RegExp(`(${Ct})(${It}${Ls})`,"gu"),xs=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,Ps=new RegExp(`${It}|(?:${Fs})${Ct}`,"gu");function Ce(t,{camel:e=null}={}){if(typeof t!="string")return console.warn("Non-string argument passed to `sluggify`"),"";if(t==="-")return t;switch(e){case null:return t.replace(Ms,"$1-$2").toLowerCase().replace(/['â€™]/g,"").replace(As," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{let s=Ce(t,{camel:"dromedary"});return s.charAt(0).toUpperCase()+s.slice(1)}case"dromedary":return t.replace(xs,"").replace(/[-_]+/g," ").replace(Ps,(s,i)=>i===0?s.toLowerCase():s.toUpperCase()).replace(/\s+/g,"");default:throw te("I don't think that's a real camel.")}}u(Ce,"sluggify");function Ze(t,e){let s=new Map;for(let i of t){let n=e(i),a=s.get(n);a?a.push(i):s.set(n,[i])}return s}u(Ze,"groupBy");function Tt(t){return(e,s)=>{let i=t(e),n=t(s);return i<n?-1:i===n?0:1}}u(Tt,"sortBy");function St(t){return t.reduce((e,s)=>e+s,0)}u(St,"sum");function et(t,e){return t.has(e)}u(et,"setHasElement");function Et(t,e){let s={name:t,label:game.i18n.localize(e[t]??t)};return Xe(CONFIG.PF2E.traitsDescriptions,t)&&(s.description=CONFIG.PF2E.traitsDescriptions[t]),s}u(Et,"traitSlugToObject");var ce={compact:t=>t.filter(Boolean),pick:(t,e)=>t==null?{}:e.reduce((s,i)=>(i in t&&(s[i]=t[i]),s),{}),groupBy:(...t)=>Dt($s(!1),t),omit:(...t)=>Dt(Rs,t)};function Dt(t,e,s){let i=t.length-e.length,n=Array.from(e);if(i===0)return t(...n);if(i===1){let a=u(o=>t(o,...n),"ret");return(s||t.lazy)&&(a.lazy=s||t.lazy,a.lazyArgs=e),a}throw new Error("Wrong number of arguments")}u(Dt,"purry");var $s=u(t=>(e,s)=>{let i={};return e.forEach((n,a)=>{let o=t?s(n,a,e):s(n);if(o!==void 0){let l=String(o);i[l]||(i[l]=[]),i[l].push(n)}}),i},"_groupBy");function Ns(t){let e={};for(let[s,i]of t)e[s]=i;return e}u(Ns,"fromPairs");function Rs(t,e){if(e.length===0)return{...t};if(e.length===1){let[i]=e,{[i]:n,...a}=t;return a}if(!e.some(i=>i in t))return{...t};let s=new Set(e);return Ns(Object.entries(t).filter(([i])=>!s.has(i)))}u(Rs,"_omit");var q={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},Ot={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function At(t,e){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+t,0,3)}}u(At,"adjustDegreeOfSuccess");function Ne(t,e){return t===20?At(Ot.INCREASE,e):t===1?At(Ot.LOWER,e):e}u(Ne,"adjustDegreeByDieValue");function Ft(t,e,s){return t-s>=10?Ne(e,q.CRITICAL_SUCCESS):s-t>=10?Ne(e,q.CRITICAL_FAILURE):t>=s?Ne(e,q.SUCCESS):Ne(e,q.FAILURE)}u(Ft,"calculateDegreeOfSuccess");var Lt=[4,6,8,10,12],_s=["criticalFailure","failure","success","criticalSuccess"],Mt=new Set(["persistent","precision","splash"]),Ie={DOUBLE_ON_CRIT:null,CRITICAL_ONLY:!0,DONT_DOUBLE_ON_CRIT:!1},Se=class{static async roll(e,s,i){let n=de(),a=s.outcome??null;s.rollMode??=(s.secret?"blindroll":void 0)??game.settings.get("core","rollMode"),s.createMessage??=!0,s.options.has("secret")&&(s.secret=!0);let o=a?s.sourceType==="attack"?game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${a}`):game.i18n.localize(`PF2E.Check.Result.Degree.Check.${a}`):null,l=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{title:e.name,subtitle:o});if(e.traits){let T=u((Y,{labels:he={},descriptions:Z={},cssClass:xe,dataAttr:we})=>Y.map(ee=>({value:ee,label:game.i18n.localize(he[ee]??"")})).sort((ee,ke)=>ee.label.localeCompare(ke.label)).map(ee=>{let ke=Z[ee.value]??"",oe=document.createElement("span");return oe.className="tag",xe&&oe.classList.add(xe),oe.dataset[we]=ee.value,oe.dataset.description=ke,oe.innerText=ee.label,oe.outerHTML}).join(""),"toTags"),H=T(e.traits,{labels:CONFIG.PF2E.actionTraits,descriptions:CONFIG.PF2E.traitsDescriptions,cssClass:null,dataAttr:"trait"}),S=s.self?.item,j=S?.isOfType("weapon","melee","spell")?T(Array.from(S.traits).filter(Y=>!(Y in CONFIG.PF2E.materialDamageEffects)),{labels:S.isOfType("spell")?CONFIG.PF2E.spellTraits:CONFIG.PF2E.npcAttackTraits,descriptions:CONFIG.PF2E.traitsDescriptions,cssClass:"tag_alt",dataAttr:"trait"}):"",J=(()=>{let Y=S?.isOfType("action","melee","weapon")?S.range:null,he=Ks(Y);if(he&&(Y?.increment||Y?.max)){let Z=Y.increment?`range-increment-${Y.increment}`:`range-${Y.max}`;return T([Z],{labels:{[Z]:he},descriptions:{[Z]:"PF2E.Item.Weapon.RangeIncrementN.Hint"},cssClass:"tag_secondary",dataAttr:"slug"})}else return""})(),ge=T(e.materials,{labels:CONFIG.PF2E.preciousMaterials,descriptions:CONFIG.PF2E.traitsDescriptions,cssClass:"tag_material",dataAttr:"material"}),be=[j,J,ge].join("");l+=be.length>0?`<div class="tags">${H}<hr class="vr" />${be}</div><hr>`:`<div class="tags">${H}</div><hr>`}let c=(Array.isArray(e.damage.breakdown)?e.damage.breakdown:e.damage.breakdown[a??"success"]).map(T=>`<span class="tag tag_transparent">${T}</span>`);l+=`<div class="tags">${c.join("")}</div>`;let d=await(()=>{let T=e.damage;if("roll"in T)return T.roll.evaluate({async:!0});let H=deepClone(T.formula[a??"success"]);if(!H)return ui.notifications.error(game.i18n.format("PF2E.UI.noDamageInfoForOutcome",{outcome:a})),null;let S=game.userId,j=a?_s.indexOf(a):null,J=game.settings.get("pf2e","critRule")==="doubledamage"?"double-damage":"double-dice",ge={rollerId:S,damage:e,degreeOfSuccess:j,ignoredResistances:T.ignoredResistances,critRule:J};return new n(H,{},ge).evaluate({async:!0})})();if(d===null)return null;let m=[...s.self?.actor?Vs(s.self?.actor.synthetics.rollNotes,s.domains??[]):[],...e.notes],g=m.filter(T=>(T.outcome.length===0||a&&T.outcome.includes(a))&&T.predicate.test(s.options)),f=(s.self?.item??s.self?.actor)?.getRollData()??{},k=(await Promise.all(g.map(async T=>await TextEditor.enrichHTML(T.text,{rollData:f,async:!0})))).join(`
`);l+=k;let{self:h,target:w}=s,b=h?.item??null,v=w?{actor:w.actor.uuid,token:w.token.uuid}:null,O=(()=>{if(b?.isOfType("melee","weapon")&&b&&h?.actor?.isOfType("character","npc")){let H=h.actor.system.actions,S=H.find(j=>j.item?.id===b.id&&j.item.slug===b.slug);if(S)return{actor:h.actor.uuid,index:H.indexOf(S),damaging:!0,name:S.item.name,altUsage:b.isOfType("weapon")?b.altUsageType:null}}return null})(),M=s.rollMode??"roll",F={type:s.type,sourceType:s.sourceType,actor:s.self?.actor.id??null,token:s.self?.token?.id??null,target:v,domains:s.domains??[],options:Array.from(s.options).sort(),mapIncreases:s.mapIncreases,notes:m.map(T=>T.toObject()),secret:s.secret??!1,rollMode:M,traits:s.traits??[],skipDialog:s.skipDialog??!game.user.settings.showRollDialogs,outcome:a,unadjustedOutcome:s.unadjustedOutcome??null},L=Q(),R=await d.toMessage({speaker:L.getSpeaker({actor:h?.actor,token:h?.token}),flavor:l,flags:{pf2e:{context:F,target:v,modifiers:e.modifiers?.map(T=>T.toObject())??[],origin:b?.getOriginData(),strike:O,preformatted:"both"}}},{create:!1}),G=await(async()=>{let T=d.instances.map(S=>({damageType:S.type,total:S.componentTotal("splash")})).filter(S=>S.total>0),H=[];for(let S of T){let j=`(${S.total}[splash])[${S.damageType}]`,J=await new n(j).evaluate({async:!0});J.options.splashOnly=!0,H.push(J.toJSON())}return H})();return s.createMessage&&(R.rolls.push(...G),await L.create(R,{rollMode:M})),Hooks.callAll("pf2e.damageRoll",d),i&&i(d),d}};u(Se,"DamagePF2e");async function $t(t,e){let s=de(),{name:i,actor:n,item:a,traits:o,extraRollOptions:l}=e;try{let r=a?.getRollData()??n?.getRollData()??{};r.actor??={level:(a&&"level"in a?a.level:null)??1};let c=js(new s(t,r)),d=ce.compact(["damage","inline-damage",a?`${a.id}-inline-damage`:null,a?`${Ce(a.slug??a.name)}-inline-damage`:null,e.domains]).flat(),p=new Set([...n?.getRollOptions(d)??[],...a?.getRollOptions("item")??[],...o??[],...l??[]]),m=c.at(0);if(m&&n?.isOfType("npc")&&(n.isElite||n.isWeak)){let F=p.has("item:frequency:limited")?4:2;m.terms?.push({dice:null,modifier:n.isElite?F:-F})}let{modifiers:g,dice:f}=(()=>n instanceof Actor?zs(n,d,{resolvables:r??{},test:p}):{modifiers:[],dice:[]})(),k={base:c,modifiers:g,dice:f,ignoredResistances:[]},h=!!o?.includes("attack"),w={type:"damage-roll",sourceType:h?"attack":"save",outcome:h?"success":null,domains:d,options:p,self:(()=>n?{actor:n,token:n.token,item:a||null,statistic:null,modifiers:g}:null)()};Bs(c,f);let{formula:b,breakdown:v}=Us(k),O=new s(b);return{template:{name:i??a?.name??n?.name??"",damage:{roll:O,breakdown:v},modifiers:[...g,...f],traits:o?.filter(F=>F in CONFIG.PF2E.actionTraits)??[],notes:[],materials:[]},context:w}}catch(r){return console.error(`Failed to parse inline @Damage ${t}:`,r),null}}u($t,"augmentInlineDamageRoll");function Us(t,e=q.SUCCESS){if(t=deepClone(t),e===q.CRITICAL_FAILURE)return null;e===q.FAILURE&&(t.dice=t.dice.filter(c=>c.category==="splash"),t.modifiers=t.modifiers.filter(c=>c.damageCategory==="splash"));let s=e===q.CRITICAL_SUCCESS;if(!t.base.length)return null;let i=new Map;for(let c of t.base){let d=i.get(c.damageType)??[];if(i.set(c.damageType,d),c.terms)d.push(...c.terms.map(p=>({...c,...p,label:null,critical:null})));else if(c.diceNumber&&c.dieSize||c.modifier){let{diceNumber:p,dieSize:m,damageType:g}=c,f=c.modifier??0,k=(()=>{let h=p?`${p}${m}`:null;if(!h)return String(f);let w=f?Math.abs(f):null,b=f<0?" - ":" + ";return[h,w].filter(v=>v!==null).join(b)})();d.push({label:k,dice:p&&m?{number:p,faces:Number(m.replace("d",""))}:null,modifier:f,critical:null,damageType:g,category:c.category,materials:c.materials??[]})}}let n=["PF2E.ConditionTypePersistent"].map(c=>game.i18n.localize(c)),a=u(c=>s||c.critical!==!0,"outcomeMatches");for(let c of t.dice.filter(d=>d.enabled&&a(d))){let d=t.base.find(f=>f.damageType===c.damageType)??t.base[0],p=Number(d.dieSize?.replace("d",""))||d.terms?.[0].dice?.faces,m=Number(c.dieSize?.replace("d",""))||p||null,g=c.damageType??d.damageType;if(c.diceNumber>0&&m){let f=i.get(g)??[];f.push({label:n.includes(c.label)?null:`${c.label} +${c.diceNumber}d${m}`,dice:{number:c.diceNumber,faces:m},modifier:0,damageType:g,category:c.category,critical:c.critical}),i.set(g,f)}}for(let c of t.modifiers.filter(d=>d.enabled&&a(d))){let d=t.base.find(g=>g.damageType===c.damageType)??t.base[0],p=c.damageType??d.damageType,m=i.get(p)??[];m.push({label:n.includes(c.label)?null:`${c.label} ${addSign(c.value)}`,dice:null,modifier:c.value,damageType:p,category:c.damageCategory,critical:c.critical}),i.set(p,m)}let o=[xt(i,{degree:e}),xt(i,{degree:e,persistent:!0})].flat(),l=o.map(c=>c.formula).join(","),r=o.flatMap(c=>c.breakdown);return{formula:`{${l}}`,breakdown:r}}u(Us,"createDamageFormula");function xt(t,{degree:e,persistent:s=!1}){return Array.from(t.entries()).flatMap(([i,n])=>{let a=n.filter(f=>f.category==="persistent"===s);if(a.length===0)return[];let o=Ze(a,f=>f.category),l=(()=>{let f=e===q.CRITICAL_SUCCESS?[Ie.DOUBLE_ON_CRIT]:[Ie.DOUBLE_ON_CRIT,Ie.DONT_DOUBLE_ON_CRIT],k=e===q.CRITICAL_SUCCESS&&f.includes(null)&&game.settings.get("pf2e","critRule")==="doubledice",h=e===q.CRITICAL_SUCCESS&&!k;return tt(Pt(o,{criticalInclusion:f,doubleDice:k}),{double:h})})(),r=(()=>{if(e!==q.CRITICAL_SUCCESS)return null;let f=[Ie.CRITICAL_ONLY,Ie.DONT_DOUBLE_ON_CRIT];return tt(Pt(o,{criticalInclusion:f}))})(),c=tt(e?[l,r]:[l]),d=Hs(c)||"0";if(d==="0"&&s)return[];let p=(()=>{let f=i==="untyped"&&!s?[]:[i],k=s?["persistent"]:[],h=n.flatMap(b=>b.materials??[]),w=[f,k,h].flat().join(",");return w.length>0?`[${w}]`:""})(),m=(()=>{let k=[null,"persistent","precision","splash"].flatMap(v=>{let O=o.get(v)??[],M=O.filter(L=>L.label!==null),F=O.filter(L=>L.label===null&&(L.modifier||L.dice?.number||O.every(R=>R.label===null)));if(F.length){let L=v==="splash"?` ${game.i18n.localize("PF2E.Damage.RollFlavor.splash")}`:"",R=Nt(F)+L;M.unshift({...F[0],label:R})}return M}),h=k.filter(v=>v.critical!==!0);if(e===q.CRITICAL_SUCCESS&&h.push(...k.filter(v=>v.critical===!0)),!h.length)return[];let w=h[0].category==="persistent"?game.i18n.format("PF2E.Damage.PersistentTooltip",{damageType:game.i18n.localize(CONFIG.PF2E.damageTypes[i]??i)}):game.i18n.localize(CONFIG.PF2E.damageTypes[i]??i),b=h.map(v=>v.label);return b[0]=`${b[0].replace(/^\s+\+/,"")} ${w}`,b})(),g=d&&p?`${d}${p}`:d;return g?{formula:g,breakdown:m}:[]})}u(xt,"instancesFromTypeMap");function Nt(t,{doubleDice:e}={}){t=Rt(t);let s=t.find(o=>!!o.modifier)?.modifier??0;return[t.filter(o=>!!o.dice&&o.dice.number>0).map(o=>{let l=e?o.dice.number*2:o.dice.number,r=o.dice.faces;return e?`(${l}d${r}[doubled])`:`${l}d${r}`}).join(" + "),Math.abs(s)].filter(o=>!!o).map(o=>typeof o=="number"&&e?`2 * ${o}`:o).join(s>0?" + ":" - ")||"0"}u(Nt,"createSimpleFormula");function Rt(t){let e=t.reduce((l,r)=>l+r.modifier,0),s=e?{dice:null,modifier:e}:null,i=t.filter(l=>!!l.dice&&l.dice.number>0).sort(Tt(l=>-l.dice.faces)),a=[...Ze(i,l=>l.dice.faces).values()].map(l=>({modifier:0,dice:{...l[0].dice,number:St(l.map(r=>r.dice.number))}})),o=ce.compact([...a,s]);return o.length?o:[{dice:null,modifier:0}]}u(Rt,"combinePartialTerms");function Hs(t){if(!t)return null;let e=/^\(.*\)$/.test(t),s=/^\d+(d\d+)?$/.test(t);return e||s?t:`(${t})`}u(Hs,"ensureValidFormulaHead");function Pt(t,{criticalInclusion:e,doubleDice:s=!1}){return[null,"persistent","precision","splash"].flatMap(n=>{let a=(t.get(n)??[]).filter(r=>e.includes(r.critical)),o=(()=>{let r=Nt(a,{doubleDice:s});return r==="0"?"":["precision","splash"].includes(n??"")&&_t(r)?`(${r})`:r})();return(o&&n&&n!=="persistent"?`${o}[${n}]`:o)||[]})}u(Pt,"createPartialFormulas");function tt(t,{double:e=!1}={}){if(t.every(n=>!n))return null;let s=t.filter(n=>!!n).join(" + ")||null,i=e&&_t(s)?`(${s})`:s;return e?`2 * ${i}`:i}u(tt,"sumExpression");function _t(t){return/[-+*/]/.test(t??"")}u(_t,"hasOperators");function js(t){function e(s,{category:i=null}={}){if(i=et(Mt,s.options.flavor)?s.options.flavor:i,Te(s,"Grouping"))return e(s.term,{category:i});if(Te(s,"Die"))return[{dice:ce.pick(s,["number","faces"]),modifier:0,category:i}];if(Te(s,"IntermediateDie")){if(typeof s.number!="number"||typeof s.faces!="number")throw te("Unable to parse DamageRoll with non-deterministic intermediate expressions.");return[{dice:{number:s.number,faces:s.faces},modifier:0,category:i}]}if(s.isDeterministic)return[{dice:null,modifier:ht().getValue(s,"expected"),category:i}];if(Te(s,"ArithmeticExpression")){let n=s.operator;if(n==="*"||n==="/")throw te(`Cannot use ${n} on non-deterministic artithmetic terms`);let a=e(s.operands[0],{category:i}),o=e(s.operands[1],{category:i});if(n==="-")for(let r of o)r.dice&&(r.dice.number*=-1),r.modifier*=-1;let l=ce.groupBy([...a,...o],r=>r.category??"");return Object.values(l).flatMap(r=>{let c=r[0].category;return Rt(r).map(d=>({...d,category:c}))})}throw s.isDeterministic?te("Unrecognized roll term type "+s.constructor.name):te(`Unable to parse DamageRoll with non-deterministic ${s.constructor.name}.`)}return u(e,"recursiveExtractTerms"),t.instances.flatMap(s=>{let i=et(Mt,s.category)?s.category:null,n=e(s.head,{category:i});return Object.values(ce.groupBy(n,a=>a.category??"")).map(a=>{let o=s.persistent?"persistent":a[0].category;return{damageType:s.type,category:o,terms:a.map(l=>ce.omit(l,["category"]))}})})}u(js,"extractBaseDamage");function Bs(t,e){let s=e.filter(i=>!i.ignored&&!!i.override);if(s.length)for(let i of t)for(let n of s){let a=i.terms?.find(o=>!!o.dice);if(!(!a||n.damageType&&n.damageType!==i.damageType)){if(a.dice.number=n.override.diceNumber??a.dice.number,n.override.dieSize){let o=Number(/\d{1,2}/.exec(n.override.dieSize)?.shift());Number.isInteger(o)&&(a.dice.faces=o)}else if(n.override.upgrade||n.override.downgrade){let o=n.override.upgrade?1:-1;a.dice.faces=Lt[Lt.indexOf(a.dice.faces)+o]??a.dice.faces}}}}u(Bs,"applyDamageDiceOverrides");function zs(t,e,s){let i=Ws(t.synthetics,e,s),n=Gs(t.synthetics.damageDice,e,s),a=ce.groupBy([s.extraModifiers??[],i].flat(),l=>l.category==="persistent"?"persistent":"main");return{modifiers:[...new game.pf2e.StatisticModifier("damage",a.main??[],s.test).modifiers,...new game.pf2e.StatisticModifier("persistent",a.persistent??[],s.test).modifiers],dice:n}}u(zs,"extractDamageSynthetics");function Gs(t,e,s){return e.flatMap(i=>t[i]??[]).flatMap(i=>i(s)??[])}u(Gs,"extractDamageDice");function Ws(t,e,s={}){let{modifierAdjustments:i,modifiers:n}=t,a=Array.from(new Set(e)).flatMap(o=>n[o]??[]).flatMap(o=>o(s)??[]);for(let o of a)o.adjustments=qs(i,e,o.slug);return a}u(Ws,"extractModifiers");function qs(t,e,s){return Array.from(new Set(e.flatMap(n=>t[n]??[]))).filter(n=>[s,null].includes(n.slug))}u(qs,"extractModifierAdjustments");function Ks(t){if(!t?.max)return null;let[e,s]=t.increment?["PF2E.Action.Range.IncrementN",t.increment]:["PF2E.Action.Range.MaxN",t.max];return game.i18n.format(e,{n:s})}u(Ks,"createActionRangeLabel");function Vs(t,e){return e.flatMap(s=>(t[s]??[]).map(i=>i.clone()))}u(Vs,"extractNotes");var Js=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),Ys=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function Qs(t,e="normal"){return t+(Js.get(e)??0)}u(Qs,"adjustDC");function Xs(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}u(Xs,"rarityToDCAdjustment");function Re(t,e="common"){return Qs(t,Xs(e))}u(Re,"adjustDCByRarity");function _e(t,{proficiencyWithoutLevel:e,rarity:s="common"}={}){let i=game.settings.get("pf2e","proficiencyVariant");e??=i==="ProficiencyWithoutLevel";let n=Ys.get(t)??14;return Re(e?n-Math.max(t,0):n,s)}u(_e,"calculateDC");function Ee(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}u(Ee,"htmlQueryAll");function st(t,e){return t instanceof Element?t.closest(e):null}u(st,"htmlClosest");function Zs(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}u(Zs,"isRelevantEvent");function De(t){let e=!game.user.settings.showRollDialogs;if(!Zs(t))return{skipDialog:e};let s={skipDialog:t.shiftKey?!e:e};return(t.ctrlKey||t.metaKey)&&(s.rollMode=game.user.isGM?"gmroll":"blindroll"),s}u(De,"eventToRollParams");var ei=["fortitude","reflex","will"],Ht=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(",");function ti(t,e){for(let s of t){(!e||e.isOwner)&&s.classList.add("with-repost");let i=Ee(s,"i[data-pf2-repost]");if(i.length>0){if(e&&!e.isOwner){for(let o of i)o.remove();s.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let n=document.createElement("i"),a=s.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";n.classList.add("fa-solid",a),n.dataset.pf2Repost="",n.title=game.i18n.localize("PF2E.Repost"),s.appendChild(n),n.addEventListener("click",o=>{o.stopPropagation();let l=o.target;if(!(l instanceof HTMLElement))return;let r=l?.parentElement;if(!r)return;let c=jt(l,e);ii(r,c)})}}u(ti,"injectRepostElement");function si(t,e=null){for(let s of Ee(t,"a.inline-roll[data-damage-roll]")){let i=st(s,"[data-item-id]")?.dataset.itemId,n=e?.items.get(i??"");n&&(s.dataset.flavor||=n.name)}}u(si,"flavorDamageRolls");function Ut(t,e){let s=t.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${t.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${s}</span> ${t.outerHTML}`.trim()}u(Ut,"makeRepostHtml");function ii(t,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(c=>c in t.dataset))return;let s=it(e),i=(s??e)?.hasPlayerOwner?"all":"gm",n=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${Ee(t.parentElement,Ht).map(d=>Ut(d,i)).join("<br>")}</div>`:Ut(t,i))(),a=Q(),o=s?a.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0).shift()}):a.getSpeaker(),l=game.messages.get(st(t,"[data-message-id]")?.dataset.messageId??""),r=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:l?.flags.pf2e.origin?{pf2e:{origin:deepClone(l.flags.pf2e.origin)}}:{};a.create({speaker:o,content:n,flags:r})}u(ii,"repostAction");function Ue(t,e){e??=jt(t,e);let s=Ee(t,Ht).filter(n=>["A","SPAN"].includes(n.nodeName));ti(s,e),si(t,e instanceof Actor?e:null);for(let n of s.filter(a=>a.dataset.pf2Action)){let{pf2Action:a,pf2Glyph:o,pf2Variant:l,pf2Dc:r,pf2ShowDc:c,pf2Skill:d}=n.dataset;n.addEventListener("click",p=>{let m=game.pf2e.actions[a?Ce(a,{camel:"dromedary"}):""],g=c??"all";a&&m?m({event:p,glyph:o,variant:l,difficultyClass:r?{scope:"check",value:Number(r)||0,visibility:g}:void 0,skill:d}):console.warn(`PF2e System | Skip executing unknown action '${a}'`)})}for(let n of s.filter(a=>a.dataset.pf2Check&&!a.dataset.invalid)){let{pf2Check:a,pf2Dc:o,pf2Traits:l,pf2Label:r,pf2Defense:c,pf2Adjustment:d,pf2Roller:p,pf2RollOptions:m}=n.dataset;if(!a)return;n.addEventListener("click",async g=>{let f=it(e),k=[f],h=[...l?.split(",").map(b=>b.trim())??[],...m?.split(",").map(b=>b.trim())??[]],w=De(g);switch(a){case"flat":{for(let b of k){let v=new Statistic(b,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),O=Number.isInteger(Number(o))?{label:r,value:Number(o)}:null;v.roll({...w,extraRollOptions:h,dc:O})}break}default:{let b=vt(ei,a),v=b?[]:h.filter(O=>O in CONFIG.PF2E.actionTraits)??[];for(let O of k){let M=(()=>{if(a in CONFIG.PF2E.magicTraditions){let S=O.spellcasting.filter(j=>j.tradition===a).flatMap(j=>j.statistic??[]).sort((j,J)=>J.check.mod-j.check.mod).shift()??null;if(S)return S}return O.getStatistic(a)})();if(!M){console.warn(te(`Skip rolling unknown statistic ${a}`).message);continue}let F=c?game.user.targets.first()?.actor:null,L=(()=>{let S=Number(d)||0;return o==="@self.level"?_e(O.level)+S:Number(o??"NaN")+S})(),R=(()=>{if(Number.isInteger(L))return{label:r,value:L};if(c){let S=F?.getStatistic(c);return S?{statistic:S.dc,scope:"check",value:S.dc.value}:null}return null})(),G=(()=>{let S=e instanceof Item?e:e instanceof ChatMessage?e.item:null;return S?.isOfType("action","feat")||b&&!S?.isOfType("weapon")?S:null})(),T={...w,extraRollOptions:h,origin:b&&f instanceof Actor?f:null,dc:R,target:!b&&R?.statistic?F:null,item:G,traits:v};if(!!(G?.isOfType("action","feat")&&G.actionCost)&&c){let S=a in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":M.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";T.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:$e(G.actionCost),subtitle:game.i18n.format(S,{type:M.label}),title:G.name})}M.roll(T)}}}})}let i={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"};for(let n of s.filter(a=>a.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:a,pf2Distance:o,pf2TemplateData:l,pf2Traits:r,pf2Width:c}=n.dataset;n.addEventListener("click",()=>{if(typeof a!="string"){console.warn("PF2e System | Could not create template'");return}let d=JSON.parse(l??"{}");switch(d.distance||=Number(o),d.fillColor||=game.user.color,d.t=i[a],d.t){case"ray":d.width=Number(c)||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":d.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let m=d.distance??0;d.distance=Math.hypot(m,m),d.width=m,d.direction=45;break}}r&&(d.flags={pf2e:{origin:{traits:r.split(",")}}});let p=new(yt())(d,{parent:canvas.scene});new(bt())(p).drawPreview()})}for(let n of t.querySelectorAll("a[data-damage-roll]"))n.addEventListener("click",async a=>{a.stopImmediatePropagation();let{pf2ItemId:o,flavor:l,mode:r,pf2BaseFormula:c,pf2Traits:d,pf2Domains:p,pf2RollOptions:m,formula:g}=a.currentTarget.dataset,f=it(e),k=f.items.get(o)?.getRollData()??f.getRollData(),h=l?{flavor:l}:{},w=Q().getSpeaker({actor:f}),b=Xe(CONFIG.Dice.rollModes,r)?r:"roll";if(c){let O=k.item instanceof Item?k.item:null,M=d?.split(",")??[],F=p?.split(","),L=m?.split(",")??[],R=await $t(c,{...De(a),actor:f,item:O,domains:F,traits:M,extraRollOptions:L});R&&await Se.roll(R.template,R.context);return}let v=new(de())(g,k,h);return v.toMessage({speaker:w,flavor:v.options.flavor},{rollMode:b})})}u(Ue,"listenInlineRoll");function jt(t,e){if(e)return e;let i=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return i instanceof Actor||i instanceof JournalEntry?i:null}u(jt,"resolveDocument");function it(t){return t instanceof Actor?t:t instanceof Item||t instanceof ChatMessage?t.actor:null}u(it,"resolveActor");var He=["U","T","E","M","L"];async function Bt(t,e){let s=t.data(),i=s.itemId?e.items.get(s.itemId):await fromUuid(s.uuid),n=await i?.getChatData({secrets:e.isOwner},s);if(!n)return;let a=document.createElement("div");return a.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(a,i,n),Ue(a,i),a}u(Bt,"getItemSummary");function se(t){t.on("mouseenter",e=>{e.preventDefault();let s=e.currentTarget.querySelector(".name"),{width:i}=s.getBoundingClientRect();if(s.scrollWidth<=Math.ceil(i))return;let n=s.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:n})}),t.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),t.on("mousedown",e=>{game.tooltip.deactivate()})}u(se,"addNameTooltipListeners");function zt(t,e){t.preventDefault(),K(t,e)?.sheet.render(!0,{focus:!0})}u(zt,"editItem");async function Gt(t,e){t.preventDefault();let s=K(t,e);if(s){if(t.ctrlKey)return s.delete();new Dialog({title:E("deleteItem.title"),content:await renderTemplate("systems/pf2e/templates/actors/delete-item-dialog.hbs",{name:s.name}),buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:E("deleteItem.ok"),callback:()=>s.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:E("deleteItem.cancel")}}}).render(!0)}}u(Gt,"deleteItem");function K(t,e){let{itemId:s}=t.currentTarget.closest("[data-item-id]").dataset;return e.items.get(s)}u(K,"getItemFromEvent");function je(t){return t.isOwner?ne(t,`macros.${game.user.id}`)?.map(e=>{let s=fromUuidSync(e);return s?{img:s.img,name:s.name,uuid:e}:null}).filter(Boolean):void 0}u(je,"getMacros");function Be(t,e){let{type:s,uuid:i}=TextEditor.getDragEventData(t.originalEvent)??{};if(s!=="Macro"||!fromUuidSync(i))return;let n=`macros.${game.user.id}`,a=ne(e,n)?.slice()??[];a.includes(i)||(a.push(i),pe(e,n,a))}u(Be,"onDroppedMacro");function ze(t,e){let s=`macros.${game.user.id}`,i=ne(e,s)?.slice();if(!i?.length)return;let{uuid:n}=t.currentTarget.closest(".macro").dataset,a=i.indexOf(n);a!==-1&&(i.splice(a,1),pe(e,s,i))}u(ze,"deleteMacro");function Ge(t=()=>!0){let e=game.user.targets,s=e.size===1?e.first():null;return s&&t(s)?s:null}u(Ge,"getUniqueTarget");function B(t,e){return e?t.toLowerCase().includes(e):!0}u(B,"filterIn");function z(t,e){return t.localeCompare(e,game.i18n.lang)}u(z,"localeCompare");async function me(t,e,s){let i=ae(),n=i?.element;if(!n)return;n.find("> .popup").remove();let a=document.createElement("div");a.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${E("popup.close")}</a>
    </div>
</div>`;let o=a.firstElementChild;typeof e=="string"?(e=await ue(e,s),o.insertAdjacentHTML("beforeend",e)):o.append(e),o.querySelector("[data-action=close-popup]").addEventListener("click",()=>o.remove()),n.append(o),i.lock()}u(me,"popup");async function V(t,e,s){s??=t.find(".name").html();let i=await Bt(t,e);i&&me(s.trim(),i,e)}u(V,"showItemSummary");async function We(t,e,s,{rollMode:i=void 0,create:n=!0,data:a={}}){let o=`systems/pf2e/templates/chat/${e.type}-card.hbs`,l=s.token,r=t?.currentTarget.closest(".item")??{},c=Q(),d=Object.keys(a).length>0?a:r.dataset||{},p={actor:s,tokenId:l?`${l.parent?.id}.${l.id}`:null,item:e,data:await e.getChatData(void 0,d)},m={speaker:c.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return i??=t?.ctrlKey||t?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(i)&&(m.whisper=c.getWhisperRecipients("GM").map(g=>g.id)),i==="blindroll"&&(m.blind=!0),m.content=await renderTemplate(o,p),n?c.create(m,{renderSheet:!1}):new c(m)}u(We,"unownedItemToMessage");async function Wt(t){if(!t.system.selfEffect)throw te(["Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.","Support will be expanded at a later time."].join(" "));let{actor:e,actionCost:s}=t,i=e.getActiveTokens(!0,!0).shift()??null,n=Q(),a=n.getSpeaker({actor:e,token:i}),o=await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{glyph:$e(s),title:t.name},item:t,traits:t.system.traits.value.map(m=>Et(m,CONFIG.PF2E.actionTraits))}),l=100,r=(()=>{if(t.actor.pack)return null;let m=document.createElement("div"),g=[...CONST.DOCUMENT_LINK_TYPES,"Compendium","UUID"],f=new RegExp(`@(${g.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return m.innerHTML=t.description.replace(f,(k,...h)=>h[3]),m.innerText.slice(0,l)})(),c={full:r&&r.length<l?t.description:null,preview:r},d=await renderTemplate("systems/pf2e/templates/chat/action/self-effect.hbs",{actor:t.actor,description:c}),p={pf2e:{context:{type:"self-effect",item:t.id}}};return n.create({speaker:a,flavor:o,content:d,flags:p})}u(Wt,"createSelfEffectMessage");async function qt({weapon:t,trait:e,selection:s}){if(t.system.traits.toggles[e].selection===s)return!1;let n=t.actor?.items.get(t.id);return n?.isOfType("weapon")&&n===t?await n.update({[`system.traits.toggles.${e}.selection`]:s}):n?.isOfType("weapon")&&t.altUsageType==="melee"?await n.update({[`system.meleeUsage.traitToggles.${e}`]:s}):await n?.rules.find(o=>o.key==="Strike"&&!o.ignored&&o.slug===t.slug)?.toggleTrait({trait:e,selection:s}),!0}u(qt,"toggleWeaponTrait");var ni=["arcana","crafting","medicine","nature","occultism","religion","society"],Kt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function Vt(t){let s=(await new Roll("1d20").evaluate({async:!0})).dice[0].total,i=s===1?"0":s===20?"3":"",n=Object.values(t.skills).filter(r=>r.lore),a=Ge(r=>r.actor?.identificationDCs)?.actor,o={dieSuccess:i,dieResult:s,target:a,i18n:r=>E(`actions.recall-knowledge.${r}`)};if(a){let{standard:r,skills:c,lore:d}=a.identificationDCs,p=r.progression.slice();p.length=4,p=[...p];let m=d.map(({progression:g})=>{let f=g;return f.length=6,[...f]});o.skillsDCs=p,o.loresDCs=m,o.skills=await Promise.all(c.map(g=>{let f=t.skills[g];return nt(f,s,p)})),o.lores=await Promise.all(n.map(g=>nt(g,s)))}else o.skills=await Promise.all([...ni.map(r=>t.skills[r]),...n].map(r=>nt(r,s)));let l=await renderTemplate(U("chat/recall-knowledge"),o);ChatMessage.create({flavor:l,speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL})}u(Vt,"rollRecallKnowledges");async function nt(t,e,s){let{rank:i,label:n}=t,a=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),o=a.total-a.dice[0].total,l=e+o;return{mod:o,rank:i,label:n,total:l,modifier:X(o),rankLabel:He[i],checks:s?.map(r=>{if(!r)return"-";let c=Ft(l,e,r);return{success:c,icon:Kt[c].icon,title:Kt[c].name}})}}u(nt,"rollSkill");var ie="pf2e-token-hud",ai="Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO",oi=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),Jt="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",ri="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",at="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",li={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${ie}.skills.actions.earnIncome`,treatWounds:`${ie}.skills.actions.treatWounds`,"borrow-arcane-spell":`${ie}.skills.actions.borrow-arcane-spell`,"identify-magic":`${ie}.skills.actions.identify-magic`,"identify-alchemy":`${ie}.skills.actions.identify-alchemy`,"learn-spell":`${ie}.skills.actions.learn-spell`,"crafting-goods":`${ie}.skills.actions.crafting-goods`,"staging-performance":`${ie}.skills.actions.staging-performance`},Yt={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:Jt,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},ci={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},Oe=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&oi.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>ot(t,Jt)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>ot(t,ri)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];Oe.forEach(t=>{t.actions=t.actions.map(i=>typeof i=="string"?ci[i]:i);let{slug:e,actions:s}=t;for(let i of s){let n=i.slug.replace(/-(.)/g,(a,o)=>o.toUpperCase()).capitalize();i.skillSlug=e,i.uuid=Yt[i.slug],i.label=li[i.slug]??`PF2E.Actions.${n}.Title`,i.variants?i.variants=i.variants.map(a=>({slug:a,label:`${ie}.skills.actions.${a}`})):i.map&&(i.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),i.modifiers?.forEach(({modifiers:a})=>{a.forEach(o=>{o.label=`${ie}.skills.modifiers.${o.slug}`})})}});var rt=Oe.map(t=>t.slug),di=Oe.reduce((t,{slug:e,actions:s})=>(t[e]={slug:e,actions:s.reduce((i,n)=>(i[n.slug]=n,i),{})},t),{}),Qt=new Set(Object.values(Yt).filter(Boolean));function lt(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}u(lt,"getSkillLabel");async function Xt(t,e,s){let i=[],n=t.isOfType("character"),a=n&&C("untrained")&&!t.itemTypes.feat.some(r=>r.sourceId===ai);for(let r=0;r<Oe.length;r++){let{slug:c,actions:d}=Oe[r],{label:p,rank:m,mod:g}=t.getStatistic(c),f=game.i18n.localize(p),k=d.filter(({condition:b,trained:v})=>(!a||!n||!v||t.skills[c].rank>=1)&&(!b||b(t))).map(b=>({...b,name:game.i18n.localize(b.label),variants:b.variants?.map(v=>({...v,name:game.i18n.localize(v.label)}))})),h=B(f,s),w=k;!h&&(w=k.filter(({name:b,variants:v})=>B(b,s)||v?.some(O=>B(O.name,s))),!w.length)||(i[r]={slug:c,name:f,rank:m,modifier:X(g),actions:h?k:w})}i.sort((r,c)=>r.slug==="perception"?-1:c.slug==="perception"?1:z(r.name,c.name));let o=Object.values(t.skills).filter(({lore:r,label:c})=>r&&B(c,s)).map(({label:r,rank:c,mod:d,slug:p})=>({slug:p,label:r,rank:c,modifier:X(d)})),l=o.reduce((r,c)=>c.modifier.length>r?c.modifier.length:r,2);return{contentData:{follow:E(`skills.actions.${es(t)?"following":"follow"}`),skills:i,lores:o,loresModifierWidth:l},doubled:C("skills-columns")}}u(Xt,"getSkillsData");function Zt(t,e,s){t.find("[data-action=action-description]").on("click",i=>{i.preventDefault();let n=$(i.currentTarget).closest(".action");V(n,e,n.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async i=>{i.preventDefault();let n=es(e);if(n)return await n.delete();let a=(await fromUuid(at)).toObject();setProperty(a,"flags.core.sourceId",at),await e.createEmbeddedDocuments("Item",[a])}),t.find("[data-action=roll-skill]").on("click",i=>{i.preventDefault();let{slug:n}=i.currentTarget.dataset;e.getStatistic(n)?.roll({event:i})}),t.find("[data-action=roll-action]").on("click contextmenu",async i=>{i.preventDefault();let n=$(i.currentTarget),{skillSlug:a,slug:o}=n.closest(".action").data(),{variant:l,map:r}=n.data(),c=i.type==="contextmenu"?await qe(a):void 0;c!==null&&pi({event:i,actor:e,token:s,skillSlug:a,slug:o,variant:l,map:r,skill:c?.selected})}),t.find("[data-action=action-chat]").on("click",async i=>{i.preventDefault();let{uuid:n}=i.currentTarget.closest(".action").dataset,a=await fromUuid(n);a&&We(i,a,e,{create:!0})}))}u(Zt,"addSkillsListeners");function es(t){return t.itemTypes.effect.find(e=>e.sourceId===at)}u(es,"isFollowingAnExpert");async function qe(t,e){let s=rt.map(n=>({slug:n,label:lt(n)})),i=await renderTemplate(U("dialogs/variant"),{i18n:n=>E(`skills.variant.${n}`),dc:e,skills:s,selected:t});return Dialog.prompt({title:E("skills.variant.title"),label:E("skills.variant.button"),callback:n=>({selected:n.find("select").val(),dc:n.find("input").val()}),rejectClose:!1,content:i,options:{width:280}})}u(qe,"variantsDialog");function pi({event:t,actor:e,skillSlug:s,slug:i,variant:n,map:a,skill:o,token:l}){let r=di[s].actions[i],c=r.type;o??=r.noSkill?void 0:s;let d=r.rollOption?[`action:${r.rollOption}`]:void 0;d&&n&&d.push(`action:${r.rollOption}:${n}`);let p={event:t,actors:[e],tokens:[l],variant:n,rollOptions:d,rollMode:r.secret?"blindroll":"roll"};if(p.modifiers=[],r.modifiers){for(let{condition:m,modifiers:g}of r.modifiers)if(!(m&&!m(e)))for(let f of g)p.modifiers.push(new game.pf2e.Modifier(f))}if(r.custom){r.custom(e,p);return}else if(!c){e.getStatistic(o)?.roll(p);return}c===1?(p.skill=o,a&&p.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:a})),game.pf2e.actions[i](p)):c===2?(p.statistic=o,a&&(p.multipleAttackPenalty=a/-5),game.pf2e.actions.get(i).use(p)):c===3&&game.pf2e.actions[i](e)}u(pi,"rollAction");var ct={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function ts(t,e,s){let{attributes:i}=t,{initiative:n}=i;return{contentData:{noMacro:E("extras.no-macro"),macros:je(t)?.filter(a=>B(a.name,s)),initiative:n&&{selected:n.statistic,skills:rt.map(a=>({slug:a,label:lt(a)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:ct}}}u(ts,"getExtrasData");function ss(t,e,s){function i(a,o,l="click"){t.find(`[data-action=${a}]`).on(l,r=>{r.preventDefault(),o(r)})}if(u(i,"action"),i("action-description",a=>{let o=$(a.currentTarget).closest(".row");V(o,e)}),!e.isOwner)return;se(t.find(".macro"));async function n(a){let{uuid:o}=a.currentTarget.closest(".macro").dataset;return fromUuid(o)}u(n,"getMacro"),i("delete-macro",a=>ze(a,e)),i("edit-macro",async a=>{(await n(a))?.sheet.render(!0)}),i("use-macro",async a=>{(await n(a))?.execute({actor:e,token:s})}),t.on("drop",a=>Be(a,e)),i("action-chat",async a=>{let{uuid:o}=a.currentTarget.closest(".row").dataset,l=await fromUuid(o);l&&We(a,l,e,{create:!0})}),t.find("input[name], select[name]").on("change",async a=>{let o=a.currentTarget,l=o.type==="number"?o.valueAsNumber:o.value;await e.update({[o.name]:l})}),i("roll-initiative",async a=>{await e.initiative.roll({event:a})}),i("prepare-dailies",a=>{let o=game.modules.get("pf2e-dailies");o?.active&&o.api.openDailiesInterface(e)}),i("rest-for-the-night",a=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[s]})}),i("roll-recall-knowledge",a=>{Vt(e)}),i("roll-aid",async a=>{let o=await qe(null,20),l={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};o!==null&&game.pf2e.actions.get("aid").use({event:a,actors:[e],tokens:[s],statistic:o?.selected,difficultyClass:{value:o?.dc},notes:[l]})},"click contextmenu"),i("roll-point-out",a=>{game.pf2e.actions.get("point-out").use({event:a,actors:[e],tokens:[s]})}),i("roll-escape",async a=>{let o=a.type==="contextmenu"?await qe():void 0,l=$(a.currentTarget).data().map;o!==null&&game.pf2e.actions.get("escape").use({event:a,actors:[e],tokens:[s],statistic:o?.selected,multipleAttackPenalty:l})},"click contextmenu")}u(ss,"addExtrasListeners");var ye={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionTypeReaction",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionTypeFree",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.ActionTypePassive",actionLabel:"PF2E.ActionTypePassive"}},is={delay:[500,0],position:"top",theme:"crb-hover",arrow:!1};async function ns(t,e,s){let i=t.isOfType("character"),n=t.synthetics.toggles.slice(),a=C("actions"),o=os()?.getStances(t).sort((h,w)=>z(h.name,w.name)),l,r=game.modules.get("pf2e-hero-actions");if(r?.active&&i){let h=r.api.getHeroActions(t),w=t.heroPoints.value-h.length;l={actions:h,draw:Math.max(w,0),discard:Math.abs(Math.min(w,0)),canTrade:h.length&&game.settings.get("pf2e-hero-actions","trade")}}let c=t.isOwner,d=t.getRollData(),p=t.system.actions?await Promise.all(t.system.actions.map(async(h,w)=>({...h,index:w,visible:!i||h.visible,damageFormula:await h.damage?.({getFormula:!0}),criticalFormula:await h.critical?.({getFormula:!0}),description:h.description?await ue(h.description,t,{rollData:d,isOwner:c}):void 0,altUsages:h.altUsages&&await Promise.all(h.altUsages.map(async b=>({...b,usage:b.item.isThrown?"thrown":"melee",damageFormula:await b.damage?.({getFormula:!0}),criticalFormula:await b.critical?.({getFormula:!0})})))}))):void 0,m=i?new game.pf2e.ElementalBlast(t):void 0,g=m?(await Promise.all(m.configs.map(async h=>{let w=h.damageTypes.find(v=>v.selected)?.value??"untyped",b=u((v,O=!0)=>m.damage({element:h.element,damageType:w,melee:O,outcome:v,getFormula:!0}),"formulaFor");return{...h,damageType:w,formula:{melee:{damage:await b("success"),critical:await b("criticalSuccess")},ranged:{damage:await b("success",!1),critical:await b("criticalSuccess",!1)}}}}))).sort((h,w)=>z(h.label,w.label)):void 0,f={},k=i?fi(t):gi(t);for(let h of k)B(h.name,s)&&(a!=="split"?(f.action??=[],f.action.push(h)):(f[h.type]??=[],f[h.type].push(h)));if(f=Object.entries(f).map(([h,w])=>(w.forEach(b=>{b.img=kt(b.cost),b.typeLabel=ye[b.type].actionLabel}),a!=="type"?w.sort((b,v)=>z(b.name,v.name)):w.sort((b,v)=>{let O=ye[b.type].order,M=ye[v.type].order;return O===M?z(b.name,v.name):O-M}),{type:h,actions:w,label:ye[h].label})),a==="split"&&f.sort((h,w)=>ye[h.type].order-ye[w.type].order),n.length||o?.length||p?.length||g?.length||f.length||l?.actions.length){let h=+((o?.length??0)>0)+ +((p?.length??0)>0)+ +((g?.length??0)>0)+f.length+ +((l?.actions.length??0)>0);return{contentData:{toggles:n,stances:o,strikes:p,blasts:g,sections:f,heroActions:l,i18n:w=>E(`actions.${w}`),variantLabel:w=>w.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:h>1&&C("actions-columns"),classes:[C("actions-colors")?"attack-damage-system-colors":""]}}}u(ns,"getActionsData");function as(t,e){se(t.find(".toggle")),se(t.find(".strike")),se(t.find(".action"));function s(o,l,r="click"){return o=typeof o=="string"?[o]:o,o=o.map(c=>`[data-action=${c}]`).join(", "),t.find(o).on(r,c=>{c.preventDefault(),l(c)})}u(s,"action");function i(o){let l=o.currentTarget.closest(".strike"),r=e.system.actions[l.dataset.index];if(!r)return null;let{altUsage:c}=o.currentTarget.dataset;return["melee","thrown"].includes(c)?r.altUsages?.find(d=>c==="thrown"?d.item.isThrown:d.item.isMelee)??null:r}u(i,"getStrike");function n(o){return $(o.currentTarget).closest(".action").data().uuid}if(u(n,"getUuid"),s("action-description",async o=>{let l=$(o.currentTarget).closest(".action");V(l,e)}),s("hero-action-description",async o=>{let{description:l,name:r}=await mi(n(o))??{};l&&me(r,l,e)}),s("strike-description",async o=>{let l=i(o);if(!l)return;let r=document.createElement("div");r.classList.add("description"),r.innerHTML=await renderTemplate(U("strike-description"),l),me(l.label,r,e)}),s("blast-description",async o=>{let l=o.currentTarget.closest(".blast");V($(l),e)}),s("trait-description",o=>{let l=i(o);if(!l)return;let{index:r}=o.currentTarget.dataset,c=l.traits[r];if(!c)return;let d=game.i18n.localize(c.description);d&&me(game.i18n.localize(c.label),d,e)}),s("stance-description",o=>{let l=$(o.currentTarget).closest(".action");V(l,e)}),!e.isOwner||(s("use-action",o=>{let l=K(o,e);l?.isOfType("action","feat")&&Wt(l)}),s("stance-chat",o=>{K(o,e)?.toMessage(o,{create:!0})}),s("stance-toggle",o=>{let{effectUuid:l}=o.currentTarget.closest(".action").dataset;game.modules.get("pf2e-stances")?.api.toggleStance(e,l)}),s("action-chat",o=>{K(o,e)?.toMessage(o,{create:!0})}),s("hero-action-chat",async o=>{await game.modules.get("pf2e-hero-actions")?.api.sendActionToChat(e,n(o))}),s("draw-hero-action",async o=>{await game.modules.get("pf2e-hero-actions")?.api.drawHeroActions(e)}),s("use-hero-action",async o=>{await game.modules.get("pf2e-hero-actions")?.api.useHeroAction(e,n(o))}),s("discard-hero-action",async o=>{await game.modules.get("pf2e-hero-actions")?.api.discardHeroActions(e,n(o))}),s("trade-hero-action",async o=>{game.modules.get("pf2e-hero-actions")?.api.tradeHeroAction(e)}),s("strike-attack",o=>{let{index:l,altUsage:r}=o.currentTarget.dataset;i(o)?.variants[l].roll({event:o,altUsage:r})}),s(["strike-damage","strike-critical"],o=>{let{action:l}=o.currentTarget.dataset;i(o)?.[l==="strike-damage"?"damage":"critical"]({event:o})}).tooltipster(is),s(["toggle-roll-option","set-suboption"],o=>{let l=o.currentTarget.closest(".toggle"),{domain:r,option:c,itemId:d}=l.dataset,p=l.querySelector("select")?.value??null;e.toggleRollOption(r,c,d??null,l.querySelector("input").checked,p)}),s("strike-auxiliary",o=>{if(o.currentTarget!==o.target)return;let l=i(o);if(!l)return;let{index:r}=o.currentTarget.dataset,c=o.currentTarget.querySelector("select")?.value??null;l.auxiliaryActions?.[r]?.execute({selection:c})}),s("toggle-versatile",o=>{let l=i(o)?.item;if(!l)return;let r=o.currentTarget,{value:c}=r.dataset,d=l?.system.damage.damageType??null,p=r.classList.contains("selected")||c===d?null:c;qt({trait:"versatile",weapon:l,selection:p})}).tooltipster(is),s("strike-ammo",async o=>{let l=i(o)?.item;if(!l)return;let r=e.items.get(o.currentTarget.value);await l.update({system:{selectedAmmoId:r?.id??null}})},"change"),!e.isOfType("character")))return;let a=["roll-attack","roll-damage","set-damage-type"].map(o=>`[data-action=${o}]`).join(",");t.find(".blast").each((o,l)=>{let{element:r,damageType:c}=l.dataset,d=new game.pf2e.ElementalBlast(e);$(l).find(a).on("click",async p=>{p.preventDefault();let m=p.currentTarget.dataset,g=m.melee==="true";switch(m.action){case"roll-attack":{let f=Math.clamped(Number(m.mapIncreases),0,2);await d.attack({mapIncreases:Math.clamped(f,0,2),element:r,damageType:c,melee:g,event:p});break}case"roll-damage":{await d.damage({element:r,damageType:c,melee:g,outcome:m.outcome,event:p});break}case"set-damage-type":console.log(r,m.value),await d.setDamageType({element:r,damageType:m.value})}})})}u(as,"addActionsListeners");function os(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:void 0}u(os,"getStancesModuleApi");function mi(t){return game.modules.get("pf2e-hero-actions")?.api.getHeroActionDetails(t)}u(mi,"getHeroActionDescription");function fi(t){let e=os()?.getActionsUUIDS()??new Set,s=new Set([...e,...Qt,...Object.values(ct)]),i=t.itemTypes.action.filter(a=>!s.has(a.sourceId)),n=t.itemTypes.feat.filter(a=>a.actionCost&&!e.has(a.sourceId));return[...i,...n].filter(a=>{let o=a.system.traits.value;return!o.includes("downtime")&&!o.includes("exploration")}).map(a=>{let o=a.actionCost;return{id:a.id,type:o?.type??"free",cost:o,name:a.name,hasEffect:!!a.system.selfEffect}})}u(fi,"getCharacterActions");function gi(t){return t.itemTypes.action.map(e=>{let s=e.actionCost,i=s?.type??"passive",n=i==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(a=>a.key==="Aura"));return{id:e.id,type:i,cost:s,name:e.name,hasDeathNote:e.system.deathNote,hasAura:n,hasEffect:!!e.system.selfEffect}})}u(gi,"getNpcActions");async function rs(t){let{system:e}=t,{details:s,traits:i,attributes:n}=e,{stealth:a}=n,{description:o,disable:l,routine:r,reset:c,isComplex:d}=s,p=t.getRollData(),m=t.isOwner,g=u(async f=>ue(f,t,{isOwner:m,rollData:p}),"enrich");return{contentData:{description:await g(o),disable:await g(l),routine:await g(r),reset:await g(c),isComplex:d,rarity:{value:i.rarity,label:CONFIG.PF2E.rarityTraits[i.rarity]},traits:i.value.map(f=>CONFIG.PF2E.hazardTraits[f]),stealth:X(a.value)},style:{["--max-width"]:C("hazard-width")+"em"}}}u(rs,"getHazardData");function ls(t,e){t.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let i=$(s.currentTarget).closest(".action");V(i,e)}),Ue(t,e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",s=>{s.preventDefault(),e.initiative.roll({event:s})})}u(ls,"addHazardListeners");var cs=new Set(["arcane","divine","occult","primal"]);function hi(t,e){return t.has(e)}u(hi,"setHasElement");function yi(t){return t.traits.has("cursed")?"unique":t.rarity}u(yi,"getDcRarity");function bi(t){let e=t.system.traits.value;return new Set(e.filter(s=>hi(cs,s)))}u(bi,"getMagicTraditions");function wi(t,e,s){let i={occult:e,primal:e,divine:e,arcane:e},n=bi(t);for(let a of cs)n.size>0&&!n.has(a)&&(i[a]=e+s);return{arcana:i.arcane,nature:i.primal,religion:i.divine,occultism:i.occult}}u(wi,"getIdentifyMagicDCs");function ki(t,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:s}){let i=_e(t.level,{proficiencyWithoutLevel:e}),n=yi(t),a=Re(i,n);return t.isMagical?wi(t,a,s):t.isAlchemical?{crafting:a}:{dc:a}}u(ki,"getItemIdentificationDCs");function vi(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(vi,"objectHasKey");var Ae=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),i=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",n=ki(e,{proficiencyWithoutLevel:i,notMatchingTraditionModifier:s});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:n}}activateListeners(e){e.find("button.update-identification").on("click",s=>{let i=$(s.delegateTarget);this.submit({updateData:{status:i.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let s=this.item,i=s.system.identification.unidentified.img,n=s.system.identification.unidentified.name,a=s.system.identification.identified.name,o=$("div#identify-item").find("tr").toArray().flatMap(c=>{let d=c.dataset.skill,p=Number(c.dataset.dc);if(!(Number.isInteger(p)&&vi(CONFIG.PF2E.skillList,d)))return[];let m=game.i18n.localize(CONFIG.PF2E.skillList[d]);return{slug:d,name:m,dc:p}}),l=s.isMagical?"action:identify-magic":s.isAlchemical?"action:identify-alchemy":null,r=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:i,itemName:n,identifiedName:a,rollOptions:["concentrate","exploration","secret",l].filter(Boolean),skills:o});await Q().create({user:game.user.id,content:r})})}async _updateObject(e,s){let i=s.status;i==="identified"&&await this.item.setIdentificationStatus(i)}};u(Ae,"IdentifyItemPopup");var Ke={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function us(t,e,s){let{contents:i,coins:n,totalWealth:a,bulk:o,invested:l}=t.inventory,r=C("containers")||(ne(t,`containers.${game.user.id}`)??[]),c={},d={};for(let p of i){if(!Ke[p.type])continue;let m=p.system.containerId;p.type!=="backpack"&&m&&(r===!0||r.includes(m))?(c[m]??=[],c[m].push(p)):(d[p.type]??=[],d[p.type].push(p))}if(d=Object.entries(d).map(([p,m])=>{if(m.sort((g,f)=>z(g.name,f.name)),p==="backpack")for(let g=m.length-1;g>=0;g--){let f=m[g],k=c[f.id]?.filter(h=>B(h.name,s));if(!k?.length){B(f.name,s)||m.splice(g,1);continue}k.sort((h,w)=>z(h.name,w.name)),m.splice(g+1,0,...k)}else m=m.filter(g=>B(g.name,s));return{type:p,items:m,label:Ke[p].label}}).filter(p=>p.items.length).sort((p,m)=>Ke[p.type].order-Ke[m.type].order),d.length)return{doubled:d.length>1&&C("items-columns"),contentData:{canCarry:!!t.adjustCarryType,categories:d,bulk:o,containers:r,i18n:p=>E(`items.${p}`),invested:l?`${game.i18n.localize("PF2E.InvestedLabel")}: ${l.value} / ${l.max}`:"",wealth:{coins:n.goldValue,total:a.goldValue}}}}u(us,"getItemsData");function ds(t,e,s){let i=t.find(".item");se(i),i.find("[data-action=item-description]").on("click",async n=>{n.preventDefault();let a=$(n.currentTarget).closest(".item");await V(a,e)}),i.find("[data-action=toggle-contains-items]").on("click",async n=>{n.preventDefault();let a=`containers.${game.user.id}`,o=n.currentTarget.closest(".item").dataset.itemId,l=ne(e,a)?.slice()??[],r=l.indexOf(o);r===-1?l.push(o):l.splice(r,1),await pe(e,a,l)}),e.isOwner&&(i.find("[data-action=item-chat]").on("click",async n=>{K(n,e)?.toMessage(n,{create:!0})}),i.on("dragstart",n=>{let a=n.target.closest(".item"),{itemType:o,uuid:l}=a.dataset,r=new Image;r.src=a.querySelector(".item-img img").src,r.style.width="32px",r.style.height="32px",r.style.borderRadius="4px",r.style.position="absolute",r.style.left="-1000px",document.body.append(r),n.originalEvent.dataTransfer.setDragImage(r,16,16),n.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:o,uuid:l})),a.addEventListener("dragend",()=>r.remove(),{once:!0})}),t.find(".quantity input").on("change",async n=>{await K(n,e)?.update({"system.quantity":n.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",n=>{n.preventDefault();let{itemId:a}=n.currentTarget.closest(".item").dataset;e.toggleInvested(a)}),t.find("[data-action=repair-item]").on("click",n=>{n.preventDefault();let a=K(n,e);a&&game.pf2e.actions.repair({item:a,actors:[e],tokens:[s]})}),t.find("[data-action=toggle-identified]").on("click",n=>{n.preventDefault();let a=K(n,e);a&&(a.isIdentified?a.setIdentificationStatus("unidentified"):new Ae(a).render(!0))}),t.find("[data-action=edit-item]").on("click",n=>{n.preventDefault(),zt(n,e)}),t.find("[data-action=delete-item]").on("click",n=>{n.preventDefault(),Gt(n,e)}),t.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(n,{event:a,origin:o}){let l=K(a,e);if(!l)return;let r=document.createElement("div");r.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:l});let c=r.children[1],d=$(c);if(d.find("[data-carry-type]").on("click",async p=>{let m=l.system.equipped,{carryType:g,handsHeld:f=0,inSlot:k}=$(p.currentTarget).data();k=k==="true",(g!==m.carryType||k!==m.inSlot||g==="held"&&f!==m.handsHeld)&&await e.adjustCarryType(l,{carryType:g,handsHeld:f,inSlot:k})}),l.type!=="backpack"){let p=e.itemTypes.backpack.filter(m=>m.isIdentified);if(p.length){let m="";for(let g of p)m+='<li><a class="item-control item-location-option',g===l.container&&(m+=" selected"),m+=`" data-action="send-to-container" data-container-id="${g.id}">`,m+=`<i class="fas fa-box"></i>${g.name}</a></li>`;d.find("ul").append(m),d.find("[data-action=send-to-container]").on("click",async g=>{let{containerId:f}=g.currentTarget.dataset;e.items.has(f)&&(n.close(),await l.update({"system.containerId":f}))})}}n.content(c)}}))}u(ds,"addItemsListeners");async function ps(t,e,s){let i=t.system.resources.focus??{value:0,max:0},n=t.spellcasting.regular,a=C("tradition"),o=[],l=[],r=!1;if(await Promise.all(n.map(async p=>{let m=p.id,g=a&&p.statistic.label[0],f=await p.getSheetData(),k=f.isFocusPool,h=p.system?.prepared?.value==="charge",w=getProperty(p,"flags.pf2e-staves.staveID")!==void 0,b={value:getProperty(p,"flags.pf2e-staves.charges")??0};for(let v of f.levels){if(!v.active.length||v.uses?.max===0)continue;let O=[],M=v.isCantrip,F=v.active.filter(L=>L&&L.uses?.max!==0);for(let L=0;L<F.length;L++){let{spell:R,expended:G,virtual:T,uses:H,castLevel:S}=F[L];B(R.name,s)&&O.push({name:R.name,img:R.img,tradition:g,castLevel:S??R.level,slotId:L,entryId:m,itemId:R.id,inputId:f.isInnate?R.id:f.id,inputPath:h?"flags.pf2e-staves.charges":f.isInnate?"system.location.uses.value":`system.slots.slot${v.level}.value`,isCharge:h,isVirtual:T,isInnate:f.isInnate,isCantrip:M,isFocus:k,isPrepared:f.isPrepared,isSpontaneous:f.isSpontaneous||f.isFlexible,slotLevel:v.level,uses:H??(h?b:v.uses),expended:G??(k&&!M?i.value<=0:!1),action:R.system.time.value,type:h?w?`${N}.spells.staff`:`${N}.spells.charges`:f.isInnate?"PF2E.PreparationTypeInnate":f.isSpontaneous?"PF2E.PreparationTypeSpontaneous":f.isFlexible?"PF2E.SpellFlexibleLabel":k?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:h?0:f.isPrepared?1:k?2:f.isInnate?3:f.isSpontaneous?4:5})}if(O.length){if(k)if(M)r=!0;else{l.push(...O);continue}o[v.level]??=[],o[v.level].push(...O)}}})),o.length){let p=C("spells")?(m,g)=>m.order===g.order?z(m.name,g.name):m.order-g.order:(m,g)=>z(m.name,g.name);o.forEach(m=>m.sort(p))}l.length&&(l.sort((p,m)=>z(p.name,m.name)),o[12]=l,r=!1);let d=(await t.spellcasting.ritual?.getSheetData())?.levels.flatMap((p,m)=>p.active.map(({spell:g})=>{if(B(g.name,s))return{name:g.name,img:g.img,slotId:m,itemId:g.id,level:g.level,time:g.system.time.value}}).filter(Boolean));if(o.length||d?.length){let p=ms(t),m=o.length+ +((d?.length??0)>0);return{contentData:{spells:o,rituals:d,focusPool:i,hasFocusCantrips:r,attackMod:fs(p)?p[0].mod:null},doubled:m>1&&C("spells-columns")}}}u(ps,"getSpellsData");function ms(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:s,id:i})=>({name:s,id:i,mod:X(e.mod),statistic:e}))}u(ms,"getSpellAttacks");function fs(t){return new Set(t.map(({mod:e})=>e)).size===1}u(fs,"hasSingleSpellAttack");function gs(t,e,s){se(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async i=>{i.preventDefault();let n=$(i.currentTarget).closest(".spell");V(n,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async i=>{i.preventDefault();let n=ms(e);if(!n.length)return;let a;if(fs(n))a=n[0].statistic;else{let r=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:E("spells.attacks.ok"),callback:c=>c.find("input:checked").val()}},title:E("spells.attacks.title"),content:await renderTemplate(U("dialogs/spell-attacks"),{attacks:n}),close:()=>null});r&&(a=e.items.get(r)?.statistic)}let o=De(i),{map:l}=i.currentTarget.dataset;l&&(o.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(l)})]),a?.check.roll(o)}),t.find("[data-action=spell-chat]").on("click",async i=>{i.preventDefault(),K(i,e)?.toMessage(i,{create:!0})}),t.find("[data-action=toggle-pips]").on("click contextmenu",async i=>{i.preventDefault();let n=i.type==="click"?1:-1,a=(e.system.resources.focus?.value??0)+n;await e.update({"system.resources.focus.value":a})}),t.find("[data-action=toggle-prepared]").on("click",i=>{i.preventDefault();let{slotLevel:n,slotId:a,entryId:o,expended:l}=$(i.currentTarget).closest(".spell").data();e.spellcasting.collections.get(o)?.setSlotExpendedState(n??0,a??0,l!==!0)}),t.find("[data-action=cast-spell]").on("click",i=>{i.preventDefault();let{slotLevel:n,slotId:a,entryId:o,itemId:l}=$(i.currentTarget).closest(".spell").data(),r=e.spellcasting.collections.get(o,{strict:!0});if(!r)return;let c=r.get(l,{strict:!0});c&&r.entry.cast(c,{slot:a,level:n})}),t.find("[data-input-path]").on("change",async i=>{let{inputPath:n,entryId:a}=$(i.currentTarget).data(),o=i.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:a,[n]:o}])}))}u(gs,"addSpellsListeners");var Ci="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",hs={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},Fe={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},Ii=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],Ti={actions:{getData:ns,addListeners:as},items:{getData:us,addListeners:ds},spells:{getData:ps,addListeners:gs},skills:{getData:Xt,addListeners:Zt},extras:{getData:ts,addListeners:ss},hazard:{getData:rs,addListeners:ls}},Le={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Si={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},Me=class extends Application{#e=null;#d=null;#s=null;#a=null;#c=!1;#o=null;#u=[!1,!1,!1];#t=!1;#i=!1;#n=!1;#p;#r;#m;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,s)=>{s?this.#h(e):this.#y(e)},this.#r=e=>{let s=e.button;if(![0,2].includes(s))return;if(e.type==="mouseup"){this.#u[s]=!1;return}this.#u[s]=!0;let i=e.target,n=this.element[0];if(n){let a=n.querySelector(".popup");if(a&&!a.contains(i))if(!n.querySelector(".sidebar"))this.forceClose();else return a.remove();i.closest("canvas")&&this.forceClose();return}else this.#g();this.unlock(!0)},this.#m=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#m),Hooks.on("canvasPan",this.forceClose)}setToken(e,s){if(e!==this.#e){this.#e&&delete this.#e.actor.apps[this.appId],this.#e=e;let i=e?.actor;i&&(i.apps[this.appId]=this)}this.#n=s??this.#f(e)}setHolding(e){let s=C("use-holding");if(s!=="none"&&(this.#c=e,!(this.#i||this.#t)))if(e){if(!this.#s)return;let i=this.#f(this.#s);if(s==="half"&&!game.user.isGM&&!i){this.#g(),this.render();return}this.setToken(this.#s,i),this.render()}else s==="all"?this.close():game.user.isGM?(this.setToken(this.#s),this.render()):this.#n&&this.close()}#f(e){let s=e?.actor;if(!s)return!1;let i,n=s.system.details.alliance==="party";return game.user.isGM&&C("use-holding")==="half"&&!this.#c||s.isOfType("familiar")&&!s.master?i=!1:i=e.isOwner||C("observer")&&(e.observer||n&&C("party")),i}#h(e){if($(window.document).find(":hover").filter("#combat-popout, #sidebar, #mini-tracker, [id^=pf2e-perception]").length)return;let s=e.actor;if(!s||s.isOfType("loot","party")||(this.#s=e,e!==this.#d&&!this.#t&&this.close(),this.mousedown||this.#t||this.#i||e===this.#e))return;let i=C("use-holding"),n=this.#f(e);i!=="none"&&!this.#c&&(i==="all"||n)||(this.#b(!0),this.setToken(e,n),i==="none"||!this.#c?this.renderWithDelay():this.render())}#y(e){this.#s=null,!(this.mousedown||this.#t||this.#i)&&(this.#o=setTimeout(()=>{this.#o=null,!(this.#i||this.#t)&&this.close()},10))}renderWithDelay(){let e=C("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#b(e){this.#o!==null&&(clearTimeout(this.#o),this.#o=null,e&&this.close())}#g(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#m),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:U("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return this.actor?.itemTypes.effect.find(e=>e.flags.core?.sourceId===Ci)}get isCharacter(){return this.actor?.isOfType("character")}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,s=this.#e?.actor;if(!s)return{};let i=null,n=C("saves"),a=C("others"),o=this.isCharacter,{attributes:l}=s,{hp:r,sp:c={max:0,value:0},ac:d}=l,p=game.settings.get("pf2e","staminaVariant"),m=C("distance"),g=C("scale");if(m==="all"||m==="self"&&this.#n){let I=C("unit").split(","),P=Number(I[0]?.trim())||1,_=I[1]?.trim()||game.system.gridUnits,x=Number(I[2]?.trim())||0,W=canvas.tokens.controlled,re=!1,le=W.length===1?W[0]:null;(!le||le===e)&&(le=Ge(),re=!0),le&&le!==e&&(i={unit:_,icon:re?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(le)*P).toFixed(x)})}let f;if(!this.#n||C("see-status")){let I=C("status").split(",").map(P=>P.trim()).filter(Boolean);if(I.length&&r.max){let P=r.max+(p?c.max:0),_=r.value+(p?c.value:0),x=Math.clamped(_/P,0,1),W=(()=>{let re=I.length;return C("last-status")?x===1?re:Math.ceil(x*(re-1)):Math.ceil(x*re)})();f={hue:x*x*122+3,value:W===0?game.i18n.localize("EFFECT.StatusDead"):I.at(W-1)}}}let k={status:f,distance:i,fontSize:g,tokenId:e.id,type:s.isOfType("creature")?"creature":s.type};if(!this.#n||s.isOfType("familiar")&&!s.master)return k;let{level:h,saves:w,isOwner:b,system:v,itemTypes:O}=s,{resistances:M,weaknesses:F,immunities:L}=l;k={...k,isOwner:b,isObserver:this.#n,name:e.document.name,hp:r,ac:d.value,level:h,hasActions:O.action.length||v.actions?.filter(I=>I.visible!==!1).length};let R=C("ranks");function G(I,P,_){let x=I.slug,W=P==="bonus"?X(I.mod):I.dc.value;return{slug:x,value:W,label:_[x].label,icon:_[x].icon,rank:R&&He[I.rank]}}u(G,"getStatistic");function T(I,P){if(!I.length)return"";let _=I.map(x=>we(x.label.replace("-"," ").titleCase())).join("");return P?`<li>${game.i18n.localize(P)}<ul>`+_+"</ul></li>":_}if(u(T,"toIWR"),s.isOfType("hazard")){let{hardness:I,emitsSound:P,stealth:_}=l;return{...k,hardness:I,emitsSound:P.toString().capitalize(),immunities:T(L),weaknesses:T(F),resistances:T(M),stealth:{value:_.value,details:await ue(_.details,s)},saves:n!=="none"&&["fortitude","reflex","will"].map(x=>{let W=w[x];return W?G(W,n,Le):{slug:x,label:Le[x].label,icon:Le[x].icon}})}}if(k={...k,sidebarTitles:{actions:`${N}.actions.title`,items:`${N}.items.title`,spells:`${N}.spells.title`,skills:`${N}.skills.title`,extras:`${N}.extras.title`},hasItems:s.inventory.size},s.isOfType("vehicle")){let{hardness:I,collisionDC:P,collisionDamage:_}=l,{details:x}=v,{crew:W,passengers:re,pilotingCheck:le,speed:Ss}=x;return{...k,hardness:I,crew:W,passengers:re,pilotingCheck:le,speed:Ss,collisionDC:P.value,collisionDamage:_.value,immunities:T(L),weaknesses:T(F),resistances:T(M),fortitude:G(w.fortitude,n,Le)}}let H=C("show-death"),{heroPoints:S,_source:j}=s,{traits:J}=v,{wounded:ge,dying:be,shield:Y,resolve:he,speed:Z,adjustment:xe}=l;function we(I){return`<li>${I.trim()}</li>`}u(we,"toInfo");function ee(I,P){return z(I,P)}u(ee,"sort");let ke=J?.languages?.value.map(I=>game.i18n.localize(CONFIG.PF2E.languages[I])).filter(Boolean).sort(ee).map(we).join(""),oe=o?J.senses.map(I=>I.label):J.senses.value?.split(","),ve=Ii.map(({type:I,icon:P},_)=>({index:_,icon:P,label:game.i18n.localize(CONFIG.PF2E.speedTypes[I]??"PF2E.SpeedTypesLand"),value:(_===0?Z.total:Z.otherSpeeds.find(x=>x.type===I)?.total)||0})),dt=ne(s,`speeds.selected.${game.user.id}`),Is=(()=>{let I=0;if(dt!==void 0)I=dt;else if(C("force-speed")||ve[0].value===0){let P={index:0,value:ve[0].value};I=ve.reduce((_,{value:x},W)=>x>_.value?{index:W,value:x}:_,P).index}return ve.splice(I,1)[0]})(),pt=ve.map(({value:I,label:P,index:_})=>`<li><a data-index="${_}">${P}: ${I}</a></li>`).join("");Z.details&&(pt+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${Z.details}</li>`);let mt=j.system.details?.alliance,Ye=mt===null?"neutral":mt??"default",ft=s.hasPlayerOwner?"party":"opposition",Ts=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(Fe[ft].label)})},{value:"opposition",label:game.i18n.localize(Fe.opposition.label)},{value:"party",label:game.i18n.localize(Fe.party.label)},{value:"neutral",label:game.i18n.localize(Fe.neutral.label)}].filter(({value:I})=>I!==Ye).map(({value:I,label:P})=>`<li><a data-alliance="${I}">${P}</a></li>`).join("");return{...k,sp:p?c:{max:0},hero:S,dying:be,wounded:ge,shield:Y,resolve:he,adjustment:xe,alliance:Fe[Ye==="default"?ft:Ye],alliances:Ts,isCharacter:o,showDeathLine:o&&(H==="always"||be.value||ge.value),digitalPips:C("pips"),hasCover:this.hasCover,saves:n!=="none"&&["fortitude","reflex","will"].map(I=>G(w[I],n,Le)),others:a!=="none"&&["perception","stealth","athletics"].map(I=>G(s.getStatistic(I),a,Si)),speeds:{main:Is,others:pt},iwr:T(L,"PF2E.ImmunitiesLabel")+T(F,"PF2E.WeaknessesLabel")+T(M,"PF2E.ResistancesLabel"),senses:oe?.filter(Boolean).map(we).join(""),languages:ke,hasSpells:s.spellcasting.some(I=>I.category!=="items"),hasNotes:!o&&(v.details.publicNotes||v.details.privateNotes&&b)}}close(e={}){this.setToken(null),this.unlock(!0),this.#i=!1,this.#g();let s=Application.RENDER_STATES;if(!e.force&&![s.RENDERED,s.ERROR].includes(this._state))return;this._state=s.CLOSING;let i=this.element;if(!i)return this._state=s.CLOSED;i.css({minHeight:0});for(let n of this.constructor._getInheritanceChain())Hooks.call(`close${n.name}`,this,i);i.remove(),this._element=null,this._state=s.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,s={}){let i,n,a,o,l;if(this.#d===this.#e){let r=this.sidebar[0];if(r){i=r.dataset.type,n=r.scrollTop;let c=r.querySelector(".sidebar-header");c.classList.contains("show")&&(l=c.querySelector(" input").value.trim())}a=this.popup[0],a&&(o=a.scrollTop)}if(await super._render(e,s),ui.windows[this.appId]=this,i){let r=await this.#l(i,l);n>0&&r.scrollTop(n)}a&&(this.element.append(a),o>0&&(a.scrollTop=o)),this.#d=this.#e,this.inner.length&&C("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let s=this.element[0],i=e.worldTransform.a,n=s.getBoundingClientRect(),a=canvas.clientCoordinatesFromCanvas(e.document._source),o={x:a.x,y:a.y,width:e.hitArea.width*i,height:e.hitArea.height*i,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},l,r=this.#n?hs[C("position")].slice():hs[C("small-position")].slice();for(;r.length&&!l;){let c=r.shift();c==="left"?(l={x:o.x-n.width,y:ut(n,o)},l.x<0&&(l=void 0)):c==="right"?(l={x:o.right,y:ut(n,o)},l.x+n.width>window.innerWidth&&(l=void 0)):c==="top"?(l={x:ys(n,o),y:o.y-n.height},l.y<0&&(l=void 0)):c==="bottom"&&(l={x:ys(n,o),y:o.bottom},l.y+n.height>window.innerHeight&&(l=void 0))}return l&&(s.style.left=`${l.x}px`,s.style.top=`${l.y}px`),l}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||C("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let s=this.#e,i=s?.actor;if(!i)return;let n=s.isOwner,a=Q();C("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",async r=>{r.preventDefault();let{publicNotes:c,privateNotes:d,blurb:p}=i.system.details,m=i.system.traits.value.map(f=>({label:game.i18n.localize(CONFIG.PF2E.monsterTraits[f])??f,description:game.i18n.localize(CONFIG.PF2E.traitsDescriptions[f])??""})),g=await renderTemplate(U("show-notes"),{traits:m,blurb:p.trim(),publicNotes:c.trim(),privateNotes:n&&d.trim()});me(`${i.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,g,i)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(C("autolock")==="hover"&&this.lock(),this.#i=!0)}),e.on("mouseleave",()=>{this.#i=!1,!(this.#t||this.#s)&&this.close()}),e.on("dragover",()=>{s.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let o=e.find("[data-action=show-info]");o.tooltipster({position:["top","bottom","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click"}),o.filter(".stealth").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(r,{origin:c,tooltip:d})=>{this.lock(),$(d).find(".content-link").on("click",()=>setTimeout(()=>r.close(),10))}).tooltipster("option","functionAfter",()=>this.unlock()),(n?o.filter(":not(.speeds):not(.stealth)"):o).on("mouseleave",r=>{$(r.currentTarget).tooltipster("hide")}),e.find("[data-action=open-sidebar]").on("click",this.#l.bind(this)),n&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",r=>{r.preventDefault();let c=r.type==="click"?"elite":"weak";i.applyAdjustment(i.system.attributes.adjustment===c?null:c)}),e.find("[data-action=toggle-alliance]").tooltipster({position:["bottom","top","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click",interactive:!0,functionReady:(r,{origin:c,tooltip:d})=>{this.lock(),d.querySelectorAll("[data-alliance]").forEach(p=>{p.addEventListener("click",async m=>{m.preventDefault();let g=p.dataset.alliance;g==="default"?i.update({"system.details.-=alliance":null}):i.update({"system.details.alliance":g==="neutral"?null:g})})})},functionAfter:()=>this.unlock()}),e.find("[data-action=collision-dc]").on("click",r=>{r.preventDefault();let c=i.system.attributes.collisionDC.value||15;a.create({content:`@Check[type:reflex|dc:${c}]`,speaker:a.getSpeaker({actor:i})})}),e.find("[data-action=collision-damage]").on("click",async r=>{r.preventDefault();let c=(i.system.attributes.collisionDamage.value||"1d6").trim();isNaN(Number(c.at(-1)))||(c+="[bludgeoning]");let d=de(),p=await new d(c).evaluate({async:!0});a.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:a.getSpeaker({actor:i}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[p]})}),e.find("input").on("change",async r=>{let c=r.currentTarget,d=c.valueAsNumber,p=c.name;c.blur(),p!=="shield.value"?await i.update({[p]:d}):await i.heldShield.update({"system.hp.value":d})}),e.find("[data-action=toggle-hero]").on("click contextmenu",r=>{r.preventDefault();let{max:c,value:d}=i.heroPoints,p=r.type==="click"?1:-1,m=Math.clamped(d+p,0,c);m!==d&&i.update({"system.resources.heroPoints.value":m})}),e.find("[data-action=raise-shield]").on("click",r=>{r.preventDefault(),game.pf2e.actions.raiseAShield({actors:[i],tokens:[s]})}),e.find("[data-action=take-cover]").on("click",async r=>{r.preventDefault(),game.pf2e.actions.get("take-cover").use({actors:[i],tokens:[s]})}),e.find("[data-action=roll-save]").on("click",r=>{r.preventDefault();let c=r.currentTarget.dataset.save;i.saves[c].roll({event:r})}),e.find("[data-action=roll-other]").on("click",r=>{r.preventDefault();let c=r.currentTarget.dataset.slug;if(c!=="athletics"){let{ctrlKey:d,metaKey:p,shiftKey:m}=r;r=new MouseEvent("click",{ctrlKey:!d,metaKey:p,shiftKey:m})}i.getStatistic(c)?.roll({event:r})}),e.find("[data-action=recovery-check]").on("click",r=>{r.preventDefault(),i.rollRecovery(r)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",r=>{r.preventDefault();let c=r.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",d=i.system.attributes[c]?.max;d&&(r.type==="click"?i.increaseCondition(c,{max:d}):i.decreaseCondition(c))}),e.find("[data-action=use-resolve]").on("click",r=>{r.preventDefault(),gt(i)}),o.filter(".speeds").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(r,{origin:c,tooltip:d})=>{this.lock(),d.querySelectorAll("[data-index]").forEach(p=>{p.addEventListener("click",async m=>{m.preventDefault(),await pe(i,`speeds.selected.${game.user.id}`,Number(p.dataset.index))})})}).tooltipster("option","functionAfter",()=>this.unlock()))}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#l(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#l(e,s){e=typeof e=="string"?e:e.currentTarget.dataset.type;let i=this.element,n=this.sidebar,a=n[0]?.dataset.type;if(n.remove(),i.find("[data-action=open-sidebar]").removeClass("active"),a===e&&s===void 0){this.unlock();return}let o=this.#e,l=o.actor,r=s!==void 0||C("filter"),{getData:c,addListeners:d}=Ti[e],p=await c(l,o,s?.toLowerCase())??{};if(!p.contentData&&!r)return ui.notifications.warn(E(`${e}.empty`,{name:this.#e.name}));let m={...p.contentData??{},isGM:game.user.isGM,isCharacter:this.isCharacter,isOwner:l.isOwner};this.lock(),i.find(`[data-action=open-sidebar][data-type=${e}]`).addClass("active"),i=i[0];let g=p.classes??[];g.push(e),C("scrollbar")||g.push("no-scrollbar"),p.doubled&&g.push("doubled");let f=p.style??{};f["--max-height"]=C("height").trim()||"100%";let k=document.createElement("div");k.innerHTML=await renderTemplate(U("sidebar"),{classes:g.join(" "),style:Object.entries(f).map(([F,L])=>`${F}: ${L}`).join("; "),type:e,filter:s,filterLabel:E("filter"),showFilter:r,content:(await renderTemplate(U(`sidebars/${e}`),m)).trim()}),n=k.firstElementChild,i.append(n);let h=n.getBoundingClientRect(),w=i.getBoundingClientRect(),b;C("position")==="left"?(b=w.x-h.width,b<0&&(b=w.right)):(b=w.right,b+h.width>window.innerWidth&&(b=w.x-h.width));let O=parseInt(window.getComputedStyle(i).padding),M=ut(h,w,O);return n.style.left=`${b}px`,n.style.top=`${M}px`,n=$(n),n.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",F=>{F.preventDefault(),n.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#l(e,"")}),n.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",F=>{F.key==="Enter"&&this.#l(e,F.currentTarget.value.trim())}),d(n,l,o),Hooks.callAll("renderHUDSidebar",e,n,this),n}};u(Me,"HUD");function ut(t,e,s=0){let i=e.y+e.height/2-t.height/2;return i+t.height>window.innerHeight&&(i=window.innerHeight-t.height-s),i<0&&(i=s),i}u(ut,"postionFromTargetY");function ys(t,e){let s=e.x+e.width/2-t.width/2;return s+t.width>window.innerWidth&&(y=window.innerWidth-t.width),s<0&&(s=0),s}u(ys,"postionFromTargetX");var N="pf2e-token-hud",fe=null;function ae(t=!1){return t?fe?.element:fe}u(ae,"getHud");function Ve(t){t&&!fe?fe=new Me:!t&&fe&&(fe.delete(),fe=null)}u(Ve,"enableModule");function C(t){return game.settings.get(N,t)}u(C,"getSetting");function E(...t){let e=t.at(-1),s=typeof e=="object",i=s?t.slice(0,-1):t;return i.unshift(N),game.i18n[s?"format":"localize"](i.join("."),e)}u(E,"localize");function ot(t,e){return t.itemTypes.feat.some(s=>s.sourceId===e)}u(ot,"hasFeat");function U(t){return`modules/${N}/templates/${t}.hbs`}u(U,"templatePath");function X(t){return t>=0?`+${t}`:t}u(X,"modifier");function ne(t,e){return t.getFlag(N,e)}u(ne,"getFlag");function pe(t,e,s){return t.setFlag(N,e,s)}u(pe,"setFlag");async function ue(t,e,{isOwner:s=e.isOwner,rollData:i=e.getRollData()}={}){return t=t?.trim(),t?await TextEditor.enrichHTML(t,{async:!0,secrets:s,rollData:i}):""}u(ue,"enrichHTML");function Te(t,e){if(typeof t!="object")return!1;for(;t=Reflect.getPrototypeOf(t);)if(t.constructor.name===e)return!0;return!1}u(Te,"isInstanceOf");function ks(){ws("hold",{onDown:()=>{C("use-holding")!=="none"&&ae()?.setHolding(!0)},onUp:()=>{ae()?.setHolding(!1)}}),ws("filter",{onUp:()=>{ae()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}u(ks,"registerKeybindings");function bs(t,e){return`${N}.keybinds.${t}.${e}`}u(bs,"path");function ws(t,e={}){game.keybindings.register(N,t,{name:bs(t,"name"),hint:bs(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}u(ws,"register");function vs(){let t=game.data.users.find(s=>s._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(s=>E(`settings.status.statuses.${s}`)).join(", ");D("status",String,e,{scope:"world"}),D("last-status",Boolean,!1,{scope:"world"}),D("party",Boolean,!1,{scope:"world"}),D("enabled",Boolean,!0,{onChange:Ve}),D("position",String,"right",{choices:{left:A("position","choices.left"),right:A("position","choices.right"),top:A("position","choices.top"),bottom:A("position","choices.bottom")}}),D("small-position",String,"top",{choices:{left:A("position","choices.left"),right:A("position","choices.right"),top:A("position","choices.top"),bottom:A("position","choices.bottom")}}),D("delay",Number,250,{range:{min:0,max:2e3,step:50}}),D("scale",Number,14,{range:{min:10,max:30,step:1}}),D("use-holding",String,"none",{hint:A("use-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:A("use-holding","choices.none"),half:A("use-holding",t?"choices.gm.half":"choices.player.half"),all:A("use-holding",t?"choices.gm.all":"choices.player.all")}}),D("autolock",String,"none",{choices:{none:A("autolock","choices.none"),hover:A("autolock","choices.hover"),render:A("autolock","choices.render")}}),D("observer",Boolean,!0),D("see-status",Boolean,!1),D("saves",String,"bonus",{choices:{none:A("saves","choices.none"),bonus:A("saves","choices.bonus"),dc:A("saves","choices.dc")}}),D("others",String,"none",{choices:{none:A("saves","choices.none"),bonus:A("saves","choices.bonus"),dc:A("saves","choices.dc")}}),D("ranks",Boolean,!1),D("show-death",String,"always",{choices:{none:A("show-death","choices.none"),always:A("show-death","choices.always"),only:A("show-death","choices.only")}}),D("force-speed",Boolean,!1),D("tooltips",Boolean,!1),D("pips",Boolean,!1),D("distance",String,"all",{choices:{none:A("distance","choices.none"),self:A("distance","choices.self"),all:A("distance","choices.all")}}),D("unit",String,""),D("height",String,""),D("filter",Boolean,!1),D("scrollbar",Boolean,!0),D("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),D("actions-columns",Boolean,!1),D("items-columns",Boolean,!1),D("spells-columns",Boolean,!1),D("skills-columns",Boolean,!1),D("actions",String,"split",{choices:{name:A("actions","choices.name"),type:A("actions","choices.type"),split:A("actions","choices.split")}}),D("actions-colors",Boolean,!0),D("containers",Boolean,!1),D("spells",Boolean,!1),D("tradition",Boolean,!1),D("untrained",Boolean,!0)}u(vs,"registerSettings");function Cs(t,e){let s=e.find(`.tab[data-tab=${N}]`);function i(n,a,o="h3"){let l=E(`menu.${a}`);s.find(`[name="${N}.${n}"]`).closest(".form-group").before(`<${o}>${l}</${o}>`)}u(i,"beforeGroup"),game.user.isGM&&i("enabled","client.header","h2"),i("saves","client.tooltip"),i("distance","client.distance"),i("height","client.sidebar"),i("actions","client.actions"),i("containers","client.items"),i("spells","client.spells"),i("untrained","client.skills")}u(Cs,"renderSettingsConfig");function A(t,e){return`${N}.settings.${t}.${e}`}u(A,"path");function D(t,e,s,i={}){game.settings.register(N,t,{name:A(t,"name"),hint:A(t,"hint"),scope:"client",config:!0,type:e,default:s,...i})}u(D,"register");Hooks.once("setup",async()=>{vs(),ks(),await loadTemplates({creature:U("tooltips/creature"),hazard:U("tooltips/hazard"),vehicle:U("tooltips/vehicle")})});Hooks.once("ready",()=>{C("enabled")&&Ve(!0),game.modules.get("pf2e-token-hud").api={getHud:ae}});Hooks.on("renderSettingsConfig",Cs);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&ae()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${N}.actor.macros.contextmenu`,condition:s=>{let{documentId:i}=s.data();return C("enabled")&&game.actors.get(i)?.isOwner},callback:s=>{let{documentId:i}=s.data();Ei(i)}})});var Je=class extends Dialog{async getData(e={}){let s=super.getData(e);return typeof s.content=="function"&&(s.content=await s.content()),s}};u(Je,"DataDialog");function Ei(t){let e=game.actors.get(t);if(!e)return;let s=new Je({title:`${e.name} - ${E("actor.macros.title")}`,content:async()=>{let i=je(e)??[];return renderTemplate(U("dialogs/macros"),{macros:i,noMacro:E("extras.no-macro")})},buttons:{},render:i=>{e.apps[s.appId]=s,i.on("drop",n=>Be(n,e)),i.find("[data-action=delete-macro]").on("click",n=>ze(n,e))},close:()=>{delete e.apps[s.appId]}},{height:"auto"}).render(!0)}u(Ei,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
