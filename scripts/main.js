(()=>{var Mt=Object.defineProperty;var c=(t,e)=>Mt(t,"name",{value:e,configurable:!0});var Pt=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),$t=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function Rt(t,e="normal"){return t+(Pt.get(e)??0)}c(Rt,"adjustDC");function Nt(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}c(Nt,"rarityToDCAdjustment");function le(t,e="common"){return Rt(t,Nt(e))}c(le,"adjustDCByRarity");function ue(t,{proficiencyWithoutLevel:e,rarity:i="common"}={}){let s=game.settings.get("pf2e","proficiencyVariant");e??=s==="ProficiencyWithoutLevel";let a=$t.get(t)??14;return le(e?a-Math.max(t,0):a,i)}c(ue,"calculateDC");function Y(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}c(Y,"htmlQueryAll");function xe(t,e){return t instanceof Element?t.closest(e):null}c(xe,"htmlClosest");function Ht(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}c(Ht,"isRelevantEvent");function Be(t){let e=!game.user.settings.showRollDialogs;if(!Ht(t))return{skipDialog:e};let i={skipDialog:t.shiftKey?!e:e};return(t.ctrlKey||t.metaKey)&&(i.rollMode=game.user.isGM?"gmroll":"blindroll"),i}c(Be,"eventToRollParams");var de={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},ze={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function Ge(t,e){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+t,0,3)}}c(Ge,"adjustDegreeOfSuccess");function pe(t,e){return t===20?Ge(ze.INCREASE,e):t===1?Ge(ze.LOWER,e):e}c(pe,"adjustDegreeByDieValue");function fe(t,e,i){return t-i>=10?pe(e,de.CRITICAL_SUCCESS):i-t>=10?pe(e,de.CRITICAL_FAILURE):t>=i?pe(e,de.SUCCESS):pe(e,de.FAILURE)}c(fe,"calculateDegreeOfSuccess");var qe=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(",");function Ut(t,e){for(let i of t){(!e||e.isOwner)&&i.classList.add("with-repost");let s=Y(i,"i[data-pf2-repost]");if(s.length>0){if(e&&!e.isOwner){for(let o of s)o.remove();i.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let a=document.createElement("i"),n=i.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";a.classList.add("fas",n),a.setAttribute("data-pf2-repost",""),a.setAttribute("title",game.i18n.localize("PF2E.Repost")),i.appendChild(a)}}c(Ut,"injectRepostElement");function _t(t,e=null){for(let i of Y(t,"a.inline-roll[data-damage-roll]")){let s=xe(i,"[data-item-id]")?.dataset.itemId,a=e?.items.get(s??"");a&&(i.dataset.flavor||=a.name)}}c(_t,"flavorDamageRolls");function Ke(t,e){let i=t.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${t.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${i}</span> ${t.outerHTML}`.trim()}c(Ke,"makeRepostHtml");function jt(t,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(l=>l in t.dataset))return;let i=e?.hasPlayerOwner?"all":"gm",s=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${Y(t.parentElement,qe).map(u=>Ke(u,i)).join("<br>")}</div>`:Ke(t,i))(),a=CONFIG.ChatMessage.documentClass,n=e instanceof Actor?a.getSpeaker({actor:e,token:e.token??e.getActiveTokens(!1,!0).shift()}):a.getSpeaker(),o=game.messages.get(xe(t,"[data-message-id]")?.dataset.messageId??""),r=o?.flags.pf2e.origin?{pf2e:{origin:deepClone(o.flags.pf2e.origin)}}:{};a.create({speaker:n,content:s,flags:r})}c(jt,"repostAction");function me(t,e){let i=t instanceof HTMLElement?t:t[0],s=Y(i,qe).filter(n=>n.nodeName==="SPAN");Ut(s,e),_t(i,e),Y(i,"i[data-pf2-repost]").forEach(n=>n.addEventListener("click",o=>{let r=o.target;if(!(r instanceof HTMLElement))return;let l=r?.parentElement;l&&jt(l,e),o.stopPropagation()}));let a=$(s);a.filter("[data-pf2-action]").on("click",n=>{let o=$(n.currentTarget),{pf2Action:r,pf2Glyph:l,pf2Variant:u,pf2Dc:f,pf2ShowDc:p,pf2Skill:d}=o[0]?.dataset??{},m=game.pf2e.actions[r?game.pf2e.system.sluggify(r,{camel:"dromedary"}):""],g=p??"all";r&&m?m({event:n,glyph:l,variant:u,difficultyClass:f?{scope:"check",value:Number(f)||0,visibility:g}:void 0,skill:d,actors:[e]}):console.warn(`PF2e System | Skip executing unknown action '${r}'`)}),a.filter("[data-pf2-check]").on("click",async n=>{let{pf2Check:o,pf2Dc:r,pf2Traits:l,pf2Label:u,pf2Adjustment:f}=n.currentTarget.dataset,p=l?.split(",").map(m=>m.trim()).filter(m=>!!m),d=Be(n);switch(o){case"flat":{let m=Number.isInteger(Number(r))?{label:u,value:Number(r)}:null,g=await new Roll("1d20").evaluate({async:!0}),k=g.total,v=g.dice[0].total,M=fe(k,v,m.value),A={value:M,unadjusted:M,adjustment:null,dieResult:v,rollTotal:k,dc:m},x=(await game.pf2e.Check.createResultFlavor({degree:A})).outerHTML;g.toMessage({flavor:x});break}default:{let m=e.getStatistic(o??"");if(m){let g=(()=>{let v=Number(f)||0;return r==="@self.level"?ue(e.level)+v:Number(r)+v})(),k=Number.isInteger(g)?{label:u,value:g}:null;m.check.roll({...d,extraRollOptions:p,origin:e,dc:k})}else console.warn(`PF2e System | Skip rolling unknown statistic ${o}`)}}}),a.filter("[data-pf2-effect-area]").on("click",async n=>{let{pf2EffectArea:o,pf2Distance:r,pf2TemplateData:l,pf2Traits:u,pf2Width:f}=n.currentTarget.dataset,p={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};if(typeof o=="string"){let d=JSON.parse(l??"{}");d.distance||=Number(r),d.fillColor||=game.user.color,d.t=p[o],d.t==="ray"?d.width=Number(f)||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):d.t==="cone"&&(d.angle=CONFIG.MeasuredTemplate.defaults.angle),u&&(d.flags={pf2e:{origin:{traits:u.split(",")}}});let m=new CONFIG.MeasuredTemplate.documentClass(d,{parent:canvas.scene});await new CONFIG.MeasuredTemplate.objectClass(m).drawPreview()}else console.warn("PF2e System | Could not create template'")})}c(me,"listenInlineRoll");var ge=["U","T","E","M","L"];async function We(t,e){let i=t.data(),s=i.itemId?e.items.get(i.itemId):await fromUuid(i.uuid),a=await s?.getChatData({secrets:e.isOwner},i);if(!a)return;let n=document.createElement("div");return n.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(n,s,a),me(n,e),n}c(We,"getItemSummary");function j(t){t.on("mouseenter",e=>{e.preventDefault();let i=e.currentTarget.querySelector(".name"),{width:s}=i.getBoundingClientRect();if(i.scrollWidth<=Math.ceil(s))return;let a=i.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:a})}),t.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),t.on("mousedown",e=>{game.tooltip.deactivate()})}c(j,"addNameTooltipListeners");function Ve(t,e){t.preventDefault(),R(t,e)?.sheet.render(!0,{focus:!0})}c(Ve,"editItem");async function Ye(t,e){t.preventDefault();let i=R(t,e);if(i){if(t.ctrlKey)return i.delete();new Dialog({title:I("deleteItem.title"),content:await renderTemplate("systems/pf2e/templates/actors/delete-item-dialog.hbs",{name:i.name}),buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:I("deleteItem.ok"),callback:()=>i.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:I("deleteItem.cancel")}}}).render(!0)}}c(Ye,"deleteItem");function R(t,e){let{itemId:i}=t.currentTarget.closest("[data-item-id]").dataset;return e.items.get(i)}c(R,"getItemFromEvent");function he(t){return t.isOwner&&J(t,`macros.${game.user.id}`)?.map(e=>{let i=fromUuidSync(e);return i?{img:i.img,name:i.name,uuid:e}:null}).filter(Boolean)}c(he,"getMacros");function ye(t,e){let{type:i,uuid:s}=TextEditor.getDragEventData(t.originalEvent)??{};if(i!=="Macro"||!fromUuidSync(s))return;let a=`macros.${game.user.id}`,n=J(e,a)?.slice()??[];n.includes(s)||(n.push(s),ee(e,a,n))}c(ye,"onDroppedMacro");function be(t,e){let i=`macros.${game.user.id}`,s=J(e,i)?.slice();if(!s?.length)return;let{uuid:a}=t.currentTarget.closest(".macro").dataset,n=s.indexOf(a);n!==-1&&(s.splice(n,1),ee(e,i,s))}c(be,"deleteMacro");function ve(t=()=>!0){let e=game.user.targets,i=e.size===1?e.first():null;return i&&t(i)?i:null}c(ve,"getUniqueTarget");function G(t,e){return e?t.toLowerCase().includes(e):!0}c(G,"filterIn");var Je={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"};function Qe(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return Je.passive;let i=typeof t!="object"?t:t.type==="action"?t.value:t.type,s=String(i??"").toLowerCase().trim();return Je[s]??e}c(Qe,"getActionIcon");async function Xe({weapon:t,trait:e,selection:i}){if(t.system.traits.toggles[e].selection===i)return!1;let a=t.actor?.items.get(t.id);return a?.isOfType("weapon")&&a===t?await a.update({[`system.traits.toggles.${e}.selection`]:i}):a?.isOfType("weapon")&&t.altUsageType==="melee"?await a.update({[`system.meleeUsage.traitToggles.${e}`]:i}):await a?.rules.find(o=>o.key==="Strike"&&!o.ignored&&o.slug===t.slug)?.toggleTrait({trait:e,selection:i}),!0}c(Xe,"toggleWeaponTrait");async function te(t,e,i){let s=se(!0);if(!s.length)return;s.find("> .popup").remove();let a=document.createElement("div");a.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${I("popup.close")}</a>
    </div>
</div>`;let n=a.firstElementChild;typeof e=="string"?(e=await Q(e,i),n.insertAdjacentHTML("beforeend",e)):n.append(e),n.querySelector("[data-action=close-popup]").addEventListener("click",()=>n.remove()),s.append(n)}c(te,"popup");async function N(t,e,i){i??=t.find(".name").html();let s=await We(t,e);s&&te(i.trim(),s,e)}c(N,"showItemSummary");async function we(t,e,i,{rollMode:s=void 0,create:a=!0,data:n={}}){let o=`systems/pf2e/templates/chat/${e.type}-card.hbs`,r=i.token,l=t?.currentTarget.closest(".item")??{},u=CONFIG.ChatMessage.documentClass,f=Object.keys(n).length>0?n:l.dataset||{},p={actor:i,tokenId:r?`${r.parent?.id}.${r.id}`:null,item:e,data:await e.getChatData(void 0,f)},d={speaker:u.getSpeaker({actor:i,token:i.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return s??=t?.ctrlKey||t?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(s)&&(d.whisper=u.getWhisperRecipients("GM").map(m=>m.id)),s==="blindroll"&&(d.blind=!0),d.content=await renderTemplate(o,p),a?u.create(d,{renderSheet:!1}):new u(d)}c(we,"unownedItemToMessage");var B="pf2e-token-hud",Bt=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),Ze="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",zt="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",Gt={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${B}.skills.actions.earnIncome`,treatWounds:`${B}.skills.actions.treatWounds`,"borrow-arcane-spell":`${B}.skills.actions.borrow-arcane-spell`,"identify-magic":`${B}.skills.actions.identify-magic`,"identify-alchemy":`${B}.skills.actions.identify-alchemy`,"learn-spell":`${B}.skills.actions.learn-spell`,"crafting-goods":`${B}.skills.actions.crafting-goods`,"staging-performance":`${B}.skills.actions.staging-performance`},et={"sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:Ze,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},Kt={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},ie=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&Bt.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>Le(t,Ze)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"]},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>Le(t,zt)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];ie.forEach(t=>{t.actions=t.actions.map(s=>typeof s=="string"?Kt[s]:s);let{slug:e,actions:i}=t;for(let s of i){let a=s.slug.replace(/-(.)/g,(n,o)=>o.toUpperCase()).capitalize();s.skillSlug=e,s.uuid=et[s.slug],s.label=Gt[s.slug]??`PF2E.Actions.${a}.Title`,s.variants?s.variants=s.variants.map(n=>({slug:n,label:`${B}.skills.actions.${n}`})):s.map&&(s.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),s.modifiers?.forEach(({modifiers:n})=>{n.forEach(o=>{o.label=`${B}.skills.modifiers.${o.slug}`})})}});var Ae=ie.map(t=>t.slug),qt=ie.reduce((t,{slug:e,actions:i})=>(t[e]={slug:e,actions:i.reduce((s,a)=>(s[a.slug]=a,s),{})},t),{}),tt=new Set(Object.values(et).filter(Boolean));function Fe(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}c(Fe,"getSkillLabel");async function st(t){let e=[],i=!b("untrained"),s=!t.isOfType("character");for(let n=0;n<ie.length;n++){let{slug:o,actions:r}=ie[n],{label:l,rank:u,mod:f}=t.getStatistic(o);e[n]={slug:o,label:l,rank:u,modifier:z(f),actions:r.filter(p=>(i||s||!p.trained||t.skills[o].rank>=1)&&(!p.condition||p.condition(t)))}}let a=Object.values(t.skills).filter(n=>n.lore).map(({label:n,rank:o,mod:r,slug:l})=>({slug:l,label:n,rank:o,modifier:z(r)}));return{contentData:{skills:e,lores:a},doubled:b("skills-columns")}}c(st,"getSkillsData");function it(t,e){t.find("[data-action=action-description]").on("click",i=>{i.preventDefault();let s=$(i.currentTarget).closest(".action");N(s,e,s.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=roll-skill]").on("click",i=>{i.preventDefault();let{slug:s}=i.currentTarget.dataset;e.getStatistic(s)?.roll({event:i})}),t.find("[data-action=roll-action]").on("click contextmenu",async i=>{i.preventDefault();let s=$(i.currentTarget),{skillSlug:a,slug:n}=s.closest(".action").data(),o=i.type==="contextmenu"?await ke(a):void 0;o!==null&&Wt(i,e,a,n,s.data(),o?.selected)}),t.find("[data-action=action-chat]").on("click",async i=>{i.preventDefault();let{uuid:s}=i.currentTarget.closest(".action").dataset,a=await fromUuid(s);a&&we(i,a,e,{create:!0})}))}c(it,"addSkillsListeners");async function ke(t,e){let i=Ae.map(a=>({slug:a,label:Fe(a)})),s=await renderTemplate(L("dialogs/variant"),{i18n:a=>I(`skills.variant.${a}`),dc:e,skills:i,selected:t});return Dialog.prompt({title:I("skills.variant.title"),label:I("skills.variant.button"),callback:a=>({selected:a.find("select").val(),dc:a.find("input").val()}),rejectClose:!1,content:s,options:{width:280}})}c(ke,"createVariantDialog");function Wt(t,e,i,s,{variant:a,map:n},o){let r=qt[i].actions[s],l=r.type;o??=r.noSkill?void 0:i;let u={event:t,actors:[e],variant:a,rollMode:r.secret?"blindroll":"roll"};if(u.modifiers=[],r.modifiers){for(let{condition:f,modifiers:p}of r.modifiers)if(!(f&&!f(e)))for(let d of p)u.modifiers.push(new game.pf2e.Modifier(d))}if(r.custom){r.custom(e,u);return}else if(!l){e.getStatistic(o)?.roll(u);return}l===1?(u.skill=o,n&&u.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:n})),game.pf2e.actions[s](u)):l===2?(u.statistic=o,n&&(u.multipleAttackPenalty=n/-5),game.pf2e.actions.get(s).use(u)):l===3&&game.pf2e.actions[s](e)}c(Wt,"rollAction");var X={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionTypeReaction",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionTypeFree",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.ActionTypePassive",actionLabel:"PF2E.ActionTypePassive"}},nt={delay:[500,0],position:"top",theme:"crb-hover",arrow:!1};async function at(t,e,i){let s=t.isOfType("character"),a=t.synthetics.toggles.slice(),n=b("actions"),o=s?Yt(t):Jt(t),r,l=game.modules.get("pf2e-hero-actions");if(l?.active&&s){let p=l.api.getHeroActions(t),d=t.heroPoints.value-p.length;r={actions:p,draw:Math.max(d,0),discard:Math.abs(Math.min(d,0)),canTrade:p.length&&game.settings.get("pf2e-hero-actions","trade")}}let u=t.system.actions&&await Promise.all(t.system.actions.filter(p=>p.visible!==!1).map(async(p,d)=>({...p,index:d,damageFormula:await p.damage?.({getFormula:!0}),criticalFormula:await p.critical?.({getFormula:!0})}))),f={};for(let p of o)G(p.name,i)&&(n!=="split"?(f.action??=[],f.action.push(p)):(f[p.type]??=[],f[p.type].push(p)));if(f=Object.entries(f).map(([p,d])=>(d.forEach(m=>{m.img=Qe(m.cost),m.typeLabel=X[m.type].actionLabel}),n!=="type"?d.sort((m,g)=>m.name.localeCompare(g.name)):d.sort((m,g)=>{let k=X[m.type].order,v=X[g.type].order;return k===v?m.name.localeCompare(g.name):k-v}),{type:p,actions:d,label:X[p].label})),n==="split"&&f.sort((p,d)=>X[p.type].order-X[d.type].order),a.length||u?.length||f.length||r?.length)return{contentData:{toggles:a,strikes:u,sections:f,heroActions:r,damageTypes:CONFIG.PF2E.damageTypes},doubled:b("actions-columns"),classes:[b("actions-colors")?"attack-damage-system-colors":""]}}c(at,"getActionsData");function ot(t,e){j(t.find(".toggle")),j(t.find(".strike")),j(t.find(".action"));function i(n,o,r="click"){return n=typeof n=="string"?[n]:n,n=n.map(l=>`[data-action=${l}]`).join(", "),t.find(n).on(r,l=>{l.preventDefault(),o(l)})}c(i,"action");function s(n){let{index:o}=n.currentTarget.closest(".strike").dataset;return e.system.actions[o]}c(s,"getStrike");function a(n){return $(n.currentTarget).closest(".action").data().uuid}c(a,"getUuid"),i("action-description",async n=>{let o=$(n.currentTarget).closest(".action");N(o,e)}),i("hero-action-description",async n=>{let{description:o,name:r}=await Vt(a(n))??{};o&&te(r,o,e)}),i("strike-description",async n=>{let o=s(n);if(!o)return;let r=document.createElement("div");r.classList.add("description"),r.innerHTML=await renderTemplate(L("strike-description"),o),te(o.label,r,e)}),i("trait-description",n=>{let o=s(n);if(!o)return;let{index:r}=n.currentTarget.dataset,l=o.traits[r];if(!l)return;let u=game.i18n.localize(l.description);u&&te(game.i18n.localize(l.label),u,e)}),e.isOwner&&(i("action-chat",n=>{R(n,e)?.toMessage(n,{create:!0})}),i("hero-action-chat",async n=>{await game.modules.get("pf2e-hero-actions")?.api.sendActionToChat(e,a(n))}),i("draw-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.drawHeroActions(e)}),i("use-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.useHeroAction(e,a(n))}),i("discard-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.discardHeroActions(e,a(n))}),i("trade-hero-action",async n=>{game.modules.get("pf2e-hero-actions")?.api.tradeHeroAction(e)}),i("strike-attack",n=>{let{index:o}=n.currentTarget.dataset;s(n)?.variants[o].roll({event:n})}),i(["toggle-roll-option","set-suboption"],n=>{let o=n.currentTarget.closest(".toggle"),{domain:r,option:l,itemId:u}=o.dataset,f=o.querySelector("select")?.value??null;e.toggleRollOption(r,l,u??null,o.querySelector("input").checked,f)}),i(["strike-damage","strike-critical"],n=>{let{action:o}=n.currentTarget.dataset;s(n)?.[o==="strike-damage"?"damage":"critical"]({event:n})}).tooltipster(nt),i("strike-auxiliary",n=>{if(n.currentTarget!==n.target)return;let o=s(n);if(!o)return;let{index:r}=n.currentTarget.dataset,l=n.currentTarget.querySelector("select")?.value??null;o.auxiliaryActions?.[r]?.execute({selection:l})}),i("toggle-versatile",n=>{let o=s(n)?.item;if(!o)return;let r=n.currentTarget,{value:l}=r.dataset,u=o?.system.damage.damageType??null,f=r.classList.contains("selected")||l===u?null:l;Xe({trait:"versatile",weapon:o,selection:f})}).tooltipster(nt),i("strike-ammo",async n=>{let o=s(n)?.item;if(!o)return;let r=e.items.get(n.currentTarget.value);await o.update({system:{selectedAmmoId:r?.id??null}})},"change"))}c(ot,"addActionsListeners");function Vt(t){return game.modules.get("pf2e-hero-actions")?.api.getHeroActionDetails(t)}c(Vt,"getHeroActionDescription");function Yt(t){let e=t.itemTypes.action.filter(s=>!tt.has(s.sourceId)),i=t.itemTypes.feat.filter(s=>s.actionCost);return[...e,...i].filter(s=>{let a=s.system.traits.value;return!a.includes("downtime")&&!a.includes("exploration")}).map(s=>{let a=s.actionCost;return{id:s.id,type:a?.type??"free",cost:a,name:s.name}})}c(Yt,"getCharacterActions");function Jt(t){return t.itemTypes.action.map(e=>{let i=e.actionCost,s=i?.type??"passive",a=s==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(n=>n.key==="Aura"));return{id:e.id,type:s,cost:i,name:e.name,hasDeathNote:e.system.deathNote,hasAura:a}})}c(Jt,"getNpcActions");var Qt=["arcana","crafting","medicine","nature","occultism","religion","society"],rt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function ct(t){let e=await new Roll("1d20").evaluate({async:!0}),i=e.total,s=e.dice[0].total,a=s===1?"0":s===20?"3":"",n=Object.values(t.skills).filter(u=>u.lore),o=ve(u=>u.actor?.identificationDCs),r={dieSuccess:a,dieResult:s,target:o,i18n:u=>I(`actions.recall-knowledge.${u}`)};if(o){let{standard:u,skills:f,lore:p}=o.actor.identificationDCs,d=u.progression.slice();d.length=4,d=[...d];let m=p.map(({progression:g})=>{let k=g;return k.length=6,[...k]});r.skillsDCs=d,r.skills=f.map(g=>{let{mod:k,label:v,rank:M}=t.skills[g],A=i+k;return{label:v,mod:k,rank:M,rankLabel:ge[M],total:A,checks:d.map(x=>{if(!x)return"-";let F=fe(A,s,x);return{success:F,icon:rt[F].icon,title:rt[F].name}})}}),r.loresDCs=m,r.lores=n.map(({label:g,rank:k,mod:v})=>({label:g,rank:k,mod:v,modifier:z(v)}))}else r.skills=[...Qt.map(u=>t.skills[u]),...n].map(({label:u,rank:f,mod:p})=>({label:u,rank:f,mod:p,modifier:z(p)}));let l=await renderTemplate(L("chat/recall-knowledge"),r);ChatMessage.create({flavor:l,speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL})}c(ct,"rollRecallKnowledges");async function lt(t,e,i){let{attributes:s}=t,{initiative:a}=s;return{contentData:{noMacro:I("extras.no-macro"),macros:he(t).filter(n=>G(n.name,i)),initiative:a&&{selected:a.statistic,skills:Ae.map(n=>({slug:n,label:Fe(n)}))},hasDailies:game.modules.get("pf2e-dailies")?.active}}}c(lt,"getExtrasData");function ut(t,e,i){function s(n,o,r="click"){t.find(`[data-action=${n}]`).on(r,l=>{l.preventDefault(),o(l)})}if(c(s,"action"),s("action-description",n=>{let o=$(n.currentTarget).closest(".row");N(o,e)}),!e.isOwner)return;j(t.find(".macro"));async function a(n){let{uuid:o}=n.currentTarget.closest(".macro").dataset;return fromUuid(o)}c(a,"getMacro"),s("delete-macro",n=>be(n,e)),s("edit-macro",async n=>{(await a(n))?.sheet.render(!0)}),s("use-macro",async n=>{(await a(n))?.execute({actor:e,token:i})}),t.on("drop",n=>ye(n,e)),s("action-chat",async n=>{let{uuid:o}=n.currentTarget.closest(".row").dataset,r=await fromUuid(o);r&&we(n,r,e,{create:!0})}),t.find("input[name], select[name]").on("change",async n=>{let o=n.currentTarget,r=o.type==="number"?o.valueAsNumber:o.value;await e.update({[o.name]:r})}),s("roll-initiative",async n=>{await e.initiative.roll({event:n})}),s("prepare-dailies",n=>{let o=game.modules.get("pf2e-dailies");o?.active&&o.api.openDailiesInterface(e)}),s("rest-for-the-night",n=>{game.pf2e.actions.restForTheNight({actors:[e]})}),s("roll-recall-knowledge",n=>{ct(e)}),s("roll-aid",async n=>{let o=await ke(null,20),r={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};o!==null&&game.pf2e.actions.get("aid").use({event:n,actors:[e],statistic:o?.selected,difficultyClass:{value:o?.dc},notes:[r]})},"click contextmenu"),s("roll-escape",async n=>{let o=n.type==="contextmenu"?await ke():void 0;o!==null&&game.pf2e.actions.get("escape").use({event:n,actors:[e],statistic:o?.selected})},"click contextmenu")}c(ut,"addExtrasListeners");async function dt(t){let{system:e}=t,{details:i,traits:s,attributes:a}=e,{stealth:n}=a,{description:o,disable:r,routine:l,reset:u,isComplex:f}=i,p=t.getRollData(),d=t.isOwner,m=c(async g=>Q(g,t,{isOwner:d,rollData:p}),"enrich");return{contentData:{description:await m(o),disable:await m(r),routine:await m(l),reset:await m(u),isComplex:f,rarity:{value:s.rarity,label:CONFIG.PF2E.rarityTraits[s.rarity]},traits:s.value.map(g=>CONFIG.PF2E.hazardTraits[g]),stealth:z(n.value)},style:{["--max-width"]:b("hazard-width")+"em"}}}c(dt,"getHazardData");function pt(t,e){t.find("[data-action=action-description]").on("click",i=>{i.preventDefault();let s=$(i.currentTarget).closest(".action");N(s,e)}),me(t,e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",i=>{i.preventDefault(),e.initiative.roll({event:i})})}c(pt,"addHazardListeners");var ft=new Set(["arcane","divine","occult","primal"]);function Xt(t,e){return t.has(e)}c(Xt,"setHasElement");function Zt(t){return t.traits.has("cursed")?"unique":t.rarity}c(Zt,"getDcRarity");function es(t){let e=t.system.traits.value;return new Set(e.filter(i=>Xt(ft,i)))}c(es,"getMagicTraditions");function ts(t,e,i){let s={occult:e,primal:e,divine:e,arcane:e},a=es(t);for(let n of ft)a.size>0&&!a.has(n)&&(s[n]=e+i);return{arcana:s.arcane,nature:s.primal,religion:s.divine,occultism:s.occult}}c(ts,"getIdentifyMagicDCs");function ss(t,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:i}){let s=ue(t.level,{proficiencyWithoutLevel:e}),a=Zt(t),n=le(s,a);return t.isMagical?ts(t,n,i):t.isAlchemical?{crafting:n}:{dc:n}}c(ss,"getItemIdentificationDCs");function is(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}c(is,"objectHasKey");var ne=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,i=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),s=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",a=ss(e,{proficiencyWithoutLevel:s,notMatchingTraditionModifier:i});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:a}}activateListeners(e){e.find("button.update-identification").on("click",i=>{let s=$(i.delegateTarget);this.submit({updateData:{status:s.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let i=this.item,s=i.system.identification.unidentified.img,a=i.system.identification.unidentified.name,n=i.system.identification.identified.name,o=$("div#identify-item").find("tr").toArray().flatMap(u=>{let f=u.dataset.skill,p=Number(u.dataset.dc);if(!(Number.isInteger(p)&&is(CONFIG.PF2E.skillList,f)))return[];let d=game.i18n.localize(CONFIG.PF2E.skillList[f]);return{slug:f,name:d,dc:p}}),r=i.isMagical?"action:identify-magic":i.isAlchemical?"action:identify-alchemy":null,l=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:s,itemName:a,identifiedName:n,rollOptions:["concentrate","exploration","secret",r].filter(Boolean),skills:o});await CONFIG.ChatMessage.documentClass.create({user:game.user.id,content:l})})}async _updateObject(e,i){let s=i.status;s==="identified"&&await this.item.setIdentificationStatus(s)}};c(ne,"IdentifyItemPopup");var Oe={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function mt(t,e,i){let s={};for(let a of t.inventory.contents)G(a.name,i)&&(s[a.type]??=[],s[a.type].push(a));if(s=Object.entries(s).map(([a,n])=>(n.sort((o,r)=>o.name.localeCompare(r.name)),{type:a,items:n,label:Oe[a].label})).sort((a,n)=>Oe[a.type].order-Oe[n.type].order),s.length)return{doubled:b("items-columns"),contentData:{canCarry:!!t.adjustCarryType,categories:s}}}c(mt,"getItemsData");function gt(t,e){let i=t.find(".item");j(i),i.find("[data-action=item-description]").on("click",async s=>{s.preventDefault();let a=$(s.currentTarget).closest(".item");N(a,e)}),e.isOwner&&(i.find("[data-action=item-chat]").on("click",async s=>{R(s,e)?.toMessage(s,{create:!0})}),i.on("dragstart",s=>{let a=s.target.closest(".item"),{itemType:n,uuid:o}=a.dataset,r=new Image;r.src=a.querySelector(".item-img img").src,r.style.width="32px",r.style.height="32px",r.style.borderRadius="4px",r.style.position="absolute",r.style.left="-1000px",document.body.append(r),s.originalEvent.dataTransfer.setDragImage(r,16,16),s.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:n,uuid:o})),a.addEventListener("dragend",()=>r.remove(),{once:!0})}),t.find(".quantity input").on("change",async s=>{await R(s,e)?.update({"system.quantity":s.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",s=>{s.preventDefault();let{itemId:a}=s.currentTarget.closest(".item").dataset;e.toggleInvested(a)}),t.find("[data-action=repair-item]").on("click",s=>{s.preventDefault();let a=R(s,e);a&&game.pf2e.actions.repair({item:a,actors:[e]})}),t.find("[data-action=toggle-identified]").on("click",s=>{s.preventDefault();let a=R(s,e);a&&(a.isIdentified?a.setIdentificationStatus("unidentified"):new ne(a).render(!0))}),t.find("[data-action=edit-item]").on("click",s=>{s.preventDefault(),Ve(s,e)}),t.find("[data-action=delete-item]").on("click",s=>{s.preventDefault(),Ye(s,e)}),t.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(s,{event:a,origin:n}){let o=R(a,e);if(!o)return;let r=document.createElement("div");r.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:o});let l=r.children[1];$(l).find("[data-carry-type]").on("click",u=>{let{carryType:f,handsHeld:p=0,inSlot:d}=$(u.currentTarget).data();e.adjustCarryType?.(o,f,p,d),s.close()}),s.content(l)}}))}c(gt,"addItemsListeners");async function ht(t,e,i){let s=t.system.resources.focus??{value:0,max:0},a=t.spellcasting.regular,n=b("tradition"),o=[],r=[],l=!1;for(let p of a){let d=p.id,m=n&&p.statistic.label[0],g=await p.getSheetData(),k=g.isFocusPool,v=p.system?.prepared?.value==="charge",M=getProperty(p,"flags.pf2e-staves.staveID")!==void 0,A={value:getProperty(p,"flags.pf2e-staves.charges")??0};for(let x of g.levels){if(!x.active.length||x.uses?.max===0)continue;let F=[],P=x.isCantrip,K=x.active.filter(H=>H&&H.uses?.max!==0);for(let H=0;H<K.length;H++){let{spell:U,expended:Ce,virtual:V,uses:_,castLevel:Te}=K[H];G(U.name,i)&&F.push({name:U.name,img:U.img,tradition:m,castLevel:Te??U.level,slotId:H,entryId:d,itemId:U.id,inputId:g.isInnate?U.id:g.id,inputPath:v?"flags.pf2e-staves.charges":g.isInnate?"system.location.uses.value":`system.slots.slot${x.level}.value`,isCharge:v,isVirtual:V,isInnate:g.isInnate,isCantrip:P,isFocus:k,isPrepared:g.isPrepared,isSpontaneous:g.isSpontaneous||g.isFlexible,slotLevel:x.level,uses:_??(v?A:x.uses),expended:Ce??(k&&!P?s.value<=0:!1),action:U.system.time.value,type:v?M?`${C}.spells.staff`:`${C}.spells.charges`:g.isInnate?"PF2E.PreparationTypeInnate":g.isSpontaneous?"PF2E.PreparationTypeSpontaneous":g.isFlexible?"PF2E.SpellFlexibleLabel":k?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:v?0:g.isPrepared?1:k?2:g.isInnate?3:g.isSpontaneous?4:5})}if(F.length){if(k)if(P)l=!0;else{r.push(...F);continue}o[x.level]??=[],o[x.level].push(...F)}}}if(o.length){let p=b("spells")?(d,m)=>d.order===m.order?d.name.localeCompare(m.name):d.order-m.order:(d,m)=>d.name.localeCompare(m.name);o.forEach(d=>d.sort(p))}r.length&&(r.sort((p,d)=>p.name.localeCompare(d.name)),o[12]=r,l=!1);let f=(await t.spellcasting.ritual?.getSheetData())?.levels.flatMap((p,d)=>p.active.map(({spell:m})=>{if(G(m.name,i))return{name:m.name,img:m.img,slotId:d,itemId:m.id,level:m.level,time:m.system.time.value}}).filter(Boolean));if(o.length||f?.length)return{contentData:{spells:o,rituals:f,focusPool:s,hasFocusCantrips:l},doubled:b("spells-columns")}}c(ht,"getSpellsData");function yt(t,e){j(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async i=>{i.preventDefault();let s=$(i.currentTarget).closest(".spell");N(s,e)}),e.isOwner&&(t.find("[data-action=spell-chat]").on("click",async i=>{R(i,e)?.toMessage(i,{create:!0})}),t.find("[data-action=toggle-pips]").on("click contextmenu",async i=>{i.preventDefault();let s=i.type==="click"?1:-1,a=(e.system.resources.focus?.value??0)+s;await e.update({"system.resources.focus.value":a})}),t.find("[data-action=toggle-prepared]").on("click",i=>{i.preventDefault();let{slotLevel:s,slotId:a,entryId:n,expended:o}=$(i.currentTarget).closest(".spell").data();e.spellcasting.collections.get(n)?.setSlotExpendedState(s??0,a??0,o!==!0)}),t.find("[data-action=cast-spell]").on("click",i=>{i.preventDefault();let{slotLevel:s,slotId:a,entryId:n,itemId:o}=$(i.currentTarget).closest(".spell").data(),r=e.spellcasting.collections.get(n,{strict:!0});if(!r)return;let l=r.get(o,{strict:!0});l&&r.entry.cast(l,{slot:a,level:s})}),t.find("[data-input-path]").on("change",async i=>{let{inputPath:s,entryId:a}=$(i.currentTarget).data(),n=i.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:a,[s]:n}])}))}c(yt,"addSpellsListeners");var Me="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",ns="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo",bt={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},as={G:"fa-solid fa-face-smile-halo",N:"fa-solid fa-face-meh",E:"fa-solid fa-face-angry-horns"},os=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],rs={actions:{getData:at,addListeners:ot},items:{getData:mt,addListeners:gt},spells:{getData:ht,addListeners:yt},skills:{getData:st,addListeners:it},extras:{getData:lt,addListeners:ut},hazard:{getData:dt,addListeners:pt}},ae={fortitude:{icon:"fa-solid fa-hand-fist",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},cs={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-dumbbell",label:"PF2E.SkillAthletics"}},oe=class extends Application{#e=null;#p=null;#s=null;#n=!1;#a=null;#o;#c=[!1,!1,!1];#t=!1;#l=!1;#u=null;#d=null;#i=!1;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#u=(e,i)=>{let s=b("chat")&&$(window.document).find(":hover").filter("#sidebar").length,a=e.actor;if(!a||s||this.mousedown||this.#t||this.#l||!(e instanceof Token)||a.isOfType("loot"))return;let n=e.localTransform,o=e.document;if(!(n.tx!==o.x||n.ty!==o.y)&&(this.#n=i,!(i&&this.#e===e&&this.rendered)))if(i&&!game.keyboard.downKeys.has("ControlLeft")){if(this.#f(e),!this.#a)return this.render(null,null,b("use-holding")==="none"||!$e());clearTimeout(this.#a),this.#a=null,this.render()}else this.close()},this.#o=e=>{let i=e.button;if(![0,2].includes(i))return;if(e.type==="mouseup"){this.#c[i]=!1;return}this.#c[i]=!0;let s=e.target,a=this.element[0];if(a){let n=a.querySelector(".popup");if(a.contains(s)){n&&!n.contains(s)&&n.remove();return}if(s.closest(".app")||s.closest(".tooltipster-base")||a.querySelector(".sidebar.extras")&&s.closest("#hotbar"))return;if(n)return n.remove();this.forceClose()}else this.#s&&(clearTimeout(this.#s),this.#s=null);this.#t=!1},this.#d=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#o),window.addEventListener("mouseup",this.#o),Hooks.on("hoverToken",this.#u),Hooks.on("deleteToken",this.#d),Hooks.on("canvasPan",this.forceClose)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#o),window.removeEventListener("mouseup",this.#o),Hooks.off("hoverToken",this.#u),Hooks.off("deleteToken",this.#d),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:L("hud")})}get mousedown(){return this.#c[0]||this.#c[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return this.actor?.itemTypes.effect.find(e=>e.flags.core?.sourceId===Me)}get isCharacter(){return this.actor?.isOfType("character")}get sidebar(){return this.element.find("> .sidebar")}#f(e){e!==this.#e&&(this.#e&&delete this.#e.actor.apps[this.appId],this.#e=e)}async getData(){let e=this.#e,i=this.#e?.actor;if(!i)return{};let s=null,a=b("saves"),n=b("others"),o=this.isCharacter,{attributes:r}=i,{hp:l,sp:u={max:0,value:0},ac:f}=r,p=game.settings.get("pf2e","staminaVariant"),d=this.#i,m=b("distance"),g=b("scale");if(m==="all"||m==="self"&&d){let h=b("unit").split(","),E=Number(h[0]?.trim())||1,D=h[1]?.trim()||game.system.gridUnits,T=Number(h[2]?.trim())||0,O=canvas.tokens.controlled,ce=!1,q=O.length===1?O[0]:null;(!q||q===e)&&(q=ve(),ce=!0),q&&q!==e&&(s={unit:D,icon:ce?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(q)*E).toFixed(T)})}let k;if(!d||b("see-status")){let h=b("status").split(",").map(E=>E.trim()).filter(Boolean);if(h.length&&l.max){let E=l.max+(p?u.max:0),T=(l.value+(p?u.value:0))/E,O=Math.ceil(T*h.length);k={hue:T*T*122+3,value:O===0?game.i18n.localize("EFFECT.StatusDead"):h.at(O-1)}}}let v={status:k,distance:s,fontSize:g,tokenId:e.id,type:i.isOfType("creature")?"creature":i.type};if(!d||i.isOfType("familiar")&&!i.master)return v;let{level:M,saves:A,isOwner:x,system:F,itemTypes:P}=i,{resistances:K,weaknesses:H,immunities:U}=r;v={...v,isOwner:x,isObserver:d,name:e.document.name,hp:l,ac:f.value,level:M,hasActions:P.action.length||F.actions?.filter(h=>h.visible!==!1).length};let Ce=b("ranks");function V(h,E,D){let T=h.slug,O=E==="bonus"?z(h.mod):h.dc.value;return{slug:T,value:O,label:D[T].label,icon:D[T].icon,rank:Ce&&ge[h.rank]}}c(V,"getStatistic");function _(h,E){if(!h.length)return"";let D=h.map(T=>De(T.label.replace("-"," ").titleCase())).join("");return E?`<li>${game.i18n.localize(E)}<ul>`+D+"</ul></li>":D}if(c(_,"toIWR"),i.isOfType("hazard")){let{hardness:h,emitsSound:E,stealth:D}=r;return{...v,hardness:h,emitsSound:E.toString().capitalize(),immunities:_(U),weaknesses:_(H),resistances:_(K),stealth:{value:D.value,details:await Q(D.details,i)},saves:a!=="none"&&["fortitude","reflex","will"].map(T=>{let O=A[T];return O?V(O,a,ae):{slug:T,label:ae[T].label,icon:ae[T].icon}})}}if(v={...v,sidebarTitles:{actions:`${C}.actions.title`,items:`${C}.items.title`,spells:`${C}.spells.title`,skills:`${C}.skills.title`,extras:`${C}.extras.title`},hasItems:i.inventory.size},i.isOfType("vehicle")){let{hardness:h,collisionDC:E,collisionDamage:D}=r,{details:T}=F,{crew:O,passengers:ce,pilotingCheck:q,speed:Ot}=T;return{...v,hardness:h,crew:O,passengers:ce,pilotingCheck:q,speed:Ot,collisionDC:E.value,collisionDamage:D.value,immunities:_(U),weaknesses:_(H),resistances:_(K),fortitude:V(A.fortitude,a,ae)}}let Te=b("show-death"),{alignment:Ne,heroPoints:Tt}=i,{traits:Ee}=F,{wounded:He,dying:Ue,shield:Et,resolve:Dt,speed:re}=r;function De(h){return`<li>${h.trim()}</li>`}c(De,"toInfo");function xt(h,E){return h.localeCompare(E)}c(xt,"sort");let Lt=Ee?.languages?.value.map(h=>game.i18n.localize(CONFIG.PF2E.languages[h])).filter(Boolean).sort(xt).map(De).join(""),At=o?Ee.senses.map(h=>h.label):Ee.senses.value?.split(",").filter(Boolean),Z=os.map(({type:h,icon:E},D)=>({index:D,icon:E,label:game.i18n.localize(CONFIG.PF2E.speedTypes[h]??"PF2E.SpeedTypesLand"),value:(D===0?re.total:re.otherSpeeds.find(T=>T.type===h)?.total)||0})),_e=J(i,`speeds.selected.${game.user.id}`),Ft=(()=>{let h=0;if(_e!==void 0)h=_e;else if(b("force-speed")||Z[0].value===0){let E={index:0,value:Z[0].value};h=Z.reduce((D,{value:T},O)=>T>D.value?{index:O,value:T}:D,E).index}return Z.splice(h,1)[0]})(),je=Z.map(({value:h,label:E,index:D})=>`<a data-index="${D}"><li>${E}: ${h}</li></a>`).join("");return re.details&&(je+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${re.details}</li>`),{...v,sp:p?u:{max:0},hero:Tt,dying:Ue,wounded:He,shield:Et,resolve:Dt,alignment:{value:Ne,icon:as[Ne.at(-1)]},isCharacter:o,showDeathLine:o&&(Te==="always"||Ue.value||He.value),hasCover:this.hasCover,saves:a!=="none"&&["fortitude","reflex","will"].map(h=>V(A[h],a,ae)),others:n!=="none"&&["perception","stealth","athletics"].map(h=>V(i.getStatistic(h),n,cs)),speeds:{main:Ft,others:je},iwr:_(U,"PF2E.ImmunitiesLabel")+_(H,"PF2E.WeaknessesLabel")+_(K,"PF2E.ResistancesLabel"),senses:At?.map(De).join(""),languages:Lt,hasSpells:i.spellcasting.some(h=>h.category!=="items")}}#m(e){this.#f(null),this.#n=!1,this.#t=!1,this.#l=!1,this.#i=!1,this.#s!==null&&(clearTimeout(this.#s),this.#s=null);let i=Application.RENDER_STATES;if(!e.force&&![i.RENDERED,i.ERROR].includes(this._state))return;this._state=i.CLOSING;let s=this.element;if(!s)return this._state=i.CLOSED;s.css({minHeight:0});for(let a of this.constructor._getInheritanceChain())Hooks.call(`close${a.name}`,this,s);s.remove(),this._element=null,this._state=i.CLOSED,delete ui.windows[this.appId]}close(e={}){if(e.force)return this.#m(e);this.#a=setTimeout(()=>{this.#a=null,!this.#n&&this.#m(e)})}async _render(e=!1,i={}){let s,a,n;if(this.#p===this.#e){let o=this.element.find("> .sidebar")[0];if(o){s=o.dataset.type,a=o.scrollTop;let r=o.querySelector(".sidebar-header");r.classList.contains("show")&&(n=r.querySelector(" input").value.trim())}}if(await super._render(e,i),ui.windows[this.appId]=this,s){let o=await this.#r(s,n);a>0&&(o.scrollTop=a)}this.#p=this.#e}render(e,i,s){let a=this.#e,n=a?.actor;if(!n)return;let o=$e(),r=b("use-holding"),l=n.system.details.alliance==="party";if(game.user.isGM&&r==="half"&&!o?this.#i=!1:n.isOfType("familiar")&&!n.master?this.#i=!1:this.#i=a.isOwner||b("observer")&&(a.observer||l&&b("party")),r!=="none"&&!o&&(r==="all"||this.#i))return;if(!s)return super.render(!0);let u=b("delay");u?this.#s=setTimeout(()=>super.render(!0),u):super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let i=this.element[0],s=e.worldTransform.a,a=i.getBoundingClientRect(),n=canvas.clientCoordinatesFromCanvas(e.document._source),o={x:n.x,y:n.y,width:e.hitArea.width*s,height:e.hitArea.height*s,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},r,l=this.#i?bt[b("position")].slice():bt[b("small-position")].slice();for(;l.length&&!r;){let u=l.shift();u==="left"?(r={x:o.x-a.width,y:Pe(a,o)},r.x<0&&(r=void 0)):u==="right"?(r={x:o.right,y:Pe(a,o)},r.x+a.width>window.innerWidth&&(r=void 0)):u==="top"?(r={x:vt(a,o),y:o.y-a.height},r.y<0&&(r=void 0)):u==="bottom"&&(r={x:vt(a,o),y:o.bottom},r.y+a.height>window.innerHeight&&(r=void 0))}return r&&(i.style.left=`${r.x}px`,i.style.top=`${r.y}px`),r}activateListeners(e){let i=this.#e,s=i?.actor;if(!s)return;let a=i.isOwner,n=CONFIG.ChatMessage.documentClass;s.apps[this.appId]=this,b("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(this.#n=!0,this.#l=!0)}),e.on("mouseleave",()=>{this.#l=!1,!this.#t&&(this.#n=!1,this.close())}),e.on("dragover",()=>{i.isOwner&&e.find("> .sidebar.extras").length&&!e.find(".popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let o=e.find("[data-action=show-info]");o.tooltipster({position:["top","bottom","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click"}),o.filter(".stealth").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(l,{origin:u,tooltip:f})=>{this.#t=!0,$(f).find(".content-link").on("click",()=>setTimeout(()=>l.close()))}).tooltipster("option","functionAfter",()=>{e.find("> .sidebar").length||(this.#t=!1)}),(a?o.filter(":not(.speeds):not(.stealth)"):o).on("mouseleave",l=>{$(l.currentTarget).tooltipster("hide")}),e.find("[data-action=open-sidebar]").on("click",this.#r.bind(this)),a&&(e.find("[data-action=collision-dc]").on("click",l=>{l.preventDefault();let u=s.system.attributes.collisionDC.value||15;n.create({content:`@Check[type:reflex|dc:${u}]`,speaker:n.getSpeaker({actor:s})})}),e.find("[data-action=collision-damage]").on("click",async l=>{l.preventDefault();let u=(s.system.attributes.collisionDamage.value||"1d6").trim();isNaN(Number(u.at(-1)))||(u+="[bludgeoning]");let f=CONFIG.Dice.rolls.find(d=>d.name==="DamageRoll"),p=await new f(u).evaluate({async:!0});n.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:n.getSpeaker({actor:s}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[p]})}),e.find("input").on("change",async l=>{let u=l.currentTarget,f=u.valueAsNumber,p=u.name;u.blur(),p!=="shield.value"?await s.update({[p]:f}):await s.heldShield.update({"system.hp.value":f})}),e.find("[data-action=toggle-hero]").on("click contextmenu",l=>{l.preventDefault();let{max:u,value:f}=s.heroPoints,p=l.type==="click"?1:-1,d=Math.clamped(f+p,0,u);d!==f&&s.update({"system.resources.heroPoints.value":d})}),e.find("[data-action=raise-shield]").on("click",l=>{l.preventDefault(),game.pf2e.actions.raiseAShield({actors:[s]})}),e.find("[data-action=take-cover]").on("click",async l=>{l.preventDefault();let u=(await fromUuid(Me)).toObject();setProperty(u,"flags.core.sourceId",Me);let f=this.hasCover;this.hasCover?await f.delete():await s.createEmbeddedDocuments("Item",[u])}),e.find("[data-action=roll-save]").on("click",l=>{l.preventDefault();let u=l.currentTarget.dataset.save;s.saves[u].roll({event:l})}),e.find("[data-action=roll-other]").on("click",l=>{l.preventDefault();let u=l.currentTarget.dataset.slug;if(u!=="athletics"){let{ctrlKey:f,metaKey:p,shiftKey:d}=l;l=new MouseEvent("click",{ctrlKey:!f,metaKey:p,shiftKey:d})}s.getStatistic(u)?.roll({event:l})}),e.find("[data-action=recovery-check]").on("click",l=>{l.preventDefault(),s.rollRecovery(l)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",l=>{l.preventDefault();let u=l.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",f=s.system.attributes[u]?.max;f&&(l.type==="click"?s.increaseCondition(u,{max:f}):s.decreaseCondition(u))}),e.find("[data-action=use-resolve]").on("click",l=>{l.preventDefault(),ls(s)}),o.filter(".speeds").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(l,{origin:u,tooltip:f})=>{this.#t=!0,f.querySelectorAll("[data-index]").forEach(p=>{p.addEventListener("click",async d=>{d.preventDefault(),await ee(s,`speeds.selected.${game.user.id}`,Number(p.dataset.index))})})}).tooltipster("option","functionAfter",()=>{e.find("> .sidebar").length||(this.#t=!1)}))}async showFilter(){let e=this.sidebar;e&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#r(e.data().type,"")),e.find(".sidebar-header").find("input").focus(),e.scrollTop(0))}async#r(e,i){e=typeof e=="string"?e:e.currentTarget.dataset.type;let s=this.element,a=this.sidebar,n=a[0]?.dataset.type;if(a.remove(),s.find("[data-action=open-sidebar]").removeClass("active"),n===e&&i===void 0){this.#t=!1;return}let o=this.#e,r=o.actor,l=i!==void 0||b("filter"),{getData:u,addListeners:f}=rs[e],p=await u(r,o,i?.toLowerCase())??{};if(!p.contentData&&!l)return ui.notifications.warn(I(`${e}.empty`,{name:this.#e.name}));let d={...p.contentData??{},isGM:game.user.isGM,isCharacter:this.isCharacter,isOwner:r.isOwner};this.#t=!0,s.find(`[data-action=open-sidebar][data-type=${e}]`).addClass("active"),s=s[0];let m=p.classes??[];m.push(e),b("scrollbar")||m.push("no-scrollbar"),p.doubled&&m.push("doubled");let g=p.style??{};g["--max-height"]=b("height").trim()||"100%";let k=document.createElement("div");k.innerHTML=await renderTemplate(L("sidebar"),{classes:m.join(" "),style:Object.entries(g).map(([P,K])=>`${P}: ${K}`).join("; "),type:e,filter:i,filterLabel:I("filter"),showFilter:l,content:(await renderTemplate(L(`sidebars/${e}`),d)).trim()}),a=k.firstElementChild,this.element.append(a);let v=a.getBoundingClientRect(),M=s.getBoundingClientRect(),A=M.x-v.width;A<0&&(A=M.right);let x=parseInt(window.getComputedStyle(s).padding),F=Pe(v,M,x);return a.style.left=`${A}px`,a.style.top=`${F}px`,a=$(a),a.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",P=>{P.preventDefault(),a.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#r(e,"")}),a.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",P=>{P.key==="Enter"&&this.#r(e,P.currentTarget.value.trim())}),f(a,r,o),a}};c(oe,"HUD");function Pe(t,e,i=0){let s=e.y+e.height/2-t.height/2;return s+t.height>window.innerHeight&&(s=window.innerHeight-t.height-i),s<0&&(s=i),s}c(Pe,"postionFromTargetY");function vt(t,e){let i=e.x+e.width/2-t.width/2;return i+t.width>window.innerWidth&&(y=window.innerWidth-t.width),i<0&&(i=0),i}c(vt,"postionFromTargetX");async function ls(t){function e(f){ChatMessage.create({user:game.user.id,content:f,speaker:ChatMessage.getSpeaker({actor:t})})}c(e,"toChat");let{name:i,attributes:s}=t,{sp:a,resolve:n}=s,o=I("hud.resolve.full",{name:i}),r=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:i});if(a.value===a.max)return ui.notifications.warn(o);if(n.value<1)return ui.notifications.warn(r);let l=t.itemTypes.feat.find(f=>f.sourceId===ns),u=await renderTemplate(L("dialogs/resolve"),{hasSteel:l,i18n:f=>I(`hud.resolve.${f}`)});new Dialog({title:I("hud.resolve.title"),content:u,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:I("hud.resolve.yes"),callback:async f=>{let{attributes:p}=t,{sp:d,resolve:m}=p;if(d.value===d.max)return e(o);if(m.value<1)return e(r);let g=f.find("input:checked").val(),k=`${d.value}/${d.max}`;if(g==="breather")e(I("hud.resolve.breather.used",{name:i,ratio:k})),await t.update({"system.attributes.sp.value":d.max,"system.attributes.resolve.value":m.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:i,ratio:k}));let v=d.value+Math.floor(d.max/2);await t.update({"system.attributes.sp.value":Math.min(v,d.max),"system.attributes.resolve.value":m.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:I("hud.resolve.no")}}}).render(!0)}c(ls,"useResolve");var C="pf2e-token-hud",W=null;function se(t=!1){return t?W?.element:W}c(se,"getHud");function Ie(t){t&&!W?W=new oe:!t&&W&&(W.delete(),W=null)}c(Ie,"enableModule");function b(t){return game.settings.get(C,t)}c(b,"getSetting");function I(...t){let e=t.at(-1),i=typeof e=="object",s=i?t.slice(0,-1):t;return s.unshift(C),game.i18n[i?"format":"localize"](s.join("."),e)}c(I,"localize");function Le(t,e){return t.itemTypes.feat.some(i=>i.sourceId===e)}c(Le,"hasFeat");function L(t){return`modules/${C}/templates/${t}.hbs`}c(L,"templatePath");function z(t){return t>=0?`+${t}`:t}c(z,"modifier");function J(t,e){return t.getFlag(C,e)}c(J,"getFlag");function ee(t,e,i){return t.setFlag(C,e,i)}c(ee,"setFlag");async function Q(t,e,{isOwner:i=e.isOwner,rollData:s=e.getRollData()}={}){return t=t?.trim(),t?await TextEditor.enrichHTML(t,{async:!0,secrets:i,rollData:s}):""}c(Q,"enrichHTML");var Re=!1;function It(){kt("hold",{onDown:()=>{Re=!0,b("use-holding")!=="none"&&se()?.render()},onUp:()=>{Re=!1}}),kt("filter",{onDown:()=>{se()?.showFilter()},editable:[{key:"KeyF",modifiers:["Control"]}]})}c(It,"registerKeybindings");function $e(){return Re}c($e,"isHolding");function wt(t,e){return`${C}.keybinds.${t}.${e}`}c(wt,"path");function kt(t,e={}){game.keybindings.register(C,t,{name:wt(t,"name"),hint:wt(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}c(kt,"register");function St(){let t=game.data.users.find(i=>i._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(i=>I(`settings.status.statuses.${i}`)).join(", ");w("status",String,e,{scope:"world"}),w("party",Boolean,!1,{scope:"world"}),w("enabled",Boolean,!0,{onChange:Ie}),w("position",String,"right",{choices:{left:S("position","choices.left"),right:S("position","choices.right"),top:S("position","choices.top"),bottom:S("position","choices.bottom")}}),w("small-position",String,"top",{choices:{left:S("position","choices.left"),right:S("position","choices.right"),top:S("position","choices.top"),bottom:S("position","choices.bottom")}}),w("delay",Number,250,{range:{min:0,max:2e3,step:50}}),w("scale",Number,14,{range:{min:10,max:30,step:1}}),w("use-holding",String,"none",{hint:S("use-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:S("use-holding","choices.none"),half:S("use-holding",t?"choices.gm.half":"choices.player.half"),all:S("use-holding",t?"choices.gm.all":"choices.player.all")}}),w("observer",Boolean,!0),w("see-status",Boolean,!1),w("chat",Boolean,!0),w("saves",String,"bonus",{choices:{none:S("saves","choices.none"),bonus:S("saves","choices.bonus"),dc:S("saves","choices.dc")}}),w("others",String,"none",{choices:{none:S("saves","choices.none"),bonus:S("saves","choices.bonus"),dc:S("saves","choices.dc")}}),w("ranks",Boolean,!1),w("show-death",String,"always",{choices:{none:S("show-death","choices.none"),always:S("show-death","choices.always"),only:S("show-death","choices.only")}}),w("force-speed",Boolean,!1),w("tooltips",Boolean,!1),w("distance",String,"all",{choices:{none:S("distance","choices.none"),self:S("distance","choices.self"),all:S("distance","choices.all")}}),w("unit",String,""),w("height",String,""),w("filter",Boolean,!1),w("scrollbar",Boolean,!0),w("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),w("actions-columns",Boolean,!1),w("items-columns",Boolean,!1),w("spells-columns",Boolean,!1),w("skills-columns",Boolean,!1),w("actions",String,"split",{choices:{name:S("actions","choices.name"),type:S("actions","choices.type"),split:S("actions","choices.split")}}),w("actions-colors",Boolean,!0),w("spells",Boolean,!1),w("tradition",Boolean,!1),w("untrained",Boolean,!0)}c(St,"registerSettings");function Ct(t,e){let i=e.find(`.tab[data-tab=${C}]`);function s(a,n,o="h3"){let r=I(`menu.${n}`);i.find(`[name="${C}.${a}"]`).closest(".form-group").before(`<${o}>${r}</${o}>`)}c(s,"beforeGroup"),game.user.isGM&&s("enabled","client.header","h2"),s("saves","client.tooltip"),s("distance","client.distance"),s("height","client.sidebar"),s("actions","client.actions"),s("spells","client.spells"),s("untrained","client.skills")}c(Ct,"renderSettingsConfig");function S(t,e){return`${C}.settings.${t}.${e}`}c(S,"path");function w(t,e,i,s={}){game.settings.register(C,t,{name:S(t,"name"),hint:S(t,"hint"),scope:"client",config:!0,type:e,default:i,...s})}c(w,"register");Hooks.once("setup",async()=>{St(),It(),await loadTemplates({creature:L("tooltips/creature"),hazard:L("tooltips/hazard"),vehicle:L("tooltips/vehicle")})});Hooks.once("ready",()=>{b("enabled")&&Ie(!0)});Hooks.on("renderSettingsConfig",Ct);Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${C}.actor.macros.contextmenu`,condition:i=>{let{documentId:s}=i.data();return b("enabled")&&game.actors.get(s)?.isOwner},callback:i=>{let{documentId:s}=i.data();us(s)}})});var Se=class extends Dialog{async getData(e={}){let i=super.getData(e);return typeof i.content=="function"&&(i.content=await i.content()),i}};c(Se,"DataDialog");function us(t){let e=game.actors.get(t);if(!e)return;let i=new Se({title:`${e.name} - ${I("actor.macros.title")}`,content:async()=>{let s=he(e)??[];return renderTemplate(L("dialogs/macros"),{macros:s,noMacro:I("extras.no-macro")})},buttons:{},render:s=>{e.apps[i.appId]=i,s.on("drop",a=>ye(a,e)),s.find("[data-action=delete-macro]").on("click",a=>be(a,e))},close:()=>{delete e.apps[i.appId]}},{height:"auto"}).render(!0)}c(us,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
