(()=>{var Ut=Object.defineProperty;var l=(i,e)=>Ut(i,"name",{value:e,configurable:!0});var zt=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),jt=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function _t(i,e="normal"){return i+(zt.get(e)??0)}l(_t,"adjustDC");function Bt(i="common"){switch(i){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}l(Bt,"rarityToDCAdjustment");function ue(i,e="common"){return _t(i,Bt(e))}l(ue,"adjustDCByRarity");function de(i,{proficiencyWithoutLevel:e,rarity:s="common"}={}){let t=game.settings.get("pf2e","proficiencyVariant");e??=t==="ProficiencyWithoutLevel";let a=jt.get(i)??14;return ue(e?a-Math.max(i,0):a,s)}l(de,"calculateDC");function ee(i,e){return i instanceof Element||i instanceof Document?Array.from(i.querySelectorAll(e)):[]}l(ee,"htmlQueryAll");function Fe(i,e){return i instanceof Element?i.closest(e):null}l(Fe,"htmlClosest");function Gt(i){return!!i&&"ctrlKey"in i&&"metaKey"in i&&"shiftKey"in i}l(Gt,"isRelevantEvent");function pe(i){let e=!game.user.settings.showRollDialogs;if(!Gt(i))return{skipDialog:e};let s={skipDialog:i.shiftKey?!e:e};return(i.ctrlKey||i.metaKey)&&(s.rollMode=game.user.isGM?"gmroll":"blindroll"),s}l(pe,"eventToRollParams");var fe={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},qe={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function Ke(i,e){switch(i){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+i,0,3)}}l(Ke,"adjustDegreeOfSuccess");function me(i,e){return i===20?Ke(qe.INCREASE,e):i===1?Ke(qe.LOWER,e):e}l(me,"adjustDegreeByDieValue");function ge(i,e,s){return i-s>=10?me(e,fe.CRITICAL_SUCCESS):s-i>=10?me(e,fe.CRITICAL_FAILURE):i>=s?me(e,fe.SUCCESS):me(e,fe.FAILURE)}l(ge,"calculateDegreeOfSuccess");var Ve=["action","check","effect-area"].map(i=>`[data-pf2-${i}]`).join(",");function qt(i,e){for(let s of i){(!e||e.isOwner)&&s.classList.add("with-repost");let t=ee(s,"i[data-pf2-repost]");if(t.length>0){if(e&&!e.isOwner){for(let o of t)o.remove();s.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let a=document.createElement("i"),n=s.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";a.classList.add("fas",n),a.setAttribute("data-pf2-repost",""),a.setAttribute("title",game.i18n.localize("PF2E.Repost")),s.appendChild(a)}}l(qt,"injectRepostElement");function Kt(i,e=null){for(let s of ee(i,"a.inline-roll[data-damage-roll]")){let t=Fe(s,"[data-item-id]")?.dataset.itemId,a=e?.items.get(t??"");a&&(s.dataset.flavor||=a.name)}}l(Kt,"flavorDamageRolls");function We(i,e){let s=i.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${i.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${s}</span> ${i.outerHTML}`.trim()}l(We,"makeRepostHtml");function Wt(i,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(c=>c in i.dataset))return;let s=e?.hasPlayerOwner?"all":"gm",t=(()=>i.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${ee(i.parentElement,Ve).map(u=>We(u,s)).join("<br>")}</div>`:We(i,s))(),a=CONFIG.ChatMessage.documentClass,n=e instanceof Actor?a.getSpeaker({actor:e,token:e.token??e.getActiveTokens(!1,!0).shift()}):a.getSpeaker(),o=game.messages.get(Fe(i,"[data-message-id]")?.dataset.messageId??""),r=o?.flags.pf2e.origin?{pf2e:{origin:deepClone(o.flags.pf2e.origin)}}:{};a.create({speaker:n,content:t,flags:r})}l(Wt,"repostAction");function he(i,e){let s=i instanceof HTMLElement?i:i[0],t=ee(s,Ve).filter(n=>n.nodeName==="SPAN");qt(t,e),Kt(s,e),ee(s,"i[data-pf2-repost]").forEach(n=>n.addEventListener("click",o=>{let r=o.target;if(!(r instanceof HTMLElement))return;let c=r?.parentElement;c&&Wt(c,e),o.stopPropagation()}));let a=$(t);a.filter("[data-pf2-action]").on("click",n=>{let o=$(n.currentTarget),{pf2Action:r,pf2Glyph:c,pf2Variant:u,pf2Dc:f,pf2ShowDc:p,pf2Skill:d}=o[0]?.dataset??{},m=game.pf2e.actions[r?game.pf2e.system.sluggify(r,{camel:"dromedary"}):""],g=p??"all";r&&m?m({event:n,glyph:c,variant:u,difficultyClass:f?{scope:"check",value:Number(f)||0,visibility:g}:void 0,skill:d,actors:[e]}):console.warn(`PF2e System | Skip executing unknown action '${r}'`)}),a.filter("[data-pf2-check]").on("click",async n=>{let{pf2Check:o,pf2Dc:r,pf2Traits:c,pf2Label:u,pf2Adjustment:f}=n.currentTarget.dataset,p=c?.split(",").map(m=>m.trim()).filter(m=>!!m),d=pe(n);switch(o){case"flat":{let m=Number.isInteger(Number(r))?{label:u,value:Number(r)}:null,g=await new Roll("1d20").evaluate({async:!0}),h=g.total,k=g.dice[0].total,S=ge(h,k,m.value),L={value:S,unadjusted:S,adjustment:null,dieResult:k,rollTotal:h,dc:m},T=(await game.pf2e.Check.createResultFlavor({degree:L})).outerHTML;g.toMessage({flavor:T});break}default:{let m=e.getStatistic(o??"");if(m){let g=(()=>{let k=Number(f)||0;return r==="@self.level"?de(e.level)+k:Number(r)+k})(),h=Number.isInteger(g)?{label:u,value:g}:null;m.check.roll({...d,extraRollOptions:p,origin:e,dc:h})}else console.warn(`PF2e System | Skip rolling unknown statistic ${o}`)}}}),a.filter("[data-pf2-effect-area]").on("click",async n=>{let{pf2EffectArea:o,pf2Distance:r,pf2TemplateData:c,pf2Traits:u,pf2Width:f}=n.currentTarget.dataset,p={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};if(typeof o=="string"){let d=JSON.parse(c??"{}");d.distance||=Number(r),d.fillColor||=game.user.color,d.t=p[o],d.t==="ray"?d.width=Number(f)||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):d.t==="cone"&&(d.angle=CONFIG.MeasuredTemplate.defaults.angle),u&&(d.flags={pf2e:{origin:{traits:u.split(",")}}});let m=new CONFIG.MeasuredTemplate.documentClass(d,{parent:canvas.scene});await new CONFIG.MeasuredTemplate.objectClass(m).drawPreview()}else console.warn("PF2e System | Could not create template'")})}l(he,"listenInlineRoll");var ye=["U","T","E","M","L"];async function Ye(i,e){let s=i.data(),t=s.itemId?e.items.get(s.itemId):await fromUuid(s.uuid),a=await t?.getChatData({secrets:e.isOwner},s);if(!a)return;let n=document.createElement("div");return n.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(n,t,a),he(n,e),n}l(Ye,"getItemSummary");function _(i){i.on("mouseenter",e=>{e.preventDefault();let s=e.currentTarget.querySelector(".name"),{width:t}=s.getBoundingClientRect();if(s.scrollWidth<=Math.ceil(t))return;let a=s.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:a})}),i.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),i.on("mousedown",e=>{game.tooltip.deactivate()})}l(_,"addNameTooltipListeners");function Je(i,e){i.preventDefault(),R(i,e)?.sheet.render(!0,{focus:!0})}l(Je,"editItem");async function Qe(i,e){i.preventDefault();let s=R(i,e);if(s){if(i.ctrlKey)return s.delete();new Dialog({title:w("deleteItem.title"),content:await renderTemplate("systems/pf2e/templates/actors/delete-item-dialog.hbs",{name:s.name}),buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:w("deleteItem.ok"),callback:()=>s.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:w("deleteItem.cancel")}}}).render(!0)}}l(Qe,"deleteItem");function R(i,e){let{itemId:s}=i.currentTarget.closest("[data-item-id]").dataset;return e.items.get(s)}l(R,"getItemFromEvent");function be(i){return i.isOwner?q(i,`macros.${game.user.id}`)?.map(e=>{let s=fromUuidSync(e);return s?{img:s.img,name:s.name,uuid:e}:null}).filter(Boolean):void 0}l(be,"getMacros");function ve(i,e){let{type:s,uuid:t}=TextEditor.getDragEventData(i.originalEvent)??{};if(s!=="Macro"||!fromUuidSync(t))return;let a=`macros.${game.user.id}`,n=q(e,a)?.slice()??[];n.includes(t)||(n.push(t),Q(e,a,n))}l(ve,"onDroppedMacro");function ke(i,e){let s=`macros.${game.user.id}`,t=q(e,s)?.slice();if(!t?.length)return;let{uuid:a}=i.currentTarget.closest(".macro").dataset,n=t.indexOf(a);n!==-1&&(t.splice(n,1),Q(e,s,t))}l(ke,"deleteMacro");function we(i=()=>!0){let e=game.user.targets,s=e.size===1?e.first():null;return s&&i(s)?s:null}l(we,"getUniqueTarget");function P(i,e){return e?i.toLowerCase().includes(e):!0}l(P,"filterIn");var Xe={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"};function Ze(i,e="systems/pf2e/icons/actions/Empty.webp"){if(i===null)return Xe.passive;let s=typeof i!="object"?i:i.type==="action"?i.value:i.type,t=String(s??"").toLowerCase().trim();return Xe[t]??e}l(Ze,"getActionIcon");async function et({weapon:i,trait:e,selection:s}){if(i.system.traits.toggles[e].selection===s)return!1;let a=i.actor?.items.get(i.id);return a?.isOfType("weapon")&&a===i?await a.update({[`system.traits.toggles.${e}.selection`]:s}):a?.isOfType("weapon")&&i.altUsageType==="melee"?await a.update({[`system.meleeUsage.traitToggles.${e}`]:s}):await a?.rules.find(o=>o.key==="Strike"&&!o.ignored&&o.slug===i.slug)?.toggleTrait({trait:e,selection:s}),!0}l(et,"toggleWeaponTrait");async function se(i,e,s){let t=Y(!0);if(!t.length)return;t.find("> .popup").remove();let a=document.createElement("div");a.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${i}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${w("popup.close")}</a>
    </div>
</div>`;let n=a.firstElementChild;typeof e=="string"?(e=await J(e,s),n.insertAdjacentHTML("beforeend",e)):n.append(e),n.querySelector("[data-action=close-popup]").addEventListener("click",()=>n.remove()),t.append(n)}l(se,"popup");async function N(i,e,s){s??=i.find(".name").html();let t=await Ye(i,e);t&&se(s.trim(),t,e)}l(N,"showItemSummary");async function Ie(i,e,s,{rollMode:t=void 0,create:a=!0,data:n={}}){let o=`systems/pf2e/templates/chat/${e.type}-card.hbs`,r=s.token,c=i?.currentTarget.closest(".item")??{},u=CONFIG.ChatMessage.documentClass,f=Object.keys(n).length>0?n:c.dataset||{},p={actor:s,tokenId:r?`${r.parent?.id}.${r.id}`:null,item:e,data:await e.getChatData(void 0,f)},d={speaker:u.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return t??=i?.ctrlKey||i?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(t)&&(d.whisper=u.getWhisperRecipients("GM").map(m=>m.id)),t==="blindroll"&&(d.blind=!0),d.content=await renderTemplate(o,p),a?u.create(d,{renderSheet:!1}):new u(d)}l(Ie,"unownedItemToMessage");var B="pf2e-token-hud",Vt=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),tt="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",Yt="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",Oe="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",Jt={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${B}.skills.actions.earnIncome`,treatWounds:`${B}.skills.actions.treatWounds`,"borrow-arcane-spell":`${B}.skills.actions.borrow-arcane-spell`,"identify-magic":`${B}.skills.actions.identify-magic`,"identify-alchemy":`${B}.skills.actions.identify-alchemy`,"learn-spell":`${B}.skills.actions.learn-spell`,"crafting-goods":`${B}.skills.actions.crafting-goods`,"staging-performance":`${B}.skills.actions.staging-performance`},it={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:tt,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},Qt={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},ne=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:i=>!i.itemTypes.equipment.some(e=>e.isHeld&&Vt.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:i=>Me(i,tt)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:i=>Me(i,Yt)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];ne.forEach(i=>{i.actions=i.actions.map(t=>typeof t=="string"?Qt[t]:t);let{slug:e,actions:s}=i;for(let t of s){let a=t.slug.replace(/-(.)/g,(n,o)=>o.toUpperCase()).capitalize();t.skillSlug=e,t.uuid=it[t.slug],t.label=Jt[t.slug]??`PF2E.Actions.${a}.Title`,t.variants?t.variants=t.variants.map(n=>({slug:n,label:`${B}.skills.actions.${n}`})):t.map&&(t.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),t.modifiers?.forEach(({modifiers:n})=>{n.forEach(o=>{o.label=`${B}.skills.modifiers.${o.slug}`})})}});var Pe=ne.map(i=>i.slug),Xt=ne.reduce((i,{slug:e,actions:s})=>(i[e]={slug:e,actions:s.reduce((t,a)=>(t[a.slug]=a,t),{})},i),{}),Ji=new Set(Object.values(it).filter(Boolean));function $e(i){return game.i18n.localize(i==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[i])}l($e,"getSkillLabel");async function st(i,e,s){let t=[],a=!v("untrained"),n=!i.isOfType("character");for(let r=0;r<ne.length;r++){let{slug:c,actions:u}=ne[r],{label:f,rank:p,mod:d}=i.getStatistic(c),m=game.i18n.localize(f),g=u.filter(({condition:S,trained:L})=>(a||n||!L||i.skills[c].rank>=1)&&(!S||S(i))).map(S=>({...S,name:game.i18n.localize(S.label),variants:S.variants?.map(L=>({...L,name:game.i18n.localize(L.label)}))})),h=P(m,s),k=g;!h&&(k=g.filter(({name:S,variants:L})=>P(S,s)||L?.some(T=>P(T.name,s))),!k.length)||(t[r]={slug:c,name:m,rank:p,modifier:U(d),actions:h?g:k})}t.sort((r,c)=>r.slug==="perception"?-1:c.slug==="perception"?1:r.name.localeCompare(c.name));let o=Object.values(i.skills).filter(({lore:r,label:c})=>r&&P(c,s)).map(({label:r,rank:c,mod:u,slug:f})=>({slug:f,label:r,rank:c,modifier:U(u)}));return{contentData:{follow:w(`skills.actions.${at(i)?"following":"follow"}`),skills:t,lores:o},doubled:v("skills-columns")}}l(st,"getSkillsData");function nt(i,e){i.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let t=$(s.currentTarget).closest(".action");N(t,e,t.find(".name").children().html())}),e.isOwner&&(i.find("[data-action=follow-the-expert]").on("click",async s=>{s.preventDefault();let t=at(e);if(t)return await t.delete();let a=(await fromUuid(Oe)).toObject();setProperty(a,"flags.core.sourceId",Oe),await e.createEmbeddedDocuments("Item",[a])}),i.find("[data-action=roll-skill]").on("click",s=>{s.preventDefault();let{slug:t}=s.currentTarget.dataset;e.getStatistic(t)?.roll({event:s})}),i.find("[data-action=roll-action]").on("click contextmenu",async s=>{s.preventDefault();let t=$(s.currentTarget),{skillSlug:a,slug:n}=t.closest(".action").data(),o=s.type==="contextmenu"?await Ce(a):void 0;o!==null&&Zt(s,e,a,n,t.data(),o?.selected)}),i.find("[data-action=action-chat]").on("click",async s=>{s.preventDefault();let{uuid:t}=s.currentTarget.closest(".action").dataset,a=await fromUuid(t);a&&Ie(s,a,e,{create:!0})}))}l(nt,"addSkillsListeners");function at(i){return i.itemTypes.effect.find(e=>e.sourceId===Oe)}l(at,"isFollowingAnExpert");async function Ce(i,e){let s=Pe.map(a=>({slug:a,label:$e(a)})),t=await renderTemplate(F("dialogs/variant"),{i18n:a=>w(`skills.variant.${a}`),dc:e,skills:s,selected:i});return Dialog.prompt({title:w("skills.variant.title"),label:w("skills.variant.button"),callback:a=>({selected:a.find("select").val(),dc:a.find("input").val()}),rejectClose:!1,content:t,options:{width:280}})}l(Ce,"createVariantDialog");function Zt(i,e,s,t,{variant:a,map:n},o){let r=Xt[s].actions[t],c=r.type;o??=r.noSkill?void 0:s;let u=r.rollOption?[`action:${r.rollOption}`]:void 0;u&&a&&u.push(`action:${r.rollOption}:${a}`);let f={event:i,actors:[e],variant:a,rollOptions:u,rollMode:r.secret?"blindroll":"roll"};if(f.modifiers=[],r.modifiers){for(let{condition:p,modifiers:d}of r.modifiers)if(!(p&&!p(e)))for(let m of d)f.modifiers.push(new game.pf2e.Modifier(m))}if(r.custom){r.custom(e,f);return}else if(!c){e.getStatistic(o)?.roll(f);return}c===1?(f.skill=o,n&&f.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:n})),game.pf2e.actions[t](f)):c===2?(f.statistic=o,n&&(f.multipleAttackPenalty=n/-5),game.pf2e.actions.get(t).use(f)):c===3&&game.pf2e.actions[t](e)}l(Zt,"rollAction");var te={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionTypeReaction",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionTypeFree",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.ActionTypePassive",actionLabel:"PF2E.ActionTypePassive"}},ot={delay:[500,0],position:"top",theme:"crb-hover",arrow:!1};async function rt(i,e,s){let t=i.isOfType("character"),a=i.synthetics.toggles.slice(),n=v("actions"),o,r,c=game.modules.get("pf2e-stances");c?.active&&t&&(o=c.api.getStances(i).sort((g,h)=>g.name.localeCompare(h.name)),r=c.api.getActionsUUIDS());let u=t?ti(i,r):ii(i),f,p=game.modules.get("pf2e-hero-actions");if(p?.active&&t){let g=p.api.getHeroActions(i),h=i.heroPoints.value-g.length;f={actions:g,draw:Math.max(h,0),discard:Math.abs(Math.min(h,0)),canTrade:g.length&&game.settings.get("pf2e-hero-actions","trade")}}let d=i.system.actions&&await Promise.all(i.system.actions.map(async(g,h)=>({...g,index:h,visible:!t||g.visible,damageFormula:await g.damage?.({getFormula:!0}),criticalFormula:await g.critical?.({getFormula:!0}),description:g.description?await J(g.description,i):void 0,altUsages:g.altUsages&&await Promise.all(g.altUsages.map(async k=>({...k,damageFormula:await k.damage?.({getFormula:!0}),criticalFormula:await k.critical?.({getFormula:!0})})))}))),m={};for(let g of u)P(g.name,s)&&(n!=="split"?(m.action??=[],m.action.push(g)):(m[g.type]??=[],m[g.type].push(g)));if(m=Object.entries(m).map(([g,h])=>(h.forEach(k=>{k.img=Ze(k.cost),k.typeLabel=te[k.type].actionLabel}),n!=="type"?h.sort((k,S)=>k.name.localeCompare(S.name)):h.sort((k,S)=>{let L=te[k.type].order,T=te[S.type].order;return L===T?k.name.localeCompare(S.name):L-T}),{type:g,actions:h,label:te[g].label})),n==="split"&&m.sort((g,h)=>te[g.type].order-te[h.type].order),a.length||o?.length||d?.length||m.length||f?.actions.length){let g=+((o?.length??0)>0)+ +((d?.length??0)>0)+m.length+ +((f?.actions.length??0)>0);return{contentData:{toggles:a,stances:o,strikes:d,sections:m,heroActions:f,i18n:h=>w(`actions.${h}`),damageTypes:CONFIG.PF2E.damageTypes},doubled:g>1&&v("actions-columns"),classes:[v("actions-colors")?"attack-damage-system-colors":""]}}}l(rt,"getActionsData");function ct(i,e){_(i.find(".toggle")),_(i.find(".strike")),_(i.find(".action"));function s(n,o,r="click"){return n=typeof n=="string"?[n]:n,n=n.map(c=>`[data-action=${c}]`).join(", "),i.find(n).on(r,c=>{c.preventDefault(),o(c)})}l(s,"action");function t(n){let{altUsage:o}=n.currentTarget.dataset,r=n.currentTarget.closest(".strike"),c=e.system.actions[r.dataset.index];return o?c?.altUsages[o]:c}l(t,"getStrike");function a(n){return $(n.currentTarget).closest(".action").data().uuid}l(a,"getUuid"),s("action-description",async n=>{let o=$(n.currentTarget).closest(".action");N(o,e)}),s("hero-action-description",async n=>{let{description:o,name:r}=await ei(a(n))??{};o&&se(r,o,e)}),s("strike-description",async n=>{let o=t(n);if(!o)return;let r=document.createElement("div");r.classList.add("description"),r.innerHTML=await renderTemplate(F("strike-description"),o),se(o.label,r,e)}),s("trait-description",n=>{let o=t(n);if(!o)return;let{index:r}=n.currentTarget.dataset,c=o.traits[r];if(!c)return;let u=game.i18n.localize(c.description);u&&se(game.i18n.localize(c.label),u,e)}),s("stance-description",n=>{let o=$(n.currentTarget).closest(".action");N(o,e)}),e.isOwner&&(s("stance-chat",n=>{R(n,e)?.toMessage(n,{create:!0})}),s("stance-toggle",n=>{let{effectUuid:o}=n.currentTarget.closest(".action").dataset;game.modules.get("pf2e-stances")?.api.toggleStance(e,o)}),s("action-chat",n=>{R(n,e)?.toMessage(n,{create:!0})}),s("hero-action-chat",async n=>{await game.modules.get("pf2e-hero-actions")?.api.sendActionToChat(e,a(n))}),s("draw-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.drawHeroActions(e)}),s("use-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.useHeroAction(e,a(n))}),s("discard-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.discardHeroActions(e,a(n))}),s("trade-hero-action",async n=>{game.modules.get("pf2e-hero-actions")?.api.tradeHeroAction(e)}),s("strike-attack",n=>{let{index:o}=n.currentTarget.dataset;t(n)?.variants[o].roll({event:n})}),s(["strike-damage","strike-critical"],n=>{let{action:o}=n.currentTarget.dataset;t(n)?.[o==="strike-damage"?"damage":"critical"]({event:n})}).tooltipster(ot),s(["toggle-roll-option","set-suboption"],n=>{let o=n.currentTarget.closest(".toggle"),{domain:r,option:c,itemId:u}=o.dataset,f=o.querySelector("select")?.value??null;e.toggleRollOption(r,c,u??null,o.querySelector("input").checked,f)}),s("strike-auxiliary",n=>{if(n.currentTarget!==n.target)return;let o=t(n);if(!o)return;let{index:r}=n.currentTarget.dataset,c=n.currentTarget.querySelector("select")?.value??null;o.auxiliaryActions?.[r]?.execute({selection:c})}),s("toggle-versatile",n=>{let o=t(n)?.item;if(!o)return;let r=n.currentTarget,{value:c}=r.dataset,u=o?.system.damage.damageType??null,f=r.classList.contains("selected")||c===u?null:c;et({trait:"versatile",weapon:o,selection:f})}).tooltipster(ot),s("strike-ammo",async n=>{let o=t(n)?.item;if(!o)return;let r=e.items.get(n.currentTarget.value);await o.update({system:{selectedAmmoId:r?.id??null}})},"change"))}l(ct,"addActionsListeners");function ei(i){return game.modules.get("pf2e-hero-actions")?.api.getHeroActionDetails(i)}l(ei,"getHeroActionDescription");function ti(i,e=new Set){let s=i.itemTypes.action.filter(a=>!e.has(a.sourceId)),t=i.itemTypes.feat.filter(a=>a.actionCost&&!e.has(a.sourceId));return[...s,...t].filter(a=>{let n=a.system.traits.value;return!n.includes("downtime")&&!n.includes("exploration")}).map(a=>{let n=a.actionCost;return{id:a.id,type:n?.type??"free",cost:n,name:a.name}})}l(ti,"getCharacterActions");function ii(i){return i.itemTypes.action.map(e=>{let s=e.actionCost,t=s?.type??"passive",a=t==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(n=>n.key==="Aura"));return{id:e.id,type:t,cost:s,name:e.name,hasDeathNote:e.system.deathNote,hasAura:a}})}l(ii,"getNpcActions");var si=["arcana","crafting","medicine","nature","occultism","religion","society"],lt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function ut(i){let e=await new Roll("1d20").evaluate({async:!0}),s=e.total,t=e.dice[0].total,a=t===1?"0":t===20?"3":"",n=Object.values(i.skills).filter(u=>u.lore),o=we(u=>u.actor?.identificationDCs),r={dieSuccess:a,dieResult:t,target:o,i18n:u=>w(`actions.recall-knowledge.${u}`)};if(o){let{standard:u,skills:f,lore:p}=o.actor.identificationDCs,d=u.progression.slice();d.length=4,d=[...d];let m=p.map(({progression:g})=>{let h=g;return h.length=6,[...h]});r.skillsDCs=d,r.skills=f.map(g=>{let{mod:h,label:k,rank:S}=i.skills[g],L=s+h;return{label:k,mod:h,rank:S,rankLabel:ye[S],total:L,checks:d.map(T=>{if(!T)return"-";let H=ge(L,t,T);return{success:H,icon:lt[H].icon,title:lt[H].name}})}}),r.loresDCs=m,r.lores=n.map(({label:g,rank:h,mod:k})=>({label:g,rank:h,mod:k,modifier:U(k)}))}else r.skills=[...si.map(u=>i.skills[u]),...n].map(({label:u,rank:f,mod:p})=>({label:u,rank:f,mod:p,modifier:U(p)}));let c=await renderTemplate(F("chat/recall-knowledge"),r);ChatMessage.create({flavor:c,speaker:ChatMessage.getSpeaker({actor:i}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL})}l(ut,"rollRecallKnowledges");async function dt(i,e,s){let{attributes:t}=i,{initiative:a}=t;return{contentData:{noMacro:w("extras.no-macro"),macros:be(i)?.filter(n=>P(n.name,s)),initiative:a&&{selected:a.statistic,skills:Pe.map(n=>({slug:n,label:$e(n)}))},hasDailies:game.modules.get("pf2e-dailies")?.active}}}l(dt,"getExtrasData");function pt(i,e,s){function t(n,o,r="click"){i.find(`[data-action=${n}]`).on(r,c=>{c.preventDefault(),o(c)})}if(l(t,"action"),t("action-description",n=>{let o=$(n.currentTarget).closest(".row");N(o,e)}),!e.isOwner)return;_(i.find(".macro"));async function a(n){let{uuid:o}=n.currentTarget.closest(".macro").dataset;return fromUuid(o)}l(a,"getMacro"),t("delete-macro",n=>ke(n,e)),t("edit-macro",async n=>{(await a(n))?.sheet.render(!0)}),t("use-macro",async n=>{(await a(n))?.execute({actor:e,token:s})}),i.on("drop",n=>ve(n,e)),t("action-chat",async n=>{let{uuid:o}=n.currentTarget.closest(".row").dataset,r=await fromUuid(o);r&&Ie(n,r,e,{create:!0})}),i.find("input[name], select[name]").on("change",async n=>{let o=n.currentTarget,r=o.type==="number"?o.valueAsNumber:o.value;await e.update({[o.name]:r})}),t("roll-initiative",async n=>{await e.initiative.roll({event:n})}),t("prepare-dailies",n=>{let o=game.modules.get("pf2e-dailies");o?.active&&o.api.openDailiesInterface(e)}),t("rest-for-the-night",n=>{game.pf2e.actions.restForTheNight({actors:[e]})}),t("roll-recall-knowledge",n=>{ut(e)}),t("roll-aid",async n=>{let o=await Ce(null,20),r={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};o!==null&&game.pf2e.actions.get("aid").use({event:n,actors:[e],statistic:o?.selected,difficultyClass:{value:o?.dc},notes:[r]})},"click contextmenu"),t("roll-escape",async n=>{let o=n.type==="contextmenu"?await Ce():void 0;o!==null&&game.pf2e.actions.get("escape").use({event:n,actors:[e],statistic:o?.selected})},"click contextmenu")}l(pt,"addExtrasListeners");async function ft(i){let{system:e}=i,{details:s,traits:t,attributes:a}=e,{stealth:n}=a,{description:o,disable:r,routine:c,reset:u,isComplex:f}=s,p=i.getRollData(),d=i.isOwner,m=l(async g=>J(g,i,{isOwner:d,rollData:p}),"enrich");return{contentData:{description:await m(o),disable:await m(r),routine:await m(c),reset:await m(u),isComplex:f,rarity:{value:t.rarity,label:CONFIG.PF2E.rarityTraits[t.rarity]},traits:t.value.map(g=>CONFIG.PF2E.hazardTraits[g]),stealth:U(n.value)},style:{["--max-width"]:v("hazard-width")+"em"}}}l(ft,"getHazardData");function mt(i,e){i.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let t=$(s.currentTarget).closest(".action");N(t,e)}),he(i,e),e.isOwner&&i.find("[data-action=roll-initiative").on("click",s=>{s.preventDefault(),e.initiative.roll({event:s})})}l(mt,"addHazardListeners");var gt=new Set(["arcane","divine","occult","primal"]);function ni(i,e){return i.has(e)}l(ni,"setHasElement");function ai(i){return i.traits.has("cursed")?"unique":i.rarity}l(ai,"getDcRarity");function oi(i){let e=i.system.traits.value;return new Set(e.filter(s=>ni(gt,s)))}l(oi,"getMagicTraditions");function ri(i,e,s){let t={occult:e,primal:e,divine:e,arcane:e},a=oi(i);for(let n of gt)a.size>0&&!a.has(n)&&(t[n]=e+s);return{arcana:t.arcane,nature:t.primal,religion:t.divine,occultism:t.occult}}l(ri,"getIdentifyMagicDCs");function ci(i,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:s}){let t=de(i.level,{proficiencyWithoutLevel:e}),a=ai(i),n=ue(t,a);return i.isMagical?ri(i,n,s):i.isAlchemical?{crafting:n}:{dc:n}}l(ci,"getItemIdentificationDCs");function li(i,e){return(typeof e=="string"||typeof e=="number")&&e in i}l(li,"objectHasKey");var ae=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),t=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",a=ci(e,{proficiencyWithoutLevel:t,notMatchingTraditionModifier:s});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:a}}activateListeners(e){e.find("button.update-identification").on("click",s=>{let t=$(s.delegateTarget);this.submit({updateData:{status:t.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let s=this.item,t=s.system.identification.unidentified.img,a=s.system.identification.unidentified.name,n=s.system.identification.identified.name,o=$("div#identify-item").find("tr").toArray().flatMap(u=>{let f=u.dataset.skill,p=Number(u.dataset.dc);if(!(Number.isInteger(p)&&li(CONFIG.PF2E.skillList,f)))return[];let d=game.i18n.localize(CONFIG.PF2E.skillList[f]);return{slug:f,name:d,dc:p}}),r=s.isMagical?"action:identify-magic":s.isAlchemical?"action:identify-alchemy":null,c=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:t,itemName:a,identifiedName:n,rollOptions:["concentrate","exploration","secret",r].filter(Boolean),skills:o});await CONFIG.ChatMessage.documentClass.create({user:game.user.id,content:c})})}async _updateObject(e,s){let t=s.status;t==="identified"&&await this.item.setIdentificationStatus(t)}};l(ae,"IdentifyItemPopup");var Re={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function ht(i,e,s){let{contents:t,coins:a,totalWealth:n,bulk:o,invested:r}=i.inventory,c=v("containers")||(q(i,`containers.${game.user.id}`)??[]),u={},f={};for(let p of t){if(!P(p.name,s))continue;let d=p.system.containerId;p.type!=="backpack"&&d&&(c===!0||c.includes(d))?(u[d]??=[],u[d].push(p)):(f[p.type]??=[],f[p.type].push(p))}if(f=Object.entries(f).map(([p,d])=>{if(d.sort((m,g)=>m.name.localeCompare(g.name)),p==="backpack")for(let m=d.length-1;m>=0;m--){let g=d[m],h=u[g.id];h?.length&&(h.sort((k,S)=>k.name.localeCompare(S.name)),d.splice(m+1,0,...h))}return{type:p,items:d,label:Re[p].label}}).sort((p,d)=>Re[p.type].order-Re[d.type].order),f.length)return{doubled:f.length>1&&v("items-columns"),contentData:{canCarry:!!i.adjustCarryType,categories:f,bulk:o,containers:c,i18n:p=>w(`items.${p}`),invested:r?`${game.i18n.localize("PF2E.InvestedLabel")}: ${r.value} / ${r.max}`:"",wealth:{coins:a.goldValue,total:n.goldValue}}}}l(ht,"getItemsData");function yt(i,e){let s=i.find(".item");_(s),s.find("[data-action=item-description]").on("click",async t=>{t.preventDefault();let a=$(t.currentTarget).closest(".item");await N(a,e)}),s.find("[data-action=toggle-contains-items]").on("click",async t=>{t.preventDefault();let a=`containers.${game.user.id}`,n=t.currentTarget.closest(".item").dataset.itemId,o=q(e,a)?.slice()??[],r=o.indexOf(n);r===-1?o.push(n):o.splice(r,1),await Q(e,a,o)}),e.isOwner&&(s.find("[data-action=item-chat]").on("click",async t=>{R(t,e)?.toMessage(t,{create:!0})}),s.on("dragstart",t=>{let a=t.target.closest(".item"),{itemType:n,uuid:o}=a.dataset,r=new Image;r.src=a.querySelector(".item-img img").src,r.style.width="32px",r.style.height="32px",r.style.borderRadius="4px",r.style.position="absolute",r.style.left="-1000px",document.body.append(r),t.originalEvent.dataTransfer.setDragImage(r,16,16),t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:n,uuid:o})),a.addEventListener("dragend",()=>r.remove(),{once:!0})}),i.find(".quantity input").on("change",async t=>{await R(t,e)?.update({"system.quantity":t.currentTarget.valueAsNumber})}),i.find("[data-action=toggle-item-invest]").on("click",t=>{t.preventDefault();let{itemId:a}=t.currentTarget.closest(".item").dataset;e.toggleInvested(a)}),i.find("[data-action=repair-item]").on("click",t=>{t.preventDefault();let a=R(t,e);a&&game.pf2e.actions.repair({item:a,actors:[e]})}),i.find("[data-action=toggle-identified]").on("click",t=>{t.preventDefault();let a=R(t,e);a&&(a.isIdentified?a.setIdentificationStatus("unidentified"):new ae(a).render(!0))}),i.find("[data-action=edit-item]").on("click",t=>{t.preventDefault(),Je(t,e)}),i.find("[data-action=delete-item]").on("click",t=>{t.preventDefault(),Qe(t,e)}),i.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(t,{event:a,origin:n}){let o=R(a,e);if(!o)return;let r=document.createElement("div");r.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:o});let c=r.children[1],u=$(c);if(u.find("[data-carry-type]").on("click",async f=>{let{carryType:p,handsHeld:d=0,inSlot:m}=$(f.currentTarget).data();t.close(),await e.adjustCarryType?.(o,p,d,m)}),o.type!=="backpack"){let f=e.itemTypes.backpack.filter(p=>p.isIdentified);if(f.length){let p="";for(let d of f)p+='<li><a class="item-control item-location-option',d===o.container&&(p+=" selected"),p+=`" data-action="send-to-container" data-container-id="${d.id}">`,p+=`<i class="fas fa-box"></i>${d.name}</a></li>`;u.find("ul").append(p),u.find("[data-action=send-to-container]").on("click",async d=>{let{containerId:m}=d.currentTarget.dataset;e.items.has(m)&&(t.close(),await o.update({"system.containerId":m}))})}}t.content(c)}}))}l(yt,"addItemsListeners");async function bt(i,e,s){let t=i.system.resources.focus??{value:0,max:0},a=i.spellcasting.regular,n=v("tradition"),o=[],r=[],c=!1;for(let p of a){let d=p.id,m=n&&p.statistic.label[0],g=await p.getSheetData(),h=g.isFocusPool,k=p.system?.prepared?.value==="charge",S=getProperty(p,"flags.pf2e-staves.staveID")!==void 0,L={value:getProperty(p,"flags.pf2e-staves.charges")??0};for(let T of g.levels){if(!T.active.length||T.uses?.max===0)continue;let H=[],O=T.isCantrip,K=T.active.filter(z=>z&&z.uses?.max!==0);for(let z=0;z<K.length;z++){let{spell:G,expended:Z,virtual:j,uses:Ee,castLevel:De}=K[z];P(G.name,s)&&H.push({name:G.name,img:G.img,tradition:m,castLevel:De??G.level,slotId:z,entryId:d,itemId:G.id,inputId:g.isInnate?G.id:g.id,inputPath:k?"flags.pf2e-staves.charges":g.isInnate?"system.location.uses.value":`system.slots.slot${T.level}.value`,isCharge:k,isVirtual:j,isInnate:g.isInnate,isCantrip:O,isFocus:h,isPrepared:g.isPrepared,isSpontaneous:g.isSpontaneous||g.isFlexible,slotLevel:T.level,uses:Ee??(k?L:T.uses),expended:Z??(h&&!O?t.value<=0:!1),action:G.system.time.value,type:k?S?`${x}.spells.staff`:`${x}.spells.charges`:g.isInnate?"PF2E.PreparationTypeInnate":g.isSpontaneous?"PF2E.PreparationTypeSpontaneous":g.isFlexible?"PF2E.SpellFlexibleLabel":h?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:k?0:g.isPrepared?1:h?2:g.isInnate?3:g.isSpontaneous?4:5})}if(H.length){if(h)if(O)c=!0;else{r.push(...H);continue}o[T.level]??=[],o[T.level].push(...H)}}}if(o.length){let p=v("spells")?(d,m)=>d.order===m.order?d.name.localeCompare(m.name):d.order-m.order:(d,m)=>d.name.localeCompare(m.name);o.forEach(d=>d.sort(p))}r.length&&(r.sort((p,d)=>p.name.localeCompare(d.name)),o[12]=r,c=!1);let f=(await i.spellcasting.ritual?.getSheetData())?.levels.flatMap((p,d)=>p.active.map(({spell:m})=>{if(P(m.name,s))return{name:m.name,img:m.img,slotId:d,itemId:m.id,level:m.level,time:m.system.time.value}}).filter(Boolean));if(o.length||f?.length){let p=vt(i),d=o.length+ +((f?.length??0)>0);return{contentData:{spells:o,rituals:f,focusPool:t,hasFocusCantrips:c,attackMod:kt(p)?p[0].mod:null},doubled:d>1&&v("spells-columns")}}}l(bt,"getSpellsData");function vt(i){return i.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:s,id:t})=>({name:s,id:t,mod:U(e.mod),statistic:e}))}l(vt,"getSpellAttacks");function kt(i){return new Set(i.map(({mod:e})=>e)).size===1}l(kt,"hasSingleSpellAttack");function wt(i,e,s){_(i.find(".spell")),i.find("[data-action=spell-description]").on("click",async t=>{t.preventDefault();let a=$(t.currentTarget).closest(".spell");N(a,e)}),e.isOwner&&(i.find("[data-action=spell-attack]").on("click",async t=>{t.preventDefault();let a=vt(e);if(!a.length)return;let n;if(kt(a))n=a[0].statistic;else{let o=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:w("spells.attacks.ok"),callback:r=>r.find("input:checked").val()}},title:w("spells.attacks.title"),content:await renderTemplate(F("dialogs/spell-attacks"),{attacks:a}),close:()=>null});o&&(n=e.items.get(o)?.statistic)}n?.check.roll(pe(t))}),i.find("[data-action=spell-chat]").on("click",async t=>{t.preventDefault(),R(t,e)?.toMessage(t,{create:!0})}),i.find("[data-action=toggle-pips]").on("click contextmenu",async t=>{t.preventDefault();let a=t.type==="click"?1:-1,n=(e.system.resources.focus?.value??0)+a;await e.update({"system.resources.focus.value":n})}),i.find("[data-action=toggle-prepared]").on("click",t=>{t.preventDefault();let{slotLevel:a,slotId:n,entryId:o,expended:r}=$(t.currentTarget).closest(".spell").data();e.spellcasting.collections.get(o)?.setSlotExpendedState(a??0,n??0,r!==!0)}),i.find("[data-action=cast-spell]").on("click",t=>{t.preventDefault();let{slotLevel:a,slotId:n,entryId:o,itemId:r}=$(t.currentTarget).closest(".spell").data(),c=e.spellcasting.collections.get(o,{strict:!0});if(!c)return;let u=c.get(r,{strict:!0});u&&c.entry.cast(u,{slot:n,level:a})}),i.find("[data-input-path]").on("change",async t=>{let{inputPath:a,entryId:n}=$(t.currentTarget).data(),o=t.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:n,[a]:o}])}))}l(wt,"addSpellsListeners");var Ne="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",di="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo",It={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},oe={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},pi=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],fi={actions:{getData:rt,addListeners:ct},items:{getData:ht,addListeners:yt},spells:{getData:bt,addListeners:wt},skills:{getData:st,addListeners:nt},extras:{getData:dt,addListeners:pt},hazard:{getData:ft,addListeners:mt}},re={fortitude:{icon:"fa-solid fa-hand-fist",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},mi={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-dumbbell",label:"PF2E.SkillAthletics"}},ce=class extends Application{#e=null;#n=null;#v=null;#a=null;#o=!1;#u=!1;#r=null;#c;#d=[!1,!1,!1];#t=!1;#i=!1;#p=null;#f=null;#s=!1;#m=null;#g=null;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,s)=>{s?window.chrome?this.#y(e):(this.#m&&clearTimeout(this.#m),this.#m=setTimeout(()=>this.#y(e),10)):window.chrome?this.#k(e):(this.#g&&clearTimeout(this.#g),this.#g=setTimeout(()=>this.#k(e),10))},this.#c=e=>{let s=e.button;if(![0,2].includes(s))return;if(e.type==="mouseup"){this.#d[s]=!1;return}this.#d[s]=!0;let t=e.target,a=this.element[0];if(a){let n=a.querySelector(".popup");if(a.contains(t)){n&&!n.contains(t)&&n.remove();return}if(t.closest(".app")||t.closest(".tooltipster-base")||a.querySelector(".sidebar.extras")&&t.closest("#hotbar"))return;if(n)return n.remove();this.forceClose()}else this.#b();this.unlock(!0)},this.#f=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#c),window.addEventListener("mouseup",this.#c),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#f),Hooks.on("canvasPan",this.forceClose)}setToken(e,s){if(e!==this.#e){this.#e&&delete this.#e.actor.apps[this.appId],this.#e=e;let t=e?.actor;t&&(t.apps[this.appId]=this)}this.#s=s??this.#h(e)}setHolding(e){let s=v("use-holding");if(s!=="none"&&(this.#u=e,!(this.#i||this.#t)))if(e){if(!this.#o)return;let t=this.#h(this.#n);if(s==="half"&&!game.user.isGM&&!t){this.#b(),this.render();return}this.setToken(this.#n,t),this.render()}else s==="all"?this.close():game.user.isGM?(this.setToken(this.#n),this.render()):this.#s&&this.close()}#h(e){let s=e?.actor;if(!s)return!1;let t,a=s.system.details.alliance==="party";return game.user.isGM&&v("use-holding")==="half"&&!this.#u||s.isOfType("familiar")&&!s.master?t=!1:t=e.isOwner||v("observer")&&(e.observer||a&&v("party")),t}#y(e){if($(window.document).find(":hover").filter("#combat-popout, #sidebar, #mini-tracker").length)return;let s=e.actor;if(!s||s.isOfType("loot","party")||(this.#o=!0,this.#n=e,this.mousedown||this.#t||this.#i||e===this.#e))return;let t=v("use-holding"),a=this.#h(e);t!=="none"&&!this.#u&&(t==="all"||a)||(this.#w(!0),this.setToken(e,a),t==="none"||!this.#u?this.renderWithDelay():this.render())}#k(e){this.#o=!1,!(this.mousedown||this.#t||this.#i)&&(this.#r=setTimeout(()=>{this.#r=null,!(this.#i||this.#t)&&this.close()},10))}renderWithDelay(){let e=v("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#w(e){this.#r!==null&&(clearTimeout(this.#r),this.#r=null,e&&this.close())}#b(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#c),window.removeEventListener("mouseup",this.#c),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#f),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:F("hud")})}get mousedown(){return this.#d[0]||this.#d[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return this.actor?.itemTypes.effect.find(e=>e.flags.core?.sourceId===Ne)}get isCharacter(){return this.actor?.isOfType("character")}get sidebar(){return this.element?.find("> .sidebar")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,s=this.#e?.actor;if(!s)return{};let t=null,a=v("saves"),n=v("others"),o=this.isCharacter,{attributes:r}=s,{hp:c,sp:u={max:0,value:0},ac:f}=r,p=game.settings.get("pf2e","staminaVariant"),d=v("distance"),m=v("scale");if(d==="all"||d==="self"&&this.#s){let b=v("unit").split(","),D=Number(b[0]?.trim())||1,A=b[1]?.trim()||game.system.gridUnits,E=Number(b[2]?.trim())||0,M=canvas.tokens.controlled,W=!1,V=M.length===1?M[0]:null;(!V||V===e)&&(V=we(),W=!0),V&&V!==e&&(t={unit:A,icon:W?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(V)*D).toFixed(E)})}let g;if(!this.#s||v("see-status")){let b=v("status").split(",").map(D=>D.trim()).filter(Boolean);if(b.length&&c.max){let D=c.max+(p?u.max:0),A=c.value+(p?u.value:0),E=Math.clamped(A/D,0,1),M=(()=>{let W=b.length;return v("last-status")?E===1?W:Math.ceil(E*(W-1)):Math.ceil(E*W)})();g={hue:E*E*122+3,value:M===0?game.i18n.localize("EFFECT.StatusDead"):b.at(M-1)}}}let h={status:g,distance:t,fontSize:m,tokenId:e.id,type:s.isOfType("creature")?"creature":s.type};if(!this.#s||s.isOfType("familiar")&&!s.master)return h;let{level:k,saves:S,isOwner:L,system:T,itemTypes:H}=s,{resistances:O,weaknesses:K,immunities:z}=r;h={...h,isOwner:L,isObserver:this.#s,name:e.document.name,hp:c,ac:f.value,level:k,hasActions:H.action.length||T.actions?.filter(b=>b.visible!==!1).length};let G=v("ranks");function Z(b,D,A){let E=b.slug,M=D==="bonus"?U(b.mod):b.dc.value;return{slug:E,value:M,label:A[E].label,icon:A[E].icon,rank:G&&ye[b.rank]}}l(Z,"getStatistic");function j(b,D){if(!b.length)return"";let A=b.map(E=>Le(E.label.replace("-"," ").titleCase())).join("");return D?`<li>${game.i18n.localize(D)}<ul>`+A+"</ul></li>":A}if(l(j,"toIWR"),s.isOfType("hazard")){let{hardness:b,emitsSound:D,stealth:A}=r;return{...h,hardness:b,emitsSound:D.toString().capitalize(),immunities:j(z),weaknesses:j(K),resistances:j(O),stealth:{value:A.value,details:await J(A.details,s)},saves:a!=="none"&&["fortitude","reflex","will"].map(E=>{let M=S[E];return M?Z(M,a,re):{slug:E,label:re[E].label,icon:re[E].icon}})}}if(h={...h,sidebarTitles:{actions:`${x}.actions.title`,items:`${x}.items.title`,spells:`${x}.spells.title`,skills:`${x}.skills.title`,extras:`${x}.extras.title`},hasItems:s.inventory.size},s.isOfType("vehicle")){let{hardness:b,collisionDC:D,collisionDamage:A}=r,{details:E}=T,{crew:M,passengers:W,pilotingCheck:V,speed:Ht}=E;return{...h,hardness:b,crew:M,passengers:W,pilotingCheck:V,speed:Ht,collisionDC:D.value,collisionDamage:A.value,immunities:j(z),weaknesses:j(K),resistances:j(O),fortitude:Z(S.fortitude,a,re)}}let Ee=v("show-death"),{heroPoints:De,_source:Lt}=s,{traits:xe}=T,{wounded:Ue,dying:ze,shield:At,resolve:Ft,speed:le,adjustment:Ot}=r;function Le(b){return`<li>${b.trim()}</li>`}l(Le,"toInfo");function Mt(b,D){return b.localeCompare(D)}l(Mt,"sort");let Pt=xe?.languages?.value.map(b=>game.i18n.localize(CONFIG.PF2E.languages[b])).filter(Boolean).sort(Mt).map(Le).join(""),$t=o?xe.senses.map(b=>b.label):xe.senses.value?.split(","),ie=pi.map(({type:b,icon:D},A)=>({index:A,icon:D,label:game.i18n.localize(CONFIG.PF2E.speedTypes[b]??"PF2E.SpeedTypesLand"),value:(A===0?le.total:le.otherSpeeds.find(E=>E.type===b)?.total)||0})),je=q(s,`speeds.selected.${game.user.id}`),Rt=(()=>{let b=0;if(je!==void 0)b=je;else if(v("force-speed")||ie[0].value===0){let D={index:0,value:ie[0].value};b=ie.reduce((A,{value:E},M)=>E>A.value?{index:M,value:E}:A,D).index}return ie.splice(b,1)[0]})(),_e=ie.map(({value:b,label:D,index:A})=>`<li><a data-index="${A}">${D}: ${b}</a></li>`).join("");le.details&&(_e+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${le.details}</li>`);let Be=Lt.system.details?.alliance,Ae=Be===null?"neutral":Be??"default",Ge=s.hasPlayerOwner?"party":"opposition",Nt=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(oe[Ge].label)})},{value:"opposition",label:game.i18n.localize(oe.opposition.label)},{value:"party",label:game.i18n.localize(oe.party.label)},{value:"neutral",label:game.i18n.localize(oe.neutral.label)}].filter(({value:b})=>b!==Ae).map(({value:b,label:D})=>`<li><a data-alliance="${b}">${D}</a></li>`).join("");return{...h,sp:p?u:{max:0},hero:De,dying:ze,wounded:Ue,shield:At,resolve:Ft,adjustment:Ot,alliance:oe[Ae==="default"?Ge:Ae],alliances:Nt,isCharacter:o,showDeathLine:o&&(Ee==="always"||ze.value||Ue.value),hasCover:this.hasCover,saves:a!=="none"&&["fortitude","reflex","will"].map(b=>Z(S[b],a,re)),others:n!=="none"&&["perception","stealth","athletics"].map(b=>Z(s.getStatistic(b),n,mi)),speeds:{main:Rt,others:_e},iwr:j(z,"PF2E.ImmunitiesLabel")+j(K,"PF2E.WeaknessesLabel")+j(O,"PF2E.ResistancesLabel"),senses:$t?.filter(Boolean).map(Le).join(""),languages:Pt,hasSpells:s.spellcasting.some(b=>b.category!=="items")}}close(e={}){this.setToken(null),this.unlock(!0),this.#i=!1,this.#b();let s=Application.RENDER_STATES;if(!e.force&&![s.RENDERED,s.ERROR].includes(this._state))return;this._state=s.CLOSING;let t=this.element;if(!t)return this._state=s.CLOSED;t.css({minHeight:0});for(let a of this.constructor._getInheritanceChain())Hooks.call(`close${a.name}`,this,t);t.remove(),this._element=null,this._state=s.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,s={}){let t,a,n;if(this.#v===this.#e){let o=this.sidebar[0];if(o){t=o.dataset.type,a=o.scrollTop;let r=o.querySelector(".sidebar-header");r.classList.contains("show")&&(n=r.querySelector(" input").value.trim())}}if(await super._render(e,s),ui.windows[this.appId]=this,t){let o=await this.#l(t,n);a>0&&o.scrollTop(a)}this.#v=this.#e,this.inner.length&&v("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let s=this.element[0],t=e.worldTransform.a,a=s.getBoundingClientRect(),n=canvas.clientCoordinatesFromCanvas(e.document._source),o={x:n.x,y:n.y,width:e.hitArea.width*t,height:e.hitArea.height*t,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},r,c=this.#s?It[v("position")].slice():It[v("small-position")].slice();for(;c.length&&!r;){let u=c.shift();u==="left"?(r={x:o.x-a.width,y:He(a,o)},r.x<0&&(r=void 0)):u==="right"?(r={x:o.right,y:He(a,o)},r.x+a.width>window.innerWidth&&(r=void 0)):u==="top"?(r={x:Ct(a,o),y:o.y-a.height},r.y<0&&(r=void 0)):u==="bottom"&&(r={x:Ct(a,o),y:o.bottom},r.y+a.height>window.innerHeight&&(r=void 0))}return r&&(s.style.left=`${r.x}px`,s.style.top=`${r.y}px`),r}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||v("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let s=this.#e,t=s?.actor;if(!t)return;let a=s.isOwner,n=CONFIG.ChatMessage.documentClass;v("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(v("autolock")==="hover"&&this.lock(),this.#i=!0)}),e.on("mouseleave",()=>{if(this.#i=!1,this.#t)return;let c=this.#e;this.#n!==c&&this.#o?(this.close(),this.#y(this.#n)):setTimeout(()=>!this.#o&&this.close(),10)}),e.on("dragover",()=>{s.isOwner&&e.find("> .sidebar.extras").length&&!e.find(".popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let o=e.find("[data-action=show-info]");o.tooltipster({position:["top","bottom","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click"}),o.filter(".stealth").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(c,{origin:u,tooltip:f})=>{this.lock(),$(f).find(".content-link").on("click",()=>setTimeout(()=>c.close(),10))}).tooltipster("option","functionAfter",()=>this.unlock()),(a?o.filter(":not(.speeds):not(.stealth)"):o).on("mouseleave",c=>{$(c.currentTarget).tooltipster("hide")}),e.find("[data-action=open-sidebar]").on("click",this.#l.bind(this)),a&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",c=>{c.preventDefault();let u=c.type==="click"?"elite":"weak";t.applyAdjustment(t.system.attributes.adjustment===u?null:u)}),e.find("[data-action=toggle-alliance]").tooltipster({position:["bottom","top","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click",interactive:!0,functionReady:(c,{origin:u,tooltip:f})=>{this.lock(),f.querySelectorAll("[data-alliance]").forEach(p=>{p.addEventListener("click",async d=>{d.preventDefault();let m=p.dataset.alliance;m==="default"?t.update({"system.details.-=alliance":null}):t.update({"system.details.alliance":m==="neutral"?null:m})})})},functionAfter:()=>this.unlock()}),e.find("[data-action=collision-dc]").on("click",c=>{c.preventDefault();let u=t.system.attributes.collisionDC.value||15;n.create({content:`@Check[type:reflex|dc:${u}]`,speaker:n.getSpeaker({actor:t})})}),e.find("[data-action=collision-damage]").on("click",async c=>{c.preventDefault();let u=(t.system.attributes.collisionDamage.value||"1d6").trim();isNaN(Number(u.at(-1)))||(u+="[bludgeoning]");let f=CONFIG.Dice.rolls.find(d=>d.name==="DamageRoll"),p=await new f(u).evaluate({async:!0});n.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:n.getSpeaker({actor:t}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[p]})}),e.find("input").on("change",async c=>{let u=c.currentTarget,f=u.valueAsNumber,p=u.name;u.blur(),p!=="shield.value"?await t.update({[p]:f}):await t.heldShield.update({"system.hp.value":f})}),e.find("[data-action=toggle-hero]").on("click contextmenu",c=>{c.preventDefault();let{max:u,value:f}=t.heroPoints,p=c.type==="click"?1:-1,d=Math.clamped(f+p,0,u);d!==f&&t.update({"system.resources.heroPoints.value":d})}),e.find("[data-action=raise-shield]").on("click",c=>{c.preventDefault(),game.pf2e.actions.raiseAShield({actors:[t]})}),e.find("[data-action=take-cover]").on("click",async c=>{c.preventDefault();let u=(await fromUuid(Ne)).toObject();setProperty(u,"flags.core.sourceId",Ne);let f=this.hasCover;this.hasCover?await f.delete():await t.createEmbeddedDocuments("Item",[u])}),e.find("[data-action=roll-save]").on("click",c=>{c.preventDefault();let u=c.currentTarget.dataset.save;t.saves[u].roll({event:c})}),e.find("[data-action=roll-other]").on("click",c=>{c.preventDefault();let u=c.currentTarget.dataset.slug;if(u!=="athletics"){let{ctrlKey:f,metaKey:p,shiftKey:d}=c;c=new MouseEvent("click",{ctrlKey:!f,metaKey:p,shiftKey:d})}t.getStatistic(u)?.roll({event:c})}),e.find("[data-action=recovery-check]").on("click",c=>{c.preventDefault(),t.rollRecovery(c)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",c=>{c.preventDefault();let u=c.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",f=t.system.attributes[u]?.max;f&&(c.type==="click"?t.increaseCondition(u,{max:f}):t.decreaseCondition(u))}),e.find("[data-action=use-resolve]").on("click",c=>{c.preventDefault(),gi(t)}),o.filter(".speeds").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(c,{origin:u,tooltip:f})=>{this.lock(),f.querySelectorAll("[data-index]").forEach(p=>{p.addEventListener("click",async d=>{d.preventDefault(),await Q(t,`speeds.selected.${game.user.id}`,Number(p.dataset.index))})})}).tooltipster("option","functionAfter",()=>this.unlock()))}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#l(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#l(e,s){e=typeof e=="string"?e:e.currentTarget.dataset.type;let t=this.element,a=this.sidebar,n=a[0]?.dataset.type;if(a.remove(),t.find("[data-action=open-sidebar]").removeClass("active"),n===e&&s===void 0){this.unlock();return}let o=this.#e,r=o.actor,c=s!==void 0||v("filter"),{getData:u,addListeners:f}=fi[e],p=await u(r,o,s?.toLowerCase())??{};if(!p.contentData&&!c)return ui.notifications.warn(w(`${e}.empty`,{name:this.#e.name}));let d={...p.contentData??{},isGM:game.user.isGM,isCharacter:this.isCharacter,isOwner:r.isOwner};this.lock(),t.find(`[data-action=open-sidebar][data-type=${e}]`).addClass("active"),t=t[0];let m=p.classes??[];m.push(e),v("scrollbar")||m.push("no-scrollbar"),p.doubled&&m.push("doubled");let g=p.style??{};g["--max-height"]=v("height").trim()||"100%";let h=document.createElement("div");h.innerHTML=await renderTemplate(F("sidebar"),{classes:m.join(" "),style:Object.entries(g).map(([O,K])=>`${O}: ${K}`).join("; "),type:e,filter:s,filterLabel:w("filter"),showFilter:c,content:(await renderTemplate(F(`sidebars/${e}`),d)).trim()}),a=h.firstElementChild,this.element.append(a);let k=a.getBoundingClientRect(),S=t.getBoundingClientRect(),L=S.x-k.width;L<0&&(L=S.right);let T=parseInt(window.getComputedStyle(t).padding),H=He(k,S,T);return a.style.left=`${L}px`,a.style.top=`${H}px`,a=$(a),a.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",O=>{O.preventDefault(),a.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#l(e,"")}),a.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",O=>{O.key==="Enter"&&this.#l(e,O.currentTarget.value.trim())}),f(a,r,o),a}};l(ce,"HUD");function He(i,e,s=0){let t=e.y+e.height/2-i.height/2;return t+i.height>window.innerHeight&&(t=window.innerHeight-i.height-s),t<0&&(t=s),t}l(He,"postionFromTargetY");function Ct(i,e){let s=e.x+e.width/2-i.width/2;return s+i.width>window.innerWidth&&(y=window.innerWidth-i.width),s<0&&(s=0),s}l(Ct,"postionFromTargetX");async function gi(i){function e(f){ChatMessage.create({user:game.user.id,content:f,speaker:ChatMessage.getSpeaker({actor:i})})}l(e,"toChat");let{name:s,attributes:t}=i,{sp:a,resolve:n}=t,o=w("hud.resolve.full",{name:s}),r=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:s});if(a.value===a.max)return ui.notifications.warn(o);if(n.value<1)return ui.notifications.warn(r);let c=i.itemTypes.feat.find(f=>f.sourceId===di),u=await renderTemplate(F("dialogs/resolve"),{hasSteel:c,i18n:f=>w(`hud.resolve.${f}`)});new Dialog({title:w("hud.resolve.title"),content:u,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:w("hud.resolve.yes"),callback:async f=>{let{attributes:p}=i,{sp:d,resolve:m}=p;if(d.value===d.max)return e(o);if(m.value<1)return e(r);let g=f.find("input:checked").val(),h=`${d.value}/${d.max}`;if(g==="breather")e(w("hud.resolve.breather.used",{name:s,ratio:h})),await i.update({"system.attributes.sp.value":d.max,"system.attributes.resolve.value":m.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:s,ratio:h}));let k=d.value+Math.floor(d.max/2);await i.update({"system.attributes.sp.value":Math.min(k,d.max),"system.attributes.resolve.value":m.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:w("hud.resolve.no")}}}).render(!0)}l(gi,"useResolve");var x="pf2e-token-hud",X=null;function Y(i=!1){return i?X?.element:X}l(Y,"getHud");function Se(i){i&&!X?X=new ce:!i&&X&&(X.delete(),X=null)}l(Se,"enableModule");function v(i){return game.settings.get(x,i)}l(v,"getSetting");function w(...i){let e=i.at(-1),s=typeof e=="object",t=s?i.slice(0,-1):i;return t.unshift(x),game.i18n[s?"format":"localize"](t.join("."),e)}l(w,"localize");function Me(i,e){return i.itemTypes.feat.some(s=>s.sourceId===e)}l(Me,"hasFeat");function F(i){return`modules/${x}/templates/${i}.hbs`}l(F,"templatePath");function U(i){return i>=0?`+${i}`:i}l(U,"modifier");function q(i,e){return i.getFlag(x,e)}l(q,"getFlag");function Q(i,e,s){return i.setFlag(x,e,s)}l(Q,"setFlag");async function J(i,e,{isOwner:s=e.isOwner,rollData:t=e.getRollData()}={}){return i=i?.trim(),i?await TextEditor.enrichHTML(i,{async:!0,secrets:s,rollData:t}):""}l(J,"enrichHTML");function Et(){Tt("hold",{onDown:()=>{v("use-holding")!=="none"&&Y()?.setHolding(!0)},onUp:()=>{Y()?.setHolding(!1)}}),Tt("filter",{onUp:()=>{Y()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}l(Et,"registerKeybindings");function St(i,e){return`${x}.keybinds.${i}.${e}`}l(St,"path");function Tt(i,e={}){game.keybindings.register(x,i,{name:St(i,"name"),hint:St(i,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}l(Tt,"register");function Dt(){let i=game.data.users.find(s=>s._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(s=>w(`settings.status.statuses.${s}`)).join(", ");I("status",String,e,{scope:"world"}),I("last-status",Boolean,!1,{scope:"world"}),I("party",Boolean,!1,{scope:"world"}),I("enabled",Boolean,!0,{onChange:Se}),I("position",String,"right",{choices:{left:C("position","choices.left"),right:C("position","choices.right"),top:C("position","choices.top"),bottom:C("position","choices.bottom")}}),I("small-position",String,"top",{choices:{left:C("position","choices.left"),right:C("position","choices.right"),top:C("position","choices.top"),bottom:C("position","choices.bottom")}}),I("delay",Number,250,{range:{min:0,max:2e3,step:50}}),I("scale",Number,14,{range:{min:10,max:30,step:1}}),I("use-holding",String,"none",{hint:C("use-holding",i?"choices.gm.hint":"choices.player.hint"),choices:{none:C("use-holding","choices.none"),half:C("use-holding",i?"choices.gm.half":"choices.player.half"),all:C("use-holding",i?"choices.gm.all":"choices.player.all")}}),I("autolock",String,"none",{choices:{none:C("autolock","choices.none"),hover:C("autolock","choices.hover"),render:C("autolock","choices.render")}}),I("observer",Boolean,!0),I("see-status",Boolean,!1),I("saves",String,"bonus",{choices:{none:C("saves","choices.none"),bonus:C("saves","choices.bonus"),dc:C("saves","choices.dc")}}),I("others",String,"none",{choices:{none:C("saves","choices.none"),bonus:C("saves","choices.bonus"),dc:C("saves","choices.dc")}}),I("ranks",Boolean,!1),I("show-death",String,"always",{choices:{none:C("show-death","choices.none"),always:C("show-death","choices.always"),only:C("show-death","choices.only")}}),I("force-speed",Boolean,!1),I("tooltips",Boolean,!1),I("distance",String,"all",{choices:{none:C("distance","choices.none"),self:C("distance","choices.self"),all:C("distance","choices.all")}}),I("unit",String,""),I("height",String,""),I("filter",Boolean,!1),I("scrollbar",Boolean,!0),I("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),I("actions-columns",Boolean,!1),I("items-columns",Boolean,!1),I("spells-columns",Boolean,!1),I("skills-columns",Boolean,!1),I("actions",String,"split",{choices:{name:C("actions","choices.name"),type:C("actions","choices.type"),split:C("actions","choices.split")}}),I("actions-colors",Boolean,!0),I("containers",Boolean,!1),I("spells",Boolean,!1),I("tradition",Boolean,!1),I("untrained",Boolean,!0)}l(Dt,"registerSettings");function xt(i,e){let s=e.find(`.tab[data-tab=${x}]`);function t(a,n,o="h3"){let r=w(`menu.${n}`);s.find(`[name="${x}.${a}"]`).closest(".form-group").before(`<${o}>${r}</${o}>`)}l(t,"beforeGroup"),game.user.isGM&&t("enabled","client.header","h2"),t("saves","client.tooltip"),t("distance","client.distance"),t("height","client.sidebar"),t("actions","client.actions"),t("containers","client.items"),t("spells","client.spells"),t("untrained","client.skills")}l(xt,"renderSettingsConfig");function C(i,e){return`${x}.settings.${i}.${e}`}l(C,"path");function I(i,e,s,t={}){game.settings.register(x,i,{name:C(i,"name"),hint:C(i,"hint"),scope:"client",config:!0,type:e,default:s,...t})}l(I,"register");Hooks.once("setup",async()=>{Dt(),Et(),await loadTemplates({creature:F("tooltips/creature"),hazard:F("tooltips/hazard"),vehicle:F("tooltips/vehicle")})});Hooks.once("ready",()=>{v("enabled")&&Se(!0),game.modules.get("pf2e-token-hud").api={getHud:Y}});Hooks.on("renderSettingsConfig",xt);Hooks.on("getActorDirectoryEntryContext",(i,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${x}.actor.macros.contextmenu`,condition:s=>{let{documentId:t}=s.data();return v("enabled")&&game.actors.get(t)?.isOwner},callback:s=>{let{documentId:t}=s.data();hi(t)}})});var Te=class extends Dialog{async getData(e={}){let s=super.getData(e);return typeof s.content=="function"&&(s.content=await s.content()),s}};l(Te,"DataDialog");function hi(i){let e=game.actors.get(i);if(!e)return;let s=new Te({title:`${e.name} - ${w("actor.macros.title")}`,content:async()=>{let t=be(e)??[];return renderTemplate(F("dialogs/macros"),{macros:t,noMacro:w("extras.no-macro")})},buttons:{},render:t=>{e.apps[s.appId]=s,t.on("drop",a=>ve(a,e)),t.find("[data-action=delete-macro]").on("click",a=>ke(a,e))},close:()=>{delete e.apps[s.appId]}},{height:"auto"}).render(!0)}l(hi,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
