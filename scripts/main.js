(()=>{var gt=Object.defineProperty;var l=(i,e)=>gt(i,"name",{value:e,configurable:!0});var te=["U","T","E","M","L"];async function De(i,e){let s=i.data(),t=s.itemId?e.items.get(s.itemId):await fromUuid(s.uuid),o=await t?.getChatData({},s);if(!o)return;let n=document.createElement("div");return n.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(n,t,o),n}l(De,"getItemSummary");function M(i){i.on("mouseenter",e=>{e.preventDefault();let s=e.currentTarget.querySelector(".name"),{width:t}=s.getBoundingClientRect();if(s.scrollWidth<=Math.ceil(t))return;let o=s.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:o})}),i.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),i.on("mousedown",e=>{game.tooltip.deactivate()})}l(M,"addNameTooltipListeners");function Le(i,e){i.preventDefault(),D(i,e)?.sheet.render(!0,{focus:!0})}l(Le,"editItem");async function Ae(i,e){i.preventDefault();let s=D(i,e);if(s){if(i.ctrlKey)return s.delete();new Dialog({title:h("deleteItem.title"),content:await renderTemplate("systems/pf2e/templates/actors/delete-item-dialog.hbs",{name:s.name}),buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:h("deleteItem.ok"),callback:()=>s.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:h("deleteItem.cancel")}}}).render(!0)}}l(Ae,"deleteItem");function D(i,e){let{itemId:s}=i.currentTarget.closest("[data-item-id]").dataset;return e.items.get(s)}l(D,"getItemFromEvent");function se(i){return i.isOwner&&G(i,`macros.${game.user.id}`)?.map(e=>fromUuidSync(e)).filter(Boolean)}l(se,"getMacros");function ie(i,e){let{type:s,uuid:t}=TextEditor.getDragEventData(i.originalEvent)??{};if(s!=="Macro"||!fromUuidSync(t))return;let o=`macros.${game.user.id}`,n=G(e,o)?.slice()??[];n.includes(t)||(n.push(t),Y(e,o,n))}l(ie,"onDroppedMacro");function ne(i,e){let s=`macros.${game.user.id}`,t=G(e,s)?.slice();if(!t?.length)return;let{uuid:o}=i.currentTarget.closest(".macro").dataset,n=t.indexOf(o);n!==-1&&(t.splice(n,1),Y(e,s,t))}l(ne,"deleteMacro");function oe(i=()=>!0){let e=game.user.targets,s=e.size===1?e.first():null;return s&&i(s)?s:null}l(oe,"getUniqueTarget");var ht=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),yt=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]),Pe=new Set(["arcane","divine","occult","primal"]),Me={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"};function $e(i,e="systems/pf2e/icons/actions/Empty.webp"){if(i===null)return Me.passive;let s=typeof i!="object"?i:i.type==="action"?i.value:i.type,t=String(s??"").toLowerCase().trim();return Me[t]??e}l($e,"getActionIcon");async function Re({weapon:i,trait:e,selection:s}){if(i.system.traits.toggles[e].selection===s)return!1;let o=i.actor?.items.get(i.id);return o?.isOfType("weapon")&&o===i?await o.update({[`system.traits.toggles.${e}.selection`]:s}):o?.isOfType("weapon")&&i.altUsageType==="melee"?await o.update({[`system.meleeUsage.traitToggles.${e}`]:s}):await o?.rules.find(r=>r.key==="Strike"&&!r.ignored&&r.slug===i.slug)?.toggleTrait({trait:e,selection:s}),!0}l(Re,"toggleWeaponTrait");function vt(i,e="normal"){return i+(ht.get(e)??0)}l(vt,"adjustDC");function bt(i="common"){switch(i){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}l(bt,"rarityToDCAdjustment");function he(i,e="common"){return vt(i,bt(e))}l(he,"adjustDCByRarity");function wt(i,{proficiencyWithoutLevel:e,rarity:s="common"}={}){let t=game.settings.get("pf2e","proficiencyVariant");e??=t==="ProficiencyWithoutLevel";let o=yt.get(i)??14;return he(e?o-Math.max(i,0):o,s)}l(wt,"calculateDC");function kt(i){return i.traits.has("cursed")?"unique":i.rarity}l(kt,"getDcRarity");function St(i){let e=i.system.traits.value;return new Set(e.filter(s=>Et(Pe,s)))}l(St,"getMagicTraditions");function Ct(i,e,s){let t={occult:e,primal:e,divine:e,arcane:e},o=St(i);for(let n of Pe)o.size>0&&!o.has(n)&&(t[n]=e+s);return{arcana:t.arcane,nature:t.primal,religion:t.divine,occultism:t.occult}}l(Ct,"getIdentifyMagicDCs");function Tt(i,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:s}){let t=wt(i.level,{proficiencyWithoutLevel:e}),o=kt(i),n=he(t,o);return i.isMagical?Ct(i,n,s):i.isAlchemical?{crafting:n}:{dc:n}}l(Tt,"getItemIdentificationDCs");function It(i,e){return(typeof e=="string"||typeof e=="number")&&e in i}l(It,"objectHasKey");function Et(i,e){return i.has(e)}l(Et,"setHasElement");var J=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),t=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",o=Tt(e,{proficiencyWithoutLevel:t,notMatchingTraditionModifier:s});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:o}}activateListeners(e){e.find("button.update-identification").on("click",s=>{let t=$(s.delegateTarget);this.submit({updateData:{status:t.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let s=this.item,t=s.system.identification.unidentified.img,o=s.system.identification.unidentified.name,n=s.system.identification.identified.name,r=$("div#identify-item").find("tr").toArray().flatMap(c=>{let d=c.dataset.skill,p=Number(c.dataset.dc);if(!(Number.isInteger(p)&&It(CONFIG.PF2E.skillList,d)))return[];let f=game.i18n.localize(CONFIG.PF2E.skillList[d]);return{slug:d,name:f,dc:p}}),a=s.isMagical?"action:identify-magic":s.isAlchemical?"action:identify-alchemy":null,u=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:t,itemName:o,identifiedName:n,rollOptions:["concentrate","exploration","secret",a].filter(Boolean),skills:r});await CONFIG.ChatMessage.documentClass.create({user:game.user.id,content:u})})}async _updateObject(e,s){let t=s.status;t==="identified"&&await this.item.setIdentificationStatus(t)}};l(J,"IdentifyItemPopup");async function ce(i,e,s,{rollMode:t=void 0,create:o=!0,data:n={}}){let r=`systems/pf2e/templates/chat/${e.type}-card.hbs`,a=s.token,u=i?.currentTarget.closest(".item")??{},c=CONFIG.ChatMessage.documentClass,d=Object.keys(n).length>0?n:u.dataset||{},p={actor:s,tokenId:a?`${a.parent?.id}.${a.id}`:null,item:e,data:await e.getChatData(void 0,d)},f={speaker:c.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return t??=i?.ctrlKey||i?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(t)&&(f.whisper=c.getWhisperRecipients("GM").map(S=>S.id)),t==="blindroll"&&(f.blind=!0),f.content=await renderTemplate(r,p),o?c.create(f,{renderSheet:!1}):new c(f)}l(ce,"unownedItemToMessage");var ae={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},Oe={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function Fe(i,e){switch(i){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+i,0,3)}}l(Fe,"adjustDegreeOfSuccess");function re(i,e){return i===20?Fe(Oe.INCREASE,e):i===1?Fe(Oe.LOWER,e):e}l(re,"adjustDegreeByDieValue");function Ue(i,e,s){return i-s>=10?re(e,ae.CRITICAL_SUCCESS):s-i>=10?re(e,ae.CRITICAL_FAILURE):i>=s?re(e,ae.SUCCESS):re(e,ae.FAILURE)}l(Ue,"calculateDegreeOfSuccess");async function X(i,e){let s=$(`#${b}`);if(!s.length)return;s.find("> .popup").remove();let t=document.createElement("div");t.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${i}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${h("popup.close")}</a>
    </div>
</div>`;let o=t.firstElementChild;typeof e=="string"?(e=await TextEditor.enrichHTML(e,{async:!0}),o.insertAdjacentHTML("beforeend",e)):o.append(e),o.querySelector("[data-action=close-popup]").addEventListener("click",()=>o.remove()),s.append(o)}l(X,"popup");async function O(i,e,s){s??=i.find(".name").html();let t=await De(i,e);t&&X(s.trim(),t)}l(O,"showItemSummary");var F="pf2e-token-hud",xt=new Set(["Compendium.pf2e.equipment-srd.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.4kz3vhkKPUuXBpxk"]),Ne="Compendium.pf2e.feats-srd.0GF2j54roPFIDmXf",Dt={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${F}.skills.actions.earnIncome`,treatWounds:`${F}.skills.actions.treatWounds`,"borrow-arcane-spell":`${F}.skills.actions.borrow-arcane-spell`,"identify-magic":`${F}.skills.actions.identify-magic`,"identify-alchemy":`${F}.skills.actions.identify-alchemy`,"learn-spell":`${F}.skills.actions.learn-spell`,"crafting-goods":`${F}.skills.actions.crafting-goods`,"staging-performance":`${F}.skills.actions.staging-performance`},He={"sense-motive":"Compendium.pf2e.actionspf2e.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.SkZAQRkLLkmBQNB9","tumble-through":"Compendium.pf2e.actionspf2e.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.QNAVeNKtHA0EUw4X",bonMot:Ne,gatherInformation:"Compendium.pf2e.actionspf2e.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.2EE4aF4SZpYf0R6H"},Lt={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},Q=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:i=>!i.itemTypes.equipment.some(e=>e.isHeld&&xt.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:i=>i.itemTypes.feat.some(e=>e.getFlag("core","sourceId")===Ne)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"]},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell"]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];Q.forEach(i=>{i.actions=i.actions.map(t=>typeof t=="string"?Lt[t]:t);let{slug:e,actions:s}=i;for(let t of s){let o=t.slug.replace(/-(.)/g,(n,r)=>r.toUpperCase()).capitalize();t.skillSlug=e,t.uuid=He[t.slug],t.label=Dt[t.slug]??`PF2E.Actions.${o}.Title`,t.variants?t.variants=t.variants.map(n=>({slug:n,label:`${F}.skills.actions.${n}`})):t.map&&(t.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),t.modifiers?.forEach(({modifiers:n})=>{n.forEach(r=>{r.label=`${F}.skills.modifiers.${r.slug}`})})}});var ye=Q.map(i=>i.slug),At=Q.reduce((i,{slug:e,actions:s})=>(i[e]={slug:e,actions:s.reduce((t,o)=>(t[o.slug]=o,t),{})},i),{}),_e=new Set(Object.values(He).filter(Boolean));function ve(i){return game.i18n.localize(i==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[i])}l(ve,"getSkillLabel");async function je(i){let e=[],s=!g("untrained"),t=!i.isOfType("character");for(let n=0;n<Q.length;n++){let{slug:r,actions:a}=Q[n],{label:u,rank:c,mod:d}=q(r,i);e[n]={slug:r,label:u,rank:c,modifier:H(d),actions:a.filter(p=>(s||t||!p.trained||i.skills[r].rank>=1)&&(!p.condition||p.condition(i)))}}let o=Object.values(i.skills).filter(n=>n.lore).map(({label:n,rank:r,mod:a,slug:u})=>({slug:u,label:n,rank:r,modifier:H(a)}));return{skills:e,lores:o,doubled:g("skills-columns")}}l(je,"getSkillsData");function q(i,e){return i==="perception"?e.perception:e.skills[i]}l(q,"getSkill");function Be(i,e){i.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let t=$(s.currentTarget).closest(".action");O(t,e,t.find(".name").children().html())}),e.isOwner&&(i.find("[data-action=roll-skill]").on("click",s=>{s.preventDefault();let{slug:t}=s.currentTarget.dataset;q(t,e).roll({event:s})}),i.find("[data-action=roll-action]").on("click contextmenu",async s=>{s.preventDefault();let t=$(s.currentTarget),{skillSlug:o,slug:n}=t.closest(".action").data(),r=s.type==="contextmenu"?await le(o):void 0;r!==null&&Mt(s,e,o,n,t.data(),r?.selected)}),i.find("[data-action=action-chat]").on("click",async s=>{s.preventDefault();let{uuid:t}=s.currentTarget.closest(".action").dataset,o=await fromUuid(t);o&&ce(s,o,e,{create:!0})}))}l(Be,"addSkillsListeners");async function le(i,e){let s='<p style="display: flex; align-items: center; justify-content: space-between;">';s+=`<strong>${h("skills.variant.label")}</strong> <select>`;for(let t of ye){let o=t===i?"selected":"",n=ve(t);s+=`<option value="${t}" ${o}>${n}</option>`}return s+="</select></p>",e&&(s+='<p style="display: flex; align-items: center; justify-content: space-between;">',s+=`<strong>${h("skills.variant.dc")}</strong>`,s+=`<input type="number" value="${e}" min="0" style="width: 4ch;"></p>`),Dialog.prompt({title:h("skills.variant.title"),label:h("skills.variant.button"),callback:t=>({selected:t.find("select").val(),dc:t.find("input").val()}),rejectClose:!1,content:s,options:{width:280}})}l(le,"createVariantDialog");function Mt(i,e,s,t,{variant:o,map:n},r){let a=At[s].actions[t],u=a.type;r??=a.noSkill?void 0:s;let c={event:i,actors:[e],variant:o,rollMode:a.secret?"blindroll":"roll"};if(c.modifiers=[],a.modifiers){for(let{condition:d,modifiers:p}of a.modifiers)if(!(d&&!d(e)))for(let f of p)c.modifiers.push(new game.pf2e.Modifier(f))}if(a.custom){a.custom(e,c);return}else if(!u){q(r,e).roll(c);return}u===1?(c.skill=r,n&&c.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:n})),game.pf2e.actions[t](c)):u===2?(c.statistic=r,n&&(c.multipleAttackPenalty=n/-5),game.pf2e.actions.get(t).use(c)):u===3&&game.pf2e.actions[t](e)}l(Mt,"rollAction");var K={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionTypeReaction",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionTypeFree",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.ActionTypePassive",actionLabel:"PF2E.ActionTypePassive"}},ze={delay:[500,0],position:"top",theme:"crb-hover",arrow:!1};async function Ge(i){let e=i.isOfType("character"),s=i.synthetics.toggles.slice(),t=g("actions"),o=e?Ft(i):Pt(i),n,r=game.modules.get("pf2e-hero-actions");if(r?.active&&e){let c=r.api.getHeroActions(i),d=i.heroPoints.value-c.length;n={actions:c,draw:Math.max(d,0),discard:Math.abs(Math.min(d,0)),canTrade:c.length&&game.settings.get("pf2e-hero-actions","trade")}}let a=await Promise.all(i.system.actions.map(async(c,d)=>({...c,index:d,damageFormula:await c.damage?.({getFormula:!0}),criticalFormula:await c.critical?.({getFormula:!0})}))),u={};for(let c of o)t!=="split"?(u.action??=[],u.action.push(c)):(u[c.type]??=[],u[c.type].push(c));if(u=Object.entries(u).map(([c,d])=>(d.forEach(p=>{p.img=$e(p.cost),p.typeLabel=K[p.type].actionLabel}),t!=="type"?d.sort((p,f)=>p.name.localeCompare(f.name)):d.sort((p,f)=>{let S=K[p.type].order,k=K[f.type].order;return S===k?p.name.localeCompare(f.name):S-k}),{type:c,actions:d,label:K[c].label})),t==="split"&&u.sort((c,d)=>K[c.type].order-K[d.type].order),s.length||a.length||u.length||n?.length)return{toggles:s,strikes:a,sections:u,heroActions:n,damageTypes:CONFIG.PF2E.damageTypes}}l(Ge,"getActionsData");function qe(i){if(g("actions-colors"))return{classList:["attack-damage-system-colors"]}}l(qe,"getActionsOptions");function Ke(i,e){M(i.find(".toggle")),M(i.find(".strike")),M(i.find(".action"));function s(n,r,a="click"){return n=typeof n=="string"?[n]:n,n=n.map(u=>`[data-action=${u}]`).join(", "),i.find(n).on(a,u=>{u.preventDefault(),r(u)})}l(s,"action");function t(n){let{index:r}=n.currentTarget.closest(".strike").dataset;return e.system.actions[r]}l(t,"getStrike");function o(n){return $(n.currentTarget).closest(".action").data().uuid}l(o,"getUuid"),s("action-description",async n=>{let r=$(n.currentTarget).closest(".action");O(r,e)}),s("hero-action-description",async n=>{let{description:r,name:a}=await Ot(o(n))??{};r&&X(a,r)}),s("strike-description",async n=>{let r=t(n);if(!r)return;let a=document.createElement("div");a.classList.add("description"),a.innerHTML=await renderTemplate(j("strike-description"),r),X(r.label,a)}),s("trait-description",n=>{let r=t(n);if(!r)return;let{index:a}=n.currentTarget.dataset,u=r.traits[a];if(!u)return;let c=game.i18n.localize(u.description);c&&X(game.i18n.localize(u.label),c)}),e.isOwner&&(s("action-chat",n=>{D(n,e)?.toMessage(n,{create:!0})}),s("hero-action-chat",async n=>{await game.modules.get("pf2e-hero-actions")?.api.sendActionToChat(e,o(n))}),s("draw-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.drawHeroActions(e)}),s("use-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.useHeroAction(e,o(n))}),s("discard-hero-action",async n=>{await game.modules.get("pf2e-hero-actions")?.api.discardHeroActions(e,o(n))}),s("trade-hero-action",async n=>{game.modules.get("pf2e-hero-actions")?.api.tradeHeroAction(e)}),s("strike-attack",n=>{let{index:r}=n.currentTarget.dataset;t(n)?.variants[r].roll({event:n})}),s(["toggle-roll-option","set-suboption"],n=>{let r=n.currentTarget.closest(".toggle"),{domain:a,option:u,itemId:c}=r.dataset,d=r.querySelector("select")?.value??null;e.toggleRollOption(a,u,c??null,r.querySelector("input").checked,d)}),s(["strike-damage","strike-critical"],n=>{let{action:r}=n.currentTarget.dataset;t(n)?.[r==="strike-damage"?"damage":"critical"]({event:n})}).tooltipster(ze),s("strike-auxiliary",n=>{if(n.currentTarget!==n.target)return;let r=t(n);if(!r)return;let{index:a}=n.currentTarget.dataset,u=n.currentTarget.querySelector("select")?.value??null;r.auxiliaryActions?.[a]?.execute({selection:u})}),s("toggle-versatile",n=>{let r=t(n)?.item;if(!r)return;let a=n.currentTarget,{value:u}=a.dataset,c=r?.system.damage.damageType??null,d=a.classList.contains("selected")||u===c?null:u;Re({trait:"versatile",weapon:r,selection:d})}).tooltipster(ze),s("strike-ammo",async n=>{let r=t(n)?.item;if(!r)return;let a=e.items.get(n.currentTarget.value);await r.update({system:{selectedAmmoId:a?.id??null}})},"change"))}l(Ke,"addActionsListeners");function Ot(i){return game.modules.get("pf2e-hero-actions")?.api.getHeroActionDetails(i)}l(Ot,"getHeroActionDescription");function Ft(i){let e=i.itemTypes.action.filter(t=>!_e.has(t.sourceId)),s=i.itemTypes.feat.filter(t=>t.actionCost);return[...e,...s].filter(t=>{let o=t.system.traits.value;return!o.includes("downtime")&&!o.includes("exploration")}).map(t=>{let o=t.actionCost;return{id:t.id,type:o?.type??"free",cost:o,name:t.name}})}l(Ft,"getCharacterActions");function Pt(i){return i.itemTypes.action.map(e=>{let s=e.actionCost,t=s?.type??"passive",o=t==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(n=>n.key==="Aura"));return{id:e.id,type:t,cost:s,name:e.name,hasDeathNote:e.system.deathNote,hasAura:o}})}l(Pt,"getNpcActions");var $t=["arcana","crafting","medicine","nature","occultism","religion","society"],We={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function Ve(i){let e=await new Roll("1d20").evaluate({async:!0}),s=e.total,t=e.dice[0].total,o=t===1?"0":t===20?"3":"",n=Object.values(i.skills).filter(c=>c.lore),r=oe(c=>c.actor?.identificationDCs),a={dieSuccess:o,dieResult:t,target:r,i18n:c=>h(`actions.recall-knowledge.${c}`)};if(r){let{standard:c,skills:d,lore:p}=r.actor.identificationDCs,f=c.progression.slice();f.length=4,f=[...f];let S=p.map(({progression:k})=>{let C=k;return C.length=6,[...C]});a.skillsDCs=f,a.skills=d.map(k=>{let{mod:C,label:E,rank:T}=i.skills[k],x=s+C;return{label:E,mod:C,rank:T,rankLabel:te[T],total:x,checks:f.map(P=>{if(!P)return"-";let R=Ue(x,t,P);return{success:R,icon:We[R].icon,title:We[R].name}})}}),a.loresDCs=S,a.lores=n.map(({label:k,rank:C,mod:E})=>({label:k,rank:C,mod:E,modifier:H(E)}))}else a.skills=[...$t.map(c=>i.skills[c]),...n].map(({label:c,rank:d,mod:p})=>({label:c,rank:d,mod:p,modifier:H(p)}));let u=await renderTemplate(j("chat/recall-knowledge"),a);ChatMessage.create({flavor:u,speaker:ChatMessage.getSpeaker({actor:i}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL})}l(Ve,"rollRecallKnowledges");async function Ye(i){let{attributes:e}=i,{initiative:s}=e;return{noMacro:h("extras.no-macro"),macros:se(i),initiative:{selected:s.statistic,skills:ye.map(t=>({slug:t,label:ve(t)}))},hasDailies:game.modules.get("pf2e-dailies")?.active}}l(Ye,"getExtrasData");function Je(i,e,s){function t(n,r,a="click"){i.find(`[data-action=${n}]`).on(a,u=>{u.preventDefault(),r(u)})}if(l(t,"action"),t("action-description",n=>{let r=$(n.currentTarget).closest(".row");O(r,e)}),!e.isOwner)return;M(i.find(".macro"));async function o(n){let{uuid:r}=n.currentTarget.closest(".macro").dataset;return fromUuid(r)}l(o,"getMacro"),t("delete-macro",n=>ne(n,e)),t("edit-macro",async n=>{(await o(n))?.sheet.render(!0)}),t("use-macro",async n=>{(await o(n))?.execute({actor:e,token:s})}),i.on("drop",n=>ie(n,e)),t("action-chat",async n=>{let{uuid:r}=n.currentTarget.closest(".row").dataset,a=await fromUuid(r);a&&ce(n,a,e,{create:!0})}),i.find("input[name], select[name]").on("change",async n=>{let r=n.currentTarget,a=r.type==="number"?r.valueAsNumber:r.value;await e.update({[r.name]:a})}),t("roll-initiative",async n=>{await e.initiative.roll({event:n})}),t("prepare-dailies",n=>{let r=game.modules.get("pf2e-dailies");r?.active&&r.api.openDailiesInterface(e)}),t("rest-for-the-night",n=>{game.pf2e.actions.restForTheNight({actors:[e]})}),t("roll-recall-knowledge",n=>{Ve(e)}),t("roll-aid",async n=>{let r=await le(null,20),a={text:"@UUID[Compendium.pf2e.other-effects.AHMUpMbaVkZ5A1KX]"};r!==null&&game.pf2e.actions.get("aid").use({event:n,actors:[e],statistic:r?.selected,difficultyClass:{value:r?.dc},notes:[a]})},"click contextmenu"),t("roll-escape",async n=>{let r=n.type==="contextmenu"?await le():void 0;r!==null&&game.pf2e.actions.get("escape").use({event:n,actors:[e],statistic:r?.selected})},"click contextmenu")}l(Je,"addExtrasListeners");var be={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function Xe(i){let e={};for(let s of i.inventory.contents)e[s.type]??=[],e[s.type].push(s);return{categories:Object.entries(e).map(([s,t])=>(t.sort((o,n)=>o.name.localeCompare(n.name)),{type:s,items:t,label:be[s].label})).sort((s,t)=>be[s.type].order-be[t.type].order)}}l(Xe,"getItemsData");function Qe(i,e){let s=i.find(".item");M(s),s.find("[data-action=item-description]").on("click",async t=>{t.preventDefault();let o=$(t.currentTarget).closest(".item");O(o,e)}),e.isOwner&&(s.find("[data-action=item-chat]").on("click",async t=>{D(t,e)?.toMessage(t,{create:!0})}),s.on("dragstart",t=>{let o=t.target.closest(".item"),{itemType:n,uuid:r}=o.dataset,a=new Image;a.src=o.querySelector(".item-img img").src,a.style.width="32px",a.style.height="32px",a.style.borderRadius="4px",a.style.position="absolute",a.style.left="-1000px",document.body.append(a),t.originalEvent.dataTransfer.setDragImage(a,16,16),t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:n,uuid:r})),o.addEventListener("dragend",()=>a.remove(),{once:!0})}),i.find(".quantity input").on("change",async t=>{await D(t,e)?.update({"system.quantity":t.currentTarget.valueAsNumber})}),i.find("[data-action=toggle-item-invest]").on("click",t=>{t.preventDefault();let{itemId:o}=t.currentTarget.closest(".item").dataset;e.toggleInvested(o)}),i.find("[data-action=repair-item]").on("click",t=>{t.preventDefault();let o=D(t,e);o&&game.pf2e.actions.repair({item:o,actors:[e]})}),i.find("[data-action=toggle-identified]").on("click",t=>{t.preventDefault();let o=D(t,e);o&&(o.isIdentified?o.setIdentificationStatus("unidentified"):new J(o).render(!0))}),i.find("[data-action=edit-item]").on("click",t=>{t.preventDefault(),Le(t,e)}),i.find("[data-action=delete-item]").on("click",t=>{t.preventDefault(),Ae(t,e)}),i.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(t,{event:o,origin:n}){let r=D(o,e);if(!r)return;let a=document.createElement("div");a.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:r});let u=a.children[1];$(u).find("[data-carry-type]").on("click",c=>{let{carryType:d,handsHeld:p=0,inSlot:f}=$(c.currentTarget).data();e.adjustCarryType(r,d,p,f),t.close()}),t.content(u)}}))}l(Qe,"addItemsListeners");async function Ze(i){let e=i.system.resources.focus??{value:0,max:0},s=i.spellcasting.regular,t=g("tradition"),o=[],n=[],r=!1;for(let c of s){let d=c.id,p=t&&c.statistic.label[0],f=await c.getSheetData(),S=f.isFocusPool,k=c.system?.prepared?.value==="charge",C=getProperty(c,"flags.pf2e-staves.staveID")!==void 0,E={value:getProperty(c,"flags.pf2e-staves.charges")??0};for(let T of f.levels){if(!T.active.length||T.uses?.max===0)continue;let x=[],P=T.isCantrip,R=T.active.filter(U=>U&&U.uses?.max!==0);for(let U=0;U<R.length;U++){let{spell:N,expended:pe,virtual:V,uses:B,castLevel:ee}=R[U];x.push({name:N.name,img:N.img,tradition:p,castLevel:ee??N.level,slotId:U,entryId:d,itemId:N.id,inputId:f.isInnate?N.id:f.id,inputPath:k?"flags.pf2e-staves.charges":f.isInnate?"system.location.uses.value":`system.slots.slot${T.level}.value`,isCharge:k,isVirtual:V,isInnate:f.isInnate,isCantrip:P,isFocus:S,isPrepared:f.isPrepared,isSpontaneous:f.isSpontaneous||f.isFlexible,slotLevel:T.level,uses:B??(k?E:T.uses),expended:pe??(S&&!P?e.value<=0:!1),action:N.system.time.value,type:k?C?`${b}.spells.staff`:`${b}.spells.charges`:f.isInnate?"PF2E.PreparationTypeInnate":f.isSpontaneous?"PF2E.PreparationTypeSpontaneous":f.isFlexible?"PF2E.SpellFlexibleLabel":S?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:k?0:f.isPrepared?1:S?2:f.isInnate?3:f.isSpontaneous?4:5})}if(x.length){if(S)if(P)r=!0;else{n.push(...x);continue}o[T.level]??=[],o[T.level].push(...x)}}}if(o.length){let c=g("spells")?(d,p)=>d.order===p.order?d.name.localeCompare(p.name):d.order-p.order:(d,p)=>d.name.localeCompare(p.name);o.forEach(d=>d.sort(c))}n.length&&(n.sort((c,d)=>c.name.localeCompare(d.name)),o[12]=n,r=!1);let u=(await i.spellcasting.ritual?.getSheetData())?.levels.flatMap((c,d)=>c.active.map(({spell:p})=>({name:p.name,img:p.img,slotId:d,itemId:p.id,level:p.level,time:p.system.time.value})));if(o.length||u?.length)return{spells:o,rituals:u,focusPool:e,hasFocusCantrips:r,doubled:g("spells-columns")}}l(Ze,"getSpellsData");function et(i,e){M(i.find(".spell")),i.find("[data-action=spell-description]").on("click",async s=>{s.preventDefault();let t=$(s.currentTarget).closest(".spell");O(t,e)}),e.isOwner&&(i.find("[data-action=spell-chat]").on("click",async s=>{D(s,e)?.toMessage(s,{create:!0})}),i.find("[data-action=toggle-pips]").on("click contextmenu",async s=>{s.preventDefault();let t=s.type==="click"?1:-1,o=(e.system.resources.focus?.value??0)+t;await e.update({"system.resources.focus.value":o})}),i.find("[data-action=toggle-prepared]").on("click",s=>{s.preventDefault();let{slotLevel:t,slotId:o,entryId:n,expended:r}=$(s.currentTarget).closest(".spell").data();e.spellcasting.collections.get(n)?.setSlotExpendedState(t??0,o??0,r!==!0)}),i.find("[data-action=cast-spell]").on("click",s=>{s.preventDefault();let{slotLevel:t,slotId:o,entryId:n,itemId:r}=$(s.currentTarget).closest(".spell").data(),a=e.spellcasting.collections.get(n,{strict:!0});if(!a)return;let u=a.get(r,{strict:!0});u&&a.entry.cast(u,{slot:o,level:t})}),i.find("[data-input-path]").on("change",async s=>{let{inputPath:t,entryId:o}=$(s.currentTarget).data(),n=s.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:o,[t]:n}])}))}l(et,"addSpellsListeners");var we="Compendium.pf2e.other-effects.I9lfZUiCwMiGogVi",Rt="Compendium.pf2e.feats-srd.jFmdevE4nKevovzo",tt={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},Ut={G:"fa-solid fa-face-smile-halo",N:"fa-solid fa-face-meh",E:"fa-solid fa-face-angry-horns"},Nt=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],Ht={actions:{getData:Ge,addListeners:Ke,getOptions:qe},items:{getData:Xe,addListeners:Qe},spells:{getData:Ze,addListeners:et},skills:{getData:je,addListeners:Be},extras:{getData:Ye,addListeners:Je}},_t={fortitude:"fa-solid fa-hand-fist",reflex:"fa-solid fa-person-running",will:"fa-solid fa-brain"},jt={perception:"fa-solid fa-eye",stealth:"fa-duotone fa-eye-slash",athletics:"fa-solid fa-dumbbell"},Z=class extends Application{#e=null;#d=null;#s=null;#n=!1;#o=null;#a;#r=[!1,!1,!1];#t=!1;#c=!1;#l=null;#u=null;#i=!1;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#l=(e,s)=>{if(g("chat")&&$(window.document).find(":hover").filter("#sidebar").length||this.mousedown||this.#t||this.#c||!(e instanceof Token)||!e.actor?.isOfType("character","npc"))return;let o=e.localTransform,n=e.document;if(!(o.tx!==n.x||o.ty!==n.y)&&(this.#n=s,!(s&&this.#e===e&&this.rendered)))if(s&&!game.keyboard.downKeys.has("ControlLeft")){if(this.#p(e),!this.#o)return this.render(null,null,g("use-holding")==="none"||!Se());clearTimeout(this.#o),this.#o=null,this.render()}else this.close()},this.#a=e=>{let s=e.button;if(![0,2].includes(s))return;if(e.type==="mouseup"){this.#r[s]=!1;return}this.#r[s]=!0;let t=e.target,o=this.element[0];if(o){let n=o.querySelector(".popup");if(o.contains(t)){n&&!n.contains(t)&&n.remove();return}if(t.closest(".app")||t.closest(".tooltipster-base")||o.querySelector(".sidebar.extras")&&t.closest("#hotbar"))return;if(n)return n.remove();this.forceClose()}else this.#s&&(clearTimeout(this.#s),this.#s=null);this.#t=!1},this.#u=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#a),window.addEventListener("mouseup",this.#a),Hooks.on("hoverToken",this.#l),Hooks.on("deleteToken",this.#u),Hooks.on("canvasPan",this.forceClose)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#a),window.removeEventListener("mouseup",this.#a),Hooks.off("hoverToken",this.#l),Hooks.off("deleteToken",this.#u),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:j("hud")})}get mousedown(){return this.#r[0]||this.#r[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return this.actor?.itemTypes.effect.find(e=>e.flags.core?.sourceId===we)}get isCharacter(){return this.actor?.isOfType("character")}#p(e){e!==this.#e&&(this.#e&&delete this.#e.actor.apps[this.appId],this.#e=e)}getData(){let e=this.#e,s=this.#e?.actor;if(!s)return{};let t=null,o=g("saves"),n=g("others"),r=this.isCharacter,{attributes:a,saves:u,heroPoints:c,system:d,alignment:p}=s,{traits:f}=d,{hp:S,sp:k={max:0,value:0},resolve:C,ac:E,shield:T,speed:x,dying:P,wounded:R,resistances:U,weaknesses:N,immunities:pe}=a,V=game.settings.get("pf2e","staminaVariant"),B=this.#i,ee=g("distance");if(ee==="all"||ee==="self"&&B){let m=g("unit").split(","),I=Number(m[0]?.trim())||1,L=m[1]?.trim()||game.system.gridUnits,A=Number(m[2]?.trim())||0,_=canvas.tokens.controlled,xe=!1,z=_.length===1?_[0]:null;(!z||z===e)&&(z=oe(),xe=!0),z&&z!==e&&(t={unit:L,icon:xe?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(z)*I).toFixed(A)})}let fe;if(!B||g("see-status")){let m=g("status").split(",").map(I=>I.trim()).filter(Boolean);if(m.length){let I=S.max+(V?k.max:0),A=(S.value+(V?k.value:0))/I,_=Math.ceil(A*m.length);fe={hue:A*A*122+3,value:_===0?game.i18n.localize("EFFECT.StatusDead"):m.at(_-1)}}}if(!B)return{status:fe,distance:t,tokenId:e.id};function me(m){return`<li>${m.trim()}</li>`}l(me,"toInfo");function ct(m,I){return m.localeCompare(I)}l(ct,"sort");let lt=s.system.traits?.languages?.value.map(m=>game.i18n.localize(CONFIG.PF2E.languages[m])).filter(Boolean).sort(ct).map(me).join(""),ut=r?f.senses.map(m=>m.label):f.senses.value.split(",").filter(Boolean);function ge(m,I){return m.length?`<li>${game.i18n.localize(I)}<ul>`+m.map(L=>me(L.label.replace("-"," ").titleCase())).join("")+"</ul></li>":""}l(ge,"toIWR");let Te=Nt.map(({type:m,icon:I},L)=>({index:L,icon:I,label:game.i18n.localize(CONFIG.PF2E.speedTypes[m]??"PF2E.SpeedTypesLand"),value:(m==="land"?x.total:x.otherSpeeds.find(A=>A.type===m)?.total)||0})),dt=G(s,`speeds.selected.${game.user.id}`)||0,pt=Te.splice(dt,1)[0],Ie=Te.map(({value:m,label:I,index:L})=>`<a data-index="${L}"><li>${I}: ${m}</li></a>`).join("");x.details&&(Ie+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${x.details}</li>`);let ft=g("show-death"),mt=g("ranks");function Ee(m,I,L){let A=m.slug,_=I==="bonus"?H(m.mod):m.dc.value;return{slug:A,value:_,label:m.label,icon:L[A],rank:mt&&te[m.rank]}}return l(Ee,"getStatistic"),{titles:{actions:`${b}.actions.title`,items:`${b}.items.title`,spells:`${b}.spells.title`,skills:`${b}.skills.title`,extras:`${b}.extras.title`},distance:t,status:fe,isOwner:e.isOwner,isObserver:B,tokenId:e.id,name:e.document.name,hp:S,sp:V?k:{max:0},ac:E.value,hero:c,dying:P,wounded:R,shield:T,resolve:C,alignment:{value:p,icon:Ut[p.at(-1)]},level:s.level,isCharacter:r,showDeathLine:r&&(ft==="always"||P.value||R.value),hasCover:this.hasCover,saves:o!=="none"&&["fortitude","reflex","will"].map(m=>Ee(u[m],o,_t)),others:n!=="none"&&["perception","stealth","athletics"].map(m=>Ee(q(m,s),n,jt)),speeds:{main:pt,others:Ie},iwr:ge(pe,"PF2E.ImmunitiesLabel")+ge(N,"PF2E.WeaknessesLabel")+ge(U,"PF2E.ResistancesLabel"),senses:ut.map(me).join(""),languages:lt,hasSpells:s.spellcasting.some(m=>m.category!=="items"),hasItems:s.inventory.size}}#f(e){this.#p(null),this.#n=!1,this.#t=!1,this.#c=!1,this.#i=!1,this.#s!==null&&(clearTimeout(this.#s),this.#s=null);let s=Application.RENDER_STATES;if(!e.force&&![s.RENDERED,s.ERROR].includes(this._state))return;this._state=s.CLOSING;let t=this.element;if(!t)return this._state=s.CLOSED;t.css({minHeight:0});for(let o of this.constructor._getInheritanceChain())Hooks.call(`close${o.name}`,this,t);t.remove(),this._element=null,this._state=s.CLOSED,delete ui.windows[this.appId]}close(e={}){if(e.force)return this.#f(e);this.#o=setTimeout(()=>{this.#o=null,!this.#n&&this.#f(e)})}async _render(e=!1,s={}){let t,o;if(this.#d===this.#e){let n=this.element.find("> .sidebar")[0];n&&(t=n.dataset.type,o=n.scrollTop)}if(await super._render(e,s),ui.windows[this.appId]=this,t){let n=await this.#m(t);o>0&&(n.scrollTop=o)}this.#d=this.#e}render(e,s,t){let o=this.#e,n=o?.actor;if(!n)return;let r=Se(),a=g("use-holding"),u=n.system.details.alliance==="party";if(game.user.isGM&&a==="half"&&!r?this.#i=!1:this.#i=o.isOwner||g("observer")&&(o.observer||u&&g("party")),a!=="none"&&!r&&(a==="all"||this.#i))return;if(!t)return super.render(!0);let c=g("delay");c?this.#s=setTimeout(()=>super.render(!0),c):super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let s=this.element[0],t=e.worldTransform.a,o=s.getBoundingClientRect(),n=canvas.clientCoordinatesFromCanvas(e.document._source),r={x:n.x,y:n.y,width:e.hitArea.width*t,height:e.hitArea.height*t,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},a,u=this.#i?tt[g("position")].slice():tt[g("small-position")].slice();for(;u.length&&!a;){let c=u.shift();c==="left"?(a={x:r.x-o.width,y:ke(o,r)},a.x<0&&(a=void 0)):c==="right"?(a={x:r.right,y:ke(o,r)},a.x+o.width>window.innerWidth&&(a=void 0)):c==="top"?(a={x:st(o,r),y:r.y-o.height},a.y<0&&(a=void 0)):c==="bottom"&&(a={x:st(o,r),y:r.bottom},a.y+o.height>window.innerHeight&&(a=void 0))}return a&&(s.style.left=`${a.x}px`,s.style.top=`${a.y}px`),a}activateListeners(e){let s=this.#e,t=s?.actor;if(!t)return;let o=s.isOwner;t.apps[this.appId]=this,g("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(this.#n=!0,this.#c=!0)}),e.on("mouseleave",()=>{this.#c=!1,!this.#t&&(this.#n=!1,this.close())}),e.on("dragover",()=>{s.isOwner&&e.find("> .sidebar.extras").length&&!e.find(".popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let n=e.find("[data-action=show-info]");n.tooltipster({position:["top","bottom","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click"}),(o?n.filter(":not(.speeds)"):n).on("mouseleave",a=>{$(a.currentTarget).tooltipster("hide")}),e.find(".inner .footer [data-type]").on("click",this.#m.bind(this)),o&&(e.find("input").on("change",async a=>{let u=a.currentTarget,c=u.valueAsNumber,d=u.name;u.blur(),d!=="shield.value"?await t.update({[d]:c}):await t.heldShield.update({"system.hp.value":c})}),e.find("[data-action=toggle-hero]").on("click contextmenu",a=>{a.preventDefault();let{max:u,value:c}=t.heroPoints,d=a.type==="click"?1:-1,p=Math.clamped(c+d,0,u);p!==c&&t.update({"system.resources.heroPoints.value":p})}),e.find("[data-action=raise-shield]").on("click",a=>{a.preventDefault(),game.pf2e.actions.raiseAShield({actors:[t]})}),e.find("[data-action=take-cover]").on("click",async a=>{a.preventDefault();let u=(await fromUuid(we)).toObject();setProperty(u,"flags.core.sourceId",we);let c=this.hasCover;this.hasCover?await c.delete():await t.createEmbeddedDocuments("Item",[u])}),e.find("[data-action=roll-save]").on("click",a=>{a.preventDefault();let u=a.currentTarget.dataset.save;t.saves[u].roll({event:a})}),e.find("[data-action=roll-other]").on("click",a=>{a.preventDefault();let u=a.currentTarget.dataset.slug;if(u!=="athletics"){let{ctrlKey:c,metaKey:d,shiftKey:p}=a;a=new MouseEvent("click",{ctrlKey:!c,metaKey:d,shiftKey:p})}q(u,t).roll({event:a})}),e.find("[data-action=recovery-check]").on("click",a=>{a.preventDefault(),t.rollRecovery(a)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",a=>{a.preventDefault();let u=a.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",c=t.system.attributes[u]?.max;c&&(a.type==="click"?t.increaseCondition(u,{max:c}):t.decreaseCondition(u))}),e.find("[data-action=use-resolve]").on("click",a=>{a.preventDefault(),Bt(t)}),n.filter(".speeds").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(a,{origin:u,tooltip:c})=>{this.#t=!0,c.querySelectorAll("[data-index]").forEach(d=>{d.addEventListener("click",async p=>{p.preventDefault(),await Y(t,`speeds.selected.${game.user.id}`,Number(d.dataset.index))})})}).tooltipster("option","functionAfter",()=>{e.find("> .sidebar").length||(this.#t=!1)}))}async#m(e){e=typeof e=="string"?e:e.currentTarget.dataset.type;let s=this.element,t=s.find("> .sidebar"),o=t[0]?.dataset.type;if(t.remove(),s.find(".inner .footer [data-type]").removeClass("active"),o===e){this.#t=!1;return}let n=this.#e,r=n.actor,{getData:a,addListeners:u,getOptions:c}=Ht[e],d=await a(r,n),{classList:p=[]}=c&&await c(r,n)||{};if(!d)return ui.notifications.warn(h(`${e}.empty`,{name:this.#e.name}));d.isGM=game.user.isGM,d.isCharacter=this.isCharacter,d.isOwner=r.isOwner,this.#t=!0,s.find(`.inner .footer [data-type=${e}]`).addClass("active"),s=s[0];let f=document.createElement("div");f.innerHTML=await renderTemplate(j(e),d),t=f.firstElementChild,t.classList.add("sidebar",...p),g("scrollbar")||t.classList.add("no-scrollbar"),d.doubled&&t.classList.add("doubled"),t.dataset.type=e,t.style.setProperty("--max-height",g("height").trim()||"100%"),this.element.append(t);let S=t.getBoundingClientRect(),k=s.getBoundingClientRect(),C=k.x-S.width;C<0&&(C=k.right);let E=parseInt(window.getComputedStyle(s).padding),T=ke(S,k,E);return t.style.left=`${C}px`,t.style.top=`${T}px`,u($(t),r,n),t}};l(Z,"HUD");function ke(i,e,s=0){let t=e.y+e.height/2-i.height/2;return t+i.height>window.innerHeight&&(t=window.innerHeight-i.height-s),t<0&&(t=s),t}l(ke,"postionFromTargetY");function st(i,e){let s=e.x+e.width/2-i.width/2;return s+i.width>window.innerWidth&&(y=window.innerWidth-i.width),s<0&&(s=0),s}l(st,"postionFromTargetX");function Bt(i){function e(d){ChatMessage.create({user:game.user.id,content:d,speaker:ChatMessage.getSpeaker({actor:i})})}l(e,"toChat");let{name:s,attributes:t}=i,{sp:o,resolve:n}=t,r=h("hud.resolve.full",{name:s}),a=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:s});if(o.value===o.max)return ui.notifications.warn(r);if(n.value<1)return ui.notifications.warn(a);let u=i.itemTypes.feat.find(d=>d.sourceId===Rt),c='<p><input type="radio" name="pick" value="breather" style="margin-right: 6px;';u||(c+=" display: none;"),c+='" checked><span>',u&&(c+=`<strong>${h("hud.resolve.breather.label")}:</strong> `),c+=`${h("hud.resolve.breather.msg")}</span></p>`,u&&(c+='<p><input type="radio" name="pick" value="steel" style="margin-right: 6px;">',c+=`<span><strong>${game.i18n.localize("PF2E.Actions.SteelYourResolve.Title")}:</strong> `,c+=`${h("hud.resolve.steel.msg")}</span></p>`),new Dialog({title:h("hud.resolve.title"),content:c,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:h("hud.resolve.yes"),callback:async d=>{let{attributes:p}=i,{sp:f,resolve:S}=p;if(f.value===f.max)return e(r);if(S.value<1)return e(a);let k=d.find("input:checked").val(),C=`${f.value}/${f.max}`;if(k==="breather")e(h("hud.resolve.breather.used",{name:s,ratio:C})),await i.update({"system.attributes.sp.value":f.max,"system.attributes.resolve.value":S.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:s,ratio:C}));let E=f.value+Math.floor(f.max/2);await i.update({"system.attributes.sp.value":Math.min(E,f.max),"system.attributes.resolve.value":S.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:h("hud.resolve.no")}}}).render(!0)}l(Bt,"useResolve");var b="pf2e-token-hud",W=null;function it(){return W}l(it,"getHud");function ue(i){i&&!W?W=new Z:!i&&W&&(W.delete(),W=null)}l(ue,"enableModule");function g(i){return game.settings.get(b,i)}l(g,"getSetting");function h(...i){let e=i.at(-1),s=typeof e=="object",t=s?i.slice(0,-1):i;return t.unshift(b),game.i18n[s?"format":"localize"](t.join("."),e)}l(h,"localize");function j(i){return`modules/${b}/templates/${i}.hbs`}l(j,"templatePath");function H(i){return i>=0?`+${i}`:i}l(H,"modifier");function G(i,e){return i.getFlag(b,e)}l(G,"getFlag");function Y(i,e,s){return i.setFlag(b,e,s)}l(Y,"setFlag");var Ce=!1;function ot(){zt("hold",{onDown:()=>{Ce=!0,g("use-holding")!=="none"&&it().render()},onUp:()=>{Ce=!1}})}l(ot,"registerKeybindings");function Se(){return Ce}l(Se,"isHolding");function nt(i,e){return`${b}.keybinds.${i}.${e}`}l(nt,"path");function zt(i,e={}){game.keybindings.register(b,i,{name:nt(i,"name"),hint:nt(i,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}l(zt,"register");function at(){let i=game.data.users.find(s=>s._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(s=>h(`settings.status.statuses.${s}`)).join(", ");w("status",String,e,{scope:"world"}),w("party",Boolean,!1,{scope:"world"}),w("enabled",Boolean,!0,{onChange:ue}),w("position",String,"right",{choices:{left:v("position","choices.left"),right:v("position","choices.right"),top:v("position","choices.top"),bottom:v("position","choices.bottom")}}),w("small-position",String,"top",{choices:{left:v("position","choices.left"),right:v("position","choices.right"),top:v("position","choices.top"),bottom:v("position","choices.bottom")}}),w("delay",Number,250,{range:{min:0,max:2e3,step:50}}),w("use-holding",String,"none",{hint:v("use-holding",i?"choices.gm.hint":"choices.player.hint"),choices:{none:v("use-holding","choices.none"),half:v("use-holding",i?"choices.gm.half":"choices.player.half"),all:v("use-holding",i?"choices.gm.all":"choices.player.all")}}),w("observer",Boolean,!0),w("see-status",Boolean,!1),w("chat",Boolean,!0),w("saves",String,"bonus",{choices:{none:v("saves","choices.none"),bonus:v("saves","choices.bonus"),dc:v("saves","choices.dc")}}),w("others",String,"none",{choices:{none:v("saves","choices.none"),bonus:v("saves","choices.bonus"),dc:v("saves","choices.dc")}}),w("ranks",Boolean,!1),w("show-death",String,"always",{choices:{none:v("show-death","choices.none"),always:v("show-death","choices.always"),only:v("show-death","choices.only")}}),w("tooltips",Boolean,!1),w("distance",String,"all",{choices:{none:v("distance","choices.none"),self:v("distance","choices.self"),all:v("distance","choices.all")}}),w("unit",String,""),w("height",String,""),w("scrollbar",Boolean,!0),w("spells-columns",Boolean,!1),w("skills-columns",Boolean,!1),w("actions",String,"split",{choices:{name:v("actions","choices.name"),type:v("actions","choices.type"),split:v("actions","choices.split")}}),w("actions-colors",Boolean,!0),w("spells",Boolean,!1),w("tradition",Boolean,!1),w("untrained",Boolean,!0)}l(at,"registerSettings");function rt(i,e){let s=e.find(`.tab[data-tab=${b}]`);function t(o,n,r="h3"){let a=h(`menu.${n}`);s.find(`[name="${b}.${o}"]`).closest(".form-group").before(`<${r}>${a}</${r}>`)}l(t,"beforeGroup"),game.user.isGM&&t("enabled","client.header","h2"),t("saves","client.tooltip"),t("distance","client.distance"),t("height","client.sidebar"),t("actions","client.actions"),t("spells","client.spells"),t("untrained","client.skills")}l(rt,"renderSettingsConfig");function v(i,e){return`${b}.settings.${i}.${e}`}l(v,"path");function w(i,e,s,t={}){game.settings.register(b,i,{name:v(i,"name"),hint:v(i,"hint"),scope:"client",config:!0,type:e,default:s,...t})}l(w,"register");Hooks.once("setup",()=>{at(),ot()});Hooks.once("ready",()=>{g("enabled")&&ue(!0)});Hooks.on("renderSettingsConfig",rt);Hooks.on("getActorDirectoryEntryContext",(i,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${b}.actor.macros.contextmenu`,condition:s=>{let{documentId:t}=s.data();return g("enabled")&&game.actors.get(t)?.isOwner},callback:s=>{let{documentId:t}=s.data();Gt(t)}})});var de=class extends Dialog{getData(e={}){let s=super.getData(e);return typeof s.content=="function"&&(s.content=s.content()),s}};l(de,"DataDialog");function Gt(i){let e=game.actors.get(i);if(!e)return;let s=new de({title:`${e.name} - ${h("actor.macros.title")}`,content:()=>{let t=se(e)??[],o='<div style="min-height: 250px; display: flex; flex-direction: column; gap: 4px;">';if(t.length)for(let n of t)o+=`<div class="macro" style="display: flex; align-items: center; height: 2em; gap: 4px;" data-uuid="${n.uuid}">`,o+=`<img src="${n.img}" style="height: 100%;"><span style="flex: 1;">${n.name}</span>`,o+='<a data-action="delete-macro"><i class="fa-solid fa-trash"></i></a></div>';else o+='<div style="text-align: center; padding-block: 4px; ',o+='color: var(--color-text-dark-4); border: 1px dashed var(--color-text-dark-6);">',o+=`${h("extras.no-macro")}</div>`;return o+="</div>",o},buttons:{},render:t=>{e.apps[s.appId]=s,t.on("drop",o=>ie(o,e)),t.find("[data-action=delete-macro]").on("click",o=>ne(o,e))},close:()=>{delete e.apps[s.appId]}},{height:"auto"}).render(!0)}l(Gt,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
