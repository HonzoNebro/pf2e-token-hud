(()=>{var ue=Object.defineProperty;var l=(i,t)=>ue(i,"name",{value:t,configurable:!0});var m="pf2e-token-hud";function h(i){return game.settings.get(m,i)}l(h,"getSetting");function g(...i){let t=i.at(-1),s=typeof t=="object",e=s?i.slice(0,-1):i;return e.unshift(m),game.i18n[s?"format":"localize"](e.join("."),t)}l(g,"localize");function x(i){return`modules/${m}/templates/${i}.hbs`}l(x,"templatePath");function H(i){return i>=0?`+${i}`:i}l(H,"modifier");var me=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),fe=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]),U=new Set(["arcane","divine","occult","primal"]),R={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"};function _(i,t="systems/pf2e/icons/actions/Empty.webp"){if(i===null)return R.passive;let s=typeof i!="object"?i:i.type==="action"?i.value:i.type,e=String(s??"").toLowerCase().trim();return R[e]??t}l(_,"getActionIcon");async function z({weapon:i,trait:t,selection:s}){if(i.system.traits.toggles[t].selection===s)return!1;let n=i.actor?.items.get(i.id);return n?.isOfType("weapon")&&n===i?await n.update({[`system.traits.toggles.${t}.selection`]:s}):n?.isOfType("weapon")&&i.altUsageType==="melee"?n.update({[`system.meleeUsage.traitToggles.${t}`]:s}):await n?.rules.find(r=>r.key==="Strike"&&!r.ignored&&r.slug===i.slug)?.toggleTrait({trait:t,selection:s}),!0}l(z,"toggleWeaponTrait");function ge(i,t="normal"){return i+(me.get(t)??0)}l(ge,"adjustDC");function ye(i="common"){switch(i){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}l(ye,"rarityToDCAdjustment");function j(i,t="common"){return ge(i,ye(t))}l(j,"adjustDCByRarity");function he(i,{proficiencyWithoutLevel:t,rarity:s="common"}={}){let e=game.settings.get("pf2e","proficiencyVariant");t??=e==="ProficiencyWithoutLevel";let n=fe.get(i)??14;return j(t?n-Math.max(i,0):n,s)}l(he,"calculateDC");function ve(i){return i.traits.has("cursed")?"unique":i.rarity}l(ve,"getDcRarity");function be(i){let t=i.system.traits.value;return new Set(t.filter(s=>Ie(U,s)))}l(be,"getMagicTraditions");function ke(i,t,s){let e={occult:t,primal:t,divine:t,arcane:t},n=be(i);for(let a of U)n.size>0&&!n.has(a)&&(e[a]=t+s);return{arcana:e.arcane,nature:e.primal,religion:e.divine,occultism:e.occult}}l(ke,"getIdentifyMagicDCs");function we(i,{proficiencyWithoutLevel:t=!1,notMatchingTraditionModifier:s}){let e=he(i.level,{proficiencyWithoutLevel:t}),n=ve(i),a=j(e,n);return i.isMagical?ke(i,a,s):i.isAlchemical?{crafting:a}:{dc:a}}l(we,"getItemIdentificationDCs");function Te(i,t){return(typeof t=="string"||typeof t=="number")&&t in i}l(Te,"objectHasKey");function Ie(i,t){return i.has(t)}l(Ie,"setHasElement");var P=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let t=this.object,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),e=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",n=we(t,{proficiencyWithoutLevel:e,notMatchingTraditionModifier:s});return{...await super.getData(),isMagic:t.isMagical,isAlchemical:t.isAlchemical,dcs:n}}activateListeners(t){t.find("button.update-identification").on("click",s=>{let e=$(s.delegateTarget);this.submit({updateData:{status:e.val()}})}),t.find("button.post-skill-checks").on("click",async()=>{let s=this.item,e=s.system.identification.unidentified.img,n=s.system.identification.unidentified.name,a=s.system.identification.identified.name,r=$("div#identify-item").find("tr").toArray().flatMap(p=>{let u=p.dataset.skill,d=Number(p.dataset.dc);if(!(Number.isInteger(d)&&Te(CONFIG.PF2E.skillList,u)))return[];let f=game.i18n.localize(CONFIG.PF2E.skillList[u]);return{slug:u,name:f,dc:d}}),c=s.isMagical?"action:identify-magic":s.isAlchemical?"action:identify-alchemy":null,o=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:e,itemName:n,identifiedName:a,rollOptions:["concentrate","exploration","secret",c].filter(Boolean),skills:r});await CONFIG.ChatMessage.documentClass.create({user:game.user.id,content:o})})}async _updateObject(t,s){let e=s.status;e==="identified"&&await this.item.setIdentificationStatus(e)}};l(P,"IdentifyItemPopup");async function E(i,t){let s=$(`#${m}`);if(!s.length)return;s.find(".popup").remove();let e=document.createElement("div");e.innerHTML=await renderTemplate(x("popup"),{title:i,close:g("popup.close")});let n=e.firstElementChild;n.append(t),n.querySelector("[data-action=close-popup]").addEventListener("click",()=>n.remove()),s.append(n)}l(E,"popup");async function L(i,t){let s=i.data(),e=s.itemId?t.items.get(s.itemId):await fromUuid(s.uuid),n=await e?.getChatData({},s);if(!n)return;let a=document.createElement("div");return a.classList.add("description"),await t.sheet.itemRenderer.renderItemSummary(a,e,n),a}l(L,"getItemSummary");function C(i){i.on("mouseenter",t=>{t.preventDefault();let s=t.currentTarget.querySelector(".name");if(s.scrollWidth<=s.clientWidth)return;let e=s.innerHTML.trim();game.tooltip.activate(t.currentTarget,{text:e})}),i.on("mouseleave",t=>{t.preventDefault(),game.tooltip.deactivate()}),i.on("mousedown",t=>{game.tooltip.deactivate()})}l(C,"addNameTooltipListeners");function G(i,t){i.preventDefault(),w(i,t)?.sheet.render(!0,{focus:!0})}l(G,"editItem");async function W(i,t){i.preventDefault();let s=w(i,t);if(s){if(i.ctrlKey)return s.delete();new Dialog({title:g("deleteItem.title"),content:await renderTemplate("systems/pf2e/templates/actors/delete-item-dialog.hbs",{name:s.name}),buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:g("deleteItem.ok"),callback:()=>s.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:g("deleteItem.cancel")}}}).render(!0)}}l(W,"deleteItem");function w(i,t){let{itemId:s}=i.currentTarget.closest("[data-item-id]").dataset;return t.items.get(s)}l(w,"getItemFromEvent");var Ce=new Set(["Compendium.pf2e.equipment-srd.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.4kz3vhkKPUuXBpxk"]),V="Compendium.pf2e.feats-srd.0GF2j54roPFIDmXf",De={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${m}.skills.actions.earnIncome`,treatWounds:`${m}.skills.actions.treatWounds`,"borrow-arcane-spell":`${m}.skills.actions.borrow-arcane-spell`,"identify-magic":`${m}.skills.actions.identify-magic`,"identify-alchemy":`${m}.skills.actions.identify-alchemy`,"learn-spell":`${m}.skills.actions.learn-spell`,"crafting-goods":`${m}.skills.actions.crafting-goods`,"staging-performance":`${m}.skills.actions.staging-performance`},J={"sense-motive":"Compendium.pf2e.actionspf2e.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.SkZAQRkLLkmBQNB9","tumble-through":"Compendium.pf2e.actionspf2e.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.QNAVeNKtHA0EUw4X",bonMot:V,gatherInformation:"Compendium.pf2e.actionspf2e.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.2EE4aF4SZpYf0R6H"},Se={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},F=[{slug:"perception",actions:[{slug:"initiative",custom:(i,t)=>i.initiative.roll(t),condition:()=>game.combat},{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},"escape",{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:["recall-knowledge",{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},"escape",{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:i=>!i.itemTypes.equipment.some(t=>t.isHeld&&Ce.has(t.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:["recall-knowledge",{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:i=>i.itemTypes.feat.some(t=>t.getFlag("core","sourceId")===V)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"]},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"recall-knowledge","identify-magic","learn-spell"]},{slug:"occultism",actions:["recall-knowledge","decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds","warning"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["recall-knowledge","decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:["recall-knowledge",{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];F.forEach(i=>{i.actions=i.actions.map(e=>typeof e=="string"?Se[e]:e);let{slug:t,actions:s}=i;for(let e of s){let n=e.slug.replace(/-(.)/g,(a,r)=>r.toUpperCase()).capitalize();e.skillSlug=t,e.uuid=J[e.slug],e.label=De[e.slug]??`PF2E.Actions.${n}.Title`,e.variants?e.variants=e.variants.map(a=>({slug:a,label:`${m}.skills.actions.${a}`})):e.map&&(e.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),e.modifiers?.forEach(({modifiers:a})=>{a.forEach(r=>{r.label=`${m}.skills.modifiers.${r.slug}`})})}});var Ee=F.map(i=>i.slug),Le=F.reduce((i,{slug:t,actions:s})=>(i[t]={slug:t,actions:s.reduce((e,n)=>(e[n.slug]=n,e),{})},i),{}),X=new Set(Object.values(J).filter(Boolean));async function K(i){let t=[];for(let e=0;e<F.length;e++){let{slug:n,actions:a}=F[e],{label:r,rank:c,mod:o}=O(n,i);t[e]={slug:n,label:r,rank:c,actions:a.filter(p=>!p.condition||p.condition(i)),modifier:H(o)}}let s=Object.values(i.skills).filter(e=>e.lore).map(({label:e,rank:n,mod:a,slug:r})=>({slug:r,label:e,rank:n,modifier:H(a)}));return{skills:t,lores:s}}l(K,"getSkillsData");function O(i,t){return i==="perception"?t.perception:t.skills[i]}l(O,"getSkill");function Q(i,t){i.find("[data-action=roll-skill]").on("click",s=>{s.preventDefault();let{slug:e}=s.currentTarget.dataset;O(e,t).roll({event:s})}),i.find("[data-action=roll-action]").on("click contextmenu",async s=>{s.preventDefault();let e=$(s.currentTarget),{skillSlug:n,slug:a}=e.closest(".action").data(),r=s.type==="contextmenu"?await Ae(t,n):void 0;r!==null&&xe(s,t,n,a,e.data(),r)}),i.find("[data-action=action-description]").on("click",async s=>{s.preventDefault();let e=$(s.currentTarget).closest(".action"),n=await L(e,t);n&&E(e.find(".name").children().html().trim(),n)})}l(Q,"addSkillsListeners");async function Ae(i,t){let s='<p style="text-align: center; margin-block: 0 8px;">';s+=`<strong>${g("skills.variant.label")}</strong> <select>`;for(let e of Ee)s+=`<option value="${e}" ${e===t?"selected":""}>${O(e,i).label}</option>`;return s+="</select></p>",Dialog.prompt({title:g("skills.variant.title"),label:g("skills.variant.button"),callback:e=>e.find("select").val(),rejectClose:!1,content:s,options:{width:280}})}l(Ae,"createVariantDialog");function xe(i,t,s,e,{variant:n,map:a},r){let c=Le[s].actions[e],o=c.type;r??=c.noSkill?void 0:s;let p={event:i,actors:[t],variant:n,rollMode:c.secret?"blindroll":"roll"};if(p.modifiers=[],c.modifiers){for(let{condition:u,modifiers:d}of c.modifiers)if(!(u&&!u(t)))for(let f of d)p.modifiers.push(new game.pf2e.Modifier(f))}if(c.custom){c.custom(t,p);return}else if(!o){O(r,t).roll(p);return}o===1?(p.skill=r,a&&p.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:a})),game.pf2e.actions[e](p)):o===2?(p.statistic=r,a&&(p.multipleAttackPenalty=a/-5),game.pf2e.actions.get(e).use(p)):o===3&&game.pf2e.actions[e](t)}l(xe,"rollAction");var A={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionTypeReaction",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionTypeFree",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.ActionTypePassive",actionLabel:"PF2E.ActionTypePassive"}},Y={delay:[500,0],position:"top",theme:"crb-hover"};async function Z(i){let t=i.isOfType("character"),s=i.synthetics.toggles.slice(),e=t?Pe(i):null,n=h("actions"),a=t?Fe(i):Me(i),r=await Promise.all(i.system.actions.map(async(o,p)=>({...o,index:p,damageFormula:await o.damage?.({getFormula:!0}),criticalFormula:await o.critical?.({getFormula:!0})}))),c={};for(let o of a)n!=="split"?(c.action??=[],c.action.push(o)):(c[o.type]??=[],c[o.type].push(o));if(c=Object.entries(c).map(([o,p])=>(p.forEach(u=>{u.img=_(u.cost),u.typeLabel=A[u.type].actionLabel}),n!=="type"?p.sort((u,d)=>u.name.localeCompare(d.name)):p.sort((u,d)=>{let f=A[u.type].order,b=A[d.type].order;return f===b?u.name.localeCompare(d.name):f-b}),{type:o,actions:p,label:A[o].label})),n==="split"&&c.sort((o,p)=>A[o.type].order-A[p.type].order),s.length||r.length||c.length||e?.length)return{toggles:s,strikes:r,sections:c,heroActions:e,damageTypes:CONFIG.PF2E.damageTypes}}l(Z,"getActionsData");function ee(i){if(h("actions-colors"))return{classList:["attack-damage-system-colors"]}}l(ee,"getActionsOptions");function te(i,t){C(i.find(".toggle")),C(i.find(".strike")),C(i.find(".action")),i.find("[data-action=action-chat]").on("click",e=>{e.preventDefault(),w(e,t).toMessage(e,{create:!0})}),i.find("[data-action=action-description]").on("click",async e=>{e.preventDefault();let n=$(e.currentTarget).closest(".action"),a=await L(n,t);a&&E(n.find(".name").html().trim(),a)}),i.find("[data-action=toggle-roll-option], [data-action=set-suboption]").on("click",e=>{e.preventDefault();let n=e.currentTarget.closest(".toggle"),{domain:a,option:r,itemId:c}=n.dataset,o=n.querySelector("select")?.value??null;t.toggleRollOption(a,r,c??null,n.querySelector("input").checked,o)});function s(e){let{index:n}=e.currentTarget.closest(".strike").dataset;return t.system.actions[n]}l(s,"getStrike"),i.find("[data-action=strike-attack]").on("click",e=>{e.preventDefault();let{index:n}=e.currentTarget.dataset;s(e)?.variants[n].roll({event:e})}),i.find("[data-action=strike-damage], [data-action=strike-critical]").on("click",e=>{e.preventDefault();let{action:n}=e.currentTarget.dataset;s(e)?.[n==="strike-damage"?"damage":"critical"]({event:e})}).tooltipster(Y),i.find("[data-action=strike-auxiliary]").on("click",e=>{if(e.preventDefault(),e.currentTarget!==e.target)return;let n=s(e);if(!n)return;let{index:a}=e.currentTarget.dataset,r=e.currentTarget.querySelector("select")?.value??null;n.auxiliaryActions?.[a]?.execute({selection:r})}),i.find("[data-action=toggle-versatile]").on("click",e=>{e.preventDefault();let n=s(e)?.item;if(!n)return;let a=e.currentTarget,{value:r}=a.dataset,c=n?.system.damage.damageType??null,o=a.classList.contains("selected")||r===c?null:r;z({trait:"versatile",weapon:n,selection:o})}).tooltipster(Y),i.find("[data-action=strike-ammo]").on("change",e=>{e.preventDefault();let n=s(e)?.item;if(!n)return;let a=t.items.get(e.currentTarget.value);n.update({system:{selectedAmmoId:a?.id??null}})})}l(te,"addActionsListeners");function Pe(i){let t=game.modules.get("pf2e-hero-actions");return t?.active?t.api.getHeroActions(i):null}l(Pe,"getHeroActions");function Fe(i){let t=i.itemTypes.action.filter(e=>!X.has(e.sourceId)),s=i.itemTypes.feat.filter(e=>e.actionCost);return[...t,...s].filter(e=>{let n=e.system.traits.value;return!n.includes("downtime")&&!n.includes("exploration")}).map(e=>{let n=e.actionCost;return{id:e.id,type:n?.type??"free",cost:n,name:e.name}})}l(Fe,"getCharacterActions");function Me(i){return i.itemTypes.action.map(t=>{let s=t.actionCost,e=s?.type??"passive",n=e==="passive"&&(t.system.traits.value.includes("aura")||!!t.system.rules.find(a=>a.key==="Aura"));return{id:t.id,type:e,cost:s,name:t.name,hasDeathNote:t.system.deathNote,hasAura:n}})}l(Me,"getNpcActions");var N={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function ie(i){let t={};for(let s of i.inventory.contents)t[s.type]??=[],t[s.type].push(s);return{categories:Object.entries(t).map(([s,e])=>(e.sort((n,a)=>n.name.localeCompare(a.name)),{type:s,items:e,label:N[s].label})).sort((s,e)=>N[s.type].order-N[e.type].order)}}l(ie,"getItemsData");function se(i,t){let s=i.find(".item");C(s),s.on("dragstart",e=>{let n=e.target.closest(".item"),{itemType:a,uuid:r}=n.dataset,c=new Image;c.src=n.querySelector(".item-img img").src,c.style.width="32px",c.style.height="32px",c.style.borderRadius="4px",c.style.position="absolute",c.style.left="-1000px",document.body.append(c),e.originalEvent.dataTransfer.setDragImage(c,16,16),e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:a,uuid:r})),n.addEventListener("dragend",()=>c.remove(),{once:!0})}),i.find(".quantity input").on("change",e=>{w(e,t)?.update({"system.quantity":e.currentTarget.valueAsNumber})}),i.find("[data-action=toggle-item-invest]").on("click",e=>{e.preventDefault();let{itemId:n}=e.currentTarget.closest(".item").dataset;t.toggleInvested(n)}),i.find("[data-action=repair-item]").on("click",e=>{e.preventDefault();let n=w(e,t);n&&game.pf2e.actions.repair({item:n,actors:[t]})}),i.find("[data-action=toggle-identified]").on("click",e=>{e.preventDefault();let n=w(e,t);n&&(n.isIdentified?n.setIdentificationStatus("unidentified"):new P(n).render(!0))}),i.find("[data-action=edit-item]").on("click",e=>G(e,t)),i.find("[data-action=delete-item]").on("click",e=>W(e,t)),i.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(e,{event:n,origin:a}){let r=w(n,t);if(!r)return;let c=document.createElement("div");c.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:r});let o=c.children[1];$(o).find("[data-carry-type]").on("click",p=>{let{carryType:u,handsHeld:d=0,inSlot:f}=$(p.currentTarget).data();t.adjustCarryType(r,u,d,f),e.close()}),e.content(o)}})}l(se,"addItemsListeners");async function ne(i){let t=i.system.resources.focus?.value??0,s=i.spellcasting.regular,e=[];for(let r of s){let c=r.id,o=await r.getSheetData(),p=r.system?.prepared?.value==="charge",u=getProperty(r,"flags.pf2e-staves.staveID")!==void 0,d={value:getProperty(r,"flags.pf2e-staves.charges")??0};for(let f of o.levels){if(!f.active.length||f.uses?.max===0)continue;let b=[],S=f.active.filter(k=>k&&k.uses?.max!==0);for(let k=0;k<S.length;k++){let{spell:I,expended:ce,virtual:le,uses:pe,castLevel:de}=S[k];b.push({name:I.name,img:I.img,castLevel:de??I.level,slotId:k,entryId:c,itemId:I.id,inputId:o.isInnate?I.id:o.id,inputPath:p?"flags.pf2e-staves.charges":o.isInnate?"system.location.uses.value":`system.slots.slot${f.level}.value`,isCharge:p,isVirtual:le,isInnate:o.isInnate,isCantrip:f.isCantrip,isFocus:o.isFocusPool,isPrepared:o.isPrepared,isSpontaneous:o.isSpontaneous||o.isFlexible,slotLevel:f.level,uses:pe??(p?d:f.uses),expended:ce??(o.isFocusPool?t<=0:!1),action:I.system.time.value,type:p?u?`${m}.spells.staff`:`${m}.spells.charges`:o.isInnate?"PF2E.PreparationTypeInnate":o.isSpontaneous?"PF2E.PreparationTypeSpontaneous":o.isFlexible?"PF2E.SpellFlexibleLabel":o.isFocusPool?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:p?0:o.isPrepared?1:o.isFocusPool?2:o.isInnate?3:o.isSpontaneous?4:5})}b.length&&(e[f.level]??=[],e[f.level].push(...b))}}if(e.length){let r=h("spells")?(c,o)=>c.order===o.order?c.name.localeCompare(o.name):c.order-o.order:(c,o)=>c.name.localeCompare(o.name);e.forEach(c=>c.sort(r))}let a=(await i.spellcasting.ritual?.getSheetData())?.levels.flatMap((r,c)=>r.active.map(({spell:o})=>({name:o.name,img:o.img,slotId:c,itemId:o.id,level:o.level,time:o.system.time.value})));if(e.length||a?.length)return{spells:e,rituals:a}}l(ne,"getSpellsData");function oe(i,t){C(i.find(".spell")),i.find("[data-action=toggle-pips]").on("click contextmenu",s=>{s.preventDefault();let e=s.type==="click"?1:-1,n=(t.system.resources.focus?.value??0)+e;t.update({"system.resources.focus.value":n})}),i.find("[data-action=toggle-prepared]").on("click",s=>{s.preventDefault();let{slotLevel:e,slotId:n,entryId:a,expended:r}=$(s.currentTarget).closest(".spell").data();t.spellcasting.collections.get(a)?.setSlotExpendedState(e??0,n??0,r!==!0)}),i.find("[data-action=cast-spell]").on("click",s=>{s.preventDefault();let{slotLevel:e,slotId:n,entryId:a,itemId:r}=$(s.currentTarget).closest(".spell").data(),c=t.spellcasting.collections.get(a,{strict:!0});if(!c)return;let o=c.get(r,{strict:!0});o&&c.entry.cast(o,{slot:n,level:e})}),i.find("[data-action=spell-description]").on("click",async s=>{s.preventDefault();let e=$(s.currentTarget).closest(".spell"),n=await L(e,t);n&&E(e.find(".name").html().trim(),n)}),i.find("[data-input-path]").on("change",async s=>{let{inputPath:e,entryId:n}=$(s.currentTarget).data(),a=s.currentTarget.valueAsNumber;await t.updateEmbeddedDocuments("Item",[{_id:n,[e]:a}])})}l(oe,"addSpellsListeners");var q="Compendium.pf2e.other-effects.I9lfZUiCwMiGogVi",Oe={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},$e=[{type:"land",icon:'<i class="fa-solid fa-shoe-prints"></i>'},{type:"burrow",icon:'<i class="fa-solid fa-chevrons-down"></i>'},{type:"climb",icon:'<i class="fa-solid fa-spider"></i>'},{type:"fly",icon:'<i class="fa-solid fa-feather"></i>'},{type:"swim",icon:'<i class="fa-solid fa-person-swimming"></i>'}],He={actions:{getData:Z,addListeners:te,getOptions:ee},items:{getData:ie,addListeners:se},spells:{getData:ne,addListeners:oe},skills:{getData:K,addListeners:Q},extras:{getData:()=>null,addListeners:()=>{}}},M=class extends Application{#e=null;#c=null;#t=null;#i=!1;#s=null;#n;#a=!1;#o=!1;#r=!1;constructor(){super(),this.hoverToken=(t,s)=>{if(this.#a||this.#o||this.#r||!(t instanceof Token)||!t.isOwner||!t.actor?.isOfType("character","npc"))return;let e=t.localTransform,n=t.document;if(!(e.tx!==n.x||e.ty!==n.y)&&(this.#i=s,!(s&&this.#e===t&&this.rendered)))if(s){if(this.#e&&delete this.#e.actor.apps[m],this.#e=t,!this.#s)return this.render();clearTimeout(this.#s),this.#s=null,this.render(!0)}else this.close()},this.#n=t=>{if(t.type==="mouseup"){this.#a=!1;return}let s=t.target,e=this.element[0];if(e){let n=e.querySelector(".popup");if(e.contains(s)){n&&!n.contains(s)&&n.remove();return}if(s.closest(".app")||s.closest(".tooltipster-base"))return;if(n)return n.remove();this.close({force:!0})}this.#o=!1,this.#a=!0},this.forceClose=()=>this.close({force:!0}),this.deleteToken=t=>{this.#e&&t.id===this.#e.id&&this.close({force:!0})},window.addEventListener("mousedown",this.#n),window.addEventListener("mouseup",this.#n)}delete(){this.close({force:!0}),window.removeEventListener("mousedown",this.#n),window.removeEventListener("mouseup",this.#n)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:x("hud")})}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return this.actor?.itemTypes.effect.find(t=>t.flags.core?.sourceId===q)}getData(){let t=this.#e,s=this.#e?.actor;if(!s)return{};let{attributes:e,saves:n}=s,{hp:a,sp:r,ac:c,shield:o,speed:p}=e,u=$e.map(d=>(d.value=(d.type==="land"?p.total:p.otherSpeeds.find(f=>f.type===d.type)?.total)??0,d));return{tokenId:t.id,name:t.document.name,hp:a,sp:r,ac:c.value,shield:o,hasCover:this.hasCover,saves:{fortitude:n.fortitude.mod,reflex:n.reflex.mod,will:n.will.mod},speeds:u,languages:this.actor.system.traits?.languages?.value.join(", "),hasSpells:s.spellcasting.some(d=>d.category!=="items"),hasItems:s.inventory.size}}#l(){this.#e=null,this.#i=!1,this.#o=!1,this.#r=!1,this.#t!==null&&(clearTimeout(this.#t),this.#t=null);let t=Application.RENDER_STATES;this._state=t.CLOSING;let s=this.element;if(!s)return this._state=t.CLOSED;s.css({minHeight:0});for(let e of this.constructor._getInheritanceChain())Hooks.call(`close${e.name}`,this,s);s.remove(),this._element=null,this._state=t.CLOSED}close(t={}){let s=Application.RENDER_STATES;if(!(!t.force&&!this.#t&&![s.RENDERED,s.ERROR].includes(this._state))){if(t.force)return this.#l(t);this.#s=setTimeout(()=>{this.#s=null,!this.#i&&this.#l(t)})}}async _render(t=!1,s={}){let e,n;if(this.#c===this.#e){let a=this.element.find(".sidebar")[0];a&&(e=a.dataset.type,n=a.scrollTop)}if(await super._render(t,s),e){let a=await this.#p(e);n>0&&(a.scrollTop=n)}this.#c=this.#e}render(t){if(!this.#e?.actor||this.#a)return;if(t)return super.render(!0);let s=h("delay");s?this.#t=setTimeout(()=>super.render(!0),s):super.render(!0)}_injectHTML(t){$("body").append(t),this._element=t}setPosition(){let t=this.#e;if(!t)return;let s=this.element[0],e=s.getBoundingClientRect(),n=t.worldTransform.a,a=canvas.clientCoordinatesFromCanvas(t.document._source),r={x:a.x,y:a.y,width:t.hitArea.width*n,height:t.hitArea.height*n,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},c=Oe[h("position")].slice(),o;for(;c.length&&!o;){let p=c.shift();p==="left"?(o={x:r.x-e.width,y:B(e,r)},o.x<0&&(o=void 0)):p==="right"?(o={x:r.right,y:B(e,r)},o.x+e.width>window.innerWidth&&(o=void 0)):p==="top"?(o={x:ae(e,r),y:r.y-e.height},o.y<0&&(o=void 0)):p==="bottom"&&(o={x:ae(e,r),y:r.bottom},o.y+e.height>window.innerHeight&&(o=void 0))}return o&&(s.style.left=`${o.x}px`,s.style.top=`${o.y}px`),o}activateListeners(t){let e=this.#e?.actor;e&&(e.apps[m]=this,t.on("mouseenter",()=>{this.#i=!0,this.#r=!0}),t.on("mouseleave",()=>{this.#r=!1,!this.#o&&(this.#i=!1,this.close())}),t.on("dragover",()=>{t.css("opacity",.1),t.css("pointerEvents","none"),window.addEventListener("dragend",()=>{t.css("opacity",1),t.css("pointerEvents","")},{once:!0})}),t.find("input").on("change",async n=>{let a=n.currentTarget,r=a.valueAsNumber,c=a.name;a.blur(),c!=="shield.value"?await e.update({[c]:r}):await e.heldShield.update({"system.hp.value":r})}),t.find("[data-action=raise-shield]").on("click",()=>{game.pf2e.actions.raiseAShield({actors:[e]})}),t.find("[data-action=take-cover]").on("click",async()=>{let n=(await fromUuid(q)).toObject();setProperty(n,"flags.core.sourceId",q);let a=this.hasCover;this.hasCover?await a.delete():await e.createEmbeddedDocuments("Item",[n])}),t.find("[data-action=roll-save]").on("click",n=>{let a=n.currentTarget.dataset.save;e.saves[a].roll({event:n})}),t.find(".inner .footer [data-type]").on("click",this.#p.bind(this)))}async#p(t){let s=this.actor,e=typeof t=="string"?t:t.currentTarget.dataset.type,{getData:n,addListeners:a,getOptions:r}=He[e],c=await n(s),{classList:o=[]}=r&&await r(s)||{};if(!c)return ui.notifications.warn(g(`${e}.empty`,{name:this.#e.name}));c.isGM=game.user.isGM,c.isCharacter=s.isOfType("character"),this.#o=!0;let p=this.element;p.find(".sidebar").remove(),p.find(".inner .footer [data-type]").removeClass("active"),p.find(`.inner .footer [data-type=${e}]`).addClass("active"),p=p[0];let u=document.createElement("div");u.innerHTML=await renderTemplate(x(e),c);let d=u.firstElementChild;d.classList.add("sidebar",...o),h("scrollbar")||d.classList.add("no-scrollbar"),d.dataset.type=e,this.element.append(d);let f=d.getBoundingClientRect(),b=p.getBoundingClientRect(),S=b.x-f.width;S<0&&(S=b.right);let k=parseInt(window.getComputedStyle(p).padding),I=B(f,b,k);return d.style.left=`${S}px`,d.style.top=`${I}px`,a($(d),s),d}};l(M,"HUD");function B(i,t,s=0){let e=t.y+t.height/2-i.height/2;return e+i.height>window.innerHeight&&(e=window.innerHeight-i.height-s),e<0&&(e=s),e}l(B,"postionFromTargetY");function ae(i,t){let s=t.x+t.width/2-i.width/2;return s+i.width>window.innerWidth&&(y=window.innerWidth-i.width),s<0&&(s=0),s}l(ae,"postionFromTargetX");var v=null;function D(i,t,s,e={}){game.settings.register(m,i,{...e,name:T(i,"name"),hint:T(i,"hint"),scope:"client",config:!0,type:t,default:s})}l(D,"registerSetting");Hooks.once("setup",()=>{D("enabled",Boolean,!0,{onChange:re}),D("position",String,"right",{choices:{left:T("position","choices.left"),right:T("position","choices.right"),top:T("position","choices.top"),bottom:T("position","choices.bottom")}}),D("delay",Number,250,{range:{min:0,max:2e3,step:50}}),D("scrollbar",Boolean,!0),D("actions",String,"split",{choices:{name:T("actions","choices.name"),type:T("actions","choices.type"),split:T("actions","choices.split")}}),D("actions-colors",Boolean,!0),D("spells",Boolean,!1)});Hooks.once("ready",()=>{h("enabled")&&re(!0)});function T(i,t){return`${m}.settings.${i}.${t}`}l(T,"settingPath");function re(i){i&&!v?(v=new M,Hooks.on("hoverToken",v.hoverToken),Hooks.on("deleteToken",v.deleteToken),Hooks.on("canvasPan",v.forceClose)):!i&&v&&(Hooks.off("hoverToken",v.hoverToken),Hooks.off("deleteToken",v.deleteToken),Hooks.off("canvasPan",v.forceClose),v.delete(),v=null)}l(re,"enableModule");})();
//# sourceMappingURL=main.js.map
